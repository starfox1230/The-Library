<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#120812" />
  <title>Calorie Log (JSON Paste)</title>
  <style>
    :root{
      --bg: #0f0813;

      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.09);

      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --faint: rgba(255,255,255,0.52);
      --line: rgba(255,255,255,0.12);

      /* Pastel pink / lavender accents */
      --accent: #ff79b7;
      --accent2:#caa8ff;
      --accent3:#ffb3d8;

      --good: #67f0c7;
      --warn: #ffd28a;
      --bad:  #ff5f93;

      --shadow: 0 14px 45px rgba(0,0,0,0.45);
      --radius: 16px;
      --radius2: 12px;
      --tap: 48px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin: 0;
      font-family: var(--font);
      background:
        radial-gradient(1200px 900px at 20% 10%, rgba(255,121,183,0.16), transparent 52%),
        radial-gradient(1000px 800px at 82% 18%, rgba(202,168,255,0.14), transparent 56%),
        radial-gradient(1000px 900px at 45% 85%, rgba(255,179,216,0.10), transparent 58%),
        var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overscroll-behavior-y: none;
      touch-action: manipulation;
    }

    /* Avoid iOS “scroll behind modal” and weird rubber-banding */
    body.locked{
      position: fixed;
      width: 100%;
      overflow: hidden;
    }

    a{ color: var(--accent); text-decoration: none; }
    a:active{ opacity: .85; }

    .app{
      min-height: 100%;
      display: flex;
      flex-direction: column;
    }

    .topbar{
      position: sticky;
      top: 0;
      z-index: 5;
      background: linear-gradient(to bottom, rgba(15,8,19,0.92), rgba(15,8,19,0.72));
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-bottom: 1px solid var(--line);
      padding: env(safe-area-inset-top) 14px 12px 14px;
    }

    .toprow{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .title{
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .title h1{
      margin: 0;
      font-size: 16px;
      letter-spacing: .2px;
      font-weight: 750;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .title .sub{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pillrow{
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .pill{
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      max-width: 100%;
    }
    .pill strong{ color: var(--text); font-weight: 750; }
    .pill .dot{
      width: 8px; height: 8px; border-radius: 999px;
      background: var(--accent);
      opacity: .95;
      flex: 0 0 auto;
    }

    .content{
      flex: 1;
      padding: 14px;
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
      max-width: 860px;
      width: 100%;
      margin: 0 auto;
    }

    .grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card .hd{
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .card .hd .hgroup{
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .card .hd .hgroup .h{
      font-size: 14px;
      font-weight: 780;
      margin: 0;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .card .hd .hgroup .hint{
      font-size: 12px;
      color: var(--muted);
      margin: 0;
      line-height: 1.35;
    }

    .card .bd{
      padding: 14px;
    }

    .row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btnrow{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button, .btn{
      min-height: var(--tap);
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      font-weight: 720;
      font-size: 14px;
      letter-spacing: .15px;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    button:active, .btn:active{ transform: translateY(1px); opacity: .92; }
    button.primary{
      background: linear-gradient(135deg, rgba(255,121,183,0.30), rgba(202,168,255,0.22));
      border-color: rgba(255,121,183,0.38);
    }
    button.ghost{
      background: transparent;
    }
    button.danger{
      background: rgba(255,95,147,0.12);
      border-color: rgba(255,95,147,0.25);
    }
    button.small{
      min-height: 40px;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 700;
    }
    button.icon{
      min-height: 40px;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    textarea, input, select{
      width: 100%;
      background: rgba(255,255,255,0.05);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
    }
    textarea{
      min-height: 180px;
      resize: vertical;
      line-height: 1.35;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      padding: 12px;
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(255,121,183,0.55);
      box-shadow: 0 0 0 3px rgba(255,121,183,0.16);
    }

    .help{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      margin-top: 8px;
    }

    .split{
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 820px){
      .split{ grid-template-columns: 1.1fr .9fr; align-items: start; }
    }

    .kpi{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .kpi .box{
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 78px;
      justify-content: center;
    }
    .kpi .box .label{ font-size: 12px; color: var(--muted); }
    .kpi .box .value{
      font-size: 22px;
      font-weight: 820;
      letter-spacing: .2px;
      line-height: 1.1;
    }
    .kpi .box .mini{ font-size: 12px; color: var(--muted); }

    .toggle{
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .switch{
      width: 52px; height: 32px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.08);
      position: relative;
      flex: 0 0 auto;
    }
    .switch .knob{
      position: absolute;
      top: 3px; left: 3px;
      width: 26px; height: 26px;
      border-radius: 999px;
      background: rgba(255,255,255,0.85);
      transition: transform .18s ease;
    }
    .switch.on{
      background: rgba(255,121,183,0.16);
      border-color: rgba(255,121,183,0.26);
    }
    .switch.on .knob{ transform: translateX(20px); background: rgba(255,121,183,0.92); }

    .sep{
      height: 1px;
      background: var(--line);
      margin: 12px 0;
    }

    .list{
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .dayHeader{
      margin-top: 2px;
      padding: 6px 2px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      color: var(--muted);
      font-size: 12px;
      font-weight: 780;
      letter-spacing: .2px;
    }

    .dayHeader .sub{
      font-weight: 700;
      opacity: .9;
    }

    .entry{
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }
    .entry .left{
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .entry .top{
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      min-width: 0;
    }
    .badge{
      font-size: 12px;
      padding: 5px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--muted);
      background: rgba(255,255,255,0.04);
    }

    .entry .name{
      font-size: 14px;
      font-weight: 760;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .entry .meta{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .entry .right{
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      flex: 0 0 auto;
    }
    .entry .kcal{
      font-weight: 860;
      font-size: 18px;
      letter-spacing: .2px;
    }

    .chart{
      height: 155px;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      align-items: end;
      padding-top: 6px;
    }
    .barwrap{
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      min-width: 0;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .barwrap:active{ transform: translateY(1px); opacity: .95; }

    .barvalue{
      font-size: 11px;
      color: rgba(255,255,255,0.86);
      line-height: 1;
      letter-spacing: .15px;
      text-align: center;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .bar{
      width: 100%;
      border-radius: 10px;
      background: rgba(255,121,183,0.18);
      border: 1px solid rgba(255,121,183,0.28);
      height: 10px;
      min-height: 10px;
      transition: height .2s ease, background .18s ease, border-color .18s ease, box-shadow .18s ease;
    }
    .bar.selected{
      background: rgba(202,168,255,0.22);
      border-color: rgba(202,168,255,0.38);
      box-shadow: 0 10px 24px rgba(202,168,255,0.12);
    }

    .barlabel{
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(14px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,0.72);
      border: 1px solid rgba(255,255,255,0.14);
      color: rgba(255,255,255,0.92);
      padding: 12px 14px;
      border-radius: 999px;
      font-size: 13px;
      z-index: 50;
      box-shadow: var(--shadow);
      max-width: min(92vw, 700px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }

    /* Modal */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.58);
      z-index: 30;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 14px;
      padding-top: calc(14px + env(safe-area-inset-top));
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
    }
    .modalOverlay.show{ display: flex; }

    .modal{
      width: min(900px, 100%);
      max-height: 86vh;
      background: rgba(18,10,24,0.92);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .modal .mhd{
      padding: 14px 14px 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .modal .mhd .mtitle{
      margin: 0;
      font-size: 15px;
      font-weight: 820;
      letter-spacing: .2px;
    }
    .modal .mhd .msub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .modal .mbd{
      padding: 14px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal .mft{
      padding: 12px 14px;
      border-top: 1px solid rgba(255,255,255,0.12);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    .formgrid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 820px){
      .formgrid{ grid-template-columns: 1fr 1fr; }
    }

    .field label{
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .items{
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }
    .itemrow{
      display: grid;
      grid-template-columns: 1.4fr .7fr auto;
      gap: 10px;
      align-items: center;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 10px;
    }
    .itemrow input{
      border-radius: 12px;
      padding: 10px 10px;
    }
    .itemrow button{
      min-height: 42px;
      padding: 10px 12px;
      border-radius: 12px;
    }

    .collapsible{
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      overflow: hidden;
      margin-top: 12px;
      background: rgba(255,255,255,0.03);
    }
    .collapsible summary{
      cursor: pointer;
      padding: 12px;
      font-size: 13px;
      font-weight: 750;
      color: rgba(255,255,255,0.88);
      list-style: none;
    }
    .collapsible summary::-webkit-details-marker{ display:none; }
    .collapsible .inner{
      padding: 0 12px 12px 12px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
    }

    .hidden{ display: none !important; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .footerActions{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
    }

    .dangerText{ color: rgba(255,210,228,0.98); }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="toprow">
        <div class="title">
          <h1 id="topTitle">Paste JSON</h1>
          <div class="sub" id="topSub">Fast calorie logging with local storage.</div>
        </div>
        <div class="btnrow">
          <button class="small ghost" id="btnGoAdd" type="button">Add</button>
          <button class="small ghost" id="btnGoView" type="button">Dashboard</button>
        </div>
      </div>

      <div class="pillrow">
        <div class="pill" title="Total calories logged today">
          <span class="dot"></span>
          <span>Today: <strong id="pillToday">0</strong> kcal</span>
        </div>
        <div class="pill" id="pillGoal" title="Goal status">
          <span class="dot" style="background: var(--good)"></span>
          <span>Goal: <strong id="pillGoalText">off</strong></span>
        </div>
        <div class="pill" title="Entries stored on this device">
          <span class="dot" style="background: var(--accent2)"></span>
          <span>Entries: <strong id="pillCount">0</strong></span>
        </div>
      </div>
    </div>

    <div class="content">
      <!-- ADD VIEW -->
      <section id="viewAdd" class="grid">
        <div class="card">
          <div class="hd">
            <div class="hgroup">
              <p class="h">Paste JSON from your GPT response</p>
              <p class="hint">On open, this screen is the default. Paste → Add. Cancel goes to the dashboard.</p>
            </div>
          </div>

          <div class="bd">
            <div class="split">
              <div>
                <textarea id="jsonInput" placeholder='Paste JSON here (one entry object, or {"entries":[...]}).'></textarea>

                <div class="help">
                  Tips: If calories look off, add first, then tap the entry on the dashboard to edit totals/items.
                </div>

                <div class="footerActions">
                  <div class="btnrow">
                    <button class="icon" id="btnPasteClipboard" type="button">Paste from clipboard</button>
                    <button class="primary" id="btnAddEntry" type="button">Add</button>
                    <button class="ghost" id="btnCancelToDashboard" type="button">Cancel</button>
                  </div>

                  <div class="btnrow">
                    <button class="small" id="btnClear" type="button">Clear</button>
                  </div>
                </div>

                <div class="sep"></div>

                <div id="addStatus" class="help"></div>
              </div>

              <div>
                <div class="kpi">
                  <div class="box">
                    <div class="label">Today total</div>
                    <div class="value"><span id="kpiToday">0</span> kcal</div>
                    <div class="mini" id="kpiTodayMini">No entries yet.</div>
                  </div>
                  <div class="box">
                    <div class="label">Goal remaining</div>
                    <div class="value" id="kpiRemain">—</div>
                    <div class="mini" id="kpiRemainMini">Goal is off.</div>
                  </div>
                </div>

                <div class="sep"></div>

                <div class="card" style="box-shadow:none; background:transparent; border:none;">
                  <div class="bd" style="padding:0;">
                    <div class="row" style="align-items:flex-end;">
                      <div style="min-width:0;">
                        <div style="font-size:13px; font-weight:780; margin-bottom:6px;">Goal</div>
                        <div class="toggle">
                          <div class="switch" id="goalSwitch" role="switch" aria-checked="false" tabindex="0">
                            <div class="knob"></div>
                          </div>
                          <div style="min-width: 180px; flex: 1;">
                            <input id="goalInput" type="number" inputmode="numeric" min="0" placeholder="Goal calories (e.g., 1800)" disabled />
                          </div>
                        </div>
                        <div class="help">Goal is optional. It affects “remaining” and the dashboard header only.</div>
                      </div>
                    </div>

                    <div class="sep"></div>

                    <div class="row">
                      <div style="min-width:0;">
                        <div style="font-size:13px; font-weight:780; margin-bottom:6px;">Data</div>
                        <div class="help">Stored locally on this device (no account). Use Export/Import from the dashboard.</div>
                      </div>
                    </div>

                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- DASHBOARD VIEW -->
      <section id="viewDash" class="grid hidden">
        <div class="card">
          <div class="hd">
            <div class="hgroup">
              <p class="h">Dashboard</p>
              <p class="hint">Tap any entry to edit. Tap a day bar to view that day’s entries.</p>
            </div>
            <div class="btnrow">
              <button class="small" id="btnExport" type="button">Export</button>
              <button class="small" id="btnImport" type="button">Import</button>
              <input id="importFile" type="file" accept="application/json" class="hidden" />
            </div>
          </div>

          <div class="bd">
            <div class="kpi">
              <div class="box">
                <div class="label">Today total</div>
                <div class="value"><span id="dashToday">0</span> kcal</div>
                <div class="mini" id="dashTodayMini">—</div>
              </div>
              <div class="box">
                <div class="label">Goal remaining</div>
                <div class="value" id="dashRemain">—</div>
                <div class="mini" id="dashRemainMini">—</div>
              </div>
            </div>

            <div class="sep"></div>

            <div class="row" style="align-items:center;">
              <div style="font-size:13px; font-weight:780;">Last 7 days</div>
              <div class="btnrow">
                <button class="small ghost" id="btnChartPrev" type="button" aria-label="Previous 7 days">‹</button>
                <button class="small" id="btnChartToday" type="button">Today</button>
                <button class="small ghost" id="btnChartNext" type="button" aria-label="Next 7 days">›</button>
              </div>
            </div>
            <div class="help" id="chartRangeHelp">—</div>

            <div class="chart" id="chart7"></div>

            <div class="sep"></div>

            <div class="row" style="align-items:flex-end;">
              <div style="min-width: 220px; flex: 1;">
                <div style="font-size:13px; font-weight:780; margin-bottom:6px;">Recent entries</div>
                <div class="help" id="recentHelp">—</div>
              </div>
              <div class="btnrow">
                <button class="small" id="btnSeeMore" type="button">See more</button>
                <button class="small danger" id="btnClearAll" type="button">Clear all</button>
              </div>
            </div>

            <div class="sep"></div>

            <div class="list" id="entryList"></div>

            <div class="help" style="margin-top: 14px;">
              Edit rules: “Total kcal” can be overridden directly, or you can adjust items and save.
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div class="modalOverlay" id="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="mhd">
        <div style="min-width:0;">
          <div class="mtitle" id="modalTitle">Edit entry</div>
          <div class="msub" id="modalSub">—</div>
        </div>
        <div class="btnrow">
          <button class="small ghost" id="btnCloseModal" type="button">Close</button>
        </div>
      </div>

      <div class="mbd">
        <div class="formgrid">
          <div class="field">
            <label for="editMealLabel">Meal label</label>
            <select id="editMealLabel">
              <option value="meal">meal</option>
              <option value="breakfast">breakfast</option>
              <option value="lunch">lunch</option>
              <option value="dinner">dinner</option>
              <option value="snack">snack</option>
            </select>
          </div>

          <div class="field">
            <label for="editCreatedAt">Time (local)</label>
            <input id="editCreatedAt" type="datetime-local" />
          </div>

          <div class="field">
            <label for="editTotal">Total kcal (override)</label>
            <input id="editTotal" type="number" inputmode="numeric" min="0" placeholder="Leave blank to compute from items" />
          </div>

          <div class="field">
            <label for="editConfidence">Confidence</label>
            <select id="editConfidence">
              <option value="high">high</option>
              <option value="medium">medium</option>
              <option value="low">low</option>
            </select>
          </div>

          <div class="field" style="grid-column: 1 / -1;">
            <label for="editFreeText">Original text / description</label>
            <input id="editFreeText" type="text" />
          </div>

          <div class="field" style="grid-column: 1 / -1;">
            <label>Items</label>
            <div class="items" id="itemsEditor"></div>
            <div class="btnrow" style="margin-top: 10px;">
              <button class="small" id="btnAddItem" type="button">Add item</button>
            </div>

            <details class="collapsible" id="assumptionsBlock">
              <summary>Show assumptions / notes</summary>
              <div class="inner" id="assumptionsText">—</div>
            </details>
          </div>

          <div class="field" style="grid-column: 1 / -1;">
            <label for="editNotes">Notes (optional)</label>
            <input id="editNotes" type="text" placeholder="Any notes you want to keep with this entry" />
          </div>
        </div>
      </div>

      <div class="mft">
        <button class="danger" id="btnDeleteEntry" type="button">Delete</button>
        <button class="primary" id="btnSaveEntry" type="button">Save</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /***********************
     * Storage + Utilities
     ***********************/
    const STORE_KEY = "calorieLogV1";
    const SETTINGS_KEY = "calorieSettingsV1";

    function safeParseJSON(text){
      try { return { ok: true, value: JSON.parse(text) }; }
      catch(e){ return { ok: false, error: e }; }
    }

    function uuid(){
      if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
        const r = Math.random()*16|0, v = c === "x" ? r : (r&0x3|0x8);
        return v.toString(16);
      });
    }

    function nowISO(){ return new Date().toISOString(); }

    function dateAtNoonLocal(d){
      const x = new Date(d);
      x.setHours(12,0,0,0);
      return x;
    }
    function addDaysLocal(d, delta){
      const x = dateAtNoonLocal(d);
      x.setDate(x.getDate() + delta);
      return dateAtNoonLocal(x);
    }
    function dateFromYMD(ymd){
      const [y,m,day] = String(ymd).split("-").map(n => parseInt(n,10));
      const d = new Date(y, (m||1)-1, day||1, 12, 0, 0, 0);
      return dateAtNoonLocal(d);
    }
    function ymdFromDateLocal(d){
      const x = new Date(d);
      const y = x.getFullYear();
      const m = String(x.getMonth()+1).padStart(2,"0");
      const day = String(x.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function toLocalDatetimeInputValue(isoString){
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return "";
      const pad = (n)=> String(n).padStart(2,"0");
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth()+1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }

    function fromLocalDatetimeInputValue(v){
      const d = new Date(v);
      if (isNaN(d.getTime())) return null;
      return d.toISOString();
    }

    function formatTimeShort(isoString){
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return "—";
      return d.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
    }

    function formatDateShort(isoString){
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return "—";
      return d.toLocaleDateString([], { weekday: "short", month: "short", day: "numeric" });
    }

    function formatDateRange(startDate, endDate){
      const s = startDate.toLocaleDateString([], { month:"short", day:"numeric" });
      const e = endDate.toLocaleDateString([], { month:"short", day:"numeric" });
      return `${s}–${e}`;
    }

    function ymdLocal(isoString){
      const d = new Date(isoString);
      if (isNaN(d.getTime())) return null;
      return ymdFromDateLocal(d);
    }

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function toast(msg){
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._timer);
      toast._timer = setTimeout(() => t.classList.remove("show"), 1600);
    }

    function loadState(){
      let entries = [];
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if (raw) entries = JSON.parse(raw) || [];
      }catch(e){ entries = []; }

      let settings = { goalEnabled: false, goalKcal: null };
      try{
        const rawS = localStorage.getItem(SETTINGS_KEY);
        if (rawS) settings = Object.assign(settings, JSON.parse(rawS) || {});
      }catch(e){}

      if (!Array.isArray(entries)) entries = [];
      return { entries, settings };
    }

    function saveEntries(entries){
      localStorage.setItem(STORE_KEY, JSON.stringify(entries));
    }
    function saveSettings(settings){
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    }

    function normalizeEntry(obj){
      const e = Object.assign({}, obj);

      if (!e.schema_version) e.schema_version = 1;
      if (!e.entry_id) e.entry_id = uuid();
      if (!e.created_at) e.created_at = nowISO();
      if (!e.meal_label) e.meal_label = "meal";
      if (!e.free_text) e.free_text = e.description || e.text || "";
      if (!Array.isArray(e.items)) e.items = [];
      if (!e.confidence) e.confidence = "medium";

      const numeric = (v)=> (typeof v === "number" && isFinite(v)) ? v : (typeof v === "string" && v.trim() !== "" && isFinite(Number(v)) ? Number(v) : null);
      let total = numeric(e.total_kcal);
      if (total == null){
        let sum = 0;
        for (const it of e.items){
          const kcal = numeric(it.kcal);
          if (kcal != null) sum += kcal;
        }
        total = sum;
      }
      e.total_kcal = Math.max(0, Math.round(total));

      if (Array.isArray(e.kcal_range) && e.kcal_range.length === 2){
        const a = numeric(e.kcal_range[0]);
        const b = numeric(e.kcal_range[1]);
        if (a != null && b != null) e.kcal_range = [Math.round(a), Math.round(b)];
        else e.kcal_range = null;
      } else {
        e.kcal_range = null;
      }

      if (!e.user_overrides) e.user_overrides = { total_kcal: null, items: {} };
      if (e.user_overrides && typeof e.user_overrides !== "object") e.user_overrides = { total_kcal: null, items: {} };

      if (typeof e.notes !== "string") e.notes = "";

      e.items = e.items.map(it => {
        const item = Object.assign({}, it);
        if (!item.id) item.id = uuid();
        if (!item.name) item.name = item.food || "Item";
        const kcal = numeric(item.kcal);
        item.kcal = kcal == null ? 0 : Math.max(0, Math.round(kcal));
        if (!item.quantity) item.quantity = 1;
        if (!item.unit) item.unit = "";
        if (!Array.isArray(item.assumptions)) item.assumptions = [];
        return item;
      });

      return e;
    }

    function todayTotals(entries){
      const today = ymdLocal(nowISO());
      let total = 0;
      let count = 0;
      for (const e of entries){
        const d = ymdLocal(e.created_at);
        if (d === today){
          total += Number(e.total_kcal || 0);
          count++;
        }
      }
      return { total, count };
    }

    function totalsForDaysWindow(entries, endDateLocalNoon, n=7){
      const out = [];
      const base = dateAtNoonLocal(endDateLocalNoon);

      for (let i = n-1; i >= 0; i--){
        const d = addDaysLocal(base, -i);
        const ymd = ymdFromDateLocal(d);
        const label = d.toLocaleDateString([], { weekday: "short" });

        let total = 0;
        for (const e of entries){
          if (ymdLocal(e.created_at) === ymd) total += Number(e.total_kcal || 0);
        }
        out.push({ ymd, label, total, date: d });
      }
      return out; // oldest -> newest
    }

    function entriesForDay(entries, ymd){
      return entries.filter(e => ymdLocal(e.created_at) === ymd);
    }

    /***********************
     * Routing
     ***********************/
    function showView(which){
      const add = document.getElementById("viewAdd");
      const dash = document.getElementById("viewDash");
      if (which === "add"){
        add.classList.remove("hidden");
        dash.classList.add("hidden");
        document.getElementById("topTitle").textContent = "Paste JSON";
        document.getElementById("topSub").textContent = "Paste → Add. Cancel goes to dashboard.";
        setTimeout(()=> document.getElementById("jsonInput").focus({ preventScroll: true }), 60);
      } else {
        dash.classList.remove("hidden");
        add.classList.add("hidden");
        document.getElementById("topTitle").textContent = "Dashboard";
        document.getElementById("topSub").textContent = "Tap a bar to view that day. See more loads prior days.";
      }
    }

    function routeFromHash(){
      const h = (location.hash || "").toLowerCase();
      if (h === "#view" || h === "#dash" || h === "#dashboard") showView("dash");
      else showView("add");
    }

    /***********************
     * Modal (safe scroll)
     ***********************/
    let _scrollY = 0;
    function lockBody(){
      _scrollY = window.scrollY || 0;
      document.body.classList.add("locked");
      document.body.style.top = `-${_scrollY}px`;
    }
    function unlockBody(){
      document.body.classList.remove("locked");
      const top = document.body.style.top;
      document.body.style.top = "";
      const y = top ? Math.abs(parseInt(top, 10)) : _scrollY;
      window.scrollTo(0, y || 0);
    }

    /***********************
     * App State
     ***********************/
    let state = loadState();
    let editingEntryId = null;

    // Dashboard view controls
    let chartEndDate = dateAtNoonLocal(new Date()); // end of the 7-day window
    let selectedDayYMD = null;                      // selected bar day (for highlight + list anchor)
    let recentAnchorYMD = ymdFromDateLocal(new Date());
    let recentDaysShown = 1;                        // 1 => anchor only; "See more" adds prior days

    function refreshHeaderPills(){
      const { total } = todayTotals(state.entries);
      document.getElementById("pillToday").textContent = total;
      document.getElementById("pillCount").textContent = state.entries.length;

      const goalText = state.settings.goalEnabled && state.settings.goalKcal ? String(state.settings.goalKcal) : "off";
      document.getElementById("pillGoalText").textContent = goalText;
    }

    function computeRemaining(){
      const { total } = todayTotals(state.entries);
      const goal = state.settings.goalEnabled ? Number(state.settings.goalKcal || 0) : 0;
      if (!state.settings.goalEnabled || !goal) return null;
      return goal - total;
    }

    function refreshAddKPIs(){
      const t = todayTotals(state.entries);
      document.getElementById("kpiToday").textContent = t.total;
      document.getElementById("kpiTodayMini").textContent = t.count ? `${t.count} entr${t.count===1?"y":"ies"} today.` : "No entries yet.";

      const rem = computeRemaining();
      if (rem == null){
        document.getElementById("kpiRemain").textContent = "—";
        document.getElementById("kpiRemainMini").textContent = "Goal is off.";
      } else {
        document.getElementById("kpiRemain").textContent = `${rem} kcal`;
        document.getElementById("kpiRemainMini").textContent = rem >= 0 ? "Remaining today." : "Over goal today.";
      }
    }

    function applyGoalUI(){
      const sw = document.getElementById("goalSwitch");
      const inp = document.getElementById("goalInput");
      const enabled = !!state.settings.goalEnabled;
      sw.classList.toggle("on", enabled);
      sw.setAttribute("aria-checked", String(enabled));
      inp.disabled = !enabled;
      inp.value = state.settings.goalKcal ? String(state.settings.goalKcal) : "";
      refreshAddKPIs();
      refreshDash();
      refreshHeaderPills();
    }

    function buildRecentWindowYMDs(){
      const anchorDate = dateFromYMD(recentAnchorYMD);
      const ymds = [];
      for (let i = 0; i < recentDaysShown; i++){
        const d = addDaysLocal(anchorDate, -i);
        ymds.push(ymdFromDateLocal(d));
      }
      return ymds; // newest->oldest
    }

    function refreshDash(){
      const t = todayTotals(state.entries);
      document.getElementById("dashToday").textContent = t.total;
      document.getElementById("dashTodayMini").textContent = t.count ? `${t.count} entr${t.count===1?"y":"ies"} today.` : "No entries today.";

      const rem = computeRemaining();
      if (rem == null){
        document.getElementById("dashRemain").textContent = "—";
        document.getElementById("dashRemainMini").textContent = "Goal is off.";
      } else {
        document.getElementById("dashRemain").textContent = `${rem} kcal`;
        document.getElementById("dashRemainMini").textContent = rem >= 0 ? "Remaining today." : "Over goal today.";
      }

      // CHART (7-day window with navigation)
      const days = totalsForDaysWindow(state.entries, chartEndDate, 7);
      const chartStart = days[0]?.date ? dateAtNoonLocal(days[0].date) : addDaysLocal(chartEndDate, -6);
      const chartHelp = document.getElementById("chartRangeHelp");
      chartHelp.textContent = `${formatDateRange(chartStart, chartEndDate)} • Tap a day to view entries`;

      const max = Math.max(1, ...days.map(d => d.total));
      const chart = document.getElementById("chart7");
      chart.innerHTML = "";

      for (const d of days){
        const wrap = document.createElement("div");
        wrap.className = "barwrap";
        wrap.tabIndex = 0;
        wrap.setAttribute("role","button");
        wrap.setAttribute("aria-label", `${d.ymd}: ${d.total} calories`);

        const val = document.createElement("div");
        val.className = "barvalue";
        val.textContent = String(d.total);

        const bar = document.createElement("div");
        bar.className = "bar";

        const h = clamp(Math.round((d.total / max) * 110), 10, 110);
        bar.style.height = `${h}px`;
        bar.title = `${d.ymd}: ${d.total} kcal`;

        if (selectedDayYMD && d.ymd === selectedDayYMD){
          bar.classList.add("selected");
        } else if (!selectedDayYMD && d.ymd === ymdFromDateLocal(new Date())){
          // subtle highlight for today when nothing selected
          bar.classList.add("selected");
        }

        const lab = document.createElement("div");
        lab.className = "barlabel";
        lab.textContent = d.label;

        const selectThisDay = () => {
          selectedDayYMD = d.ymd;
          recentAnchorYMD = d.ymd;
          recentDaysShown = 1;
          refreshDash();
          toast(`Showing ${d.label}`);
        };

        wrap.addEventListener("click", selectThisDay);
        wrap.addEventListener("keydown", (ev) => {
          if (ev.key === "Enter" || ev.key === " "){
            ev.preventDefault();
            selectThisDay();
          }
        });

        wrap.appendChild(val);
        wrap.appendChild(bar);
        wrap.appendChild(lab);
        chart.appendChild(wrap);
      }

      // RECENT ENTRIES (today only by default; "See more" adds prior days; tapping chart sets anchor day)
      const list = document.getElementById("entryList");
      list.innerHTML = "";

      const windowYMDs = buildRecentWindowYMDs(); // newest->oldest
      const windowSet = new Set(windowYMDs);

      const entriesInWindow = [...state.entries]
        .filter(e => windowSet.has(ymdLocal(e.created_at)))
        .sort((a,b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());

      const todayYMD = ymdFromDateLocal(new Date());
      const isTodayAnchor = (recentAnchorYMD === todayYMD);

      if (recentDaysShown === 1){
        document.getElementById("recentHelp").textContent =
          isTodayAnchor ? "Showing today only. Tap “See more” to include yesterday. Tap a bar to view a specific day."
                        : `Showing ${formatDateShort(dateFromYMD(recentAnchorYMD).toISOString())} only. Tap “See more” to include the prior day.`;
      } else {
        const start = dateFromYMD(windowYMDs[windowYMDs.length - 1]);
        const end = dateFromYMD(windowYMDs[0]);
        document.getElementById("recentHelp").textContent =
          `Showing ${formatDateRange(start, end)} (most recent first). Tap a bar to jump to a specific day.`;
      }

      // Group by day (newest->oldest)
      const grouped = new Map();
      for (const ymd of windowYMDs){
        grouped.set(ymd, []);
      }
      for (const e of entriesInWindow){
        const y = ymdLocal(e.created_at);
        if (grouped.has(y)) grouped.get(y).push(e);
      }

      let anyRendered = false;
      for (const ymd of windowYMDs){
        const d = dateFromYMD(ymd);
        const label = d.toLocaleDateString([], { weekday:"long", month:"short", day:"numeric" });
        const dayEntries = grouped.get(ymd) || [];
        const dayTotal = dayEntries.reduce((s, e) => s + Number(e.total_kcal || 0), 0);

        const hdr = document.createElement("div");
        hdr.className = "dayHeader";
        hdr.innerHTML = `<span>${escapeHTML(label)}</span><span class="sub">${dayEntries.length ? `${dayTotal} kcal` : "No entries"}</span>`;
        list.appendChild(hdr);

        if (!dayEntries.length) continue;
        anyRendered = true;

        for (const e of dayEntries){
          const div = document.createElement("div");
          div.className = "entry";
          div.tabIndex = 0;
          div.role = "button";

          const left = document.createElement("div");
          left.className = "left";

          const top = document.createElement("div");
          top.className = "top";

          // Confidence tag removed here (still editable in modal)
          const b2 = document.createElement("span");
          b2.className = "badge";
          b2.textContent = e.meal_label || "meal";
          top.appendChild(b2);

          const name = document.createElement("div");
          name.className = "name";
          name.textContent = (e.free_text && e.free_text.trim()) ? e.free_text.trim() : "Entry";

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = `${formatTimeShort(e.created_at)} • ${e.items?.length || 0} item(s)`;

          left.appendChild(top);
          left.appendChild(name);
          left.appendChild(meta);

          const right = document.createElement("div");
          right.className = "right";

          const kcal = document.createElement("div");
          kcal.className = "kcal";
          kcal.textContent = `${Number(e.total_kcal || 0)} kcal`;

          let rangeText = "";
          if (Array.isArray(e.kcal_range) && e.kcal_range.length === 2){
            rangeText = `${e.kcal_range[0]}–${e.kcal_range[1]}`;
          }
          const mini = document.createElement("div");
          mini.className = "meta";
          mini.textContent = rangeText ? `range ${rangeText}` : "";

          right.appendChild(kcal);
          if (rangeText) right.appendChild(mini);

          div.appendChild(left);
          div.appendChild(right);

          div.addEventListener("click", () => openEditModal(e.entry_id));
          div.addEventListener("keydown", (ev) => {
            if (ev.key === "Enter" || ev.key === " "){
              ev.preventDefault();
              openEditModal(e.entry_id);
            }
          });

          list.appendChild(div);
        }
      }

      if (!anyRendered && state.entries.length){
        // If window exists but has no entries (e.g., selected future day), keep headers and add a hint
        const hint = document.createElement("div");
        hint.className = "help";
        hint.textContent = "No entries in this range.";
        list.appendChild(hint);
      } else if (!state.entries.length){
        const hint = document.createElement("div");
        hint.className = "help";
        hint.textContent = "No entries saved yet.";
        list.appendChild(hint);
      }

      refreshHeaderPills();
    }

    /***********************
     * Add Flow
     ***********************/
    function addParsedObject(obj){
      let toAdd = [];
      if (obj && typeof obj === "object" && Array.isArray(obj.entries)){
        toAdd = obj.entries;
      } else {
        toAdd = [obj];
      }

      const normalized = [];
      for (const raw of toAdd){
        if (!raw || typeof raw !== "object") continue;
        normalized.push(normalizeEntry(raw));
      }
      if (!normalized.length) return { ok: false, msg: "No valid entry objects found in JSON." };

      const existingIds = new Set(state.entries.map(e => e.entry_id));
      let added = 0;
      for (const e of normalized){
        if (existingIds.has(e.entry_id)) e.entry_id = uuid();
        state.entries.push(e);
        added++;
      }

      saveEntries(state.entries);
      return { ok: true, added };
    }

    async function pasteFromClipboard(){
      const area = document.getElementById("jsonInput");
      try{
        if (!navigator.clipboard || !navigator.clipboard.readText){
          toast("Clipboard not available here.");
          return;
        }
        const text = await navigator.clipboard.readText();
        if (!text || !text.trim()){
          toast("Clipboard is empty.");
          return;
        }
        area.value = text;
        toast("Pasted.");
        area.focus({ preventScroll: false });
      }catch(e){
        toast("Clipboard paste blocked. Tap and paste manually.");
      }
    }

    function handleAdd(){
      const area = document.getElementById("jsonInput");
      const status = document.getElementById("addStatus");
      status.textContent = "";
      const txt = area.value.trim();
      if (!txt){
        status.textContent = "Paste JSON first.";
        toast("Paste JSON first.");
        return;
      }

      const parsed = safeParseJSON(txt);
      if (!parsed.ok){
        status.innerHTML = `<span class="dangerText">Invalid JSON.</span> Check quotes/commas and try again.`;
        toast("Invalid JSON.");
        return;
      }

      const res = addParsedObject(parsed.value);
      if (!res.ok){
        status.innerHTML = `<span class="dangerText">${escapeHTML(res.msg)}</span>`;
        toast("Nothing added.");
        return;
      }

      status.textContent = `Added ${res.added} entr${res.added===1?"y":"ies"}.`;
      toast(`Added ${res.added}.`);
      area.value = "";

      // If user is viewing a specific past day, keep it; otherwise keep "today-only" window anchored to today
      if (!selectedDayYMD){
        recentAnchorYMD = ymdFromDateLocal(new Date());
        recentDaysShown = 1;
      }

      refreshAddKPIs();
      refreshDash();
    }

    /***********************
     * Edit Modal
     ***********************/
    function openEditModal(entryId){
      const e = state.entries.find(x => x.entry_id === entryId);
      if (!e) return;

      editingEntryId = entryId;

      document.getElementById("modalSub").textContent =
        `${formatDateShort(e.created_at)} • ${formatTimeShort(e.created_at)} • ID ${entryId.slice(0,8)}…`;

      document.getElementById("editMealLabel").value = (e.meal_label || "meal");
      document.getElementById("editCreatedAt").value = toLocalDatetimeInputValue(e.created_at);
      document.getElementById("editConfidence").value = (e.confidence || "medium");
      document.getElementById("editFreeText").value = (e.free_text || "");
      document.getElementById("editNotes").value = (e.notes || "");

      const override = e.user_overrides && typeof e.user_overrides.total_kcal === "number" ? e.user_overrides.total_kcal : null;
      document.getElementById("editTotal").value = (override == null) ? "" : String(override);

      renderItemsEditor(e.items || []);

      const lines = [];
      if (Array.isArray(e.items)){
        for (const it of e.items){
          if (Array.isArray(it.assumptions) && it.assumptions.length){
            lines.push(`${it.name}: ${it.assumptions.join("; ")}`);
          }
        }
      }
      if (e.kcal_range) lines.push(`kcal_range: ${e.kcal_range[0]}–${e.kcal_range[1]}`);
      document.getElementById("assumptionsText").textContent = lines.length ? lines.join("\n") : "No assumptions listed.";
      document.getElementById("assumptionsBlock").open = false;

      const overlay = document.getElementById("modalOverlay");
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden","false");
      lockBody();
    }

    function closeEditModal(){
      editingEntryId = null;
      const overlay = document.getElementById("modalOverlay");
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
      unlockBody();
    }

    function renderItemsEditor(items){
      const box = document.getElementById("itemsEditor");
      box.innerHTML = "";

      if (!Array.isArray(items) || !items.length){
        const empty = document.createElement("div");
        empty.className = "help";
        empty.textContent = "No items. Add one below if you want item-level tracking.";
        box.appendChild(empty);
        return;
      }

      for (const it of items){
        const row = document.createElement("div");
        row.className = "itemrow";
        row.dataset.itemId = it.id;

        const name = document.createElement("input");
        name.type = "text";
        name.value = it.name || "";
        name.placeholder = "Item name";

        const kcal = document.createElement("input");
        kcal.type = "number";
        kcal.min = "0";
        kcal.inputMode = "numeric";
        kcal.value = String(Number(it.kcal || 0));
        kcal.placeholder = "kcal";

        const del = document.createElement("button");
        del.className = "danger";
        del.type = "button";
        del.textContent = "Remove";
        del.addEventListener("click", () => row.remove());

        row.appendChild(name);
        row.appendChild(kcal);
        row.appendChild(del);
        box.appendChild(row);
      }
    }

    function gatherItemsFromEditor(){
      const rows = Array.from(document.querySelectorAll("#itemsEditor .itemrow"));
      const out = [];
      for (const r of rows){
        const inputs = r.querySelectorAll("input");
        if (!inputs || inputs.length < 2) continue;
        const nm = (inputs[0].value || "").trim();
        const kcal = Number(inputs[1].value || 0);
        if (!nm && !kcal) continue;
        out.push({
          id: r.dataset.itemId || uuid(),
          name: nm || "Item",
          kcal: Math.max(0, Math.round(kcal)),
          assumptions: []
        });
      }
      return out;
    }

    function saveEditedEntry(){
      const e = state.entries.find(x => x.entry_id === editingEntryId);
      if (!e) return;

      const mealLabel = document.getElementById("editMealLabel").value;
      const dtLocal = document.getElementById("editCreatedAt").value;
      const iso = dtLocal ? fromLocalDatetimeInputValue(dtLocal) : null;

      e.meal_label = mealLabel || "meal";
      if (iso) e.created_at = iso;

      e.confidence = document.getElementById("editConfidence").value || "medium";
      e.free_text = document.getElementById("editFreeText").value || "";
      e.notes = document.getElementById("editNotes").value || "";

      e.items = gatherItemsFromEditor();

      const totalField = document.getElementById("editTotal").value.trim();
      const override = (totalField === "") ? null : Number(totalField);
      if (!e.user_overrides || typeof e.user_overrides !== "object") e.user_overrides = { total_kcal: null, items: {} };
      if (override == null || !isFinite(override)){
        e.user_overrides.total_kcal = null;
      } else {
        e.user_overrides.total_kcal = Math.max(0, Math.round(override));
      }

      if (typeof e.user_overrides.total_kcal === "number"){
        e.total_kcal = e.user_overrides.total_kcal;
      } else {
        let sum = 0;
        for (const it of e.items) sum += Number(it.kcal || 0);
        e.total_kcal = Math.max(0, Math.round(sum));
      }

      saveEntries(state.entries);
      refreshDash();
      refreshAddKPIs();
      toast("Saved.");
      closeEditModal();
    }

    function deleteEditedEntry(){
      if (!editingEntryId) return;
      const idx = state.entries.findIndex(x => x.entry_id === editingEntryId);
      if (idx < 0) return;
      state.entries.splice(idx, 1);
      saveEntries(state.entries);
      refreshDash();
      refreshAddKPIs();
      toast("Deleted.");
      closeEditModal();
    }

    /***********************
     * Export / Import
     ***********************/
    function exportData(){
      const payload = {
        exported_at: nowISO(),
        schema_version: 1,
        settings: state.settings,
        entries: state.entries
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `calorie-log-${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Exported.");
    }

    function importDataFromFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        const txt = String(reader.result || "");
        const parsed = safeParseJSON(txt);
        if (!parsed.ok){
          toast("Invalid import JSON.");
          return;
        }
        const obj = parsed.value;
        if (!obj || typeof obj !== "object" || !Array.isArray(obj.entries)){
          toast("Import file missing entries[].");
          return;
        }

        const existing = new Set(state.entries.map(e => e.entry_id));
        let added = 0;
        for (const raw of obj.entries){
          const e = normalizeEntry(raw);
          if (existing.has(e.entry_id)) e.entry_id = uuid();
          state.entries.push(e);
          added++;
        }

        if (obj.settings && typeof obj.settings === "object"){
          if (typeof obj.settings.goalEnabled === "boolean") state.settings.goalEnabled = obj.settings.goalEnabled;
          if (obj.settings.goalKcal != null && isFinite(Number(obj.settings.goalKcal))) state.settings.goalKcal = Math.round(Number(obj.settings.goalKcal));
        }

        saveEntries(state.entries);
        saveSettings(state.settings);

        // Reset to today view on import (predictable)
        chartEndDate = dateAtNoonLocal(new Date());
        selectedDayYMD = null;
        recentAnchorYMD = ymdFromDateLocal(new Date());
        recentDaysShown = 1;

        applyGoalUI();
        refreshDash();
        refreshAddKPIs();
        toast(`Imported ${added}.`);
      };
      reader.readAsText(file);
    }

    /***********************
     * Safety helpers
     ***********************/
    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, ch => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[ch]));
    }

    /***********************
     * Wire up UI
     ***********************/
    document.getElementById("btnGoAdd").addEventListener("click", () => {
      location.hash = "#add";
      routeFromHash();
    });
    document.getElementById("btnGoView").addEventListener("click", () => {
      location.hash = "#view";
      routeFromHash();
      refreshDash();
    });

    document.getElementById("btnCancelToDashboard").addEventListener("click", () => {
      location.hash = "#view";
      routeFromHash();
      refreshDash();
    });

    document.getElementById("btnPasteClipboard").addEventListener("click", pasteFromClipboard);
    document.getElementById("btnAddEntry").addEventListener("click", handleAdd);
    document.getElementById("btnClear").addEventListener("click", () => {
      document.getElementById("jsonInput").value = "";
      document.getElementById("addStatus").textContent = "";
      toast("Cleared.");
      document.getElementById("jsonInput").focus({ preventScroll: true });
    });

    // Goal toggle
    function toggleGoal(){
      state.settings.goalEnabled = !state.settings.goalEnabled;
      if (state.settings.goalEnabled && (!state.settings.goalKcal || !isFinite(Number(state.settings.goalKcal)))){
        state.settings.goalKcal = 1800;
      }
      saveSettings(state.settings);
      applyGoalUI();
      toast(state.settings.goalEnabled ? "Goal on." : "Goal off.");
    }

    const goalSwitch = document.getElementById("goalSwitch");
    goalSwitch.addEventListener("click", toggleGoal);
    goalSwitch.addEventListener("keydown", (ev) => {
      if (ev.key === "Enter" || ev.key === " "){
        ev.preventDefault();
        toggleGoal();
      }
    });

    document.getElementById("goalInput").addEventListener("input", (ev) => {
      const v = Number(ev.target.value || 0);
      if (!isFinite(v) || v <= 0){
        state.settings.goalKcal = null;
      } else {
        state.settings.goalKcal = Math.round(v);
      }
      saveSettings(state.settings);
      refreshHeaderPills();
      refreshAddKPIs();
      refreshDash();
    });

    // Dashboard buttons
    document.getElementById("btnExport").addEventListener("click", exportData);
    document.getElementById("btnImport").addEventListener("click", () => {
      document.getElementById("importFile").click();
    });
    document.getElementById("importFile").addEventListener("change", (ev) => {
      const f = ev.target.files && ev.target.files[0];
      if (!f) return;
      importDataFromFile(f);
      ev.target.value = "";
    });

    document.getElementById("btnClearAll").addEventListener("click", () => {
      const ok = confirm("Clear all entries from this device? This cannot be undone.");
      if (!ok) return;
      state.entries = [];
      saveEntries(state.entries);

      // Reset to today view
      chartEndDate = dateAtNoonLocal(new Date());
      selectedDayYMD = null;
      recentAnchorYMD = ymdFromDateLocal(new Date());
      recentDaysShown = 1;

      refreshDash();
      refreshAddKPIs();
      toast("Cleared all.");
    });

    // See more (adds one prior calendar day)
    document.getElementById("btnSeeMore").addEventListener("click", () => {
      recentDaysShown = clamp(recentDaysShown + 1, 1, 60);
      refreshDash();
    });

    // Chart navigation
    document.getElementById("btnChartPrev").addEventListener("click", () => {
      chartEndDate = addDaysLocal(chartEndDate, -7);
      refreshDash();
    });
    document.getElementById("btnChartNext").addEventListener("click", () => {
      chartEndDate = addDaysLocal(chartEndDate, +7);
      refreshDash();
    });
    document.getElementById("btnChartToday").addEventListener("click", () => {
      chartEndDate = dateAtNoonLocal(new Date());
      selectedDayYMD = null;
      recentAnchorYMD = ymdFromDateLocal(new Date());
      recentDaysShown = 1;
      refreshDash();
      toast("Today view");
    });

    // Modal controls
    document.getElementById("btnCloseModal").addEventListener("click", closeEditModal);
    document.getElementById("modalOverlay").addEventListener("click", (ev) => {
      if (ev.target.id === "modalOverlay") closeEditModal();
    });
    document.getElementById("btnSaveEntry").addEventListener("click", saveEditedEntry);
    document.getElementById("btnDeleteEntry").addEventListener("click", () => {
      const ok = confirm("Delete this entry?");
      if (!ok) return;
      deleteEditedEntry();
    });

    document.getElementById("btnAddItem").addEventListener("click", () => {
      const box = document.getElementById("itemsEditor");
      const helper = box.querySelector(".help");
      if (helper) helper.remove();

      const row = document.createElement("div");
      row.className = "itemrow";
      row.dataset.itemId = uuid();

      const name = document.createElement("input");
      name.type = "text";
      name.placeholder = "Item name";

      const kcal = document.createElement("input");
      kcal.type = "number";
      kcal.min = "0";
      kcal.inputMode = "numeric";
      kcal.placeholder = "kcal";
      kcal.value = "0";

      const del = document.createElement("button");
      del.className = "danger";
      del.type = "button";
      del.textContent = "Remove";
      del.addEventListener("click", () => row.remove());

      row.appendChild(name);
      row.appendChild(kcal);
      row.appendChild(del);
      box.appendChild(row);

      name.focus({ preventScroll: false });
    });

    // Hash routing
    window.addEventListener("hashchange", routeFromHash);

    // Init
    (function init(){
      if (!location.hash) location.hash = "#add";
      routeFromHash();

      applyGoalUI();

      refreshHeaderPills();
      refreshAddKPIs();

      // Always start dashboard list in "today only" mode unless user already picked a day in this session
      chartEndDate = dateAtNoonLocal(new Date());
      selectedDayYMD = null;
      recentAnchorYMD = ymdFromDateLocal(new Date());
      recentDaysShown = 1;

      refreshDash();
      if ((location.hash||"").toLowerCase().includes("view")) refreshDash();
    })();
  </script>
</body>
</html>
