<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Core Study Organizer</title>
  <style>
    :root {
      --bg: #0d1117;
      --panel: #161b22;
      --card: #1f2630;
      --border: #30363d;
      --text: #c9d1d9;
      --muted: #8b949e;
      --accent: #58a6ff;
      --accent-hover: #79c0ff;
      --success: #3fb950;
      --danger: #f85149;
      --warning: #d29922;
      --radius: 8px;
      --shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
      display: flex;
      justify-content: center;
    }
    .page {
      width: min(1000px, 100%);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* -- Header & Plan Manager -- */
    header {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }
    header h1 { margin: 0 0 8px; font-size: 1.5rem; color: var(--accent); }
    header p { margin: 0; color: var(--muted); font-size: 0.9rem; }

    .plan-manager {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .plan-manager select { flex: 1; min-width: 200px; }

    /* -- General UI -- */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
    }
    #day-card {
      scroll-margin-top: 12px;
    }
    .setup-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
      cursor: pointer;
    }
    .setup-title { font-weight: 700; }
    .setup-sub { color: var(--muted); font-size: 0.85rem; }
    .setup-content.collapsed { display: none; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    label { display: block; font-weight: 500; margin-bottom: 6px; font-size: 0.85rem; color: var(--muted); }
    select, input[type="date"] {
      width: 100%;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #0d1117;
      color: var(--text);
      font-size: 0.95rem;
      outline: none;
    }
    select:focus, input:focus { border-color: var(--accent); }
    button {
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
      background: var(--accent);
      color: #0d1117;
    }
    button:hover:not(:disabled) { background: var(--accent-hover); transform: translateY(-1px); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    button.secondary { background: #21262d; color: var(--accent); border: 1px solid var(--border); }
    button.secondary:hover:not(:disabled) { background: #30363d; }
    button.danger { background: rgba(248, 81, 73, 0.1); color: var(--danger); border: 1px solid rgba(248, 81, 73, 0.4); }
    
    .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 16px; }
    .msg { margin-top: 10px; font-size: 0.9rem; min-height: 1.4em; }
    .msg.error { color: var(--danger); }
    .msg.info { color: var(--accent); }

    /* -- Real Calendar Styles -- */
    .calendar-container {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .month-block { margin-bottom: 24px; }
    .month-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 10px; color: var(--text); }
    
    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    .cal-header {
      text-align: center;
      font-size: 0.8rem;
      color: var(--muted);
      padding-bottom: 4px;
      font-weight: bold;
    }
    .cal-day {
      aspect-ratio: 1;
      border-radius: 4px;
      background: #21262d; /* Default empty */
      border: 1px solid var(--border);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.8);
      position: relative;
      transition: transform 0.1s;
      overflow: hidden; /* Keeps the sliver inside rounded corners */
    }
    .cal-day:not(.empty):hover { transform: scale(1.1); z-index: 20; border-color: white; }
    .cal-day.active { border: 2px solid white; z-index: 10; }
    .cal-day.empty { background: transparent; border: none; cursor: default; }

    /* The new Bottom Sliver for Relative Load */
    .load-sliver {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 5px;
      z-index: 5;
      pointer-events: none;
    }

    /* -- Day Detail View -- */
    .day-header {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .day-nav { display: flex; gap: 8px; align-items: center; }
    .day-actions { display: flex; align-items: center; gap: 12px; }

    .char-count-badge {
      font-size: 0.85rem;
      color: var(--muted);
      background: rgba(255,255,255,0.05);
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      white-space: nowrap;
    }
    
    .section-item {
      background: #161b22;
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 16px;
      overflow: hidden;
    }
    .section-header {
      padding: 12px;
      background: #21262d;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .section-top {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .section-title { font-weight: 600; font-size: 0.95rem; }
    .section-meta {
      font-size: 0.8rem;
      color: var(--muted);
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      padding: 4px 8px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .section-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }
    .section-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
    }
    .section-actions .split-btn {
      background: #21262d;
      color: #c084fc;
      border: 1px solid var(--border);
      padding: 8px 12px;
      font-size: 0.85rem;
    }
    .section-actions .split-btn:hover:not(:disabled) {
      background: #30363d;
      color: #d8b4fe;
    }

    .checklist-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      background: rgba(0,0,0,0.2);
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    .chk-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      user-select: none;
    }
    .chk-label input { width: 16px; height: 16px; accent-color: var(--success); cursor: pointer; }

    .section-content { padding: 12px; overflow-x: auto; }
    pre {
      margin: 0;
      white-space: pre-wrap;
      font-family: inherit;
      font-size: 0.95rem;
      line-height: 1.6;
      color: #e6edf3;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .loading-text { color: var(--accent); font-style: italic; padding: 20px; text-align: center; }
    .summary-pills { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 12px; }
    .pill {
      background: rgba(88,166,255,0.1);
      border: 1px solid rgba(88,166,255,0.2);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      color: var(--accent-hover);
    }

    .hidden { display: none !important; }
    
    /* Legend for split calendar */
    .cal-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 10px;
      font-size: 0.8rem;
      color: var(--muted);
      justify-content: center;
    }
    .legend-item { display: flex; align-items: center; gap: 5px; }
    .legend-box { width: 12px; height: 12px; border: 1px solid var(--border); border-radius: 2px; }
  </style>
</head>
<body>

<div class="page">
  <!-- Top Bar -->
  <header>
    <h1>Core Study Organizer</h1>

    <div class="plan-manager">
      <select id="saved-plans-select">
        <option value="">-- Load a saved plan --</option>
      </select>
      <button id="load-plan-btn" class="secondary">Load</button>
      <button id="delete-plan-btn" class="danger">Delete</button>
      <div style="flex:1"></div>
      <button id="download-data-btn" class="secondary" title="Backup all data">⬇ Backup</button>
      <button id="upload-data-btn" class="secondary" title="Restore data">⬆ Restore</button>
      <input type="file" id="upload-file" accept=".json" style="display:none">
    </div>
  </header>

  <!-- Setup Card -->
  <div class="card" id="setup-card">
    <div class="setup-header" id="setup-header">
      <div>
        <div class="setup-title">Plan Builder</div>
        <div class="setup-sub"></div>
      </div>
      <button id="setup-toggle" class="secondary" aria-expanded="false">Expand</button>
    </div>
    <div id="setup-content" class="setup-content collapsed">
      <div class="grid">
        <div>
          <label for="book-select">Book</label>
          <select id="book-select"><option value="">Loading books...</option></select>
        </div>
        <div>
          <label for="start-section">Start Section</label>
          <select id="start-section" disabled><option>--</option></select>
        </div>
        <div>
          <label for="end-section">End Section</label>
          <select id="end-section" disabled><option>--</option></select>
        </div>
        <div>
          <label for="start-date">Start Date</label>
          <input type="date" id="start-date">
        </div>
        <div>
          <label for="end-date">Target Date</label>
          <input type="date" id="end-date">
        </div>
      </div>
      <div class="actions">
        <button id="generate-btn">Generate New Plan</button>
      </div>
      <div id="setup-msg" class="msg"></div>
    </div>
  </div>

  <!-- Plan View (Calendar + Day) -->
  <div id="plan-view" class="hidden">
    <!-- Summary -->
    <div class="card">
      <div class="summary-pills">
        <div class="pill" id="sum-book"></div>
        <div class="pill" id="sum-range"></div>
        <div class="pill" id="sum-counts"></div>
      </div>
      
      <div style="display:flex; justify-content: space-between; align-items: center;">
        <label style="margin:0;">Progress Calendar</label>
        <button id="toggle-cal-btn" class="secondary" style="padding: 6px 12px; font-size: 0.8rem;">Show Calendar</button>
      </div>

      <div id="calendar-wrapper" class="calendar-container hidden">
        <div id="real-calendar-root"></div>
        <div class="cal-legend">
          <div class="legend-item"><div class="legend-box" style="background: linear-gradient(90deg, #f85149 50%, #21262d 50%)"></div> Read (0%)</div>
          <div class="legend-item"><div class="legend-box" style="background: linear-gradient(90deg, #3fb950 50%, #21262d 50%)"></div> Read (100%)</div>
          <div class="legend-item"><div class="legend-box" style="background: linear-gradient(90deg, #21262d 50%, #f85149 50%)"></div> Anki (0%)</div>
          <div class="legend-item"><div class="legend-box" style="background: linear-gradient(90deg, #21262d 50%, #3fb950 50%)"></div> Anki (100%)</div>
          <div class="legend-item" style="border-left: 1px solid var(--border); padding-left: 10px; margin-left: 5px;">
            <div class="legend-box" style="background: #3fb950"></div> Light Load
          </div>
          <div class="legend-item"><div class="legend-box" style="background: #f85149"></div> Heavy Load</div>
        </div>
      </div>
    </div>

    <!-- Day Detail -->
    <div class="card" id="day-card">
      <div class="day-header">
        <div class="day-nav">
          <button id="prev-day" class="secondary">◀</button>
          <select id="day-jumper" style="width: auto; min-width: 140px;"></select>
          <button id="next-day" class="secondary">▶</button>
          <button id="today-btn">Today</button>
        </div>
        
        <div class="day-actions">
          <button id="copy-day-btn" class="secondary">Copy Full Day</button>
          <div id="day-char-count" class="char-count-badge">0 chars</div>
        </div>
      </div>

      <div id="day-content"></div>
    </div>
  </div>
</div>

<script>
/**
 * Core Study Organizer V4.1
 * - Includes Character Count Badge in Day Header
 * - Includes Relative Load "Sliver" in Calendar (Green=Light, Red=Heavy)
 */

const STORAGE_KEY = 'core_study_data_v4';
let appData = {
  savedPlans: {}, 
  lastActiveId: null
};

let booksData = {};
let currentBookSections = [];
let currentBookPath = '';
let currentPlan = null;
let currentDayIndex = 0;
let runtimeTextCache = {};

// UI Refs
const els = {
  savedSelect: document.getElementById('saved-plans-select'),
  loadBtn: document.getElementById('load-plan-btn'),
  delBtn: document.getElementById('delete-plan-btn'),
  dlBtn: document.getElementById('download-data-btn'),
  ulBtn: document.getElementById('upload-data-btn'),
  ulInput: document.getElementById('upload-file'),
  setupCard: document.getElementById('setup-card'),
  setupHeader: document.getElementById('setup-header'),
  setupToggle: document.getElementById('setup-toggle'),
  setupContent: document.getElementById('setup-content'),
  bookSelect: document.getElementById('book-select'),
  startSec: document.getElementById('start-section'),
  endSec: document.getElementById('end-section'),
  startDate: document.getElementById('start-date'),
  endDate: document.getElementById('end-date'),
  genBtn: document.getElementById('generate-btn'),
  msg: document.getElementById('setup-msg'),
  planView: document.getElementById('plan-view'),
  sumBook: document.getElementById('sum-book'),
  sumRange: document.getElementById('sum-range'),
  sumCounts: document.getElementById('sum-counts'),
  
  toggleCalBtn: document.getElementById('toggle-cal-btn'),
  calWrapper: document.getElementById('calendar-wrapper'),
  calRoot: document.getElementById('real-calendar-root'),
  
  prevDay: document.getElementById('prev-day'),
  nextDay: document.getElementById('next-day'),
  dayJumper: document.getElementById('day-jumper'),
  todayBtn: document.getElementById('today-btn'),
  copyDayBtn: document.getElementById('copy-day-btn'),
  dayCharCount: document.getElementById('day-char-count'),
  dayContent: document.getElementById('day-content'),
  dayCard: document.getElementById('day-card')
};

async function init() {
  loadData();
  setDefaultDates();
  setSetupCollapsed(true);
  try {
    const res = await fetch('books.json');
    booksData = await res.json();
    populateBooks();
    if (appData.lastActiveId && appData.savedPlans[appData.lastActiveId]) {
      setTimeout(() => loadPlan(appData.lastActiveId), 100);
    }
  } catch (e) {
    showMsg('Error loading books.json: ' + e.message, 'error');
  }
  updateSavedPlansDropdown();
}

function loadData() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (raw) {
    try { appData = JSON.parse(raw); } catch(e) { console.error(e); }
  }
}
function saveData() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
  updateSavedPlansDropdown();
}
function setSetupCollapsed(collapsed) {
  if (!els.setupContent) return;
  if (collapsed) {
    els.setupContent.classList.add('collapsed');
    els.setupToggle.textContent = 'Expand';
    els.setupToggle.setAttribute('aria-expanded', 'false');
    els.setupCard.classList.add('is-collapsed');
  } else {
    els.setupContent.classList.remove('collapsed');
    els.setupToggle.textContent = 'Collapse';
    els.setupToggle.setAttribute('aria-expanded', 'true');
    els.setupCard.classList.remove('is-collapsed');
  }
}
function showMsg(txt, type) {
  els.msg.textContent = txt;
  els.msg.className = 'msg ' + type;
  setTimeout(() => els.msg.textContent = '', 4000);
}

function formatLocalISO(date) {
  const tzOffset = date.getTimezoneOffset() * 60000;
  return new Date(date.getTime() - tzOffset).toISOString().split('T')[0];
}

function parseLocalISO(dateStr) {
  if (!dateStr) return new Date(NaN);
  const [datePart] = dateStr.split('T');
  const [y, m, d] = (datePart || '').split('-').map(Number);
  return new Date(y, (m || 1) - 1, d || 1);
}

// --- Import/Export ---
function exportData() {
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
  const node = document.createElement('a');
  node.setAttribute("href", dataStr);
  node.setAttribute("download", "study_plan_v4_backup.json");
  document.body.appendChild(node);
  node.click();
  node.remove();
}
function importData(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (evt) => {
    try {
      const parsed = JSON.parse(evt.target.result);
      if (parsed.savedPlans) {
        appData = parsed;
        saveData();
        location.reload(); 
      } else { alert("Invalid file."); }
    } catch(err) { alert("Error parsing JSON"); }
  };
  reader.readAsText(file);
}

// --- Plan Management ---
function updateSavedPlansDropdown() {
  els.savedSelect.innerHTML = '<option value="">-- Load a saved plan --</option>';
  const plans = Object.values(appData.savedPlans).sort((a,b) => b.created - a.created);
  plans.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = `${p.book} (${parseLocalISO(p.startDate).toLocaleDateString()} - ${parseLocalISO(p.endDate).toLocaleDateString()})`;
    els.savedSelect.appendChild(opt);
  });
}
function loadPlanFromDropdown() {
  const id = els.savedSelect.value;
  if(id && appData.savedPlans[id]) loadPlan(id);
}
function deletePlan() {
  const id = els.savedSelect.value;
  if (!id) return;
  if (confirm("Delete this plan?")) {
    delete appData.savedPlans[id];
    if (appData.lastActiveId === id) appData.lastActiveId = null;
    saveData();
    location.reload();
  }
}

// --- Setup Logic ---
function populateBooks() {
  els.bookSelect.innerHTML = '<option value="">-- Select Book --</option>';
  Object.keys(booksData).forEach(k => {
    els.bookSelect.appendChild(new Option(k, k));
  });
}
async function handleBookChange() {
  const name = els.bookSelect.value;
  if (!name) return;
  const info = booksData[name];
  currentBookPath = info.basePath;
  try {
    const res = await fetch(info.manifest);
    const manifest = await res.json();
    currentBookSections = flattenManifest(manifest);
    populateRangeSelects();
  } catch(e) { showMsg("Error loading manifest", 'error'); }
}
function flattenManifest(manifest) {
  const chapters = Object.keys(manifest).sort(natCompare);
  const flat = [];
  chapters.forEach(chKey => {
    const ch = manifest[chKey];
    if (ch.title && !ch.file && typeof ch === 'object') {
      const secKeys = Object.keys(ch).filter(k => k !== 'title').sort(compareSectionKeys);
      secKeys.forEach(secKey => {
        flat.push({
          chapter: ch.title,
          sectionKey: secKey,
          title: ch[secKey].title,
          file: ch[secKey].file,
          fullTitle: `${ch.title} · ${secKey} - ${ch[secKey].title}`
        });
      });
    }
  });
  return flat;
}
function populateRangeSelects() {
  els.startSec.innerHTML = ''; els.endSec.innerHTML = '';
  els.startSec.disabled = false; els.endSec.disabled = false;
  currentBookSections.forEach((s, idx) => {
    els.startSec.add(new Option(s.fullTitle, idx));
    els.endSec.add(new Option(s.fullTitle, idx));
  });
  els.endSec.value = currentBookSections.length - 1;
}

// --- Generation ---
async function generatePlan() {
  const bookName = els.bookSelect.value;
  const startIdx = parseInt(els.startSec.value);
  const endIdx = parseInt(els.endSec.value);
  const sDate = parseLocalISO(els.startDate.value);
  const eDate = parseLocalISO(els.endDate.value);

  if (!bookName || isNaN(startIdx) || isNaN(endIdx) || !sDate || !eDate) {
    showMsg("Fill all fields", 'error'); return;
  }
  if (endIdx < startIdx) { showMsg("Invalid range", 'error'); return; }
  if (eDate < sDate) { showMsg("Invalid dates", 'error'); return; }

  els.genBtn.disabled = true;
  showMsg("Analyzing...", 'info');

  try {
    const selection = currentBookSections.slice(startIdx, endIdx + 1);
    const hydratedSections = [];
    
    // Fetch text temporarily to measure length
    for (const sec of selection) {
      const url = encodePath(`${currentBookPath}/${sec.file}`);
      const r = await fetch(url);
      if(!r.ok) throw new Error(`Missing: ${sec.file}`);
      const text = await r.text();
      hydratedSections.push({
        file: sec.file,
        fullTitle: sec.fullTitle,
        length: text.length,
        // DUAL CHECKBOX STATE
        read: false, 
        anki: false 
      });
    }

    const daysCount = Math.floor((eDate - sDate) / (1000 * 60 * 60 * 24)) + 1;
    const totalChars = hydratedSections.reduce((acc, s) => acc + s.length, 0);
    const targetPerDay = totalChars / daysCount;

    const days = [];
    let secIndex = 0;

    for (let d = 0; d < daysCount; d++) {
      const dayDate = new Date(sDate);
      dayDate.setDate(dayDate.getDate() + d);
      const dayObj = { date: formatLocalISO(dayDate), sections: [] };
      let dayLoad = 0;

      while (secIndex < hydratedSections.length) {
        const sec = hydratedSections[secIndex];
        const remainingSections = hydratedSections.length - secIndex;
        const remainingDays = daysCount - d;

        if (remainingSections <= remainingDays && dayObj.sections.length > 0) break; 

        if (dayObj.sections.length === 0) {
          dayObj.sections.push(sec); dayLoad += sec.length; secIndex++;
        } else {
          const currentDiff = Math.abs(dayLoad - targetPerDay);
          const nextDiff = Math.abs((dayLoad + sec.length) - targetPerDay);
          if (nextDiff < currentDiff || (dayLoad < targetPerDay * 0.7)) {
            dayObj.sections.push(sec); dayLoad += sec.length; secIndex++;
          } else { break; }
        }
      }
      days.push(dayObj);
    }
    while(secIndex < hydratedSections.length) {
      days[days.length-1].sections.push(hydratedSections[secIndex++]);
    }

    const planId = Date.now().toString();
    const newPlan = {
      id: planId,
      created: Date.now(),
      book: bookName,
      range: `${selection[0].fullTitle} -> ${selection[selection.length-1].fullTitle.split('·')[1] || 'End'}`,
      startDate: els.startDate.value,
      endDate: els.endDate.value,
      totalSections: selection.length,
      days: days
    };

    appData.savedPlans[planId] = newPlan;
    appData.lastActiveId = planId;
    saveData();
    showMsg("Plan created!", 'info');
    loadPlan(planId);

  } catch(e) { showMsg("Error: " + e.message, 'error'); } 
  finally { els.genBtn.disabled = false; }
}

// --- Rendering ---
function loadPlan(id) {
  currentPlan = appData.savedPlans[id];
  if (!currentPlan) return;
  appData.lastActiveId = id;
  saveData();
  if (booksData[currentPlan.book]) currentBookPath = booksData[currentPlan.book].basePath;
  
  els.planView.classList.remove('hidden');
  els.sumBook.innerHTML = `<strong>Book:</strong> ${currentPlan.book}`;
  els.sumRange.innerHTML = `<strong>Range:</strong> ${currentPlan.range}`;
  els.sumCounts.innerHTML = `<strong>Stats:</strong> ${currentPlan.days.length} Days, ${currentPlan.totalSections} Sections`;
  
  els.dayJumper.innerHTML = '';
  currentPlan.days.forEach((d, i) => {
    els.dayJumper.add(new Option(`Day ${i+1}: ${parseLocalISO(d.date).toLocaleDateString()}`, i));
  });

  renderRealCalendar();

  const todayIdx = getTodayIndex();
  setDay(todayIdx, true);
  els.bookSelect.value = currentPlan.book;
}

// --- Real Calendar Logic ---
function renderRealCalendar() {
  els.calRoot.innerHTML = '';
  if (!currentPlan) return;

  // 1. Calculate Load Min/Max for formatting
  let maxLoad = 0;
  let minLoad = Infinity;
  currentPlan.days.forEach(d => {
    const load = d.sections.reduce((a,b) => a + (b.length || 0), 0);
    if(load > maxLoad) maxLoad = load;
    if(load < minLoad) minLoad = load;
  });
  // Edge case: if all days are equal, avoid divide by zero
  if (maxLoad === minLoad) { maxLoad++; } 

  const sDate = parseLocalISO(currentPlan.startDate);
  const eDate = parseLocalISO(currentPlan.endDate);
  
  const dateMap = {};
  currentPlan.days.forEach((day, idx) => {
    dateMap[day.date.split('T')[0]] = { day, idx };
  });

  let iter = new Date(sDate.getFullYear(), sDate.getMonth(), 1);
  const finalMonth = new Date(eDate.getFullYear(), eDate.getMonth(), 1);

  while (iter <= finalMonth) {
    const year = iter.getFullYear();
    const month = iter.getMonth();
    
    const monthBlock = document.createElement('div');
    monthBlock.className = 'month-block';
    
    const title = document.createElement('div');
    title.className = 'month-title';
    title.textContent = iter.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
    monthBlock.appendChild(title);
    
    const grid = document.createElement('div');
    grid.className = 'cal-grid';
    ['S','M','T','W','T','F','S'].forEach(d => {
      const h = document.createElement('div');
      h.className = 'cal-header';
      h.textContent = d;
      grid.appendChild(h);
    });

    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const startDay = new Date(year, month, 1).getDay(); 

    for (let i = 0; i < startDay; i++) {
      const empty = document.createElement('div');
      empty.className = 'cal-day empty';
      grid.appendChild(empty);
    }

    for (let d = 1; d <= daysInMonth; d++) {
      const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const cell = document.createElement('div');
      cell.className = 'cal-day';
      cell.textContent = d;
      
      if (dateMap[dateStr]) {
        const { day, idx } = dateMap[dateStr];
        updateCalendarCellColor(cell, day);
        
        // --- Add Sliver ---
        const dayLoad = day.sections.reduce((a,b) => a + (b.length || 0), 0);
        // Ratio 0 to 1
        const ratio = (dayLoad - minLoad) / (maxLoad - minLoad);
        const sliver = document.createElement('div');
        sliver.className = 'load-sliver';
        // Green(Light) to Red(Heavy). 
        // My getGradientColor is Red(0)->Green(1).
        // So for Light Load (low char count) -> we want Green (1).
        // For Heavy Load (high char count) -> we want Red (0).
        // Input should be: 1 - ratio.
        sliver.style.background = getGradientColor(1 - ratio);
        cell.appendChild(sliver);
        // ------------------

        cell.onclick = () => setDay(idx, true);
        if (idx === currentDayIndex) cell.classList.add('active');
        cell.dataset.planIdx = idx; 
      } else {
        cell.classList.add('empty');
        cell.style.opacity = '0.3';
      }
      
      grid.appendChild(cell);
    }

    monthBlock.appendChild(grid);
    els.calRoot.appendChild(monthBlock);
    iter.setMonth(iter.getMonth() + 1);
  }
}

// --- Split Color Gradient Logic ---
function updateCalendarCellColor(cell, day) {
  if (!day.sections || day.sections.length === 0) {
    cell.style.background = '#21262d'; 
    return;
  }
  
  const total = day.sections.length;
  const readCount = day.sections.filter(s => s.read).length;
  const ankiCount = day.sections.filter(s => s.anki).length;
  
  const readPct = readCount / total;
  const ankiPct = ankiCount / total;

  const cRead = getGradientColor(readPct);
  const cAnki = getGradientColor(ankiPct);
  
  cell.style.background = `linear-gradient(90deg, ${cRead} 50%, ${cAnki} 50%)`;
  cell.style.textShadow = '0 1px 2px rgba(0,0,0,0.8)';
}

function getGradientColor(pct) {
  // Red (0) -> Yellow (0.5) -> Green (1)
  let r, g, b = 85; 
  if (pct < 0.5) {
    // Red to Yellow
    // Red: 248, 81, 73 (#f85149)
    // Yellow: 210, 153, 34 (#d29922)
    const ratio = pct * 2;
    r = 248 + (210 - 248) * ratio;
    g = 81 + (153 - 81) * ratio;
    b = 73 + (34 - 73) * ratio;
  } else {
    // Yellow to Green
    // Yellow (#d29922) to Green (#3fb950)
    const ratio = (pct - 0.5) * 2;
    r = 210 + (63 - 210) * ratio;
    g = 153 + (185 - 153) * ratio;
    b = 34 + (80 - 34) * ratio;
  }
  if (pct === 0) return 'rgba(33, 38, 45, 1)';
  return `rgb(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)})`;
}

// --- Day View ---
function scrollToDayTop() {
  if (!els.dayCard) return;
  requestAnimationFrame(() => {
    els.dayCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });
}

async function setDay(idx, scrollToDay = false) {
  if (!currentPlan) return;
  if (idx < 0) idx = 0; if (idx >= currentPlan.days.length) idx = currentPlan.days.length - 1;
  currentDayIndex = idx;
  els.dayJumper.value = idx;

  if (scrollToDay && els.dayCard) {
    scrollToDayTop();
  }

  document.querySelectorAll('.cal-day').forEach(el => {
    if (el.dataset.planIdx == idx) el.classList.add('active');
    else el.classList.remove('active');
  });

  const day = currentPlan.days[idx];
  els.dayContent.innerHTML = '';

  // Update Character Count Badge
  const totalChars = day.sections.reduce((a,b) => a + (b.length || 0), 0);
  els.dayCharCount.textContent = `${totalChars.toLocaleString()} chars`;

  if (day.sections.length === 0) {
    els.dayContent.innerHTML = '<div style="padding:20px; text-align:center; color:var(--muted)">Rest Day</div>';
    return;
  }

  els.dayContent.innerHTML = '<div class="loading-text">Fetching content...</div>';

  try {
    const sectionPromises = day.sections.map(async (sec) => {
      const cacheKey = currentPlan.book + '_' + sec.file;
      if (runtimeTextCache[cacheKey]) return { ...sec, text: runtimeTextCache[cacheKey] };
      const url = encodePath(`${currentBookPath}/${sec.file}`);
      const res = await fetch(url);
      if (!res.ok) return { ...sec, text: "Error loading text." };
      const txt = await res.text();
      runtimeTextCache[cacheKey] = txt;
      return { ...sec, text: txt };
    });

    const richSections = await Promise.all(sectionPromises);
    els.dayContent.innerHTML = '';

    richSections.forEach((sec, sIdx) => {
      const item = document.createElement('div');
      item.className = 'section-item';
      
      const head = document.createElement('div');
      head.className = 'section-header';

      const headerTop = document.createElement('div');
      headerTop.className = 'section-top';
      headerTop.innerHTML = `<div class="section-title">${sec.fullTitle}</div><div class="section-meta">${sec.length} chars</div>`;
      
      const grp = document.createElement('div');
      grp.className = 'checklist-group';
      
      const lRead = document.createElement('label');
      lRead.className = 'chk-label';
      const cRead = document.createElement('input');
      cRead.type = 'checkbox';
      cRead.checked = day.sections[sIdx].read || false;
      cRead.onchange = () => toggleCheck(idx, sIdx, 'read', cRead.checked);
      lRead.append(cRead, "Read");

      const lAnki = document.createElement('label');
      lAnki.className = 'chk-label';
      const cAnki = document.createElement('input');
      cAnki.type = 'checkbox';
      cAnki.checked = day.sections[sIdx].anki || false;
      cAnki.onchange = () => toggleCheck(idx, sIdx, 'anki', cAnki.checked);
      lAnki.append(cAnki, "Anki");

      grp.append(lRead, lAnki);

      const cpBtn = document.createElement('button');
      cpBtn.className = 'secondary';
      cpBtn.textContent = 'Copy';
      cpBtn.onclick = (e) => copyText(sec.text, e.target);

      const splitBtn = document.createElement('button');
      splitBtn.className = 'split-btn';
      splitBtn.textContent = 'Split';
      splitBtn.onclick = () => window.open('../text-splitter/index.html', '_blank');

      const actionStack = document.createElement('div');
      actionStack.className = 'section-actions';
      actionStack.append(cpBtn, splitBtn);

      const controls = document.createElement('div');
      controls.className = 'section-controls';
      controls.append(grp, actionStack);

      head.append(headerTop, controls);
      
      const content = document.createElement('div');
      content.className = 'section-content';
      const pre = document.createElement('pre');
      pre.textContent = sec.text;
      content.appendChild(pre);
      
      item.append(head, content);
      els.dayContent.appendChild(item);
    });

  } catch (err) { els.dayContent.innerHTML = `<div class="msg error">${err.message}</div>`; }
}

function toggleCheck(dayIdx, secIdx, type, isChecked) {
  currentPlan.days[dayIdx].sections[secIdx][type] = isChecked;
  saveData();
  const cells = document.querySelectorAll('.cal-day');
  cells.forEach(c => {
    if (c.dataset.planIdx == dayIdx) {
      updateCalendarCellColor(c, currentPlan.days[dayIdx]);
    }
  });
}

// --- Utils ---
async function copyText(text, btn) {
  try {
    await navigator.clipboard.writeText(text);
    const orig = btn.textContent; btn.textContent = "Copied!"; btn.classList.add('success');
    setTimeout(() => { btn.textContent = orig; btn.classList.remove('success'); }, 1500);
  } catch (e) { console.error(e); }
}

async function copyFullDay() {
  const day = currentPlan.days[currentDayIndex];
  if (!day || !day.sections.length) return;
  const orig = els.copyDayBtn.textContent; els.copyDayBtn.textContent = "Gathering...";
  try {
    let full = "";
    for (const sec of day.sections) {
      const k = currentPlan.book + '_' + sec.file;
      let txt = runtimeTextCache[k];
      if (!txt) {
         const url = encodePath(`${currentBookPath}/${sec.file}`);
         const res = await fetch(url);
         txt = await res.text();
         runtimeTextCache[k] = txt;
      }
      full += `# ${sec.fullTitle}\n${txt}\n\n`;
    }
    await navigator.clipboard.writeText(full);
    els.copyDayBtn.textContent = "Copied!"; els.copyDayBtn.classList.add('success');
    setTimeout(() => { els.copyDayBtn.textContent = orig; els.copyDayBtn.classList.remove('success'); }, 1500);
  } catch (e) { els.copyDayBtn.textContent = "Error"; }
}

function getTodayIndex() {
  if (!currentPlan) return 0;
  const now = new Date(); now.setHours(0,0,0,0);
  const start = parseLocalISO(currentPlan.startDate); start.setHours(0,0,0,0);
  const diff = Math.floor((now - start) / (1000 * 60 * 60 * 24));
  if (diff < 0) return 0; if (diff >= currentPlan.days.length) return currentPlan.days.length - 1;
  return diff;
}
function setDefaultDates() {
  const t = new Date(); els.startDate.value = formatLocalISO(t);
  t.setDate(t.getDate() + 14); els.endDate.value = formatLocalISO(t);
}

els.toggleCalBtn.addEventListener('click', () => {
  els.calWrapper.classList.toggle('hidden');
  els.toggleCalBtn.textContent = els.calWrapper.classList.contains('hidden') ? "Show Calendar" : "Hide Calendar";
});

const natCompare = (a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
const compareSectionKeys = (a, b) => {
  const nA = a.split('.').map(Number); const nB = b.split('.').map(Number);
  for (let i = 0; i < Math.max(nA.length, nB.length); i++) {
    if ((nA[i]||0) !== (nB[i]||0)) return (nA[i]||0) - (nB[i]||0);
  } return 0;
};
const encodePath = (p) => p.split('/').map(encodeURIComponent).join('/');

function toggleSetupPanel() {
  const isCollapsed = els.setupContent.classList.contains('collapsed');
  setSetupCollapsed(!isCollapsed);
}

els.bookSelect.addEventListener('change', handleBookChange);
els.genBtn.addEventListener('click', generatePlan);
els.loadBtn.addEventListener('click', loadPlanFromDropdown);
els.delBtn.addEventListener('click', deletePlan);
els.dlBtn.addEventListener('click', exportData);
els.ulBtn.addEventListener('click', () => els.ulInput.click());
els.ulInput.addEventListener('change', importData);
els.dayJumper.addEventListener('change', (e) => setDay(parseInt(e.target.value)));
els.prevDay.addEventListener('click', () => setDay(currentDayIndex - 1));
els.nextDay.addEventListener('click', () => setDay(currentDayIndex + 1));
els.todayBtn.addEventListener('click', () => setDay(getTodayIndex(), true));
els.copyDayBtn.addEventListener('click', copyFullDay);
els.setupHeader.addEventListener('click', toggleSetupPanel);
els.setupToggle.addEventListener('click', (e) => { e.stopPropagation(); toggleSetupPanel(); });

init();
</script>
</body>
</html>