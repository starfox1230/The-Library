<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Birthday Board</title>
<style>
  :root{
    --bg:#0f1117; --panel:#151826; --muted:#8b92a7; --text:#e6e8ef; --accent:#7aa2ff; --accent-2:#25d0a4;
    --card:#121527; --chip:#1b2034; --danger:#ff6b6b; --ok:#50fa7b; --warn:#ffb86c; --ring:rgba(122,162,255,.35);
    --radius:14px; --shadow: 0 10px 30px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background: radial-gradient(1200px 600px at 20% -10%, #1a1f35 0%, transparent 60%),
                         radial-gradient(1200px 600px at 120% 0%, #10202c 0%, transparent 55%), var(--bg);
    color:var(--text); font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom);
  }
  header{
    display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 8px 10px;
    position:sticky; top:0; backdrop-filter: blur(8px); background:linear-gradient(180deg, rgba(15,17,23,.9), rgba(15,17,23,.5) 60%, transparent);
    z-index:5;
  }
  .title{display:flex; align-items:center; gap:12px}
  .logo{
    width:40px; height:40px; border-radius:10px; background:
      conic-gradient(from 210deg, #2c7cff, #58ffd6, #2c7cff 75%);
    box-shadow: 0 0 30px rgba(122,162,255,.35); position:relative; isolation:isolate;
  }
  .logo::after{content:"ðŸŽ‚"; position:absolute; inset:0; display:flex; align-items:center; justify-content:center; filter: drop-shadow(0 2px 8px rgba(0,0,0,.5))}
  h1{font-size:18px; margin:0; letter-spacing:.3px}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  .pill{
    background:var(--chip); color:var(--text); border:1px solid transparent; padding:8px 12px; border-radius:999px;
    cursor:pointer; transition: .15s ease; user-select:none; font-weight:600; font-size:13px;
  }
  .pill[aria-pressed="true"]{background: linear-gradient(180deg, #1f2640, #171c31); border-color: var(--ring); box-shadow: 0 0 0 6px var(--ring) inset}
  .icon-btn{
    background:var(--panel); border:1px solid #23283d; width:40px; height:40px; border-radius:12px; display:grid; place-items:center;
    cursor:pointer; transition: .15s; box-shadow: var(--shadow);
  }
  .icon-btn:hover{border-color:var(--accent)}
  .gear{width:20px; height:20px; color:var(--text)}
  main{max-width:1000px; margin:0 auto; padding:10px 6px 30px}
  .cards{display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:14px}
  .card{
    background: linear-gradient(180deg, rgba(122,162,255,.06), rgba(122,162,255,0) 40%), var(--card);
    border:1px solid #1d2341; border-radius: var(--radius); padding:14px; box-shadow: var(--shadow); position:relative; overflow:hidden;
  }
  .card .name{font-weight:700; font-size:16px; margin-bottom:6px}
  .meta{display:flex; gap:10px; flex-wrap:wrap; color:var(--muted); font-size:13px}
  .meta .dot{width:6px; height:6px; background:var(--accent-2); border-radius:50%; display:inline-block; margin-right:6px}
  .countdown{
    margin-top:10px; font-weight:700; letter-spacing:.2px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;
  }
  .badge{
    font-size:12px; padding:4px 8px; border-radius:999px; background:#19233f; border:1px solid #233055; color:#c9d3ff;
  }
  .today{background:#1d2f1f; border-color:#264b2b; color:#b7f7c2}
  .soon{background:#2d2418; border-color:#5a4c2f; color:#ffd79a}
  .danger{background:#3a2226; border-color:#63333a; color:#ffb1c0}
  .age{margin-left:auto; font-weight:600; color:#cdd5ff}
  .empty{opacity:.7; text-align:center; padding:60px 20px}
  /* Modal */
  dialog{border:none; padding:0; border-radius:16px; width:min(920px, 96vw); background:var(--panel); color:var(--text); box-shadow: 0 20px 60px rgba(0,0,0,.55)}
  .modal-head{display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid #23283d}
  .modal-body{padding:16px 18px; display:grid; grid-template-columns: 1.1fr .9fr; gap:16px}
  .modal-col{background: #121528; border:1px solid #1d2341; border-radius:12px; padding:16px}
  .modal-col h3{margin:0 0 8px; font-size:15px}
  .modal-col p{margin:0 0 10px; color:var(--muted); font-size:13px}
  textarea, input[type="file"]{
    width:100%; background:#0f1324; color:var(--text); border:1px solid #273056; border-radius:10px; padding:10px; font: 13px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, 'Roboto Mono', monospace;
  }
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .btn{
    background:linear-gradient(180deg, #26335f, #1b2445); border:1px solid #2e3b73; color:#dbe3ff; padding:10px 14px; border-radius:10px; font-weight:700;
    cursor:pointer; transition:.15s; text-decoration:none; display:inline-flex; align-items:center; gap:8px; user-select:none;
  }
  .btn:hover{filter:brightness(1.07)}
  .btn.secondary{background:#121528; border-color:#2a335f; color:#cbd3fb}
  .switch{display:inline-flex; align-items:center; gap:10px; font-weight:600}
  .switch input{appearance:none; width:46px; height:26px; background:#222a47; border-radius:999px; position:relative; outline:none; cursor:pointer; border:1px solid #2b355e}
  .switch input:checked{background:#29406a; border-color:#3a5aa3}
  .switch input::after{content:""; position:absolute; width:20px; height:20px; top:2px; left:2px; background:#e8ecff; border-radius:50%; transition:.18s}
  .switch input:checked::after{left:24px; background:#cde0ff}
  .select{background:#0f1324; color:var(--text); border:1px solid #273056; border-radius:10px; padding:10px; min-width:200px}
  .footer-row{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:12px 18px; border-top:1px solid #23283d}
  .small{font-size:12px; color:var(--muted)}
  .kbd{font:12px/1.1 ui-monospace, SFMono-Regular, Menlo, Consolas; background:#0e1222; border:1px solid #273056; padding:2px 6px; border-radius:6px; color:#cbd3fb}

  /* Settings Modal mobile optimization */
  @media (max-width: 720px) {
    .modal-body {
      grid-template-columns: 1fr; /* Stack columns */
      padding: 12px;
      max-height: 80vh;
      overflow-y: auto;
    }
    textarea#jsonArea {
      height: 250px; /* Make textarea shorter on mobile */
    }
  }
</style>
</head>
<body>
  <header>
    <div class="title">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Birthday Board</h1>
        <div class="small">Upcoming birthdays with local-only storage</div>
      </div>
    </div>

    <div class="toolbar" id="filters">
      <button class="pill" data-view="next7" aria-pressed="false" title="Next 7 days">Next 7</button>
      <button class="pill" data-view="next30" aria-pressed="false" title="Next 30 days">Next 30</button>
      <button class="pill" data-view="year" aria-pressed="false" title="This calendar year">Year</button>
      <button class="pill" data-view="all" aria-pressed="false" title="Everything (sorted by next occurrence)">All</button>
    </div>

    <button class="icon-btn" id="openSettings" title="Settings">
      <svg class="gear" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 0 1 7.04 3.4l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09c0 .67.39 1.28 1 1.51.59.23 1.26.1 1.76-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06c-.43.5-.56 1.17-.33 1.76.23.61.84 1 1.51 1H21a2 2 0 0 1 0 4h-.09c-.67 0-1.28.39-1.51 1Z"/>
      </svg>
    </button>
  </header>

  <main>
    <div id="list" class="cards" role="list"></div>
    <div id="empty" class="empty" hidden>
      <p>No birthdays yet.</p>
      <p class="small">Open <span class="kbd">Settings</span> â†’ paste or upload your JSON, then <strong>Save</strong>.</p>
    </div>
  </main>

  <!-- Settings Modal -->
  <dialog id="settings">
    <div class="modal-head">
      <strong>Settings</strong>
      <div class="row">
        <button class="btn secondary" id="closeSettings">Close (Esc)</button>
      </div>
    </div>

    <div class="modal-body">
      <div class="modal-col">
        <h3>Data</h3>
        <p>Paste or upload your birthdays as JSON. Supported forms:</p>
        <ul class="small">
          <li><code>[{ "name": "Alice", "month": 5, "day": 8, "year": 1990 }]</code></li>
          <li><code>[{ "name": "Ben", "date": "2001-11-02" }]</code> (year optional, e.g. <code>"--05-08"</code> or <code>"05-08"</code>)</li>
        </ul>

        <div class="row" style="margin:10px 0">
          <input type="file" id="fileInput" accept=".json,application/json" />
          <button class="btn" id="downloadBtn" title="Download current JSON">Download JSON</button>
          <button class="btn secondary" id="sampleBtn" title="Load sample data">Load sample</button>
          <button class="btn secondary" id="clearBtn" title="Remove all birthdays">Clear all</button>
        </div>

        <textarea id="jsonArea" rows="16" spellcheck="false" placeholder='[{ "name":"Alice", "month":5, "day":8, "year":1990 }]'></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="saveJson">Save</button>
          <span id="saveStatus" class="small"></span>
        </div>
      </div>

      <div class="modal-col">
        <h3>Preferences</h3>
        <div class="row" style="margin:6px 0 14px">
          <label class="switch" title="Live tick tock timers (updates hourly/second)">
            <input id="liveCountdown" type="checkbox" />
            <span>Live countdowns</span>
          </label>
        </div>
        <div class="row" style="margin:6px 0 14px">
          <label class="switch" title="Show age they are turning if birth year is provided">
            <input id="showAge" type="checkbox" />
            <span>Show age on next birthday</span>
          </label>
        </div>
        <div class="row" style="margin:6px 0 14px">
          <label class="switch" title="Feb 29 rule in non-leap years">
            <input id="feb29AsMar1" type="checkbox" />
            <span>Treat Feb 29 as Mar 1 (unchecked = Feb 28)</span>
          </label>
        </div>
        <div style="margin:10px 0">
          <label for="defaultView" class="small">Default view</label><br/>
          <select id="defaultView" class="select">
            <option value="next7">Next 7</option>
            <option value="next30">Next 30</option>
            <option value="year">Year</option>
            <option value="all">All</option>
          </select>
        </div>
        <p class="small">Your choices and data are stored locally in your browser (no server).</p>
        <p class="small">Keyboard: <span class="kbd">1</span>=Next 7, <span class="kbd">2</span>=Next 30, <span class="kbd">3</span>=Year, <span class="kbd">4</span>=All, <span class="kbd">S</span>=Settings</p>
      </div>
    </div>

    <div class="footer-row">
      <span class="small" id="err" style="color:#ffb1c0"></span>
      <span class="small">Tip: keep a backupâ€”use <em>Download JSON</em> after edits.</span>
    </div>
  </dialog>

<script>
(() => {
  // --- Local storage keys
  const LS_KEYS = {
    data: 'bb_birthdays_v1',
    prefs: 'bb_prefs_v1',
    lastView: 'bb_view_v1'
  };

  // --- Defaults & state
  const defaultPrefs = {
    liveCountdown: true,
    showAge: true,
    feb29AsMar1: false, // if false: treat as Feb 28
    defaultView: 'next30'
  };
  let prefs = loadPrefs();
  let state = {
    view: localStorage.getItem(LS_KEYS.lastView) || prefs.defaultView,
    timer: null,
    data: loadData()
  };

  // --- Elements
  const listEl = document.getElementById('list');
  const emptyEl = document.getElementById('empty');
  const settingsDlg = document.getElementById('settings');
  const openSettingsBtn = document.getElementById('openSettings');
  const closeSettingsBtn = document.getElementById('closeSettings');
  const jsonArea = document.getElementById('jsonArea');
  const downloadBtn = document.getElementById('downloadBtn');
  const sampleBtn = document.getElementById('sampleBtn');
  const clearBtn = document.getElementById('clearBtn');
  const fileInput = document.getElementById('fileInput');
  const saveJsonBtn = document.getElementById('saveJson');
  const saveStatus = document.getElementById('saveStatus');
  const errEl = document.getElementById('err');
  const defaultViewSel = document.getElementById('defaultView');
  const liveCountdownChk = document.getElementById('liveCountdown');
  const showAgeChk = document.getElementById('showAge');
  const feb29AsMar1Chk = document.getElementById('feb29AsMar1');
  const filters = document.getElementById('filters');

  // --- Init UI
  hydratePrefsUI();
  applyViewUI(state.view);
  render();

  // --- Events: filters
  filters.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-view]');
    if(!btn) return;
    const view = btn.getAttribute('data-view');
    setView(view);
  });

  // Keyboard shortcuts
  window.addEventListener('keydown', (e) => {
    if (e.key === '1') setView('next7');
    else if (e.key === '2') setView('next30');
    else if (e.key === '3') setView('year');
    else if (e.key === '4') setView('all');
    else if (e.key.toLowerCase() === 's') openSettings();
    else if (e.key === 'Escape' && settingsDlg.open) settingsDlg.close();
  });

  // --- Settings open/close
  openSettingsBtn.addEventListener('click', openSettings);
  closeSettingsBtn.addEventListener('click', () => settingsDlg.close());
  settingsDlg.addEventListener('close', () => { errEl.textContent = ''; saveStatus.textContent=''; });

  function openSettings(){
    jsonArea.value = state.data && state.data.length > 0 ? JSON.stringify(state.data, null, 2) : '';
    defaultViewSel.value = prefs.defaultView;
    liveCountdownChk.checked = prefs.liveCountdown;
    showAgeChk.checked = prefs.showAge;
    feb29AsMar1Chk.checked = prefs.feb29AsMar1;
    settingsDlg.showModal();
  }

  // --- Settings actions
  downloadBtn.addEventListener('click', () => downloadJSON(state.data, 'birthdays.json'));

  sampleBtn.addEventListener('click', () => {
    const sample = [
      {"name":"Amanda","date":"--09-12"},
      {"name":"Matilda","date":"--05-03"},
      {"name":"Eloise","date":"--02-17"},
      {"name":"Desmond","date":"--09-08"},
      {"name":"Sterling","month":7,"day":14,"year":1994},
      {"name":"Grandma Jones","date":"1948-12-21"},
      {"name":"Friend (Leap)","date":"--02-29"}
    ];
    jsonArea.value = JSON.stringify(sample, null, 2);
    flash(saveStatus, 'Loaded sample (not saved yet)');
  });

  clearBtn.addEventListener('click', () => {
    if(confirm('Remove all birthdays? This only affects your local browser.')){
      state.data = [];
      saveData(state.data);
      render();
      jsonArea.value = '';
      flash(saveStatus, 'Cleared');
    }
  });

  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const text = await file.text();
      const parsed = normalizeAndValidate(JSON.parse(text));
      jsonArea.value = JSON.stringify(parsed, null, 2);
      flash(saveStatus, `Loaded ${parsed.length} from file (not saved yet)`);
      errEl.textContent = '';
    }catch(err){
      errEl.textContent = 'File parse error: ' + err.message;
    } finally {
      fileInput.value = '';
    }
  });

  saveJsonBtn.addEventListener('click', () => {
    try{
      const input = JSON.parse(jsonArea.value || '[]');
      const normalized = normalizeAndValidate(input);
      state.data = normalized;
      saveData(state.data);
      render();
      flash(saveStatus, 'Saved âœ“');
      errEl.textContent = '';
    }catch(err){
      errEl.textContent = 'Invalid JSON: ' + err.message;
    }
  });

  defaultViewSel.addEventListener('change', () => {
    prefs.defaultView = defaultViewSel.value;
    savePrefs();
    flash(saveStatus, 'Default view saved');
  });
  liveCountdownChk.addEventListener('change', () => {
    prefs.liveCountdown = liveCountdownChk.checked;
    savePrefs(); restartTicker();
  });
  showAgeChk.addEventListener('change', () => {
    prefs.showAge = showAgeChk.checked;
    savePrefs(); render();
  });
  feb29AsMar1Chk.addEventListener('change', () => {
    prefs.feb29AsMar1 = feb29AsMar1Chk.checked;
    savePrefs(); render();
  });

  // --- Core render
  function render(){
    const items = state.data.map(x => enrich(x));
    const now = new Date();

    let filtered = items;
    if(state.view === 'next7'){
      filtered = items.filter(i => i.until.totalMs >= 0 && i.until.days <= 7);
    } else if(state.view === 'next30'){
      filtered = items.filter(i => i.until.totalMs >= 0 && i.until.days <= 30);
    } else if(state.view === 'year'){
      // This calendar year only; show future ones first, then past ones (marked)
      const year = now.getFullYear();
      filtered = items.map(i => {
        const thisYearDate = new Date(year, i.month-1, i.day);
        return {...i, isPastThisYear: thisYearDate < stripTime(now)};
      });
    }
    // Sort by soonest upcoming (All/Next filters) else by month/day for Year
    if(state.view === 'year'){
      filtered.sort((a,b) => (a.month - b.month) || (a.day - b.day) || a.name.localeCompare(b.name));
    } else {
      filtered.sort((a,b) => a.until.totalMs - b.until.totalMs || a.name.localeCompare(b.name));
    }

    listEl.innerHTML = '';
    if(filtered.length === 0){
      emptyEl.hidden = false; return;
    } else emptyEl.hidden = true;

    for(const item of filtered){
      const card = document.createElement('div');
      card.className = 'card';
      card.setAttribute('role','listitem');

      const name = document.createElement('div');
      name.className = 'name';
      name.textContent = item.name;

      const meta = document.createElement('div');
      meta.className = 'meta';
      const d1 = document.createElement('div');
      d1.innerHTML = `<span class="dot"></span>${fmtMonthDay(item.month,item.day)}${item.year ? ' â€¢ born '+item.year : ''}`;
      meta.appendChild(d1);

      const d2 = document.createElement('div');
      d2.textContent = 'Next: ' + item.nextStr;
      meta.appendChild(d2);

      if(state.view === 'year' && item.isPastThisYear){
        const past = document.createElement('span');
        past.className = 'badge danger';
        past.textContent = 'passed this year';
        meta.appendChild(past);
      }

      const cd = document.createElement('div');
      cd.className = 'countdown';

      const badge = document.createElement('span');
      const days = item.until.days;
      if(days === 0){
        badge.className = 'badge today';
        badge.textContent = 'Today ðŸŽ‰';
      } else if(days <= 7){
        badge.className = 'badge soon';
        badge.textContent = 'Soon';
      } else {
        badge.className = 'badge';
        badge.textContent = 'Upcoming';
      }
      cd.appendChild(badge);

      const txt = document.createElement('span');
      txt.dataset.name = item.name;
      txt.dataset.key = item.key;
      txt.textContent = prefs.liveCountdown ? liveCountdownText(item) : staticCountdownText(item);
      cd.appendChild(txt);

      if(prefs.showAge && item.year){
        const age = document.createElement('div');
        age.className = 'age';
        age.textContent = `Turning ${item.nextAge}`;
        cd.appendChild(age);
      }

      card.appendChild(name);
      card.appendChild(meta);
      card.appendChild(cd);
      listEl.appendChild(card);
    }

    restartTicker();
  }

  function restartTicker(){
    if(state.timer){ clearInterval(state.timer); state.timer = null; }
    if(!prefs.liveCountdown) return;
    // Update every 1s for smooth hours/min/seconds; if you want hourly, change to 3600000
    state.timer = setInterval(() => {
      const nodes = listEl.querySelectorAll('.countdown span[data-key]');
      nodes.forEach(node => {
        const item = state.data.find(x => keyOf(x) === node.dataset.key);
        if(!item) return;
        const enriched = enrich(item); // recompute times
        node.textContent = liveCountdownText(enriched);
      });
    }, 1000);
  }

  // --- Data helpers
  function enrich(entry){
    // Normalize structure
    let {name, month, day, year, date} = entry;
    if(date){
      // Support "YYYY-MM-DD", "--MM-DD", "MM-DD"
      const m = String(date).trim();
      const parts = m.startsWith('--') ? m.slice(2).split('-')
                 : (m.length === 5 && m.includes('-')) ? m.split('-')
                 : m.split('-');
      if(parts.length === 3){
        year = toInt(parts[0]);
        month = toInt(parts[1]);
        day = toInt(parts[2]);
      }else if(parts.length === 2){
        month = toInt(parts[0]);
        day = toInt(parts[1]);
      }
    }
    month = toInt(month); day = toInt(day); year = year ? toInt(year) : undefined;

    const next = nextOccurrence(month, day, prefs.feb29AsMar1);
    const until = diff(nowLocal(), next);
    const nextAge = year ? (next.getFullYear() - year) : null;

    return {
      key: keyOf({name, month, day, year}),
      name, month, day, year,
      next, nextStr: next.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'numeric'}),
      until, nextAge
    };
  }

  function keyOf(x){ return `${x.name}|${x.month}-${x.day}|${x.year||''}`; }

  function loadData(){
    try{
      const txt = localStorage.getItem(LS_KEYS.data);
      if(!txt) return [];
      const parsed = JSON.parse(txt);
      return normalizeAndValidate(parsed);
    }catch{ return []; }
  }
  function saveData(arr){
    localStorage.setItem(LS_KEYS.data, JSON.stringify(arr));
  }

  function loadPrefs(){
    try{
      const txt = localStorage.getItem(LS_KEYS.prefs);
      return {...defaultPrefs, ...(txt ? JSON.parse(txt) : {})};
    }catch{ return {...defaultPrefs}; }
  }
  function savePrefs(){
    localStorage.setItem(LS_KEYS.prefs, JSON.stringify(prefs));
  }
  function hydratePrefsUI(){
    // set filter button aria
    applyViewUI(state.view);
  }
  function setView(view){
    state.view = view;
    localStorage.setItem(LS_KEYS.lastView, view);
    applyViewUI(view);
    render();
  }
  function applyViewUI(view){
    document.querySelectorAll('.pill[data-view]').forEach(btn=>{
      btn.setAttribute('aria-pressed', btn.getAttribute('data-view')===view ? 'true' : 'false');
    });
  }

  function normalizeAndValidate(input){
    if(!Array.isArray(input)) throw new Error('Root must be an array');
    const out = [];
    for(const [i, row] of input.entries()){
      if(typeof row !== 'object' || row==null) throw new Error(`Item ${i+1} must be an object`);
      let {name, month, day, year, date} = row;
      if(!name || typeof name !== 'string') throw new Error(`Item ${i+1}: "name" required`);
      if(date){
        // accept YYYY-MM-DD, --MM-DD, MM-DD
        let m = String(date).trim();
        let monthS, dayS, yearS = null;
        if(m.startsWith('--')){ [monthS, dayS] = m.slice(2).split('-'); }
        else {
          const parts = m.split('-');
          if(parts.length === 3){ [yearS, monthS, dayS] = parts; }
          else if(parts.length === 2){ [monthS, dayS] = parts; }
          else throw new Error(`Item ${i+1}: bad "date" format`);
        }
        month = toInt(monthS); day = toInt(dayS); year = yearS ? toInt(yearS) : (year||undefined);
      } else {
        month = toInt(month); day = toInt(day); year = year ? toInt(year) : undefined;
      }
      if(!(month>=1 && month<=12)) throw new Error(`Item ${i+1}: month 1-12`);
      if(!(day>=1 && day<=31)) throw new Error(`Item ${i+1}: day 1-31`);
      if(year && (year<1900 || year> 3000)) throw new Error(`Item ${i+1}: year out of range`);
      out.push({name, month, day, ...(year?{year}:{} )});
    }
    return out;
  }

  // --- Date/time helpers
  function nowLocal(){ return new Date(); }
  function stripTime(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function nextOccurrence(month, day, feb29AsMar1){
    const now = nowLocal();
    const y = now.getFullYear();
    const candidate = makeDate(y, month, day, feb29AsMar1);
    if(candidate >= now) return candidate;
    return makeDate(y+1, month, day, feb29AsMar1);
  }
  function makeDate(y,m,d,feb29AsMar1){
    // Handle Feb 29 preference in non-leap years
    if(m===2 && d===29 && !isLeap(y)){
      if(feb29AsMar1) return new Date(y, 2-1, 1+ (29-28)); // Mar 1
      else return new Date(y, 2-1, 28); // Feb 28
    }
    return new Date(y, m-1, d);
  }
  function isLeap(y){ return (y%4===0 && y%100!==0) || (y%400===0); }

  function diff(a,b){
    const ms = b.getTime() - a.getTime();
    const totalMs = Math.max(ms, 0);
    const totalSec = Math.floor(totalMs/1000);
    const days = Math.floor(totalSec / 86400);
    const hours = Math.floor((totalSec % 86400)/3600);
    const minutes = Math.floor((totalSec % 3600)/60);
    const seconds = totalSec % 60;
    return {totalMs, days, hours, minutes, seconds};
  }

  function fmtMonthDay(m,d){
    return new Date(2000, m-1, d).toLocaleDateString(undefined, {month:'short', day:'numeric'});
  }

  function liveCountdownText(item){
    const u = item.until;
    if(u.days===0){
      // show hours:minutes:seconds to midnight end (next day 00:00)
      return `Today â€¢ ${pad(u.hours)}:${pad(u.minutes)}:${pad(u.seconds)}`;
    }
    return `in ${u.days}d ${u.hours}h ${pad(u.minutes)}m`;
  }
  function staticCountdownText(item){
    const u = item.until;
    if(u.days===0) return 'Today';
    if(u.days===1) return 'in 1 day';
    return `in ${u.days} days`;
  }
  function pad(n){ return String(n).padStart(2,'0'); }
  function toInt(v){ return v==null || v==='' ? NaN : parseInt(v,10); }

  // --- Utilities
  function downloadJSON(obj, filename){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename || 'data.json';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  function flash(el, msg){
    el.textContent = msg;
    setTimeout(()=>{ el.textContent=''; }, 1600);
  }

})();
</script>
</body>
</html>