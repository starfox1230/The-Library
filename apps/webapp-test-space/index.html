<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Breast MRI Lesion Descriptor Builder</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1733;
      --panel2:#0c132b;
      --text:#e8ecff;
      --muted:#a8b2d6;
      --line:#243055;
      --accent:#7aa2ff;
      --accent2:#47ffd1;
      --warn:#ffcf5a;
      --bad:#ff6b6b;
      --ok:#7CFF7A;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(122,162,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 20%, rgba(71,255,209,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:22px 18px 10px;
      max-width:1100px;
      margin:0 auto;
    }
    h1{
      margin:0 0 6px;
      font-size:18px;
      letter-spacing:.2px;
      font-weight:700;
    }
    .sub{
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
    }
    main{
      max-width:1100px;
      margin:0 auto;
      padding: 10px 18px 26px;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(122,162,255,.16);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(122,162,255,.14);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: linear-gradient(90deg, rgba(122,162,255,.10), rgba(71,255,209,.06));
    }
    .card .hd .title{
      font-weight:700;
      font-size:14px;
    }
    .card .bd{ padding:14px; }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 560px){
      .grid{grid-template-columns:1fr}
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin: 0 0 6px;
    }
    input, select, textarea, button{
      font-family:inherit;
    }
    input[type="text"], input[type="number"], select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid rgba(122,162,255,.18);
      background: rgba(8,12,26,.55);
      color: var(--text);
      outline:none;
    }
    input[type="number"]{ appearance:textfield; }
    textarea{
      min-height: 84px;
      resize: vertical;
      font-family: var(--mono);
      font-size: 12.5px;
      line-height: 1.5;
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(122,162,255,.18);
      background: rgba(8,12,26,.45);
      color: var(--text);
      font-size:12px;
    }
    .pill input{ transform: translateY(1px); }
    details{
      border-top: 1px dashed rgba(122,162,255,.20);
      margin-top:12px;
      padding-top:12px;
    }
    summary{
      cursor:pointer;
      color: var(--text);
      font-weight:700;
      font-size:12.5px;
      list-style:none;
      user-select:none;
    }
    summary::-webkit-details-marker{display:none}
    .hint{
      margin-top:8px;
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }
    .warn{
      margin-top:10px;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,207,90,.35);
      background: rgba(255,207,90,.08);
      color: var(--text);
      font-size:12px;
      line-height:1.4;
    }
    .bad{
      border-color: rgba(255,107,107,.45) !important;
      background: rgba(255,107,107,.10) !important;
    }
    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    button{
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(122,162,255,.25);
      background: rgba(122,162,255,.14);
      color: var(--text);
      cursor:pointer;
      font-weight:700;
      font-size:12.5px;
    }
    button:hover{ background: rgba(122,162,255,.20); }
    button.secondary{
      background: rgba(8,12,26,.45);
    }
    button.secondary:hover{
      background: rgba(8,12,26,.60);
    }
    button.good{
      background: rgba(71,255,209,.12);
      border-color: rgba(71,255,209,.30);
    }
    button.good:hover{ background: rgba(71,255,209,.18); }
    .outbox{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .status{
      font-size:12px;
      color: var(--muted);
    }
    .kbd{
      font-family: var(--mono);
      font-size:11.5px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid rgba(122,162,255,.18);
      background: rgba(8,12,26,.55);
      color: var(--text);
    }
    .twoCols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 560px){
      .twoCols{grid-template-columns:1fr}
    }
    .sep{
      height:1px;
      background: rgba(122,162,255,.14);
      margin: 10px 0;
    }
    .small{
      font-size:11.5px;
      color: var(--muted);
      line-height:1.35;
    }
  </style>
</head>

<body>
<header>
  <h1>Breast MRI Lesion Descriptor Builder</h1>
  <div class="sub">
    Generates lesion-only report language for <b>focus</b>, <b>mass</b>, or <b>non-mass enhancement (NME)</b> using BI-RADS–style descriptors (shape/margin/pattern/T2/kinetics/location/best seen).
  </div>
</header>

<main>
  <!-- INPUTS -->
  <section class="card" id="inputsCard">
    <div class="hd">
      <div class="title">Inputs</div>
      <div class="row">
        <span class="pill"><input id="autosave" type="checkbox" checked /> <label for="autosave" style="margin:0;color:var(--text)">Autosave</label></span>
        <span class="pill"><span class="small">Preset</span>
          <select id="preset" style="width:auto;padding:7px 10px;border-radius:999px">
            <option value="">—</option>
            <option value="focus_probably_benign">Focus (probably benign pattern)</option>
            <option value="mass_fibroadenoma_like">Mass (fibroadenoma-like)</option>
            <option value="mass_suspicious">Mass (suspicious pattern)</option>
            <option value="nme_suspicious">NME (suspicious pattern)</option>
          </select>
        </span>
      </div>
    </div>

    <div class="bd">
      <div class="grid">
        <div>
          <label for="lesionType">Lesion type</label>
          <select id="lesionType">
            <option value="focus">Enhancing focus (&lt; 5 mm)</option>
            <option value="mass">Mass (3D space-occupying)</option>
            <option value="nme">Non-mass enhancement (NME)</option>
          </select>
        </div>

        <div>
          <label for="laterality">Laterality</label>
          <select id="laterality">
            <option value="right">Right</option>
            <option value="left">Left</option>
          </select>
        </div>
      </div>

      <div class="sep"></div>

      <!-- LOCATION -->
      <div class="card" style="border-radius:14px;border-color:rgba(122,162,255,.12);box-shadow:none;background:rgba(8,12,26,.28)">
        <div class="bd" style="padding:12px">
          <div class="row" style="justify-content:space-between">
            <div style="font-weight:700;font-size:12.5px">Location (lesion-only)</div>
            <div class="row">
              <span class="pill">
                <input type="radio" name="locMode" id="locQuadrant" value="quadrant" checked />
                <label for="locQuadrant" style="margin:0;color:var(--text)">Quadrant</label>
              </span>
              <span class="pill">
                <input type="radio" name="locMode" id="locClock" value="clock" />
                <label for="locClock" style="margin:0;color:var(--text)">Clock-face</label>
              </span>
            </div>
          </div>

          <div class="grid" style="margin-top:10px">
            <div id="quadrantBox">
              <label for="quadrant">Quadrant</label>
              <select id="quadrant">
                <option value="upper outer quadrant">Upper outer quadrant</option>
                <option value="upper inner quadrant">Upper inner quadrant</option>
                <option value="lower outer quadrant">Lower outer quadrant</option>
                <option value="lower inner quadrant">Lower inner quadrant</option>
              </select>
            </div>

            <div id="clockBox" style="display:none">
              <label>Clock-face</label>
              <div class="row" style="gap:8px">
                <select id="clockPos" style="flex:1;min-width:140px">
                  <option value="12">12:00</option><option value="1">1:00</option><option value="2">2:00</option><option value="3">3:00</option>
                  <option value="4">4:00</option><option value="5">5:00</option><option value="6">6:00</option><option value="7">7:00</option>
                  <option value="8">8:00</option><option value="9">9:00</option><option value="10">10:00</option><option value="11">11:00</option>
                </select>
                <input id="clockDist" type="number" min="0" step="0.1" placeholder="cm from nipple (optional)" style="flex:1;min-width:160px" />
              </div>
            </div>

            <div>
              <label for="zone">Zone (optional)</label>
              <select id="zone">
                <option value="">—</option>
                <option value="central">Central</option>
                <option value="retroareolar">Retroareolar</option>
                <option value="axillary tail">Axillary tail</option>
              </select>
            </div>

            <div>
              <label for="depth">Depth</label>
              <select id="depth">
                <option value="anterior depth">Anterior depth</option>
                <option value="middle depth">Middle depth</option>
                <option value="posterior depth">Posterior depth</option>
              </select>
            </div>

            <div>
              <label for="distSkin">Distance from skin (optional, cm)</label>
              <input id="distSkin" type="number" min="0" step="0.1" placeholder="e.g., 0.8" />
            </div>

            <div>
              <label for="distChest">Distance from chest wall (optional, cm)</label>
              <input id="distChest" type="number" min="0" step="0.1" placeholder="e.g., 1.5" />
            </div>
          </div>

          <div class="hint">
            Clock-face orientation is assumed standard; include only what helps you localize for second-look US/biopsy.
          </div>
        </div>
      </div>

      <!-- MEASUREMENTS -->
      <details open>
        <summary>Size & “Best seen”</summary>
        <div class="grid" style="margin-top:10px">
          <div>
            <label>Size (mm)</label>
            <div class="row" style="gap:8px">
              <input id="m1" type="number" min="0" step="0.1" placeholder="AP" />
              <input id="m2" type="number" min="0" step="0.1" placeholder="TR" />
              <input id="m3" type="number" min="0" step="0.1" placeholder="CC (optional)" />
            </div>
            <div class="small">Enter 1–3 dimensions. For focus: typically a single value (e.g., 4 mm).</div>
          </div>
          <div class="twoCols">
            <div>
              <label for="series">Best seen: Series (optional)</label>
              <input id="series" type="text" placeholder="e.g., Series 6" />
            </div>
            <div>
              <label for="image">Best seen: Image (optional)</label>
              <input id="image" type="text" placeholder="e.g., Image 102" />
            </div>
          </div>
        </div>
      </details>

      <!-- FOCUS -->
      <div id="focusFields">
        <details open>
          <summary>Focus descriptors</summary>
          <div class="grid" style="margin-top:10px">
            <div>
              <label for="focusUniqueness">Relationship to background</label>
              <select id="focusUniqueness">
                <option value="">—</option>
                <option value="unique from background parenchymal enhancement">Unique from background parenchymal enhancement</option>
                <option value="similar to background parenchymal enhancement">Similar to background parenchymal enhancement</option>
              </select>
            </div>
            <div>
              <label for="focusChange">Change over time</label>
              <select id="focusChange">
                <option value="">—</option>
                <option value="new">New</option>
                <option value="increased">Increased</option>
                <option value="stable">Stable</option>
              </select>
            </div>
            <div>
              <label for="focusT2">T2/STIR correlate (optional)</label>
              <select id="focusT2">
                <option value="">—</option>
                <option value="T2 hyperintense">T2 hyperintense</option>
                <option value="not T2 hyperintense">Not T2 hyperintense</option>
              </select>
            </div>
            <div>
              <label for="focusNote">Optional focus qualifier</label>
              <select id="focusNote">
                <option value="not further characterizable">Not further characterizable</option>
                <option value="">— omit —</option>
              </select>
            </div>
          </div>
        </details>
      </div>

      <!-- MASS -->
      <div id="massFields" style="display:none">
        <details open>
          <summary>Mass morphology</summary>
          <div class="grid" style="margin-top:10px">
            <div>
              <label for="massShape">Shape</label>
              <select id="massShape">
                <option value="oval">Oval</option>
                <option value="round">Round</option>
                <option value="irregular">Irregular</option>
              </select>
            </div>
            <div>
              <label for="massMargin">Margin</label>
              <select id="massMargin">
                <option value="circumscribed">Circumscribed</option>
                <option value="irregular">Not circumscribed (irregular)</option>
                <option value="spiculated">Not circumscribed (spiculated)</option>
              </select>
            </div>
            <div>
              <label for="massInternal">Internal enhancement</label>
              <select id="massInternal">
                <option value="homogeneous internal enhancement">Homogeneous</option>
                <option value="heterogeneous internal enhancement">Heterogeneous</option>
                <option value="rim enhancement">Rim enhancement</option>
                <option value="dark (non-enhancing) internal septations">Dark internal septations</option>
              </select>
            </div>
            <div>
              <label for="massT2">T2/STIR correlate</label>
              <select id="massT2">
                <option value="T2 hyperintense">T2 hyperintense</option>
                <option value="not T2 hyperintense">Not T2 hyperintense</option>
                <option value="">— omit —</option>
              </select>
            </div>
          </div>
        </details>
      </div>

      <!-- NME -->
      <div id="nmeFields" style="display:none">
        <details open>
          <summary>Non-mass enhancement (NME) morphology</summary>
          <div class="grid" style="margin-top:10px">
            <div>
              <label for="nmeDist">Distribution</label>
              <select id="nmeDist">
                <option value="focal">Focal</option>
                <option value="linear">Linear</option>
                <option value="segmental">Segmental</option>
                <option value="regional">Regional</option>
                <option value="multiple regions">Multiple regions</option>
                <option value="diffuse">Diffuse</option>
              </select>
            </div>
            <div>
              <label for="nmePattern">Internal enhancement pattern</label>
              <select id="nmePattern">
                <option value="homogeneous">Homogeneous</option>
                <option value="heterogeneous">Heterogeneous</option>
                <option value="clumped">Clumped</option>
                <option value="clustered ring">Clustered ring</option>
              </select>
            </div>
            <div>
              <label for="nmeT2">T2/STIR correlate</label>
              <select id="nmeT2">
                <option value="T2 hyperintense">T2 hyperintense</option>
                <option value="not T2 hyperintense">Not T2 hyperintense</option>
                <option value="">— omit —</option>
              </select>
            </div>
            <div>
              <label for="nmeExtent">Extent phrase (optional)</label>
              <select id="nmeExtent">
                <option value="">—</option>
                <option value="spanning from anterior to posterior breast tissue">Spanning anterior-to-posterior</option>
                <option value="centered at nipple level">Centered at nipple level</option>
                <option value="with ductal distribution">With ductal distribution</option>
              </select>
            </div>
          </div>
        </details>
      </div>

      <!-- KINETICS -->
      <details open>
        <summary>Kinetics (supporting language)</summary>
        <div class="grid" style="margin-top:10px">
          <div>
            <label for="kinInit">Initial phase</label>
            <select id="kinInit">
              <option value="">— omit —</option>
              <option value="slow initial enhancement">Slow</option>
              <option value="medium initial enhancement">Medium</option>
              <option value="fast initial enhancement">Fast</option>
            </select>
          </div>
          <div>
            <label for="kinDel">Delayed phase</label>
            <select id="kinDel">
              <option value="">— omit —</option>
              <option value="persistent kinetics">Persistent</option>
              <option value="plateau kinetics">Plateau</option>
              <option value="washout kinetics">Washout</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <span class="pill">
            <input id="includeMorphOverKin" type="checkbox" />
            <label for="includeMorphOverKin" style="margin:0;color:var(--text)">Add sentence: “Morphology is prioritized over kinetics.”</label>
          </span>
        </div>
      </details>

      <!-- OPTIONAL EXTRA -->
      <details>
        <summary>Optional add-ons (lesion-adjacent only)</summary>
        <div class="grid" style="margin-top:10px">
          <div>
            <label for="adjacent">Associated/adjacent feature phrase (optional)</label>
            <select id="adjacent">
              <option value="">—</option>
              <option value="with associated architectural distortion">Architectural distortion</option>
              <option value="with associated skin thickening">Skin thickening</option>
              <option value="with associated skin enhancement">Skin enhancement</option>
              <option value="with associated nipple retraction">Nipple retraction</option>
              <option value="abutting the pectoralis muscle">Abutting pectoralis muscle</option>
              <option value="with suspected pectoralis involvement">Suspected pectoralis involvement</option>
              <option value="with suspected chest wall involvement">Suspected chest wall involvement</option>
            </select>
            <div class="small">Keep this limited to lesion-adjacent descriptors; omit global exam findings.</div>
          </div>

          <div>
            <label for="freeText">Free-text addendum (optional, appended)</label>
            <input id="freeText" type="text" placeholder="e.g., “correlate with second-look ultrasound” (if you want it included)" />
          </div>
        </div>
      </details>

      <div id="validation" class="warn" style="display:none"></div>

      <div class="btns">
        <button class="good" id="btnGenerate" type="button">Generate description</button>
        <button class="secondary" id="btnCopy" type="button">Copy</button>
        <button class="secondary" id="btnClear" type="button">Clear</button>
      </div>

      <div class="hint">
        Tip: Press <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> to generate.
      </div>
    </div>
  </section>

  <!-- OUTPUT -->
  <section class="card">
    <div class="hd">
      <div class="title">Generated lesion description</div>
      <div class="status" id="status">Ready.</div>
    </div>
    <div class="bd outbox">
      <textarea id="output" placeholder="Generated text will appear here..."></textarea>
      <div class="small">
        Output is intentionally “lesion-only.” Add BI-RADS assessment/management elsewhere as needed.
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  const stateKey = "breast_mri_lesion_descriptor_builder_v1";

  const els = {
    autosave: $("autosave"),
    preset: $("preset"),
    lesionType: $("lesionType"),
    laterality: $("laterality"),

    locQuadrant: $("locQuadrant"),
    locClock: $("locClock"),
    quadrantBox: $("quadrantBox"),
    clockBox: $("clockBox"),
    quadrant: $("quadrant"),
    clockPos: $("clockPos"),
    clockDist: $("clockDist"),
    zone: $("zone"),
    depth: $("depth"),
    distSkin: $("distSkin"),
    distChest: $("distChest"),

    m1: $("m1"),
    m2: $("m2"),
    m3: $("m3"),
    series: $("series"),
    image: $("image"),

    focusFields: $("focusFields"),
    focusUniqueness: $("focusUniqueness"),
    focusChange: $("focusChange"),
    focusT2: $("focusT2"),
    focusNote: $("focusNote"),

    massFields: $("massFields"),
    massShape: $("massShape"),
    massMargin: $("massMargin"),
    massInternal: $("massInternal"),
    massT2: $("massT2"),

    nmeFields: $("nmeFields"),
    nmeDist: $("nmeDist"),
    nmePattern: $("nmePattern"),
    nmeT2: $("nmeT2"),
    nmeExtent: $("nmeExtent"),

    kinInit: $("kinInit"),
    kinDel: $("kinDel"),
    includeMorphOverKin: $("includeMorphOverKin"),

    adjacent: $("adjacent"),
    freeText: $("freeText"),

    validation: $("validation"),
    btnGenerate: $("btnGenerate"),
    btnCopy: $("btnCopy"),
    btnClear: $("btnClear"),
    output: $("output"),
    status: $("status"),
  };

  function show(el, on){ el.style.display = on ? "" : "none"; }

  function setStatus(msg){
    els.status.textContent = msg;
  }

  function valNum(x){
    const n = parseFloat(x);
    return Number.isFinite(n) ? n : null;
  }

  function measurementString(){
    const a = valNum(els.m1.value);
    const b = valNum(els.m2.value);
    const c = valNum(els.m3.value);

    const parts = [];
    if (a !== null) parts.push(a);
    if (b !== null) parts.push(b);
    if (c !== null) parts.push(c);

    if (parts.length === 0) return "";
    if (parts.length === 1) return `${parts[0]} mm`;
    return `${parts.join(" x ")} mm`;
  }

  function bestSeenString(){
    const s = els.series.value.trim();
    const i = els.image.value.trim();
    if (!s && !i) return "";
    if (s && i) return `best seen on ${s}, ${i}`;
    if (s) return `best seen on ${s}`;
    return `best seen on ${i}`;
  }

  function locationString(){
    const lat = els.laterality.value;
    const zone = els.zone.value ? `${els.zone.value} ` : "";
    const depth = els.depth.value;

    let region = "";
    const mode = document.querySelector('input[name="locMode"]:checked')?.value || "quadrant";
    if (mode === "quadrant"){
      region = els.quadrant.value;
    } else {
      const cp = els.clockPos.value;
      const d = valNum(els.clockDist.value);
      region = `${cp}:00 position`;
      if (d !== null && d > 0) region += `, ${d} cm from the nipple`;
    }

    const distSkin = valNum(els.distSkin.value);
    const distChest = valNum(els.distChest.value);
    const distParts = [];
    if (distSkin !== null && distSkin > 0) distParts.push(`${distSkin} cm from the skin`);
    if (distChest !== null && distChest > 0) distParts.push(`${distChest} cm from the chest wall`);
    const distPhrase = distParts.length ? `, ${distParts.join(", ")}` : "";

    return `In the ${lat} breast at ${zone}${region}, ${depth}${distPhrase}`;
  }

  function kineticsString(){
    const init = els.kinInit.value;
    const del  = els.kinDel.value;

    if (!init && !del) return "";
    if (init && del) return `demonstrating ${init} with ${del}`;
    if (init) return `demonstrating ${init}`;
    return `demonstrating ${del}`;
  }

  function sentenceCap(s){
    if (!s) return s;
    return s.charAt(0).toUpperCase() + s.slice(1);
  }

  function buildDescription(){
    const type = els.lesionType.value;
    const loc = locationString();
    const meas = measurementString();
    const best = bestSeenString();
    const kin  = kineticsString();
    const adjacent = els.adjacent.value;
    const freeText = els.freeText.value.trim();

    // Validation + warnings
    const warnings = [];
    let isHardError = false;

    if (type === "focus"){
      const a = valNum(els.m1.value);
      const b = valNum(els.m2.value);
      const c = valNum(els.m3.value);
      const sizes = [a,b,c].filter(v=>v!==null);
      if (sizes.length === 0){
        warnings.push("Focus selected: consider entering a single size in mm (e.g., 4).");
      } else {
        const max = Math.max(...sizes);
        if (max >= 5){
          warnings.push("Focus selected but size is ≥ 5 mm; consider classifying as a small mass if it is space-occupying / characterizable.");
        }
      }
    }

    if (type !== "focus"){
      const sizes = [valNum(els.m1.value), valNum(els.m2.value), valNum(els.m3.value)].filter(v=>v!==null);
      if (sizes.length === 0){
        warnings.push("Consider adding lesion measurements in mm.");
      }
    }

    // Build lesion-specific clause
    let lesionClause = "";
    if (type === "focus"){
      const uniq = els.focusUniqueness.value;
      const change = els.focusChange.value;
      const t2 = els.focusT2.value;
      const note = els.focusNote.value;

      lesionClause = `there is an enhancing focus`;
      if (meas) lesionClause += ` measuring ${meas}`;
      const mods = [];
      if (uniq) mods.push(uniq.toLowerCase());
      if (change) mods.push(change.toLowerCase());
      if (t2) mods.push(t2);
      if (note) mods.push(note.toLowerCase());
      if (mods.length) lesionClause += `, ${mods.join(", ")}`;
    }

    if (type === "mass"){
      const shape = els.massShape.value;
      const marginVal = els.massMargin.value; // values already contain words
      const internal = els.massInternal.value;
      const t2 = els.massT2.value;

      const marginPhrase = (marginVal === "circumscribed") ? "circumscribed margin" :
                           (marginVal === "irregular") ? "not circumscribed margin (irregular)" :
                           "not circumscribed margin (spiculated)";

      lesionClause = `there is an enhancing mass`;
      if (meas) lesionClause += ` measuring ${meas}`;
      lesionClause += ` with ${shape} shape, ${marginPhrase}, and ${internal}`;
      if (t2) lesionClause += `, ${t2}`;
    }

    if (type === "nme"){
      const dist = els.nmeDist.value;
      const pattern = els.nmePattern.value;
      const t2 = els.nmeT2.value;
      const extent = els.nmeExtent.value;

      lesionClause = `there is non-mass enhancement`;
      if (meas) lesionClause += ` spanning ${meas}`;
      lesionClause += ` with ${dist} distribution and ${pattern} internal enhancement pattern`;
      if (extent) lesionClause += `, ${extent}`;
      if (t2) lesionClause += `, ${t2}`;
    }

    // Assemble main sentence
    let s1 = `${loc}, ${lesionClause}`;
    if (adjacent) s1 += `, ${adjacent}`;
    if (kin) s1 += `, ${kin}`;
    if (best) s1 += `, ${best}`;
    s1 += `.`;

    // Optional morphology-over-kinetics sentence
    let s2 = "";
    if (els.includeMorphOverKin.checked){
      s2 = `Morphology is prioritized over kinetics.`;
    }

    // Free-text addendum
    let s3 = "";
    if (freeText){
      s3 = freeText.endsWith(".") ? freeText : (freeText + ".");
    }

    // Show validation box if warnings exist
    if (warnings.length){
      els.validation.innerHTML = "<b>Notes:</b><br>" + warnings.map(w=>`• ${w}`).join("<br>");
      show(els.validation, true);
    } else {
      show(els.validation, false);
      els.validation.textContent = "";
    }

    return [sentenceCap(s1), s2, s3].filter(Boolean).join("\n");
  }

  function updateTypeVisibility(){
    const type = els.lesionType.value;
    show(els.focusFields, type === "focus");
    show(els.massFields, type === "mass");
    show(els.nmeFields, type === "nme");
    setStatus("Ready.");
  }

  function updateLocModeVisibility(){
    const mode = document.querySelector('input[name="locMode"]:checked')?.value || "quadrant";
    show(els.quadrantBox, mode === "quadrant");
    show(els.clockBox, mode === "clock");
  }

  function saveState(){
    if (!els.autosave.checked) return;
    const payload = {};
    const ids = Object.keys(els).filter(k => ["validation","btnGenerate","btnCopy","btnClear","output","status","quadrantBox","clockBox","focusFields","massFields","nmeFields"].indexOf(k) === -1);
    // store inputs/selects/checkbox/radios
    const inputs = document.querySelectorAll("input, select, textarea");
    inputs.forEach(el=>{
      if (!el.id && el.name) return; // radios handled below
      if (el.type === "checkbox") payload[el.id] = !!el.checked;
      else if (el.type === "radio") payload[el.id] = !!el.checked;
      else payload[el.id] = el.value;
    });
    localStorage.setItem(stateKey, JSON.stringify(payload));
  }

  function loadState(){
    const raw = localStorage.getItem(stateKey);
    if (!raw) return;
    let payload = null;
    try { payload = JSON.parse(raw); } catch { return; }
    if (!payload) return;

    const inputs = document.querySelectorAll("input, select, textarea");
    inputs.forEach(el=>{
      if (!(el.id in payload)) return;
      if (el.type === "checkbox" || el.type === "radio") el.checked = !!payload[el.id];
      else el.value = payload[el.id];
    });

    updateLocModeVisibility();
    updateTypeVisibility();
  }

  function clearAll(){
    // Reset selects/inputs (preserve autosave checked state)
    const keepAutosave = els.autosave.checked;
    document.querySelectorAll("input, select, textarea").forEach(el=>{
      if (el === els.autosave) return;
      if (el.type === "checkbox" || el.type === "radio") el.checked = false;
      else el.value = "";
    });

    // restore defaults
    els.autosave.checked = keepAutosave;
    els.lesionType.value = "focus";
    els.laterality.value = "right";
    els.locQuadrant.checked = true;
    els.quadrant.value = "upper outer quadrant";
    els.depth.value = "posterior depth";
    els.focusNote.value = "not further characterizable";
    els.output.value = "";
    els.includeMorphOverKin.checked = false;

    show(els.validation, false);
    updateLocModeVisibility();
    updateTypeVisibility();
    saveState();
    setStatus("Cleared.");
  }

  function applyPreset(kind){
    if (!kind) return;

    // baseline: clear lesion-specific fields but keep location defaults
    els.focusUniqueness.value = "";
    els.focusChange.value = "";
    els.focusT2.value = "";
    els.massShape.value = "oval";
    els.massMargin.value = "circumscribed";
    els.massInternal.value = "homogeneous internal enhancement";
    els.massT2.value = "T2 hyperintense";
    els.nmeDist.value = "focal";
    els.nmePattern.value = "homogeneous";
    els.nmeT2.value = "T2 hyperintense";
    els.nmeExtent.value = "";
    els.kinInit.value = "";
    els.kinDel.value = "";
    els.adjacent.value = "";
    els.freeText.value = "";
    els.includeMorphOverKin.checked = false;

    if (kind === "focus_probably_benign"){
      els.lesionType.value = "focus";
      els.m1.value = "4";
      els.m2.value = "";
      els.m3.value = "";
      els.focusUniqueness.value = "unique from background parenchymal enhancement";
      els.focusChange.value = "stable";
      els.focusT2.value = "T2 hyperintense";
      els.kinInit.value = "slow initial enhancement";
      els.kinDel.value = "persistent kinetics";
    }

    if (kind === "mass_fibroadenoma_like"){
      els.lesionType.value = "mass";
      els.m1.value = "12";
      els.m2.value = "8";
      els.m3.value = "";
      els.massShape.value = "oval";
      els.massMargin.value = "circumscribed";
      els.massInternal.value = "dark (non-enhancing) internal septations";
      els.massT2.value = "T2 hyperintense";
      els.kinInit.value = "medium initial enhancement";
      els.kinDel.value = "persistent kinetics";
    }

    if (kind === "mass_suspicious"){
      els.lesionType.value = "mass";
      els.m1.value = "10";
      els.m2.value = "9";
      els.m3.value = "8";
      els.massShape.value = "irregular";
      els.massMargin.value = "spiculated";
      els.massInternal.value = "rim enhancement";
      els.massT2.value = "not T2 hyperintense";
      els.kinInit.value = "fast initial enhancement";
      els.kinDel.value = "washout kinetics";
      els.includeMorphOverKin.checked = true;
    }

    if (kind === "nme_suspicious"){
      els.lesionType.value = "nme";
      els.m1.value = "35";
      els.m2.value = "18";
      els.m3.value = "";
      els.nmeDist.value = "segmental";
      els.nmePattern.value = "clustered ring";
      els.nmeT2.value = "not T2 hyperintense";
      els.kinInit.value = "fast initial enhancement";
      els.kinDel.value = "plateau kinetics";
      els.includeMorphOverKin.checked = true;
    }

    updateTypeVisibility();
    saveState();
    setStatus("Preset applied.");
  }

  // Event wiring
  els.lesionType.addEventListener("change", ()=>{ updateTypeVisibility(); saveState(); });
  document.querySelectorAll('input[name="locMode"]').forEach(r=>{
    r.addEventListener("change", ()=>{ updateLocModeVisibility(); saveState(); });
  });

  document.addEventListener("input", (e)=>{
    if (e.target && (e.target.matches("input") || e.target.matches("select") || e.target.matches("textarea"))){
      if (e.target.id === "output") return; // don't autosave output edits
      saveState();
    }
  });

  els.preset.addEventListener("change", ()=>{
    applyPreset(els.preset.value);
    els.preset.value = "";
  });

  els.btnGenerate.addEventListener("click", ()=>{
    const text = buildDescription();
    els.output.value = text;
    setStatus("Generated.");
    saveState();
  });

  els.btnCopy.addEventListener("click", async ()=>{
    const text = els.output.value.trim();
    if (!text){
      setStatus("Nothing to copy.");
      return;
    }
    try{
      await navigator.clipboard.writeText(text);
      setStatus("Copied.");
    }catch{
      // Fallback
      els.output.focus();
      els.output.select();
      document.execCommand("copy");
      setStatus("Copied (fallback).");
    }
  });

  els.btnClear.addEventListener("click", clearAll);

  // Keyboard shortcut: Ctrl+Enter
  document.addEventListener("keydown", (e)=>{
    if (e.ctrlKey && e.key === "Enter"){
      e.preventDefault();
      els.btnGenerate.click();
    }
  });

  // Init
  loadState();
  updateLocModeVisibility();
  updateTypeVisibility();
})();
</script>
</body>
</html>
