<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Q/A/Explanation Scroller</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#253047;
      --accent:#60a5fa;
      --warn:#f59e0b;
    }
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-text-size-adjust:100%;
    }
    .topbar{
      position:sticky;
      top:0;
      z-index:10;
      background:rgba(11,15,23,0.92);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--line);
      padding:8px 10px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .pill{
      border:1px solid var(--line);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .pill[aria-pressed="true"]{
      border-color:rgba(96,165,250,0.55);
      box-shadow:0 0 0 2px rgba(96,165,250,0.15) inset;
    }
    .pill.secondary{
      color:var(--muted);
    }
    .pill.primary{
      border-color:rgba(96,165,250,0.55);
    }
    .spacer{flex:1}
    .badge{
      color:var(--muted);
      font-size:12px;
      padding:0 6px;
    }

    .wrap{
      max-width:960px;
      margin:0 auto;
      padding:12px 10px 40px;
    }

    textarea{
      width:100%;
      min-height:180px;
      resize:vertical;
      border:1px solid var(--line);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      color:var(--text);
      border-radius:12px;
      padding:12px;
      outline:none;
      font-size:16px;
    }
    textarea:focus{
      border-color:rgba(96,165,250,0.65);
      box-shadow:0 0 0 3px rgba(96,165,250,0.12);
    }
    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:10px 0 14px;
      align-items:center;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border-radius:14px;
      padding:12px;
    }
    .cardHeader{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .qText{
      flex:1;
      font-size:15px;
      font-weight:650;
      letter-spacing:0.1px;
      white-space:pre-wrap;
    }
    .favBtn{
      border:1px solid var(--line);
      background:transparent;
      color:var(--muted);
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      user-select:none;
      line-height:1;
    }
    .delBtn{
      border:1px solid rgba(239,68,68,0.4);
      background:transparent;
      color:rgba(239,68,68,0.8);
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      user-select:none;
      line-height:1;
    }
    .delBtn.deleted{
      color:#fecaca;
      background:rgba(239,68,68,0.18);
      border-color:rgba(239,68,68,0.8);
      box-shadow:0 0 0 2px rgba(239,68,68,0.12) inset;
    }
    .favBtn.faved{
      color:var(--warn);
      border-color:rgba(245,158,11,0.55);
      box-shadow:0 0 0 2px rgba(245,158,11,0.12) inset;
    }
    details{
      border-top:1px solid rgba(37,48,71,0.7);
      margin-top:10px;
      padding-top:10px;
    }
    summary{
      cursor:pointer;
      user-select:none;
      color:var(--accent);
      font-weight:650;
      outline:none;
      list-style:none;
    }
    summary::-webkit-details-marker{display:none}
    .content{
      margin-top:8px;
      color:var(--text);
      white-space:pre-wrap;
    }
    .empty{
      border:1px dashed var(--line);
      color:var(--muted);
      border-radius:14px;
      padding:14px;
      margin-top:12px;
    }
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(17,24,39,0.95);
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 14px;
      color:var(--text);
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity 180ms ease;
      z-index:20;
    }
    .toast.show{opacity:1}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .panel{
      border:1px solid var(--line);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border-radius:14px;
      padding:12px;
      margin-top:12px;
      display:none;
    }
    .panel.show{display:block;}
    .dropdownPanel{
      position:absolute;
      top:58px;
      right:10px;
      left:10px;
      width:auto;
      max-width:520px;
      margin:0;
      z-index:15;
      max-height:60vh;
      overflow:auto;
      box-shadow:0 12px 30px rgba(0,0,0,0.35);
    }
    .dropdownPanel.alignRight{
      left:auto;
    }
    .panelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .panelTitle{
      font-weight:650;
    }
    .panelList{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .panelRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      border:1px solid rgba(37,48,71,0.7);
      border-radius:10px;
      padding:8px 10px;
    }
    .panelMeta{
      color:var(--muted);
      font-size:12px;
    }
    .toggleRow{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <button id="toggleFavView" class="pill" aria-pressed="false" title="Show only favorites">Favorites only</button>
    <button id="toggleAllView" class="pill" aria-pressed="false" title="Show deleted items">All view</button>
    <button id="copyBtn" class="pill primary" title="Copy items">Copy</button>
    <button id="togglePriors" class="pill secondary" title="View saved priors">Priors</button>
    <span class="spacer"></span>
    <span id="counts" class="badge">0 items</span>
  </div>

  <div class="wrap">
    <textarea id="input" placeholder="Paste your content here (Question:/Answer:/Explanation: blocks)"></textarea>

    <div class="controls">
      <button id="parseBtn" class="pill primary">Parse / Refresh</button>
      <button id="loadSampleBtn" class="pill secondary">Load sample (from this page)</button>
      <button id="clearBtn" class="pill secondary">Clear</button>
      <span class="hint">
        Expected blocks: <span class="mono">Question:</span> … <span class="mono">Answer:</span> … <span class="mono">Explanation:</span> …
        (lines like <span class="mono">5, 4, 3, 2, 1.</span> and <span class="mono">[attachment_#]</span> are ignored)
      </span>
    </div>

    <div id="list" class="list"></div>
    <div id="empty" class="empty" style="display:none">No questions parsed yet.</div>

  </div>

  <div id="priorsPanel" class="panel dropdownPanel alignRight">
    <div class="panelHeader">
      <div class="panelTitle">Saved priors</div>
      <span class="panelMeta" id="priorsMeta">0 saved</span>
    </div>
    <div id="priorsList" class="panelList"></div>
  </div>

  <div id="copyPanel" class="panel dropdownPanel">
    <div class="panelHeader">
      <div class="panelTitle">Copy options</div>
      <span class="panelMeta">Choose what to copy</span>
    </div>
    <div class="panelList">
      <button id="copyAllBtn" class="pill secondary" type="button">Copy all</button>
      <button id="copyAllVisibleBtn" class="pill secondary" type="button">Copy all (not deleted)</button>
      <button id="copyFavsBtn" class="pill secondary" type="button">Copy favorites</button>
    </div>
    <label class="toggleRow">
      <input id="countdownToggle" type="checkbox" /> Include 5-4-3-2-1 countdown
    </label>
  </div>

  <div id="toast" class="toast"></div>

<script>
(() => {
  const els = {
    input: document.getElementById('input'),
    parseBtn: document.getElementById('parseBtn'),
    loadSampleBtn: document.getElementById('loadSampleBtn'),
    clearBtn: document.getElementById('clearBtn'),
    list: document.getElementById('list'),
    empty: document.getElementById('empty'),
    toggleFavView: document.getElementById('toggleFavView'),
    toggleAllView: document.getElementById('toggleAllView'),
    copyBtn: document.getElementById('copyBtn'),
    copyPanel: document.getElementById('copyPanel'),
    copyAllBtn: document.getElementById('copyAllBtn'),
    copyAllVisibleBtn: document.getElementById('copyAllVisibleBtn'),
    copyFavsBtn: document.getElementById('copyFavsBtn'),
    countdownToggle: document.getElementById('countdownToggle'),
    togglePriors: document.getElementById('togglePriors'),
    priorsPanel: document.getElementById('priorsPanel'),
    priorsList: document.getElementById('priorsList'),
    priorsMeta: document.getElementById('priorsMeta'),
    counts: document.getElementById('counts'),
    toast: document.getElementById('toast'),
  };

  const STORAGE = {
    favs: 'qa_favorites_v1',
    deleted: 'qa_deleted_v1',
    lastInput: 'qa_last_input_v1',
    priors: 'qa_priors_v1',
    includeCountdown: 'qa_copy_countdown_v1'
  };

  const TITLE_EXCLUDE_WORDS = [
    'question',
    'explanation',
    'radiographic',
    'characteristic'
  ];

  let state = {
    items: [],
    favSet: new Set(),
    deletedSet: new Set(),
    favOnly: false,
    showAll: false,
    priors: [],
    activePriorId: null,
  };

  function showToast(msg){
    els.toast.textContent = msg;
    els.toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => els.toast.classList.remove('show'), 1400);
  }

  function safeIdFromQuestion(q){
    // Simple deterministic id (not crypto): normalize and hash.
    const s = (q || '').trim().toLowerCase().replace(/\s+/g,' ');
    let h = 2166136261;
    for (let i=0; i<s.length; i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return 'q_' + (h >>> 0).toString(16);
  }

  function loadFavs(){
    try{
      const raw = localStorage.getItem(STORAGE.favs);
      if (!raw) return;
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) state.favSet = new Set(arr);
    }catch(e){}
  }

  function loadDeleted(){
    try{
      const raw = localStorage.getItem(STORAGE.deleted);
      if (!raw) return;
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) state.deletedSet = new Set(arr);
    }catch(e){}
  }

  function saveFavs(){
    try{
      localStorage.setItem(STORAGE.favs, JSON.stringify(Array.from(state.favSet)));
    }catch(e){}
  }

  function saveDeleted(){
    try{
      localStorage.setItem(STORAGE.deleted, JSON.stringify(Array.from(state.deletedSet)));
    }catch(e){}
  }

  function saveLastInput(){
    try{
      localStorage.setItem(STORAGE.lastInput, els.input.value || '');
    }catch(e){}
  }

  function loadLastInput(){
    try{
      const v = localStorage.getItem(STORAGE.lastInput);
      if (v) els.input.value = v;
    }catch(e){}
  }

  function loadPriors(){
    try{
      const raw = localStorage.getItem(STORAGE.priors);
      if (!raw) return;
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) state.priors = arr;
    }catch(e){}
  }

  function savePriors(){
    try{
      localStorage.setItem(STORAGE.priors, JSON.stringify(state.priors));
    }catch(e){}
  }

  function setActivePrior(id){
    state.activePriorId = id || null;
  }

  function syncActivePrior(options = {}){
    if (!state.activePriorId) return;
    const prior = state.priors.find(item => item.id === state.activePriorId);
    if (!prior) return;
    prior.rawInput = els.input.value || '';
    if (options.includeItems !== false) prior.items = state.items;
    prior.favIds = Array.from(state.favSet);
    prior.deletedIds = Array.from(state.deletedSet);
    savePriors();
    if (els.priorsPanel.classList.contains('show')) renderPriors();
  }

  function loadCopyCountdown(){
    try{
      const raw = localStorage.getItem(STORAGE.includeCountdown);
      if (raw === null) return;
      els.countdownToggle.checked = raw === 'true';
    }catch(e){}
  }

  function saveCopyCountdown(){
    try{
      localStorage.setItem(STORAGE.includeCountdown, els.countdownToggle.checked ? 'true' : 'false');
    }catch(e){}
  }

  function isIgnorableLine(line){
    const t = line.trim();
    if (!t) return false;

    // rating lines like "5, 4, 3, 2, 1." or "5,4,3,2,1"
    if (/^\d\s*,\s*\d\s*,\s*\d\s*,\s*\d\s*,\s*\d\s*\.?\s*$/.test(t)) return true;

    // attachment markers like "[attachment_0](attachment)" or "[attachment_0]"
    if (/^\[attachment_\d+\](\(.+\))?\s*$/.test(t)) return true;

    return false;
  }

  function parseInput(raw){
    const text = (raw || '').replace(/\r\n/g, '\n');
    const lines = text.split('\n');

    const items = [];
    let cur = null;
    let mode = null; // 'q' | 'a' | 'e'

    function pushCur(){
      if (!cur) return;
      const q = (cur.question || '').trim();
      const a = (cur.answer || '').trim();
      const e = (cur.explanation || '').trim();

      if (!q) return;

      const id = safeIdFromQuestion(q);
      items.push({ id, question: q, answer: a, explanation: e });
    }

    for (let i=0; i<lines.length; i++){
      const line = lines[i];

      if (isIgnorableLine(line)) continue;

      const trimmed = line.trim();

      // Detect field headers (case sensitive as provided, but allow mild variance)
      const mQ = /^Question:\s*(.*)\s*$/.exec(line);
      const mA = /^Answer:\s*(.*)\s*$/.exec(line);
      const mE = /^Explanation:\s*(.*)\s*$/.exec(line);

      if (mQ){
        // new question starts -> push previous
        pushCur();
        cur = { question: mQ[1] || '', answer: '', explanation: '' };
        mode = 'q';
        continue;
      }
      if (mA){
        if (!cur) cur = { question: '', answer: '', explanation: '' };
        cur.answer = (mA[1] || '');
        mode = 'a';
        continue;
      }
      if (mE){
        if (!cur) cur = { question: '', answer: '', explanation: '' };
        cur.explanation = (mE[1] || '');
        mode = 'e';
        continue;
      }

      // Ignore stray attachment markdown lines even if they don't match earlier regex
      if (/^\s*\[attachment_\d+\]/.test(trimmed)) continue;

      // Accumulate multiline content
      if (cur && mode){
        // Skip lines that are only punctuation
        if (/^\s*[.·•-]\s*$/.test(line)) continue;

        if (mode === 'q') cur.question += (cur.question ? '\n' : '') + line;
        if (mode === 'a') cur.answer += (cur.answer ? '\n' : '') + line;
        if (mode === 'e') cur.explanation += (cur.explanation ? '\n' : '') + line;
      }
    }

    pushCur();
    return items;
  }

  function render(){
    const itemsAll = state.items;
    const baseItems = state.showAll
      ? itemsAll
      : itemsAll.filter(it => !state.deletedSet.has(it.id));
    const items = state.favOnly
      ? baseItems.filter(it => state.favSet.has(it.id))
      : baseItems;

    els.list.innerHTML = '';
    els.empty.style.display = items.length ? 'none' : 'block';

    const total = itemsAll.length;
    const favCount = state.favSet.size;
    const deletedCount = state.deletedSet.size;

    if (state.favOnly){
      els.counts.textContent = `${items.length} favorites shown (of ${total})`;
    }else if (state.showAll){
      els.counts.textContent = `${total} items (${favCount} favorites, ${deletedCount} deleted)`;
    }else{
      const visibleCount = items.length;
      els.counts.textContent = `${visibleCount} items shown (${favCount} favorites, ${deletedCount} deleted)`;
    }

    for (const it of items){
      const card = document.createElement('div');
      card.className = 'card';

      const head = document.createElement('div');
      head.className = 'cardHeader';

      const q = document.createElement('div');
      q.className = 'qText';
      q.textContent = it.question;

      const fav = document.createElement('button');
      fav.className = 'favBtn' + (state.favSet.has(it.id) ? ' faved' : '');
      fav.type = 'button';
      fav.title = 'Toggle favorite';
      fav.textContent = state.favSet.has(it.id) ? '★' : '☆';

      fav.addEventListener('click', () => {
        if (state.favSet.has(it.id)) state.favSet.delete(it.id);
        else state.favSet.add(it.id);
        saveFavs();
        syncActivePrior();
        render();
      });

      const del = document.createElement('button');
      del.className = 'delBtn' + (state.deletedSet.has(it.id) ? ' deleted' : '');
      del.type = 'button';
      del.title = 'Toggle deleted';
      del.textContent = '✕';

      del.addEventListener('click', () => {
        if (state.deletedSet.has(it.id)) state.deletedSet.delete(it.id);
        else state.deletedSet.add(it.id);
        saveDeleted();
        syncActivePrior();
        render();
      });

      head.appendChild(q);
      head.appendChild(fav);
      head.appendChild(del);

      const ans = document.createElement('details');
      const ansSum = document.createElement('summary');
      ansSum.textContent = 'Answer';
      const ansBody = document.createElement('div');
      ansBody.className = 'content';
      ansBody.textContent = it.answer || '(No answer parsed.)';
      ans.appendChild(ansSum);
      ans.appendChild(ansBody);

      const exp = document.createElement('details');
      const expSum = document.createElement('summary');
      expSum.textContent = 'Explanation';
      const expBody = document.createElement('div');
      expBody.className = 'content';
      expBody.textContent = it.explanation || '(No explanation parsed.)';
      exp.appendChild(expSum);
      exp.appendChild(expBody);

      card.appendChild(head);
      card.appendChild(ans);
      card.appendChild(exp);

      els.list.appendChild(card);
    }
  }

  function formatItemsText(items, includeCountdown){
    if (!items.length) return '';

    return items.map(it => {
      const parts = [];
      parts.push(`Question: ${it.question}`);
      if (includeCountdown) parts.push('5, 4, 3, 2, 1.');
      parts.push(`Answer: ${it.answer || ''}`);
      parts.push(`Explanation: ${it.explanation || ''}`);
      return parts.join('\n');
    }).join('\n\n');
  }

  async function copyTextToClipboard(text){
    // Prefer modern clipboard API; fallback to hidden textarea.
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      try{
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        ta.style.top = '0';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      }catch(_){
        return false;
      }
    }
  }

  function parseAndRender(){
    const raw = els.input.value || '';
    state.items = parseInput(raw);
    // Keep favorites for items that still exist (optional cleanup)
    const ids = new Set(state.items.map(x => x.id));
    state.favSet = new Set(Array.from(state.favSet).filter(id => ids.has(id)));
    state.deletedSet = new Set(Array.from(state.deletedSet).filter(id => ids.has(id)));
    saveFavs();
    saveDeleted();
    saveLastInput();
    storePrior(raw);
    render();
    showToast(`Parsed ${state.items.length} question(s).`);
  }

  function pickTopWords(raw){
    const words = (raw || '')
      .toLowerCase()
      .match(/[a-z]{7,}/g) || [];
    const counts = new Map();
    for (const w of words){
      if (TITLE_EXCLUDE_WORDS.includes(w)) continue;
      counts.set(w, (counts.get(w) || 0) + 1);
    }
    const sorted = Array.from(counts.entries())
      .sort((a,b) => b[1] - a[1])
      .slice(0,2)
      .map(([w]) => w);
    return sorted;
  }

  function formatPriorLabel(words){
    if (!words.length) return 'etc';
    return `${words.join(', ')}, etc`;
  }

  function storePrior(raw){
    const trimmed = (raw || '').trim();
    if (!trimmed) return;
    const createdAt = new Date().toISOString();
    const displayDate = new Date().toLocaleString();
    const words = pickTopWords(raw);
    const wordLabel = formatPriorLabel(words);
    const label = `${displayDate} — ${wordLabel}`;
    const entry = {
      id: `prior_${Date.now()}`,
      createdAt,
      label,
      name: '',
      rawInput: raw,
      items: state.items,
      favIds: Array.from(state.favSet),
      deletedIds: Array.from(state.deletedSet)
    };
    state.priors.unshift(entry);
    state.priors = state.priors.slice(0, 25);
    savePriors();
    renderPriors();
    setActivePrior(entry.id);
  }

  function renderPriors(){
    els.priorsList.innerHTML = '';
    els.priorsMeta.textContent = `${state.priors.length} saved`;
    if (!state.priors.length){
      const empty = document.createElement('div');
      empty.className = 'panelMeta';
      empty.textContent = 'No priors saved yet.';
      els.priorsList.appendChild(empty);
      return;
    }
    for (const prior of state.priors){
      const row = document.createElement('div');
      row.className = 'panelRow';

      const label = document.createElement('div');
      label.textContent = (prior.name || '').trim() || prior.label;

      const meta = document.createElement('div');
      meta.className = 'panelMeta';
      meta.textContent = `${prior.items.length} items · ${prior.favIds.length} favorites · ${prior.deletedIds.length} deleted`;

      const loadBtn = document.createElement('button');
      loadBtn.className = 'pill secondary';
      loadBtn.type = 'button';
      loadBtn.textContent = 'Load';

      loadBtn.addEventListener('click', () => {
        els.input.value = prior.rawInput || '';
        state.items = prior.items || parseInput(prior.rawInput || '');
        state.favSet = new Set(prior.favIds || []);
        state.deletedSet = new Set(prior.deletedIds || []);
        saveFavs();
        saveDeleted();
        saveLastInput();
        setActivePrior(prior.id);
        render();
        showToast('Loaded prior.');
      });

      const renameBtn = document.createElement('button');
      renameBtn.className = 'pill secondary';
      renameBtn.type = 'button';
      renameBtn.textContent = 'Rename';

      renameBtn.addEventListener('click', () => {
        const currentName = (prior.name || '').trim() || prior.label;
        const nextName = window.prompt('Rename this prior:', currentName);
        if (nextName === null) return;
        prior.name = nextName.trim();
        savePriors();
        renderPriors();
        showToast(prior.name ? 'Prior renamed.' : 'Prior name cleared.');
      });

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'pill secondary';
      deleteBtn.type = 'button';
      deleteBtn.textContent = 'Delete';

      deleteBtn.addEventListener('click', () => {
        const ok = window.confirm(`Delete this prior?\n\n${prior.label}`);
        if (!ok) return;
        state.priors = state.priors.filter(item => item.id !== prior.id);
        savePriors();
        renderPriors();
        showToast('Prior deleted.');
      });

      const left = document.createElement('div');
      left.appendChild(label);
      left.appendChild(meta);

      row.appendChild(left);
      row.appendChild(loadBtn);
      row.appendChild(renameBtn);
      row.appendChild(deleteBtn);
      els.priorsList.appendChild(row);
    }
  }

  // Events
  els.parseBtn.addEventListener('click', parseAndRender);

  els.toggleFavView.addEventListener('click', () => {
    state.favOnly = !state.favOnly;
    els.toggleFavView.setAttribute('aria-pressed', state.favOnly ? 'true' : 'false');
    render();
  });

  els.toggleAllView.addEventListener('click', () => {
    state.showAll = !state.showAll;
    els.toggleAllView.setAttribute('aria-pressed', state.showAll ? 'true' : 'false');
    render();
  });

  els.togglePriors.addEventListener('click', () => {
    els.priorsPanel.classList.toggle('show');
    if (els.priorsPanel.classList.contains('show')){
      els.copyPanel.classList.remove('show');
      renderPriors();
    }
  });

  els.copyBtn.addEventListener('click', () => {
    els.copyPanel.classList.toggle('show');
    if (els.copyPanel.classList.contains('show')){
      els.priorsPanel.classList.remove('show');
    }
  });

  els.countdownToggle.addEventListener('change', saveCopyCountdown);

  els.copyAllBtn.addEventListener('click', async () => {
    const text = formatItemsText(state.items, els.countdownToggle.checked);
    if (!text){
      showToast('No items to copy.');
      return;
    }
    const ok = await copyTextToClipboard(text);
    showToast(ok ? 'All items copied.' : 'Copy failed.');
  });

  els.copyAllVisibleBtn.addEventListener('click', async () => {
    const items = state.items.filter(it => !state.deletedSet.has(it.id));
    const text = formatItemsText(items, els.countdownToggle.checked);
    if (!text){
      showToast('No visible items to copy.');
      return;
    }
    const ok = await copyTextToClipboard(text);
    showToast(ok ? 'Visible items copied.' : 'Copy failed.');
  });

  els.copyFavsBtn.addEventListener('click', async () => {
    const items = state.items.filter(it => state.favSet.has(it.id) && !state.deletedSet.has(it.id));
    const text = formatItemsText(items, els.countdownToggle.checked);
    if (!text){
      showToast('No favorites to copy.');
      return;
    }
    const ok = await copyTextToClipboard(text);
    showToast(ok ? 'Favorites copied.' : 'Copy failed.');
  });

  els.clearBtn.addEventListener('click', () => {
    els.input.value = '';
    state.items = [];
    saveLastInput();
    syncActivePrior();
    render();
    showToast('Cleared.');
  });

  els.loadSampleBtn.addEventListener('click', () => {
    els.input.value = SAMPLE_TEXT.trim();
    parseAndRender();
  });

  els.input.addEventListener('input', () => {
    saveLastInput();
    syncActivePrior({ includeItems: false });
  });

  // Init
  loadFavs();
  loadDeleted();
  loadLastInput();
  loadPriors();
  loadCopyCountdown();
  // Auto-parse if there is stored input
  if ((els.input.value || '').trim()){
    state.items = parseInput(els.input.value);
  }
  renderPriors();
  render();

  // Sample text (includes a few from your example)
  const SAMPLE_TEXT = `
Question: What is the most frequently fractured tarsal bone?
5, 4, 3, 2, 1.
Answer: The calcaneus is the most fractured tarsal bone.
Explanation: These fractures are usually intra-articular, accounting for seventy-five percent of cases.

Question: What is the Terry Thomas sign?
5, 4, 3, 2, 1.
Answer: The Terry Thomas sign is a gap between the scaphoid and lunate seen on plain film.
Explanation: A gap wider than three millimeters indicates a scapholunate ligament tear or dissociation.

[attachment_0](attachment)

Question: What is a Colles Fracture?
5, 4, 3, 2, 1.
Answer: A Colles fracture is an extra-articular fracture of the distal radial metaphysis with dorsal angulation.
Explanation: It creates a "dinner fork deformity" and is commonly seen in older adults with osteoporosis.
`;
})();
</script>
</body>
</html>
