<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Q/A/Explanation Scroller</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#253047;
      --accent:#60a5fa;
      --warn:#f59e0b;
    }
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-text-size-adjust:100%;
    }
    .topbar{
      position:sticky;
      top:0;
      z-index:10;
      background:rgba(11,15,23,0.92);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--line);
      padding:8px 10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .topbarLeft,
    .topbarRight{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .topbarRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .topbarRight{
      align-items:flex-end;
    }
    .pill{
      border:1px solid var(--line);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .pill[aria-pressed="true"]{
      border-color:rgba(96,165,250,0.55);
      box-shadow:0 0 0 2px rgba(96,165,250,0.15) inset;
    }
    .pill.secondary{
      color:var(--muted);
    }
    .pill.primary{
      border-color:rgba(96,165,250,0.55);
    }
    .pill.iconButton{
      min-width:42px;
      min-height:42px;
      padding:0 14px;
      font-size:18px;
      font-weight:700;
      border-color:rgba(96,165,250,0.45);
      background:
        radial-gradient(circle at top, rgba(96,165,250,0.28), transparent 62%),
        linear-gradient(180deg,#1f2937 0%, #0f172a 100%);
      box-shadow:0 8px 18px rgba(15,23,42,0.55);
      transition:transform 160ms ease, box-shadow 160ms ease, border-color 160ms ease;
    }
    .pill.iconButton:hover{
      border-color:rgba(96,165,250,0.8);
      box-shadow:0 12px 22px rgba(30,64,175,0.35);
      transform:translateY(-1px);
    }
    .pill.iconButton:active{
      transform:translateY(0);
      box-shadow:0 6px 12px rgba(15,23,42,0.4);
    }
    .spacer{flex:1}
    .badge{
      color:var(--muted);
      font-size:12px;
      padding:0 6px;
    }
    .countsRow{
      background:rgba(11,15,23,0.92);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--line);
      padding:6px 10px 8px;
    }

    .wrap{
      max-width:960px;
      margin:0 auto;
      padding:12px 10px 40px;
    }

    textarea{
      width:100%;
      max-width:100%;
      box-sizing:border-box;
      min-height:180px;
      resize:vertical;
      border:1px solid var(--line);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      color:var(--text);
      border-radius:12px;
      padding:12px;
      outline:none;
      font-size:16px;
    }
    textarea:focus{
      border-color:rgba(96,165,250,0.65);
      box-shadow:0 0 0 3px rgba(96,165,250,0.12);
    }
    .controls{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:10px 0 14px;
      align-items:center;
    }
    .hint{
      color:var(--muted);
      font-size:12px;
      margin-top:6px;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border-radius:14px;
      padding:12px;
    }
    .cardHeader{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .cardActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      width:100%;
    }
    .qText{
      flex:1;
      font-size:15px;
      font-weight:650;
      letter-spacing:0.1px;
      white-space:pre-wrap;
    }
    .favBtn{
      border:1px solid rgba(245,158,11,0.55);
      background:transparent;
      color:var(--muted);
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      user-select:none;
      line-height:1;
      font-weight:600;
      transition:color 160ms ease, background 160ms ease;
    }
    .delBtn{
      border:1px solid rgba(239,68,68,0.4);
      background:transparent;
      color:var(--muted);
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      user-select:none;
      line-height:1;
      font-weight:600;
      transition:color 160ms ease, background 160ms ease;
    }
    .learnBtn{
      border:1px solid rgba(96,165,250,0.35);
      background:transparent;
      color:var(--muted);
      border-radius:10px;
      padding:8px 10px;
      cursor:pointer;
      user-select:none;
      line-height:1;
      font-weight:600;
      transition:color 160ms ease, background 160ms ease;
    }
    .delBtn.deleted{
      color:rgba(239,68,68,0.9);
      background:rgba(239,68,68,0.15);
      border-color:rgba(239,68,68,0.8);
      box-shadow:0 0 0 2px rgba(239,68,68,0.12) inset;
    }
    .favBtn.faved{
      color:var(--warn);
      border-color:rgba(245,158,11,0.55);
      background:rgba(245,158,11,0.12);
      box-shadow:0 0 0 2px rgba(245,158,11,0.12) inset;
    }
    .learnBtn.learning{
      color:#60a5fa;
      border-color:rgba(59,130,246,0.8);
      background:rgba(59,130,246,0.14);
      box-shadow:0 0 0 2px rgba(59,130,246,0.12) inset;
    }
    .favBtn,
    .learnBtn,
    .delBtn{
      touch-action:manipulation;
    }
    .statusLegend{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
    }
    .statusLegend span{
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .statusDot{
      width:10px;
      height:10px;
      border-radius:50%;
      display:inline-block;
    }
    .statusDot.mastered{background:var(--warn);}
    .statusDot.developing{background:#60a5fa;}
    .statusDot.discarded{background:#f87171;}
    details{
      border-top:1px solid rgba(37,48,71,0.7);
      margin-top:10px;
      padding-top:10px;
    }
    summary{
      cursor:pointer;
      user-select:none;
      color:var(--accent);
      font-weight:650;
      outline:none;
      list-style:none;
    }
    summary::-webkit-details-marker{display:none}
    .content{
      margin-top:8px;
      color:var(--text);
      white-space:pre-wrap;
    }
    .empty{
      border:1px dashed var(--line);
      color:var(--muted);
      border-radius:14px;
      padding:14px;
      margin-top:12px;
    }
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(17,24,39,0.95);
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 14px;
      color:var(--text);
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity 180ms ease;
      z-index:20;
    }
    .toast.show{opacity:1}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .panel{
      border:1px solid var(--line);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border-radius:14px;
      padding:12px;
      margin-top:12px;
      display:none;
    }
    .panel.show{display:block;}
    .dropdownPanel{
      position:fixed;
      top:0;
      left:0;
      width:auto;
      max-width:min(520px, calc(100vw - 20px));
      margin:0;
      z-index:15;
      max-height:60vh;
      overflow:auto;
      box-shadow:0 12px 30px rgba(0,0,0,0.35);
    }
    .panelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
      gap:8px;
    }
    .panelHeaderActions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .panelHeaderActions input[type="file"]{
      display:none;
    }
    .panelTitle{
      font-weight:650;
    }
    .panelList{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .panelRow{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:stretch;
      border:1px solid rgba(37,48,71,0.7);
      border-radius:10px;
      padding:10px 12px;
      transition:border-color 160ms ease, background 160ms ease;
    }
    .panelRow.pressable{
      cursor:pointer;
    }
    .panelRow.pressed{
      border-color:rgba(96,165,250,0.55);
      background:rgba(96,165,250,0.12);
    }
    .panelRowBody{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .panelRowActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-start;
    }
    .panelMeta{
      color:var(--muted);
      font-size:12px;
    }
    .statusText.mastered{color:var(--warn);}
    .statusText.developing{color:#60a5fa;}
    .statusText.discarded{color:#f87171;}
    .toggleRow{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbarLeft">
      <div class="topbarRow">
        <button id="toggleAllView" class="pill" aria-pressed="false" title="Show all items, including discarded">Show all</button>
        <button id="toggleFavView" class="pill" aria-pressed="false" title="Show only mastered items">Mastered only</button>
        <button id="toggleLearningView" class="pill" aria-pressed="false" title="Show only developing items">Developing only</button>
      </div>
      <div class="topbarRow">
        <button id="copyBtn" class="pill primary" title="Copy items">Copy</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="topbarRight">
      <button id="newBtn" class="pill primary iconButton" title="Create a new set">+</button>
      <button id="togglePriors" class="pill secondary" title="View saved priors">Priors</button>
    </div>
  </div>
  <div class="countsRow">
    <span id="counts" class="badge">0 items</span>
  </div>

  <div class="wrap">
    <div class="statusLegend">
      <span><span class="statusDot mastered"></span>Mastered = learned &amp; ready for Anki</span>
      <span><span class="statusDot developing"></span>Developing = needs more review</span>
      <span><span class="statusDot discarded"></span>Discarded = already known / low yield</span>
    </div>

    <div id="list" class="list"></div>
    <div id="empty" class="empty" style="display:none">No questions parsed yet.</div>

  </div>

  <div id="priorsPanel" class="panel dropdownPanel alignRight">
    <div class="panelHeader">
      <div class="panelTitle">Saved priors</div>
      <div class="panelHeaderActions">
        <button id="downloadPriorsBtn" class="pill secondary" type="button">Download JSON</button>
        <button id="uploadPriorsBtn" class="pill secondary" type="button">Upload JSON</button>
        <input id="uploadPriorsInput" type="file" accept="application/json" />
        <span class="panelMeta" id="priorsMeta">0 saved</span>
      </div>
    </div>
    <div id="priorsList" class="panelList"></div>
  </div>

  <div id="newPanel" class="panel dropdownPanel alignRight">
    <div class="panelHeader">
      <div class="panelTitle">New set</div>
      <span class="panelMeta">Paste Q/A/Explanation blocks</span>
    </div>
    <textarea id="input" placeholder="Paste your content here (Question:/Answer:/Explanation: blocks)"></textarea>
    <div class="controls">
      <button id="parseBtn" class="pill primary">Create set</button>
    </div>
    <div class="hint">Creating a new set overwrites the current list and saves the previous one as a prior.</div>
  </div>

  <div id="copyPanel" class="panel dropdownPanel">
    <div class="panelHeader">
      <div class="panelTitle">Copy options</div>
    </div>
    <div class="panelList">
      <button id="copyAllBtn" class="pill secondary" type="button">Copy all</button>
      <button id="copyAllVisibleBtn" class="pill secondary" type="button">Copy all (not deleted)</button>
      <button id="copyFavsBtn" class="pill secondary" type="button">Copy mastered</button>
      <button id="copyLearningBtn" class="pill secondary" type="button">Copy developing</button>
    </div>
    <label class="toggleRow">
      <input id="countdownToggle" type="checkbox" /> Include 5-4-3-2-1 countdown
    </label>
  </div>

  <div id="toast" class="toast"></div>

<script>
(() => {
  const els = {
    input: document.getElementById('input'),
    parseBtn: document.getElementById('parseBtn'),
    list: document.getElementById('list'),
    empty: document.getElementById('empty'),
    toggleFavView: document.getElementById('toggleFavView'),
    toggleLearningView: document.getElementById('toggleLearningView'),
    toggleAllView: document.getElementById('toggleAllView'),
    copyBtn: document.getElementById('copyBtn'),
    copyPanel: document.getElementById('copyPanel'),
    copyAllBtn: document.getElementById('copyAllBtn'),
    copyAllVisibleBtn: document.getElementById('copyAllVisibleBtn'),
    copyFavsBtn: document.getElementById('copyFavsBtn'),
    copyLearningBtn: document.getElementById('copyLearningBtn'),
    countdownToggle: document.getElementById('countdownToggle'),
    newBtn: document.getElementById('newBtn'),
    newPanel: document.getElementById('newPanel'),
    togglePriors: document.getElementById('togglePriors'),
    priorsPanel: document.getElementById('priorsPanel'),
    priorsList: document.getElementById('priorsList'),
    priorsMeta: document.getElementById('priorsMeta'),
    downloadPriorsBtn: document.getElementById('downloadPriorsBtn'),
    uploadPriorsBtn: document.getElementById('uploadPriorsBtn'),
    uploadPriorsInput: document.getElementById('uploadPriorsInput'),
    counts: document.getElementById('counts'),
    toast: document.getElementById('toast'),
  };

  const STORAGE = {
    favs: 'qa_favorites_v1',
    learning: 'qa_learning_v1',
    deleted: 'qa_deleted_v1',
    lastInput: 'qa_last_input_v1',
    priors: 'qa_priors_v1',
    includeCountdown: 'qa_copy_countdown_v1'
  };

  const TITLE_EXCLUDE_WORDS = [
    'question',
    'explanation',
    'radiographic',
    'characteristic'
  ];

  let state = {
    items: [],
    favSet: new Set(),
    learningSet: new Set(),
    deletedSet: new Set(),
    filterView: 'active',
    priors: [],
    activePriorId: null,
  };

  function showToast(msg){
    els.toast.textContent = msg;
    els.toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => els.toast.classList.remove('show'), 1400);
  }

  function safeIdFromQuestion(q){
    // Simple deterministic id (not crypto): normalize and hash.
    const s = (q || '').trim().toLowerCase().replace(/\s+/g,' ');
    let h = 2166136261;
    for (let i=0; i<s.length; i++){
      h ^= s.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return 'q_' + (h >>> 0).toString(16);
  }

  function loadFavs(){
    try{
      const raw = localStorage.getItem(STORAGE.favs);
      if (!raw) return;
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) state.favSet = new Set(arr);
    }catch(e){}
  }

  function loadDeleted(){
    try{
      const raw = localStorage.getItem(STORAGE.deleted);
      if (!raw) return;
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) state.deletedSet = new Set(arr);
    }catch(e){}
  }

  function loadLearning(){
    try{
      const raw = localStorage.getItem(STORAGE.learning);
      if (!raw) return;
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) state.learningSet = new Set(arr);
    }catch(e){}
  }

  function saveFavs(){
    try{
      localStorage.setItem(STORAGE.favs, JSON.stringify(Array.from(state.favSet)));
    }catch(e){}
  }

  function saveDeleted(){
    try{
      localStorage.setItem(STORAGE.deleted, JSON.stringify(Array.from(state.deletedSet)));
    }catch(e){}
  }

  function saveLearning(){
    try{
      localStorage.setItem(STORAGE.learning, JSON.stringify(Array.from(state.learningSet)));
    }catch(e){}
  }

  function saveLastInput(){
    try{
      localStorage.setItem(STORAGE.lastInput, els.input.value || '');
    }catch(e){}
  }

  function loadLastInput(){
    try{
      const v = localStorage.getItem(STORAGE.lastInput);
      if (v) els.input.value = v;
    }catch(e){}
  }

  function positionDropdown(panel, anchor, align = 'left'){
    if (!panel || !anchor) return;
    const rect = anchor.getBoundingClientRect();
    const offset = 8;
    const top = Math.min(rect.bottom + offset, window.innerHeight - 16);
    panel.style.top = `${Math.max(10, top)}px`;
    if (align === 'right'){
      const right = window.innerWidth - rect.right;
      panel.style.right = `${Math.max(10, right)}px`;
      panel.style.left = 'auto';
    }else{
      panel.style.left = `${Math.max(10, rect.left)}px`;
      panel.style.right = 'auto';
    }
  }

  function positionOpenPanels(){
    if (els.copyPanel.classList.contains('show')){
      positionDropdown(els.copyPanel, els.copyBtn, 'left');
    }
    if (els.priorsPanel.classList.contains('show')){
      positionDropdown(els.priorsPanel, els.togglePriors, 'right');
    }
    if (els.newPanel.classList.contains('show')){
      positionDropdown(els.newPanel, els.newBtn, 'right');
    }
  }

  function loadPriors(){
    try{
      const raw = localStorage.getItem(STORAGE.priors);
      if (!raw) return;
      const arr = JSON.parse(raw);
      if (Array.isArray(arr)) state.priors = arr;
    }catch(e){}
  }

  function savePriors(){
    try{
      localStorage.setItem(STORAGE.priors, JSON.stringify(state.priors));
    }catch(e){}
  }

  function setActivePrior(id){
    state.activePriorId = id || null;
  }

  function syncActivePrior(options = {}){
    if (!state.activePriorId) return;
    const prior = state.priors.find(item => item.id === state.activePriorId);
    if (!prior) return;
    prior.rawInput = els.input.value || '';
    if (options.includeItems !== false) prior.items = state.items;
    prior.favIds = Array.from(state.favSet);
    prior.learningIds = Array.from(state.learningSet);
    prior.deletedIds = Array.from(state.deletedSet);
    savePriors();
    if (els.priorsPanel.classList.contains('show')) renderPriors();
  }

  function persistActivePrior(){
    if (!state.activePriorId) return;
    syncActivePrior();
  }

  function loadCopyCountdown(){
    try{
      const raw = localStorage.getItem(STORAGE.includeCountdown);
      if (raw === null) return;
      els.countdownToggle.checked = raw === 'true';
    }catch(e){}
  }

  function saveCopyCountdown(){
    try{
      localStorage.setItem(STORAGE.includeCountdown, els.countdownToggle.checked ? 'true' : 'false');
    }catch(e){}
  }

  function isIgnorableLine(line){
    const t = line.trim();
    if (!t) return false;

    // rating lines like "5, 4, 3, 2, 1." or "5,4,3,2,1"
    if (/^\d\s*,\s*\d\s*,\s*\d\s*,\s*\d\s*,\s*\d\s*\.?\s*$/.test(t)) return true;

    // attachment markers like "[attachment_0](attachment)" or "[attachment_0]"
    if (/^\[attachment_\d+\](\(.+\))?\s*$/.test(t)) return true;

    return false;
  }

  function parseInput(raw){
    const text = (raw || '').replace(/\r\n/g, '\n');
    const lines = text.split('\n');

    const items = [];
    let cur = null;
    let mode = null; // 'q' | 'a' | 'e'

    function pushCur(){
      if (!cur) return;
      const q = (cur.question || '').trim();
      const a = (cur.answer || '').trim();
      const e = (cur.explanation || '').trim();

      if (!q) return;

      const id = safeIdFromQuestion(q);
      items.push({ id, question: q, answer: a, explanation: e });
    }

    for (let i=0; i<lines.length; i++){
      const line = lines[i];

      if (isIgnorableLine(line)) continue;

      const trimmed = line.trim();

      // Detect field headers (case sensitive as provided, but allow mild variance)
      const mQ = /^Question:\s*(.*)\s*$/i.exec(line);
      const mA = /^Answer:\s*(.*)\s*$/i.exec(line);
      const mE = /^Explanation:\s*(.*)\s*$/i.exec(line);

      if (mQ){
        // new question starts -> push previous
        pushCur();
        cur = { question: mQ[1] || '', answer: '', explanation: '' };
        mode = 'q';
        continue;
      }
      if (mA){
        if (!cur) cur = { question: '', answer: '', explanation: '' };
        cur.answer = (mA[1] || '');
        mode = 'a';
        continue;
      }
      if (mE){
        if (!cur) cur = { question: '', answer: '', explanation: '' };
        cur.explanation = (mE[1] || '');
        mode = 'e';
        continue;
      }

      // Ignore stray attachment markdown lines even if they don't match earlier regex
      if (/^\s*\[attachment_\d+\]/.test(trimmed)) continue;

      // Accumulate multiline content
      if (cur && mode){
        // Skip lines that are only punctuation
        if (/^\s*[.·•-]\s*$/.test(line)) continue;

        if (mode === 'q') cur.question += (cur.question ? '\n' : '') + line;
        if (mode === 'a') cur.answer += (cur.answer ? '\n' : '') + line;
        if (mode === 'e') cur.explanation += (cur.explanation ? '\n' : '') + line;
      }
    }

    pushCur();
    return items;
  }

  function looksUrlEncoded(s){
    return /%[0-9A-Fa-f]{2}/.test(s || '');
  }

  function decodeBestEffort(s){
    const plusFixed = (s || '').replace(/\+/g, '%20');
    try{
      return decodeURIComponent(plusFixed);
    }catch(e){
      return s;
    }
  }

  function attachAutoDecodeOnPaste(el){
    if (!el) return;
    let suppress = false;

    el.addEventListener('paste', (event) => {
      const clipboard = event.clipboardData || window.clipboardData;
      if (!clipboard || typeof clipboard.getData !== 'function') return;

      const text =
        clipboard.getData('text/plain') ||
        clipboard.getData('Text') ||
        clipboard.getData('text') ||
        '';

      if (!text) return;
      if (!looksUrlEncoded(text)) return;

      event.preventDefault();

      const decoded = decodeBestEffort(text);
      const start = typeof el.selectionStart === 'number' ? el.selectionStart : el.value.length;
      const end = typeof el.selectionEnd === 'number' ? el.selectionEnd : el.value.length;

      el.value = el.value.slice(0, start) + decoded + el.value.slice(end);

      const newPos = start + decoded.length;
      if (typeof el.setSelectionRange === 'function'){
        el.setSelectionRange(newPos, newPos);
      }

      suppress = true;
      el.dispatchEvent(new Event('input', { bubbles: true }));
      suppress = false;
    });

    el.addEventListener('input', () => {
      if (suppress) return;
      if (!looksUrlEncoded(el.value)) return;

      const decoded = decodeBestEffort(el.value);
      if (decoded !== el.value){
        const pos = el.selectionStart ?? decoded.length;
        el.value = decoded;
        if (typeof el.setSelectionRange === 'function'){
          el.setSelectionRange(pos, pos);
        }
      }
    });
  }

  function attachAutoDecodeOnPasteContentEditable(el){
    if (!el) return;
    el.addEventListener('paste', (event) => {
      const clipboard = event.clipboardData || window.clipboardData;
      const text = clipboard && clipboard.getData ? clipboard.getData('text') : '';
      if (!text || !looksUrlEncoded(text)) return;

      event.preventDefault();
      const decoded = decodeBestEffort(text);
      document.execCommand('insertText', false, decoded);
    });
  }

  function render(){
    const itemsAll = state.items;
    const items = state.filterView === 'mastered'
      ? itemsAll.filter(it => state.favSet.has(it.id))
      : state.filterView === 'developing'
        ? itemsAll.filter(it => state.learningSet.has(it.id))
        : state.filterView === 'all'
          ? itemsAll
          : itemsAll.filter(it => !state.deletedSet.has(it.id));

    els.list.innerHTML = '';
    els.empty.style.display = items.length ? 'none' : 'block';

    const total = itemsAll.length;
    const favCount = state.favSet.size;
    const learningCount = state.learningSet.size;
    const deletedCount = state.deletedSet.size;

    if (state.filterView === 'mastered'){
      els.counts.textContent = `${items.length} mastered shown (of ${total})`;
    }else if (state.filterView === 'developing'){
      els.counts.textContent = `${items.length} developing shown (of ${total})`;
    }else if (state.filterView === 'all'){
      els.counts.textContent = `${items.length} items shown (including ${deletedCount} discarded)`;
    }else{
      const visibleCount = items.length;
      els.counts.textContent = `${visibleCount} items shown (${favCount} mastered, ${learningCount} developing, ${deletedCount} discarded)`;
    }

    for (const it of items){
      const card = document.createElement('div');
      card.className = 'card';

      const head = document.createElement('div');
      head.className = 'cardHeader';

      const fav = document.createElement('button');
      fav.className = 'favBtn' + (state.favSet.has(it.id) ? ' faved' : '');
      fav.type = 'button';
      fav.title = 'Toggle mastered';
      fav.textContent = state.favSet.has(it.id) ? 'Mastered' : 'Master';

      fav.addEventListener('click', () => {
        if (state.favSet.has(it.id)) {
          state.favSet.delete(it.id);
        }else{
          state.favSet.add(it.id);
          state.learningSet.delete(it.id);
          state.deletedSet.delete(it.id);
        }
        saveFavs();
        saveLearning();
        saveDeleted();
        persistActivePrior();
        render();
      });

      const learn = document.createElement('button');
      learn.className = 'learnBtn' + (state.learningSet.has(it.id) ? ' learning' : '');
      learn.type = 'button';
      learn.title = 'Toggle developing';
      learn.textContent = state.learningSet.has(it.id) ? 'Developing' : 'Develop';

      learn.addEventListener('click', () => {
        if (state.learningSet.has(it.id)) {
          state.learningSet.delete(it.id);
        }else{
          state.learningSet.add(it.id);
          state.favSet.delete(it.id);
          state.deletedSet.delete(it.id);
        }
        saveLearning();
        saveFavs();
        saveDeleted();
        persistActivePrior();
        render();
      });

      const del = document.createElement('button');
      del.className = 'delBtn' + (state.deletedSet.has(it.id) ? ' deleted' : '');
      del.type = 'button';
      del.title = 'Toggle discarded';
      del.textContent = state.deletedSet.has(it.id) ? 'Discarded' : 'Discard';

      del.addEventListener('click', () => {
        if (state.deletedSet.has(it.id)) {
          state.deletedSet.delete(it.id);
        }else{
          state.deletedSet.add(it.id);
          state.favSet.delete(it.id);
          state.learningSet.delete(it.id);
        }
        saveDeleted();
        saveFavs();
        saveLearning();
        persistActivePrior();
        render();
      });

      const actions = document.createElement('div');
      actions.className = 'cardActions';
      actions.appendChild(fav);
      actions.appendChild(learn);
      actions.appendChild(del);

      const q = document.createElement('div');
      q.className = 'qText';
      q.textContent = it.question;

      head.appendChild(actions);
      head.appendChild(q);

      const ans = document.createElement('details');
      const ansSum = document.createElement('summary');
      ansSum.textContent = 'Answer';
      const ansBody = document.createElement('div');
      ansBody.className = 'content';
      ansBody.textContent = it.answer || '(No answer parsed.)';
      ans.appendChild(ansSum);
      ans.appendChild(ansBody);

      const exp = document.createElement('details');
      const expSum = document.createElement('summary');
      expSum.textContent = 'Explanation';
      const expBody = document.createElement('div');
      expBody.className = 'content';
      expBody.textContent = it.explanation || '(No explanation parsed.)';
      exp.appendChild(expSum);
      exp.appendChild(expBody);

      card.appendChild(head);
      card.appendChild(ans);
      card.appendChild(exp);

      els.list.appendChild(card);
    }
  }

  function formatItemsText(items, includeCountdown){
    if (!items.length) return '';

    return items.map(it => {
      const parts = [];
      parts.push(`Question: ${it.question}`);
      if (includeCountdown) parts.push('5, 4, 3, 2, 1.');
      parts.push(`Answer: ${it.answer || ''}`);
      parts.push(`Explanation: ${it.explanation || ''}`);
      return parts.join('\n');
    }).join('\n\n');
  }

  async function copyTextToClipboard(text){
    // Prefer modern clipboard API; fallback to hidden textarea.
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      try{
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        ta.style.top = '0';
        document.body.appendChild(ta);
        ta.focus();
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
      }catch(_){
        return false;
      }
    }
  }

  function parseAndRender(){
    const raw = els.input.value || '';
    if (!raw.trim()){
      showToast('Paste content to create a set.');
      return;
    }
    state.items = parseInput(raw);
    // Keep favorites for items that still exist (optional cleanup)
    const ids = new Set(state.items.map(x => x.id));
    state.favSet = new Set(Array.from(state.favSet).filter(id => ids.has(id)));
    state.learningSet = new Set(Array.from(state.learningSet).filter(id => ids.has(id)));
    state.deletedSet = new Set(Array.from(state.deletedSet).filter(id => ids.has(id)));
    saveFavs();
    saveLearning();
    saveDeleted();
    saveLastInput();
    storePrior(raw);
    render();
    showToast(`Parsed ${state.items.length} question(s).`);
    els.newPanel.classList.remove('show');
  }

  function pickTopWords(raw){
    const words = (raw || '')
      .toLowerCase()
      .match(/[a-z]{7,}/g) || [];
    const counts = new Map();
    for (const w of words){
      if (TITLE_EXCLUDE_WORDS.includes(w)) continue;
      counts.set(w, (counts.get(w) || 0) + 1);
    }
    const sorted = Array.from(counts.entries())
      .sort((a,b) => b[1] - a[1])
      .slice(0,2)
      .map(([w]) => w);
    return sorted;
  }

  function formatPriorLabel(words){
    if (!words.length) return 'etc';
    return `${words.join(', ')}, etc`;
  }

  function storePrior(raw){
    const trimmed = (raw || '').trim();
    if (!trimmed) return;
    const createdAt = new Date().toISOString();
    const displayDate = new Date().toLocaleString();
    const words = pickTopWords(raw);
    const wordLabel = formatPriorLabel(words);
    const label = `${displayDate} — ${wordLabel}`;
    const entry = {
      id: `prior_${Date.now()}`,
      createdAt,
      label,
      name: '',
      rawInput: raw,
      items: state.items,
      favIds: Array.from(state.favSet),
      learningIds: Array.from(state.learningSet),
      deletedIds: Array.from(state.deletedSet)
    };
    state.priors.unshift(entry);
    state.priors = state.priors.slice(0, 25);
    savePriors();
    renderPriors();
    setActivePrior(entry.id);
  }

  function renderPriors(){
    els.priorsList.innerHTML = '';
    els.priorsMeta.textContent = `${state.priors.length} saved`;
    if (!state.priors.length){
      const empty = document.createElement('div');
      empty.className = 'panelMeta';
      empty.textContent = 'No priors saved yet.';
      els.priorsList.appendChild(empty);
      return;
    }
    for (const prior of state.priors){
      const row = document.createElement('div');
      row.className = 'panelRow pressable';

      const rowBody = document.createElement('div');
      rowBody.className = 'panelRowBody';

      const label = document.createElement('div');
      label.textContent = (prior.name || '').trim() || prior.label;

      const meta = document.createElement('div');
      meta.className = 'panelMeta';
      const developingCount = (prior.learningIds || []).length;
      meta.innerHTML = `${prior.items.length} items · <span class="statusText mastered">${prior.favIds.length} mastered</span> · <span class="statusText developing">${developingCount} developing</span> · <span class="statusText discarded">${prior.deletedIds.length} discarded</span>`;

      const actions = document.createElement('div');
      actions.className = 'panelRowActions';

      const renameBtn = document.createElement('button');
      renameBtn.className = 'pill secondary';
      renameBtn.type = 'button';
      renameBtn.textContent = 'Rename';

      renameBtn.addEventListener('click', () => {
        const currentName = (prior.name || '').trim() || prior.label;
        const nextName = window.prompt('Rename this prior:', currentName);
        if (nextName === null) return;
        prior.name = nextName.trim();
        savePriors();
        renderPriors();
        showToast(prior.name ? 'Prior renamed.' : 'Prior name cleared.');
      });

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'pill secondary';
      deleteBtn.type = 'button';
      deleteBtn.textContent = 'Delete';

      deleteBtn.addEventListener('click', () => {
        const ok = window.confirm(`Delete this prior?\n\n${prior.label}`);
        if (!ok) return;
        state.priors = state.priors.filter(item => item.id !== prior.id);
        savePriors();
        renderPriors();
        showToast('Prior deleted.');
      });

      actions.appendChild(deleteBtn);
      actions.appendChild(renameBtn);

      rowBody.appendChild(label);
      rowBody.appendChild(meta);
      rowBody.appendChild(actions);

      row.appendChild(rowBody);
      els.priorsList.appendChild(row);

      const loadPrior = () => {
        persistActivePrior();
        els.input.value = prior.rawInput || '';
        state.items = prior.items || parseInput(prior.rawInput || '');
        state.favSet = new Set(prior.favIds || []);
        state.learningSet = new Set(prior.learningIds || []);
        state.deletedSet = new Set(prior.deletedIds || []);
        saveFavs();
        saveLearning();
        saveDeleted();
        saveLastInput();
        setActivePrior(prior.id);
        render();
        els.priorsPanel.classList.remove('show');
        showToast('Loaded prior.');
      };

      row.addEventListener('pointerdown', (event) => {
        if (event.target.closest('button')) return;
        row.classList.add('pressed');
      });

      row.addEventListener('pointerup', (event) => {
        if (!row.classList.contains('pressed')) return;
        row.classList.remove('pressed');
        if (event.target.closest('button')) return;
        loadPrior();
      });

      row.addEventListener('pointerleave', () => {
        row.classList.remove('pressed');
      });

      row.addEventListener('pointercancel', () => {
        row.classList.remove('pressed');
      });
    }
  }

  function buildExportPayload(){
    const priors = state.priors.map(prior => {
      const masteredCount = (prior.favIds || []).length;
      const developingCount = (prior.learningIds || []).length;
      const discardedCount = (prior.deletedIds || []).length;
      return {
        ...prior,
        counts: {
          total: (prior.items || []).length,
          mastered: masteredCount,
          developing: developingCount,
          discarded: discardedCount
        }
      };
    });
    return {
      version: 1,
      exportedAt: new Date().toISOString(),
      priors
    };
  }

  function downloadPriors(){
    if (!state.priors.length){
      showToast('No priors to download.');
      return;
    }
    const payload = buildExportPayload();
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const stamp = new Date().toISOString().slice(0,10);
    a.href = url;
    a.download = `qa-priors-${stamp}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Priors downloaded.');
  }

  function normalizePrior(prior){
    if (!prior || typeof prior !== 'object') return null;
    const createdAt = prior.createdAt || new Date().toISOString();
    const label = prior.label || new Date(createdAt).toLocaleString();
    const id = prior.id || `prior_${Date.now()}_${Math.random().toString(16).slice(2,8)}`;
    let items = Array.isArray(prior.items) ? prior.items : [];
    const rawInput = prior.rawInput || '';
    if (!items.length && rawInput){
      items = parseInput(rawInput);
    }
    return {
      id,
      createdAt,
      label,
      name: prior.name || '',
      rawInput,
      items,
      favIds: Array.isArray(prior.favIds) ? prior.favIds : [],
      learningIds: Array.isArray(prior.learningIds) ? prior.learningIds : [],
      deletedIds: Array.isArray(prior.deletedIds) ? prior.deletedIds : []
    };
  }

  function mergeImportedPriors(imported){
    if (!Array.isArray(imported)) return 0;
    const existing = new Map(state.priors.map(prior => [prior.id, prior]));
    let added = 0;
    for (const raw of imported){
      const normalized = normalizePrior(raw);
      if (!normalized) continue;
      if (existing.has(normalized.id)) continue;
      existing.set(normalized.id, normalized);
      added++;
    }
    state.priors = Array.from(existing.values()).sort((a,b) => {
      const aTime = new Date(a.createdAt || 0).getTime();
      const bTime = new Date(b.createdAt || 0).getTime();
      return bTime - aTime;
    }).slice(0,25);
    return added;
  }

  // Events
  els.parseBtn.addEventListener('click', parseAndRender);

  els.toggleFavView.addEventListener('click', () => {
    state.filterView = state.filterView === 'mastered' ? 'active' : 'mastered';
    els.toggleFavView.setAttribute('aria-pressed', state.filterView === 'mastered' ? 'true' : 'false');
    els.toggleLearningView.setAttribute('aria-pressed', state.filterView === 'developing' ? 'true' : 'false');
    els.toggleAllView.setAttribute('aria-pressed', state.filterView === 'all' ? 'true' : 'false');
    render();
  });

  els.toggleLearningView.addEventListener('click', () => {
    state.filterView = state.filterView === 'developing' ? 'active' : 'developing';
    els.toggleLearningView.setAttribute('aria-pressed', state.filterView === 'developing' ? 'true' : 'false');
    els.toggleFavView.setAttribute('aria-pressed', state.filterView === 'mastered' ? 'true' : 'false');
    els.toggleAllView.setAttribute('aria-pressed', state.filterView === 'all' ? 'true' : 'false');
    render();
  });

  els.toggleAllView.addEventListener('click', () => {
    state.filterView = state.filterView === 'all' ? 'active' : 'all';
    els.toggleAllView.setAttribute('aria-pressed', state.filterView === 'all' ? 'true' : 'false');
    els.toggleFavView.setAttribute('aria-pressed', state.filterView === 'mastered' ? 'true' : 'false');
    els.toggleLearningView.setAttribute('aria-pressed', state.filterView === 'developing' ? 'true' : 'false');
    render();
  });

  els.togglePriors.addEventListener('click', () => {
    els.priorsPanel.classList.toggle('show');
    if (els.priorsPanel.classList.contains('show')){
      els.copyPanel.classList.remove('show');
      els.newPanel.classList.remove('show');
      positionDropdown(els.priorsPanel, els.togglePriors, 'right');
      renderPriors();
    }
  });

  els.downloadPriorsBtn.addEventListener('click', downloadPriors);

  els.uploadPriorsBtn.addEventListener('click', () => {
    els.uploadPriorsInput.value = '';
    els.uploadPriorsInput.click();
  });

  els.uploadPriorsInput.addEventListener('change', async () => {
    const file = els.uploadPriorsInput.files && els.uploadPriorsInput.files[0];
    if (!file) return;
    try{
      const text = await file.text();
      const parsed = JSON.parse(text);
      const priors = Array.isArray(parsed) ? parsed : parsed.priors;
      if (!Array.isArray(priors)){
        showToast('Invalid priors file.');
        return;
      }
      const added = mergeImportedPriors(priors);
      if (added > 0){
        savePriors();
        renderPriors();
        showToast(`Imported ${added} new prior${added === 1 ? '' : 's'}.`);
      }else{
        showToast('No new priors found.');
      }
    }catch(e){
      showToast('Unable to import priors.');
    }
  });

  els.copyBtn.addEventListener('click', () => {
    els.copyPanel.classList.toggle('show');
    if (els.copyPanel.classList.contains('show')){
      els.priorsPanel.classList.remove('show');
      els.newPanel.classList.remove('show');
      positionDropdown(els.copyPanel, els.copyBtn, 'left');
    }
  });

  els.newBtn.addEventListener('click', () => {
    els.newPanel.classList.toggle('show');
    if (els.newPanel.classList.contains('show')){
      els.copyPanel.classList.remove('show');
      els.priorsPanel.classList.remove('show');
      els.input.value = '';
      saveLastInput();
      positionDropdown(els.newPanel, els.newBtn, 'right');
      els.input.focus();
    }
  });

  document.addEventListener('pointerdown', (event) => {
    const target = event.target;
    const path = event.composedPath ? event.composedPath() : [];
    const clickedCopy = els.copyBtn.contains(target) || path.includes(els.copyBtn);
    const clickedCopyPanel = els.copyPanel.contains(target) || path.includes(els.copyPanel);
    const clickedPriors = els.togglePriors.contains(target) || path.includes(els.togglePriors);
    const clickedPriorsPanel = els.priorsPanel.contains(target) || path.includes(els.priorsPanel);
    const clickedNew = els.newBtn.contains(target) || path.includes(els.newBtn);
    const clickedNewPanel = els.newPanel.contains(target) || path.includes(els.newPanel);

    if (!clickedCopy && !clickedCopyPanel && els.copyPanel.classList.contains('show')){
      els.copyPanel.classList.remove('show');
    }
    if (!clickedPriors && !clickedPriorsPanel && els.priorsPanel.classList.contains('show')){
      els.priorsPanel.classList.remove('show');
    }
    if (!clickedNew && !clickedNewPanel && els.newPanel.classList.contains('show')){
      els.newPanel.classList.remove('show');
    }
  });

  els.countdownToggle.addEventListener('change', saveCopyCountdown);

  els.copyAllBtn.addEventListener('click', async () => {
    const text = formatItemsText(state.items, els.countdownToggle.checked);
    if (!text){
      showToast('No items to copy.');
      return;
    }
    const ok = await copyTextToClipboard(text);
    showToast(ok ? 'All items copied.' : 'Copy failed.');
  });

  els.copyAllVisibleBtn.addEventListener('click', async () => {
    const items = state.items.filter(it => !state.deletedSet.has(it.id));
    const text = formatItemsText(items, els.countdownToggle.checked);
    if (!text){
      showToast('No visible items to copy.');
      return;
    }
    const ok = await copyTextToClipboard(text);
    showToast(ok ? 'Visible items copied.' : 'Copy failed.');
  });

  els.copyFavsBtn.addEventListener('click', async () => {
    const items = state.items.filter(it => state.favSet.has(it.id) && !state.deletedSet.has(it.id));
    const text = formatItemsText(items, els.countdownToggle.checked);
    if (!text){
      showToast('No mastered items to copy.');
      return;
    }
    const ok = await copyTextToClipboard(text);
    showToast(ok ? 'Mastered items copied.' : 'Copy failed.');
  });

  els.copyLearningBtn.addEventListener('click', async () => {
    const items = state.items.filter(it => state.learningSet.has(it.id) && !state.deletedSet.has(it.id));
    const text = formatItemsText(items, els.countdownToggle.checked);
    if (!text){
      showToast('No developing items to copy.');
      return;
    }
    const ok = await copyTextToClipboard(text);
    showToast(ok ? 'Developing items copied.' : 'Copy failed.');
  });

  els.input.addEventListener('input', () => {
    saveLastInput();
    syncActivePrior({ includeItems: false });
  });

  window.addEventListener('resize', positionOpenPanels);
  window.addEventListener('scroll', positionOpenPanels, { passive: true });

  // Init
  loadFavs();
  loadLearning();
  loadDeleted();
  loadLastInput();
  loadPriors();
  loadCopyCountdown();
  attachAutoDecodeOnPaste(els.input);
  // Auto-parse if there is stored input
  if ((els.input.value || '').trim()){
    state.items = parseInput(els.input.value);
  }
  renderPriors();
  render();

})();
</script>
</body>
</html>
