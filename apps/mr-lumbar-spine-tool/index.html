<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Lumbar Spine MRI Structured Report Builder</title>
<style>
:root {
  --bg:#0f172a;
  --card-bg:#1e253a;
  --accent:#38bdf8;
  --accent-soft:rgba(56,189,248,.15);
  --text:#f8fafc;
  --text-dim:#94a3b8;
  --border:#334155;
  --radius-lg:1rem;
  --radius-sm:.5rem;
  --gap:1rem;
  --font-stack:-apple-system,BlinkMacSystemFont,"Inter","SF Pro Text","Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
}
* { box-sizing:border-box; }
body {
 background:var(--bg);
 color:var(--text);
 font-family:var(--font-stack);
 line-height:1.4;
 margin:0;
 padding:1rem 1rem 4rem;
}
h1,h2,h3,h4,h5 {
 margin:0;
 font-weight:600;
 color:var(--text);
 line-height:1.2;
}
small { color:var(--text-dim); }

.container {
 display:grid;
 grid-template-columns:1fr 400px;
 gap:var(--gap);
 align-items:flex-start;
}
@media(max-width:1100px){
 .container{grid-template-columns:1fr;}
}

.card {
 background:var(--card-bg);
 border:1px solid var(--border);
 border-radius:var(--radius-lg);
 padding:1rem 1rem 1rem;
 box-shadow:0 20px 40px rgb(0 0 0 / .6);
}

.header-bar{
 display:flex;
 align-items:flex-start;
 justify-content:space-between;
 flex-wrap:wrap;
 gap:.5rem;
 margin-bottom:1rem;
}
.header-left{
 display:flex;
 flex-direction:column;
 gap:.5rem;
}
.header-right{
 display:flex;
 align-items:flex-start;
 flex-wrap:wrap;
 gap:.5rem;
}

.badge{
 background:var(--accent-soft);
 color:var(--accent);
 font-size:.7rem;
 font-weight:500;
 padding:.25rem .5rem;
 border-radius:var(--radius-sm);
 border:1px solid var(--accent);
 line-height:1.2;
}

button{
 cursor:pointer;
 border:none;
 border-radius:var(--radius-sm);
 background:var(--accent-soft);
 color:var(--accent);
 border:1px solid var(--accent);
 font-size:.8rem;
 font-weight:500;
 line-height:1.2;
 padding:.5rem .75rem;
 transition:all .12s linear;
}
button:hover{
 background:var(--accent);
 color:#0f172a;
}

.section-card{
 margin-bottom:1rem;
 border:1px solid var(--border);
 border-radius:var(--radius-lg);
 background:rgba(15,23,42,.4);
}
.section-head{
 display:flex;
 justify-content:space-between;
 align-items:center;
 padding:.75rem 1rem;
 border-bottom:1px solid var(--border);
 cursor:pointer;
}
.section-head h3{
 font-size:.9rem;
 font-weight:600;
 margin:0;
 display:flex;
 align-items:center;
 gap:.5rem;
}
.section-head span.level-count{
 font-size:.7rem;
 color:var(--text-dim);
 background:rgba(148,163,184,.1);
 padding:.15rem .4rem;
 border-radius:.4rem;
 border:1px solid var(--border);
}
.section-body{
 padding:1rem;
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(min(220px,100%),1fr));
 gap:.75rem 1rem;
}

.option-group{
 display:flex;
 flex-direction:column;
 gap:.5rem;
}
.option-group label.option-line{
 display:flex;
 align-items:flex-start;
 font-size:.8rem;
 line-height:1.3;
 color:var(--text);
 gap:.5rem;
 padding:.4rem .5rem;
 background:#1e253a;
 border:1px solid var(--border);
 border-radius:var(--radius-sm);
 cursor:pointer;
}
.option-group label.option-line input{
 margin-top:.2rem;
}

textarea.custom-text{
 width:100%;
 min-height:3.5rem;
 background:#0f172a;
 border:1px solid var(--border);
 border-radius:var(--radius-sm);
 color:var(--text);
 font-size:.8rem;
 padding:.5rem .5rem .75rem;
 line-height:1.3;
 resize:vertical;
}
textarea.custom-text:focus,
select:focus,
input[type="text"]:focus{
 outline:2px solid var(--accent);
 outline-offset:0;
}

.small-note{
 font-size:.7rem;
 line-height:1.2;
 color:var(--text-dim);
}

/* Level builder cards */

.level-builder-card{
 border:1px solid var(--border);
 border-radius:var(--radius-lg);
 background:rgba(15,23,42,.6);
 padding:1rem;
 margin-bottom:1rem;
 position:relative;
}
.level-builder-top{
 display:flex;
 flex-wrap:wrap;
 gap:.5rem 1rem;
 align-items:flex-start;
 margin-bottom:.75rem;
}
.level-builder-top select,
.level-builder-top input[type="checkbox"]{
 font-size:.8rem;
}

select,
input[type="text"]{
 background:#0f172a;
 border:1px solid var(--border);
 border-radius:var(--radius-sm);
 color:var(--text);
 font-size:.8rem;
 line-height:1.3;
 padding:.5rem .5rem .5rem .5rem;
 min-width:8rem;
}
select:focus,
input[type="text"]:focus{
 outline:2px solid var(--accent);
 outline-offset:0;
}

.level-advanced{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(min(200px,100%),1fr));
 gap:1rem;
}

.form-block{
 display:flex;
 flex-direction:column;
 gap:.5rem;
}
.form-block label{
 font-size:.7rem;
 text-transform:uppercase;
 font-weight:600;
 color:var(--text-dim);
 letter-spacing:.03em;
}
.form-block select{
 width:100%;
}

.form-block .checkbox-multi{
 display:flex;
 flex-direction:column;
 gap:.4rem;
 max-height:8rem;
 overflow-y:auto;
 background:#1e253a;
 border:1px solid var(--border);
 border-radius:var(--radius-sm);
 padding:.5rem;
}
.form-block .checkbox-multi label{
 text-transform:none;
 font-weight:400;
 font-size:.75rem;
 color:var(--text);
 display:flex;
 gap:.5rem;
 line-height:1.3;
 cursor:pointer;
}

.perLevelCustomText{
 min-height:3rem;
 resize:vertical;
}

.remove-level-btn{
 position:absolute;
 top:.75rem;
 right:.75rem;
 font-size:.7rem;
 padding:.3rem .5rem;
 background:#1e1e2f;
 border:1px solid #ef4444;
 color:#ef4444;
 border-radius:var(--radius-sm);
}
.remove-level-btn:hover{
 background:#ef4444;
 color:#0f172a;
}

/* Report preview (sticky panel, auto-expanding textarea) */

.report-card{
 position:sticky;
 top:1rem;
 display:flex;
 flex-direction:column;
}

.report-card textarea{
 width:100%;
 background:#0f172a;
 border:1px solid var(--border);
 border-radius:var(--radius-lg);
 color:var(--text);
 font-size:.8rem;
 line-height:1.4;
 padding:1rem;
 resize:none;
 overflow:hidden;
 min-height:8rem;
 height:auto;
 white-space:pre-wrap;
}

.report-actions{
 display:flex;
 justify-content:space-between;
 align-items:flex-start;
 flex-wrap:wrap;
 gap:.5rem;
 margin-top:.75rem;
}

footer{
 margin-top:2rem;
 color:var(--text-dim);
 font-size:.7rem;
 line-height:1.4;
 text-align:center;
}

.toggle-indicator{
 font-size:.8rem;
 color:var(--text-dim);
}

.hidden{
 display:none !important;
}
</style>
</head>
<body>
<div class="header-bar">
 <div class="header-left">
   <h1>Lumbar Spine MRI Report Builder</h1>
   <div class="badge">prototype • checkbox → prose</div>
   <small>
     Builds draft FINDINGS text for lumbar/thoracolumbar spine (disc → canal → foramina).  
     You must review and edit before signing.
   </small>
 </div>
 <div class="header-right">
   <button id="addLevelBtn" title="Add another level section">+ Add Level</button>
   <button id="copyBtn" title="Copy generated report to clipboard">Copy Report</button>
 </div>
</div>

<div class="container">
 <!-- LEFT COLUMN: inputs -->
 <div>
   <!-- Global sections -->
   <div id="sectionsContainer"></div>

   <!-- Level Builder -->
   <div class="card">
     <div class="header-bar" style="margin-bottom:.5rem;">
        <div class="header-left">
           <h2 style="font-size:1rem;">Level-by-Level Builder (Lumbar)</h2>
           <small>Pathology → canal stenosis → foraminal narrowing.</small>
        </div>
        <div class="header-right" style="margin-left:auto;">
           <button id="addLevelBtn2">+ Add Level</button>
        </div>
     </div>
     <div id="levelsContainer"></div>
   </div>
 </div>

 <!-- RIGHT COLUMN: live preview -->
 <div class="card report-card">
   <h2 style="font-size:1rem; margin-bottom:.5rem;">Report Preview</h2>
   <textarea id="reportOutput" spellcheck="false"></textarea>
   <div class="report-actions">
     <button id="copyBtn2">Copy Report</button>
     <small class="small-note">Empty sections are skipped automatically.</small>
   </div>
 </div>
</div>

<footer>
   Lumbar Spine MRI structured-report helper. Generated text is not final and should not be used verbatim without clinical review.
</footer>

<script>
// ------------------------------------
// CONFIGURATION DATA (Lumbar-specific)
// ------------------------------------

// Global section configuration
// These are the "header" sections before the per-level breakdown.
const sectionsConfig = [
  {
    key: "bones",
    label: "BONES",
    phrases: [
      "No acute fracture or aggressive marrow lesion.",
      "No evidence of fracture or bone marrow lesion.",
      "Alignment and vertebral body heights are maintained.",
      "Vertebral body heights are preserved.",
      "No vertebral body collapse or retropulsion.",
      "Small vertebral body hemangioma.",
      "Small lipid-poor L1 hemangioma.",
      "Schmorl node with chronic deformity.",
      "Edematous degenerative changes of opposing endplates.",
      "Fatty degenerative changes of opposing endplates.",
      "Modic type I degenerative endplate changes.",
      "Modic type II degenerative endplate changes.",
      "Widespread osseous metastatic lesions without vertebral collapse or significant epidural component.",
      "Enhancing osseous lesions concerning for metastasis.",
      "L5 is transitional.",
      "Prior partial hemilaminectomy."
    ]
  },
  {
    key: "alignment",
    label: "VERTEBRAL ALIGNMENT",
    phrases: [
      "Lumbar spine alignment is within normal limits.",
      "Alignment and vertebral body heights are maintained.",
      "No significant spondylolisthesis.",
      "Trace anterolisthesis of L4 on L5.",
      "Trace retrolisthesis of L1 on L2.",
      "Retrolisthesis grade 1 of L1 over L2.",
      "Mild levocurvature.",
      "Mild dextrocurvature."
    ]
  },
  {
    key: "soft",
    label: "PARASPINAL / SOFT TISSUES",
    phrases: [
      "Prevertebral and paraspinal soft tissues are within normal limits.",
      "Paraspinal soft tissues are within normal limits.",
      "No abnormal paraspinal fluid collection.",
      "No significant retroperitoneal abnormality.",
      "Mild paraspinal muscular strain.",
      "Multiple cutaneous lesions compatible with neurofibromas.",
      "Bilateral simple renal cysts.",
      "Status post nephrectomy with soft tissue thickening in the left renal fossa (partially visualized).",
      "No suspicious epidural collection."
    ]
  },
  {
    key: "cord",
    label: "CORD / CONUS",
    phrases: [
      "No evidence of cord compression.",
      "The conus is normal in size and signal and terminates at L1 level, within normal limits.",
      "The conus is normal in size and signal and terminates at mid L2 level, within normal limits.",
      "No intra or extradural mass.",
      "No abnormal enhancement.",
      "No abnormal cauda equina nerve root clumping.",
      "No significant crowding of cauda equina nerve roots.",
      "Mild crowding of cauda equina nerve roots at L3-L4.",
      "Mild mass effect on the thecal sac without significant nerve root compression."
    ]
  },
  {
    key: "discs",
    label: "DISCS",
    phrases: [
      "Multilevel degenerative disc disease.",
      "Multilevel disc bulges on a background of congenital canal stenosis.",
      "Multilevel facet arthropathy is seen.",
      "Multilevel facet arthropathy.",
      "No significant disc herniation or spinal canal stenosis.",
      "No high-grade neural foraminal narrowing.",
      "No neural impingement.",
      "Severe spinal stenosis at L3-L4 with crowding of cauda equina nerve roots.",
      "Severe foraminal stenosis at L4-L5.",
      "L5 is transitional."
    ]
  },
  {
    key: "enhance",
    label: "ABNORMAL ENHANCEMENT",
    phrases: [
      "No abnormal postcontrast enhancement.",
      "No abnormal spinal cord, dural or leptomeningeal enhancement.",
      "No abnormal contrast enhancement is noted.",
      "Mild enhancement associated with Modic type I degenerative endplate changes.",
      "Enhancing osseous lesions concerning for metastasis.",
      "No abnormal epidural or paraspinal soft tissue enhancement."
    ]
  },
  {
    key: "other",
    label: "OTHER / ADDITIONAL FINDINGS",
    phrases: [
      "L5 is transitional.",
      "Mild dural ectasia.",
      "Pre-existing congenital canal stenosis from L2-3 through L4-5.",
      "No intradural mass.",
      "Recommend PET/CT for further evaluation.",
      "No acute abnormality identified."
    ]
  }
];

// Level labels for lumbar
const levelOptions = [
  "T12-L1",
  "L1-L2",
  "L2-L3",
  "L3-L4",
  "L4-L5",
  "L5-S1"
];

// Disc / morphology options (pathology list start)
const discOptions = [
  "No disc bulge.",
  "No significant disc bulge.",
  "Mild diffuse disc bulge.",
  "Mild bulge with posterior annular fissure.",
  "Mild bulge and posterior annular fissure.",
  "Symmetric disc bulge.",
  "Broad-based disc bulge-osteophyte complex.",
  "Disc bulge-osteophyte complex, eccentric to the left.",
  "Disc bulge-osteophyte complex lateralizing towards the left posterolateral margin.",
  "Posterior disc extrusion with caudal migration.",
  "Prior partial hemilaminectomy changes."
];

// Degenerative / facet / ligament / hardware (additional pathology list items)
const degenerativeJointOptions = [
  "Facet joint arthropathy.",
  "Facet hypertrophy.",
  "Bilateral facet hypertrophy.",
  "Facet hypertrophy, left greater than right.",
  "Ligamentum flavum thickening.",
  "Thickening of the ligamenta flava.",
  "Congenital canal stenosis.",
  "Edematous degenerative endplate changes.",
  "Modic type I degenerative endplate changes.",
  "Modic type II degenerative endplate changes.",
  "Severe facet arthropathy.",
  "Residual laminectomy changes."
];

// Canal stenosis / central canal severity
const canalOptions = [
  "No central canal stenosis.",
  "No significant central canal stenosis.",
  "No spinal canal stenosis.",
  "No significant spinal canal stenosis.",
  "Mild spinal canal stenosis.",
  "Mild canal narrowing.",
  "Mild spinal stenosis.",
  "Mild to moderate spinal canal stenosis.",
  "Moderate spinal canal stenosis.",
  "Moderate spinal canal narrowing.",
  "Severe spinal canal stenosis.",
  "Severe spinal stenosis with crowding of cauda equina nerve roots.",
  "Severe spinal stenosis with crowding of cauda equina nerve roots proximal to this level.",
  "Minimal indentation of the thecal sac anteriorly.",
  "Mild mass effect on the anterior thecal sac.",
  "Residual mild canal narrowing, improved."
];

// Thecal sac / cauda equina impact, ties to canal
const cordEffectOptions = [
  "",
  "Without significant thecal sac compression.",
  "Without significant cord compression.",
  "With minimal indentation of the thecal sac.",
  "With mild mass effect on the anterior thecal sac.",
  "With crowding of cauda equina nerve roots.",
  "With slight ventral cord flattening."
];

// Foraminal / subarticular narrowing (last clause)
const foraminalOptions = [
  "No neural foraminal stenosis.",
  "No significant neural foraminal stenosis.",
  "No significant foraminal stenosis.",
  "No significant foraminal narrowing.",
  "Mild bilateral foraminal stenosis.",
  "Mild bilateral neural foraminal narrowing.",
  "Mild left foraminal stenosis.",
  "Mild right foraminal stenosis.",
  "Mild left neural foraminal narrowing.",
  "Mild right neural foraminal narrowing.",
  "Moderate bilateral foraminal stenosis.",
  "Moderate right foraminal stenosis.",
  "Moderate left foraminal stenosis.",
  "Moderate right subarticular zone narrowing.",
  "Moderate to marked right subarticular zone narrowing.",
  "Severe bilateral foraminal stenosis.",
  "Severe left foraminal stenosis.",
  "Severe right foraminal stenosis.",
  "Marked bilateral foraminal stenosis.",
  "Bilateral subarticular stenosis.",
  "Severe left subarticular and left foraminal stenosis.",
  "Severe right lateral recess and foraminal stenosis."
];

// Nerve root impact (extends foraminal clause)
const nerveImpactOptions = [
  "",
  "Which may affect the transiting right L3 nerve.",
  "Which may affect the transiting left L4 nerve.",
  "Which may affect the transiting right L4 nerve.",
  "Which may affect the exiting left L3 nerve at the neural foramen.",
  "With mild medial displacement of the transiting left L5 nerve.",
  "With superior displacement of the exiting left L4 nerve at the neural foramen.",
  "With compression of both L5 nerves at the neural foramina."
];

// ------------------------------------
// DOM HELPERS
// ------------------------------------

function escapeHtml(str){
  return str
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

// Build each global section card (BONES, ALIGNMENT, etc.)
function createSectionCard(sectionCfg){
  const card = document.createElement("div");
  card.className = "section-card";
  card.dataset.sectionKey = sectionCfg.key;

  // header
  const head = document.createElement("div");
  head.className = "section-head";

  const h3 = document.createElement("h3");
  h3.innerHTML = `<span>${sectionCfg.label}</span><span class="level-count">${sectionCfg.phrases.length} options</span>`;

  const toggleSpan = document.createElement("span");
  toggleSpan.className = "toggle-indicator";
  toggleSpan.textContent = "▼";

  head.appendChild(h3);
  head.appendChild(toggleSpan);

  // body
  const body = document.createElement("div");
  body.className = "section-body";

  // checkbox list
  const group = document.createElement("div");
  group.className = "option-group";

  sectionCfg.phrases.forEach((phrase, idx) => {
    const lbl = document.createElement("label");
    lbl.className = "option-line";
    const id = `${sectionCfg.key}_${idx}`;
    lbl.innerHTML = `
      <input type="checkbox" data-phrase="${escapeHtml(phrase)}" id="${id}" />
      <span>${phrase}</span>
    `;
    group.appendChild(lbl);
  });

  // custom text addition
  const customBlock = document.createElement("div");
  customBlock.className = "option-group";
  const customLabel = document.createElement("div");
  customLabel.className = "small-note";
  customLabel.textContent = "Custom text to append to this section (optional):";
  const customTA = document.createElement("textarea");
  customTA.className = "custom-text";
  customTA.setAttribute("placeholder", "Custom addition for this section...");
  customTA.dataset.customFor = sectionCfg.key;

  customBlock.appendChild(customLabel);
  customBlock.appendChild(customTA);

  body.appendChild(group);
  body.appendChild(customBlock);

  // collapse/expand behavior
  head.addEventListener("click", () => {
    body.classList.toggle("hidden");
    toggleSpan.textContent = body.classList.contains("hidden") ? "▲" : "▼";
    buildReport();
  });

  // live update report on selection
  body.addEventListener("input", buildReport);

  card.appendChild(head);
  card.appendChild(body);
  return card;
}

// ------------------------------------
// LEVEL CARD CREATION (Lumbar levels)
// ------------------------------------

let levelIdCounter = 0;

function makeFormBlockInline(labelTxt, element){
  const wrap = document.createElement("div");
  wrap.className = "form-block";
  wrap.style.minWidth = "8rem";
  const lbl = document.createElement("label");
  lbl.textContent = labelTxt;
  wrap.appendChild(lbl);
  wrap.appendChild(element);
  return wrap;
}

function createLevelCard(){
  levelIdCounter += 1;
  const lvlId = `levelCard_${levelIdCounter}`;

  const card = document.createElement("div");
  card.className = "level-builder-card";
  card.dataset.levelCardId = lvlId;

  // remove button
  const rmBtn = document.createElement("button");
  rmBtn.className = "remove-level-btn";
  rmBtn.textContent = "Remove";
  rmBtn.addEventListener("click", ()=>{
    card.remove();
    buildReport();
  });
  card.appendChild(rmBtn);

  // top row: level select + normal checkbox
  const top = document.createElement("div");
  top.className = "level-builder-top";

  // level select
  const levelSel = document.createElement("select");
  levelSel.innerHTML =
    `<option value="">[Select level]</option>` +
    levelOptions.map(l => `<option value="${escapeHtml(l)}">${l}</option>`).join("");
  levelSel.className = "level-select";

  // normal-level checkbox
  const normalWrap = document.createElement("label");
  normalWrap.style.fontSize = ".75rem";
  normalWrap.style.display = "flex";
  normalWrap.style.alignItems = "center";
  normalWrap.style.gap = ".4rem";
  const normalChk = document.createElement("input");
  normalChk.type = "checkbox";
  normalChk.className = "normal-level-chk";
  normalWrap.appendChild(normalChk);
  normalWrap.appendChild(document.createTextNode("Normal level (no canal or foraminal stenosis)"));

  top.appendChild(makeFormBlockInline("Level", levelSel));
  top.appendChild(normalWrap);

  // advanced detail grid
  const adv = document.createElement("div");
  adv.className = "level-advanced";

  // Disc / morphology (pathology)
  const discBlock = document.createElement("div");
  discBlock.className = "form-block";
  const discLbl = document.createElement("label");
  discLbl.textContent = "Disc / morphology (pathology list start)";
  const discSel = document.createElement("select");
  discSel.innerHTML = `<option value="">(none)</option>` +
    discOptions.map(p => `<option value="${escapeHtml(p)}">${p}</option>`).join("");
  discSel.className = "disc-phrase";
  discBlock.appendChild(discLbl);
  discBlock.appendChild(discSel);

  // Degenerative / facet / ligament etc (additional pathology list)
  const degenBlock = document.createElement("div");
  degenBlock.className = "form-block";
  const degenLbl = document.createElement("label");
  degenLbl.textContent = "Facet / ligament / endplate / postop (more pathology)";
  const degenBox = document.createElement("div");
  degenBox.className = "checkbox-multi degen-phrases";
  degenerativeJointOptions.forEach((p,idx)=>{
    const dlbl = document.createElement("label");
    const did = `${lvlId}_degen_${idx}`;
    dlbl.innerHTML = `
      <input type="checkbox" value="${escapeHtml(p)}" id="${did}" />
      <span>${p}</span>`;
    degenBox.appendChild(dlbl);
  });
  degenBlock.appendChild(degenLbl);
  degenBlock.appendChild(degenBox);

  // Canal stenosis / central canal severity
  const canalBlock = document.createElement("div");
  canalBlock.className = "form-block";
  const canalLbl = document.createElement("label");
  canalLbl.textContent = "Central canal stenosis / canal severity";
  const canalSel = document.createElement("select");
  canalSel.innerHTML = `<option value="">(none)</option>` +
    canalOptions.map(p => `<option value="${escapeHtml(p)}">${p}</option>`).join("");
  canalSel.className = "canal-phrase";
  canalBlock.appendChild(canalLbl);
  canalBlock.appendChild(canalSel);

  // Thecal sac / cauda equina effect
  const cordEffBlock = document.createElement("div");
  cordEffBlock.className = "form-block";
  const cordEffLbl = document.createElement("label");
  cordEffLbl.textContent = "Thecal sac / cauda equina impact (ties to canal stenosis)";
  const cordEffSel = document.createElement("select");
  cordEffSel.innerHTML = cordEffectOptions
    .map(p => `<option value="${escapeHtml(p)}">${p || "(none)"} </option>`)
    .join("");
  cordEffSel.className = "cord-effect-phrase";
  cordEffBlock.appendChild(cordEffLbl);
  cordEffBlock.appendChild(cordEffSel);

  // Foraminal / subarticular narrowing (last clause)
  const foramBlock = document.createElement("div");
  foramBlock.className = "form-block";
  const foramLbl = document.createElement("label");
  foramLbl.textContent = "Foraminal / subarticular narrowing (last clause)";
  const foramSel = document.createElement("select");
  foramSel.innerHTML = `<option value="">(none)</option>` +
    foraminalOptions.map(p => `<option value="${escapeHtml(p)}">${p}</option>`).join("");
  foramSel.className = "foraminal-phrase";
  foramBlock.appendChild(foramLbl);
  foramBlock.appendChild(foramSel);

  // Nerve root impact
  const nerveBlock = document.createElement("div");
  nerveBlock.className = "form-block";
  const nerveLbl = document.createElement("label");
  nerveLbl.textContent = "Nerve root impact (after foraminal clause)";
  const nerveSel = document.createElement("select");
  nerveSel.innerHTML = nerveImpactOptions
    .map(p => `<option value="${escapeHtml(p)}">${p || "(none)"} </option>`)
    .join("");
  nerveSel.className = "nerve-phrase";
  nerveBlock.appendChild(nerveLbl);
  nerveBlock.appendChild(nerveSel);

  // Custom free text per level
  const customBlock = document.createElement("div");
  customBlock.className = "form-block";
  const customLbl = document.createElement("label");
  customLbl.textContent = "Custom note for this level (optional)";
  const customTA = document.createElement("textarea");
  customTA.className = "custom-text perLevelCustomText";
  customTA.setAttribute("placeholder", "Custom detail, e.g. 'Severe left foraminal stenosis with compression of the exiting L5 nerve.'");
  customBlock.appendChild(customLbl);
  customBlock.appendChild(customTA);

  // assemble advanced grid
  adv.appendChild(discBlock);
  adv.appendChild(degenBlock);
  adv.appendChild(canalBlock);
  adv.appendChild(cordEffBlock);
  adv.appendChild(foramBlock);
  adv.appendChild(nerveBlock);
  adv.appendChild(customBlock);

  // listeners to update report
  [
    levelSel,
    normalChk,
    discSel,
    canalSel,
    foramSel,
    nerveSel,
    cordEffSel,
    customTA
  ].forEach(el => {
    el.addEventListener("input", ()=>{
      toggleAdvanced();
      buildReport();
    });
  });
  degenBox.addEventListener("input", buildReport);

  // hide advanced if "normal level" checked
  function toggleAdvanced(){
    if(normalChk.checked){
      adv.classList.add("hidden");
    }else{
      adv.classList.remove("hidden");
    }
  }
  toggleAdvanced();

  card.appendChild(top);
  card.appendChild(adv);

  return card;
}

// ------------------------------------
// REPORT GENERATION
// ------------------------------------

// resize preview textarea so it grows with content
function autoResize(el){
  if(!el) return;
  el.style.height = "auto";
  el.style.height = el.scrollHeight + "px";
}

function buildReport(){
  const reportParts = [];

  // harvest text from each global section
  function getSectionText(secKey){
    const card = document.querySelector(`.section-card[data-section-key="${secKey}"]`);
    if(!card) return "";
    const body = card.querySelector(".section-body");
    if(!body) return "";

    // collect checked phrases
    const checked = Array.from(body.querySelectorAll('input[type="checkbox"]:checked'))
      .map(cb => cb.getAttribute("data-phrase"))
      .filter(Boolean);

    // dedupe while preserving order
    const deduped = [];
    checked.forEach(p => { if(!deduped.includes(p)) deduped.push(p); });

    const custom = (body.querySelector('textarea.custom-text')?.value || "").trim();

    let text = "";
    if(deduped.length){
      text += deduped.join(" ");
    }
    if(custom){
      if(text) text += " ";
      text += custom;
    }
    return text.trim();
  }

  // Build level text (lumbar) using the specified ordering:
  //   1. Pathology list (disc + facet/ligament/etc)
  //   2. "resulting in" canal stenosis + thecal sac / cauda equina effect
  //   3. "and" foraminal / subarticular stenosis + nerve root impact
  function buildLevelsText(){
    const lvlCards = Array.from(document.querySelectorAll(".level-builder-card"));
    if(!lvlCards.length) return "";

    const lines = [];

    lvlCards.forEach(card=>{
      const level = card.querySelector(".level-select")?.value || "";
      const normal = card.querySelector(".normal-level-chk")?.checked || false;

      if(!level) return; // skip cards without level

      if(normal){
        lines.push(`${level}: No central canal or neural foraminal stenosis.`);
        return;
      }

      // collect pieces from the form
      const discPhrase = (card.querySelector(".disc-phrase")?.value || "").trim();
      const canalPhrase = (card.querySelector(".canal-phrase")?.value || "").trim();
      const foraminalPhrase = (card.querySelector(".foraminal-phrase")?.value || "").trim();
      const nervePhrase = (card.querySelector(".nerve-phrase")?.value || "").trim();
      const cordEffPhrase = (card.querySelector(".cord-effect-phrase")?.value || "").trim();
      const custom = (card.querySelector(".perLevelCustomText")?.value || "").trim();

      // multi-select degenerative / facet etc.
      const degenChecks = Array
        .from(card.querySelectorAll(".degen-phrases input[type='checkbox']:checked"))
        .map(cb=>cb.value.trim())
        .filter(Boolean);

      // Build pathology list from discPhrase + degenerative phrases
      const pathologyList = [];
      if(discPhrase) pathologyList.push(discPhrase.replace(/\.$/,""));
      if(degenChecks.length){
        pathologyList.push(degenChecks.map(p=>p.replace(/\.$/,"")).join(", "));
      }
      const pathologyStr = pathologyList.join(", ");

      // Build canal portion: canal severity + thecal sac / cauda equina impact
      let canalPart = "";
      if(canalPhrase){
        canalPart += canalPhrase.replace(/\.$/,"");
      }
      if(cordEffPhrase){
        const ce = cordEffPhrase.replace(/\.$/,"");
        if(canalPart){
          canalPart += " " + ce;
        } else {
          canalPart = ce;
        }
      }
      canalPart = canalPart.trim();

      // Build foraminal portion: foraminal stenosis + nerve root impact
      let foraminalPart = "";
      if(foraminalPhrase){
        foraminalPart += foraminalPhrase.replace(/\.$/,"");
      }
      if(nervePhrase){
        const np = nervePhrase.replace(/\.$/,"");
        if(foraminalPart){
          foraminalPart += " " + np;
        } else {
          foraminalPart = np;
        }
      }
      foraminalPart = foraminalPart.trim();

      // Final sentence assembly
      // "[LEVEL]: [PATHOLOGIES], resulting in [CANAL], and [FORAMINAL]."
      let sentenceCore = "";

      if(pathologyStr){
        sentenceCore += pathologyStr;
        if(canalPart && foraminalPart){
          sentenceCore += ", resulting in " + canalPart + ", and " + foraminalPart;
        } else if(canalPart){
          sentenceCore += ", resulting in " + canalPart;
        } else if(foraminalPart){
          sentenceCore += ", resulting in " + foraminalPart;
        }
      } else {
        // If no pathology string, but stenosis phrases exist, just report those.
        if(canalPart && foraminalPart){
          sentenceCore += canalPart + ", and " + foraminalPart;
        } else if(canalPart){
          sentenceCore += canalPart;
        } else if(foraminalPart){
          sentenceCore += foraminalPart;
        }
      }

      sentenceCore = sentenceCore.trim();
      if(sentenceCore && !sentenceCore.endsWith(".")){
        sentenceCore += ".";
      }

      // append custom detail (if provided)
      let trailingCustom = "";
      if(custom){
        let c = custom.trim();
        if(!c.endsWith(".")) c += ".";
        trailingCustom = " " + c;
      }

      const fullSentence = `${level}: ${sentenceCore}${trailingCustom}`.trim();
      if(fullSentence){
        lines.push(fullSentence);
      }
    });

    return lines.join("\n");
  }

  // canonical output section order
  const order = [
    {key:"bones", label:"BONES"},
    {key:"alignment", label:"VERTEBRAL ALIGNMENT"},
    {key:"soft", label:"PARASPINAL / SOFT TISSUES"},
    {key:"cord", label:"CORD / CONUS"},
    {key:"discs", label:"DISCS"},
    {key:"levels", label:"LEVELS"},
    {key:"enhance", label:"ABNORMAL ENHANCEMENT"},
    {key:"other", label:"OTHER / ADDITIONAL FINDINGS"}
  ];

  const levelsText = buildLevelsText();
  const reportPartsLocal = [];

  order.forEach(item=>{
    let bodyText = "";
    if(item.key === "levels"){
      bodyText = levelsText.trim();
    } else {
      bodyText = getSectionText(item.key);
    }
    if(bodyText){
      reportPartsLocal.push(item.label + ":\n" + bodyText.trim());
    }
  });

  const finalText = "FINDINGS:\n\n" + reportPartsLocal.join("\n\n");
  const outEl = document.getElementById("reportOutput");
  if(outEl){
    outEl.value = finalText.trim();
    autoResize(outEl);
  }
}

// ------------------------------------
// INIT
// ------------------------------------

function initSections(){
  const container = document.getElementById("sectionsContainer");
  sectionsConfig.forEach(secCfg=>{
    const card = createSectionCard(secCfg);
    container.appendChild(card);
  });
}

function initLevelButtons(){
  const addBtns = [document.getElementById("addLevelBtn"), document.getElementById("addLevelBtn2")];
  addBtns.forEach(btn=>{
    if(btn){
      btn.addEventListener("click", ()=>{
        const lvlCard = createLevelCard();
        document.getElementById("levelsContainer").appendChild(lvlCard);
        buildReport();
      });
    }
  });
}

function initCopyButtons(){
  const copyBtns = [document.getElementById("copyBtn"), document.getElementById("copyBtn2")];
  copyBtns.forEach(btn=>{
    if(btn){
      btn.addEventListener("click", ()=>{
        const text = document.getElementById("reportOutput").value;
        navigator.clipboard.writeText(text).then(()=>{
          btn.textContent = "Copied!";
          setTimeout(()=>{btn.textContent="Copy Report";},1500);
        }).catch(()=>{
          btn.textContent = "Copy Failed";
          setTimeout(()=>{btn.textContent="Copy Report";},1500);
        });
      });
    }
  });
}

function initPreviewAutosize(){
  const outEl = document.getElementById("reportOutput");
  if(!outEl) return;
  outEl.addEventListener("input", ()=>{
    autoResize(outEl);
  });
}

document.addEventListener("DOMContentLoaded", ()=>{
  initSections();
  initLevelButtons();
  initCopyButtons();
  initPreviewAutosize();
  buildReport();
});
</script>
</body>
</html>
