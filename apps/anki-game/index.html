<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>APKG → Lightning Drill</title>
<style>
  :root{
    --bg:#0b0f14; --fg:#e8f0ff; --muted:#9bb0d0; --accent:#4ea1ff;
    --good:#25d366; --bad:#ff4d6d; --panel:#121826; --panel2:#0f1522; --stroke:#243042;
  }
  html,body{height:100%}
  body{
    margin:0; background:#000;
    color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    overflow:hidden;
  }

  /* Animated background */
  #bgfx, #bgfx2{
    position:fixed; inset:0; z-index:-2; pointer-events:none; filter:blur(40px) saturate(120%);
    background:
      radial-gradient(1200px 600px at 10% 20%, #113a71 0%, transparent 60%),
      radial-gradient(1000px 600px at 90% 80%, #360f5b 0%, transparent 60%),
      linear-gradient(180deg, #070b12 0%, #0a1020 100%);
    animation:bgpan 18s linear infinite alternate;
  }
  #bgfx2{
    mix-blend-mode:screen; opacity:.7; filter:blur(60px) saturate(160%);
    background:
      radial-gradient(700px 500px at 70% 20%, #0064ff 0%, transparent 60%),
      radial-gradient(700px 500px at 30% 80%, #a000ff 0%, transparent 60%);
    animation:bgpan2 22s linear infinite alternate;
  }
  @keyframes bgpan { to{ transform:translate3d(0,8%,0) } }
  @keyframes bgpan2{ to{ transform:translate3d(0,-6%,0) } }

  header{
    position:relative; z-index:2; display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    padding:12px 14px; border-bottom:1px solid #0f1a2a; background:linear-gradient(180deg, rgba(10,16,28,.7), rgba(10,16,28,.25));
    backdrop-filter:blur(8px);
  }
  input[type=file]{ background:#0e1522; border:1px solid #1c2a3f; color:var(--fg); padding:8px; border-radius:10px }
  button, .btn{
    border:0; padding:10px 14px; border-radius:12px; background:var(--accent); color:#fff; font-weight:700; cursor:pointer;
    box-shadow:0 6px 18px rgba(78,161,255,.25);
  }
  button.small{ padding:8px 10px; font-size:12px; background:#2b6cb0 }
  button.ghost{ background:#0f1522; color:var(--fg); border:1px solid #263246; box-shadow:none }
  button.good{ background:var(--good) } button.bad{ background:var(--bad) }
  button:active{ transform:translateY(1px) }

  .tag{ font-size:12px; opacity:.85; color:var(--muted) }
  .sep{ width:1px; height:28px; background:#1b283d; margin:0 6px }

  #hud{
    position:relative; z-index:1; display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-left:auto;
  }
  #timer, #stats{ padding:6px 10px; border-radius:10px; background:#0f1522; border:1px solid #1f2b40; font-weight:700 }
  #stats small{ font-weight:600; color:var(--muted) }

  main{
    position:fixed; inset:64px 0 0 0; display:grid; place-items:center; padding:18px;
  }
  #card{
    width:min(900px, 92vw); min-height:48vh;
    background:linear-gradient(180deg, var(--panel), var(--panel2));
    border:1px solid var(--stroke); border-radius:18px; padding:22px;
    box-shadow:0 30px 80px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02);
    display:flex; flex-direction:column; justify-content:space-between; gap:16px;
  }
  #front, #back{ font-size:22px; line-height:1.45; }
  #back{ display:none }
  .cloze{ cursor:pointer; border-bottom:1px dashed #6aa9ff }
  #controls{ display:flex; gap:12px; flex-wrap:wrap; justify-content:center }
  #reveal{ background:#6c5ce7 }
  #progressWrap{ height:6px; background:#102035; border-radius:999px; overflow:hidden; border:1px solid #22324d }
  #progress{ height:100%; width:0%; background:linear-gradient(90deg, #00d8ff, #6a5cff); transition:width .2s ease }
  #subhud{ display:flex; justify-content:space-between; align-items:center; gap:10px }
  #title{ font-weight:700; color:#cfe2ff; opacity:.9; letter-spacing:.3px }

  /* Missed drawer */
  #drawer{
    position:fixed; top:64px; right:0; width:min(540px, 92vw); height:calc(100% - 64px);
    background:linear-gradient(180deg, #0f1522, #0c1220); border-left:1px solid #22324d; transform:translateX(100%);
    transition:transform .25s ease; z-index:3; display:flex; flex-direction:column;
  }
  #drawer.open{ transform:none }
  #drawer header{ border-bottom:1px solid #22324d }
  #missList{ padding:12px; overflow:auto; display:grid; gap:10px }
  .missItem{
    background:#0f1627; border:1px solid #22324d; border-radius:12px; padding:12px; font-size:14px; line-height:1.35
  }
  .missItem .front{ font-weight:700; color:#d7e7ff; margin-bottom:6px }
  .missItem .back{ color:#b9c9e4 }

  /* Start modal + pause overlay + summary */
  .overlay{
    position:fixed; inset:0; backdrop-filter:blur(10px); display:flex; align-items:center; justify-content:center;
    background:rgba(5,10,18,.6); z-index:4;
  }
  .sheet{
    width:min(700px, 94vw); background:linear-gradient(180deg, #10182a, #0b1324);
    border:1px solid #22324d; border-radius:16px; padding:18px; box-shadow:0 30px 80px rgba(0,0,0,.45);
  }
  .optRow{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 6px }
  .optRow button{ background:#172037 }
  .optRow button.sel{ outline:2px solid #4ea1ff }
  .field{ display:flex; gap:8px; align-items:center }
  .field input{ width:80px; background:#0e1522; border:1px solid #22324d; color:var(--fg); padding:8px; border-radius:10px }
  .sheet h2{ margin:0 0 8px 0 }
  .sheet p{ margin:6px 0 10px 0; color:#b9c9e4 }

  #pausedBanner{
    position:fixed; inset:0; z-index:5; display:none; align-items:center; justify-content:center; color:#fff;
    background:rgba(10,14,24,.6); backdrop-filter:blur(6px);
  }
  #pausedBanner .tag{ font-size:18px }
  #pausedBanner .big{ font-size:42px; font-weight:900; margin-top:4px }

  /* Bursts */
  .burst{
    position:fixed; width:20px; height:20px; border-radius:50%; pointer-events:none; opacity:.85; z-index:2;
    transform:translate(-50%,-50%); animation:pop .6s ease forwards;
  }
  @keyframes pop{
    0%{ transform:translate(-50%,-50%) scale(.6); opacity:.9 }
    100%{ transform:translate(-50%,-50%) scale(18); opacity:0 }
  }

  /* Log + debug (toggleable) */
  #log{ position:fixed; left:12px; bottom:10px; font-size:12px; opacity:.8 }
  #debug{ display:none; position:fixed; left:12px; bottom:30px; font-size:12px; white-space:pre-wrap; background:#0d1626; border:1px solid #1e2c44; color:#cae8ff; padding:10px; border-radius:10px; max-width:min(70ch,92vw) }

  /* Responsive tweaks */
  @media (max-width:700px){
    #front,#back{ font-size:18px }
    #card{ min-height:50vh }
  }
</style>
</head>
<body>
<div id="bgfx"></div><div id="bgfx2"></div>

<header>
  <input id="file" type="file" accept=".apkg,.colpkg" />
  <button id="showStart" class="ghost" disabled>Configure & Start</button>
  <button id="toggleDrawer" class="ghost">Missed (0)</button>
  <div class="sep"></div>
  <button id="pauseBtn" class="ghost" disabled>Pause</button>
  <div id="hud">
    <div id="timer" aria-live="polite">⏱️ —</div>
    <div id="stats"><small>Seen</small> <b id="seen">0</b> · <small>Got</small> <b id="got">0</b> · <small>Missed</small> <b id="miss">0</b></div>
  </div>
</header>

<main>
  <div id="card" aria-live="polite" aria-atomic="true">
    <div id="subhud">
      <div id="title">Load a deck to begin</div>
      <div id="progressWrap" style="flex:1"><div id="progress"></div></div>
    </div>
    <div id="front">(front)</div>
    <div id="back">(back)</div>
    <div id="controls">
      <button id="reveal" class="btn">Reveal (Space)</button>
      <button id="badBtn" class="btn bad">Missed (←)</button>
      <button id="goodBtn" class="btn good">Got it (→)</button>
    </div>
  </div>
</main>

<!-- Missed Drawer -->
<aside id="drawer" aria-label="Missed list">
  <header style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
    <div style="display:flex;align-items:center;gap:10px">
      <strong>Missed</strong><span class="tag" id="missCountTop">0 items</span>
    </div>
    <div style="display:flex;gap:8px;align-items:center;padding-right:8px">
      <button id="exportMiss" class="ghost small">Export CSV</button>
      <button id="studyMissed" class="small">Study Missed Only</button>
    </div>
  </header>
  <div id="missList"></div>
</aside>

<!-- Start Modal -->
<div id="startOverlay" class="overlay" style="display:none">
  <div class="sheet">
    <h2>Lightning Drill</h2>
    <p>Choose a session length. You can pause anytime (P). This won’t modify Anki scheduling.</p>
    <div class="optRow" id="presets">
      <button data-min="2">2 min</button>
      <button data-min="5" class="sel">5 min</button>
      <button data-min="10">10 min</button>
      <button data-min="15">15 min</button>
      <button data-min="0">Untimed</button>
    </div>
    <div class="field"><label for="customMin">Custom:</label> <input id="customMin" type="number" min="0" value="0" /> <span class="tag">minutes (0 = untimed)</span></div>
    <div class="optRow" style="margin-top:12px">
      <button id="startBtn">Start Session</button>
      <button id="cancelStart" class="ghost">Cancel</button>
    </div>
    <div class="tag" id="deckInfo">No deck loaded</div>
  </div>
</div>

<!-- Paused Overlay -->
<div id="pausedBanner" class="overlay">
  <div style="text-align:center">
    <div class="tag">Session paused</div>
    <div class="big">⏸️</div>
    <div class="optRow" style="justify-content:center;margin-top:12px">
      <button id="resumeBtn">Resume (P)</button>
    </div>
  </div>
</div>

<!-- Summary Overlay -->
<div id="summary" class="overlay" style="display:none">
  <div class="sheet">
    <h2>Session Complete</h2>
    <p><b><span id="sumSeen">0</span></b> seen · <b><span id="sumGot">0</span></b> got · <b><span id="sumMiss">0</span></b> missed</p>
    <div class="optRow">
      <button id="restartBtn">Restart</button>
      <button id="missOnlyBtn" class="ghost">Study Missed Only</button>
      <button id="closeSummary" class="ghost">Close</button>
    </div>
  </div>
</div>

<!-- Logs -->
<div id="debug"></div>
<div id="log"></div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sql.js@1.10.2/dist/sql-wasm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/protobufjs@7.3.0/dist/protobuf.min.js"></script>
<script>
/* ========== Helpers / UI ========== */
const $ = sel => document.querySelector(sel);
const logEl = $('#log'), dbgEl = $('#debug');
function log(s){ logEl.textContent = s }
function showDebug(text){ dbgEl.style.display='block'; dbgEl.textContent = text }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])).replace(/'/g, '&#39;') }
function sanitize(html){ return String(html).replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,'') }
function stripHtml(s){ const d=document.createElement('div'); d.innerHTML=s; return d.textContent||d.innerText||'' }
function pulseBurst(x,y,color){ const b=document.createElement('div'); b.className='burst'; b.style.left=x+'px'; b.style.top=y+'px'; b.style.background=color; document.body.appendChild(b); setTimeout(()=>b.remove(),600) }

/* ========== Global state ========== */
let SQLReady=false, SQL;
let G = {
  entries:null, fileTable:{}, mediaMap:{}, replaceMedia:(h)=>h,
  decks:{}, models:{}, notes:[], cards:[],
  queue:[], idx:0, seen:0, got:0, missed:[],
  sessionMs: 5*60*1000, untimed:false, endAt:0, paused:false, timerHandle:null,
  isClozeByMid:{}
};

/* ========== Load sql.js ========== */
initSqlJs({ locateFile: f => `https://cdn.jsdelivr.net/npm/sql.js@1.10.2/dist/${f}` })
.then(db => { SQL=db; SQLReady=true })
.catch(e => alert('Failed to load SQLite (sql.js). Refresh and try again.\n'+e?.message));

/* ========== ZIP read ========== */
function unzipWithWatchdog(buf, timeoutMs=20000){
  return new Promise((resolve, reject) => {
    let done=false; const to=setTimeout(()=>{ if(!done){done=true; reject(new Error('Unzip timeout'))}}, timeoutMs);
    try{
      fflate.unzip(buf, {consume:true}, (err,obj)=>{
        if(done) return; clearTimeout(to);
        if(err){ done=true; reject(err) } else { done=true; resolve(obj) }
      });
    }catch(e){ clearTimeout(to); reject(e) }
  });
}

/* ========== Media parsing (JSON or protobuf; zstd lazy) ========== */
function looksGzip(b){ return b.length>2 && b[0]===0x1F && b[1]===0x8B }
function looksZstd(b){ return b.length>4 && ((b[0]===0xFD&&b[1]===0x2F&&b[2]===0xB5&&b[3]===0x28)||(b[0]===0x28&&b[1]===0xB5&&b[2]===0x2F&&b[3]===0xFD)) }
function loadScript(url){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=url; s.onload=res; s.onerror=()=>rej(new Error('Failed '+url)); document.head.appendChild(s) }) }
async function maybeDecompress(bytes){
  if(bytes[0]===0x7B) return bytes;
  if(looksGzip(bytes)) return fflate.gunzipSync(bytes);
  if(looksZstd(bytes)){
    if(!window.ZstdCodec) await loadScript('https://cdn.jsdelivr.net/npm/zstd-codec@0.1.4/dist/zstd-codec.min.js');
    return await new Promise((resolve,reject)=>{
      window.ZstdCodec.run(zstd=>{
        try{ const out = new zstd.Simple().decompress(bytes); resolve(out) }catch(e){ reject(e) }
      })
    })
  }
  return bytes;
}
function parseMediaJSON(txt){
  if (txt.charCodeAt(0)===0xFEFF) txt=txt.slice(1);
  const first=txt.indexOf('{'), last=txt.lastIndexOf('}');
  if(first<0||last<0||last<=first) throw new Error('No JSON object in media file');
  txt=txt.slice(first,last+1).replace(/,\s*([}\]])/g,'$1').replace(/[\u0000-\u0008\u000B-\u000C\u000E-\u001F]/g,'')
                             .replace(/([{,]\s*)(\d+)(\s*:)/g,'$1"$2"$3');
  return JSON.parse(txt);
}
async function decodeProtoMedia(bytes){
  const urls=[
    "https://cdn.jsdelivr.net/gh/ankitects/anki@stable/proto/anki/import_export.proto",
    "https://cdn.jsdelivr.net/gh/ankitects/anki@main/proto/anki/import_export.proto"
  ];
  let root=null;
  for(const u of urls){
    try{ const r=await fetch(u,{cache:'force-cache'}); if(!r.ok) continue; root=protobuf.parse(await r.text()).root; break }catch{}
  }
  if(!root) throw new Error('proto load failed');
  // heuristic scan for entries with index+filename
  function toMap(obj){
    for(const v of Object.values(obj||{})){
      if(Array.isArray(v)&&v.length&&typeof v[0]==='object'){
        const hasIdx=('index'in v[0])||('id'in v[0]); const hasNm=('filename'in v[0])||('name'in v[0]);
        if(hasIdx&&hasNm){ const m={}; for(const it of v){ const k=(it.index??it.id); const nm=(it.filename??it.name); if(k!=null&&typeof nm==='string') m[String(k)]=nm } return m }
      }
    }
    return null;
  }
  const all=[];(function walk(ns){ for(const k of Object.keys(ns.nested||{})){ const v=ns.nested[k]; if(v.fields) all.push(v); if(v.nested) walk(v) } })(root);
  for(const T of all){ try{ const msg=T.decode(bytes); const map=toMap(msg); if(map) return map }catch{} }
  throw new Error('unknown media map in protobuf');
}
async function parseMediaEntry(entryBytes){
  const td=new TextDecoder('utf-8',{fatal:false});
  let bytes=await maybeDecompress(entryBytes);
  if(bytes[0]===0x7B){ return parseMediaJSON(td.decode(bytes)) }
  try{ return await decodeProtoMedia(bytes) }catch(e){ console.warn('media map parse failed',e); return {} }
}
function mediaURLForKey(key, files){
  const bytes=files[key]; if(!bytes) return null;
  return URL.createObjectURL(new Blob([bytes],{type:'application/octet-stream'}));
}
function buildMediaReplacer(mediaMap, files){
  const reverse={}; for(const [k,v] of Object.entries(mediaMap)) reverse[v]=k;
  const imgRE=/<img[^>]+src=["']([^"']+)["'][^>]*>/gi;
  const audioRE=/\[sound:([^\]]+)\]/gi;
  function resolve(src){
    if(/^\d+$/.test(src)){ const u=mediaURLForKey(src,files); if(u) return u }
    let u=mediaURLForKey(src,files); if(u) return u;
    const idx=reverse[src]; if(idx!==undefined){ u=mediaURLForKey(idx,files); if(u) return u }
    return null;
  }
  return function replaceAll(html){
    html=html.replace(imgRE,(m,src)=>{ const u=resolve(src); return u? m.replace(src,u):m });
    html=html.replace(audioRE,(m,name)=>{ const u=resolve(name); return u? `<audio controls preload="metadata" src="${u}"></audio>`:m });
    return html;
  }
}

/* ========== Template + Cloze ========== */
function applyConditionals(tpl, fields, fieldNames){
  tpl=tpl.replace(/\{\{#([^}]+)\}\}([\s\S]*?)\{\{\/\1\}\}/g,(m,name,inner)=>{
    const idx=fieldNames.indexOf(name.trim()); const val=idx>=0?fields[idx]:'';
    return String(val).trim()? inner : '';
  });
  tpl=tpl.replace(/\{\{\^([^}]+)\}\}([\s\S]*?)\{\{\/\1\}\}/g,(m,name,inner)=>{
    const idx=fieldNames.indexOf(name.trim()); const val=idx>=0?fields[idx]:'';
    return String(val).trim()? '' : inner;
  });
  return tpl;
}
function collectClozeFieldsFromTemplate(tpl){
  const set=new Set(); tpl.replace(/\{\{([^}]+)\}\}/g,(_m,token)=>{
    const parts=token.trim().split(':'); const field=parts.pop().trim();
    const chain=parts.map(p=>p.trim().toLowerCase());
    if(chain.includes('cloze')) set.add(field);
  }); return set;
}
function processClozeForOrd(text, targetIndex, side){
  return String(text).replace(/\{\{c(\d+)::([\s\S]*?)(?:::(.*?))?\}\}/g,(m,n,inner,hint)=>{
    const idx=parseInt(n,10);
    if(idx===targetIndex){
      if(side==='front'){ return `<span class="cloze" title="${escapeHtml(hint||'')}">[ tap to reveal ]<span style="display:none">${escapeHtml(inner)}</span></span>` }
      else{ return `<span class="cloze-reveal">${escapeHtml(inner)}</span>` }
    }
    return escapeHtml(inner);
  });
}
function stripClozeMarkup(s){
  return String(s).replace(/\{\{c\d+::([\s\S]*?)(?:::[^}]*)?\}\}/g,'$1');
}
function substituteTokens(tpl, fields, fieldNames, { side, targetCloze, templateForScan }){
  const clozeFields=collectClozeFieldsFromTemplate(templateForScan||tpl);
  return tpl.replace(/\{\{([^}]+)\}\}/g,(m,raw)=>{
    const token=raw.trim(); if(token==='FrontSide') return '{{FrontSide}}';
    const parts=token.split(':'); const fieldName=parts.pop().trim();
    const chain=parts.map(p=>p.trim().toLowerCase());
    const idx=fieldNames.indexOf(fieldName); const val=idx>=0?(fields[idx]??''):'';
    const hasCloze=chain.includes('cloze'); const hasType=chain.includes('type');
    const hasText=chain.includes('text') || chain.includes('hint');
    if(hasCloze) return processClozeForOrd(val, targetCloze, side);
    if(hasType)  return `<input class="type-answer" aria-label="type your answer" style="padding:6px 8px;border:1px solid #334;border-radius:6px;background:#0e1522;color:#eee" />`;
    if(hasText){ if(clozeFields.has(fieldName)) return ''; return stripClozeMarkup(val) }
    if(clozeFields.has(fieldName)) return '';
    return val;
  });
}
function collapseExactDuplicate(html){
  const lines=String(html).split(/(?:\r?\n|<br\s*\/?>)+/i).map(s=>s.trim()).filter(Boolean);
  const seen=new Set(), keep=[];
  for(const line of lines){ const key=line.replace(/\s+/g,' '); if(!seen.has(key)){ seen.add(key); keep.push(line) } }
  return keep.join('<br>');
}

/* ========== Game Engine ========== */
const els = {
  file: $('#file'), showStart: $('#showStart'), startOverlay: $('#startOverlay'),
  presets: $('#presets'), customMin: $('#customMin'), startBtn: $('#startBtn'), cancelStart: $('#cancelStart'),
  deckInfo: $('#deckInfo'),
  front: $('#front'), back: $('#back'),
  reveal: $('#reveal'), goodBtn: $('#goodBtn'), badBtn: $('#badBtn'),
  title: $('#title'), timer: $('#timer'),
  seen: $('#seen'), got: $('#got'), miss: $('#miss'),
  progress: $('#progress'), pauseBtn: $('#pauseBtn'), pausedBanner: $('#pausedBanner'), resumeBtn: $('#resumeBtn'),
  drawer: $('#drawer'), toggleDrawer: $('#toggleDrawer'), missList: $('#missList'), missCountTop: $('#missCountTop'),
  exportMiss: $('#exportMiss'), studyMissed: $('#studyMissed'),
  summary: $('#summary'), sumSeen: $('#sumSeen'), sumGot: $('#sumGot'), sumMiss: $('#sumMiss'),
  restartBtn: $('#restartBtn'), missOnlyBtn: $('#missOnlyBtn'), closeSummary: $('#closeSummary')
};

function setCounts(){
  els.seen.textContent=G.seen; els.got.textContent=G.got; els.miss.textContent=G.missed.length;
  els.toggleDrawer.textContent=`Missed (${G.missed.length})`; els.missCountTop.textContent=`${G.missed.length} items`;
}
function setProgress(){
  const pct = G.queue.length ? (G.idx/G.queue.length)*100 : 0;
  els.progress.style.width = `${Math.min(100, pct)}%`;
}
function renderMissed(){
  els.missList.innerHTML='';
  for(const m of G.missed){
    const div=document.createElement('div'); div.className='missItem';
    div.innerHTML=`<div class="front">${m.front}</div><div class="back">${m.back}</div>`;
    els.missList.appendChild(div);
  }
}
function toggleDrawer(){ els.drawer.classList.toggle('open') }
function openStart(){ els.startOverlay.style.display='flex' }
function closeStart(){ els.startOverlay.style.display='none' }
function showPaused(v){ els.pausedBanner.style.display = v?'flex':'none' }

function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [arr[i],arr[j]]=[arr[j],arr[i]] } }
function nowMs(){ return Date.now() }

/* build queue from G.cards (array of card rows) */
function buildQueue(cards){ G.queue = cards.slice(); shuffle(G.queue); G.idx=0; setProgress() }

/* render current card */
function renderCurrent(){
  if(!G.queue.length){ finishSession(); return }
  const card = G.queue[G.idx];
  const note = G.notes.find(n => n.id===card.nid); if(!note){ nextCard(); return }
  const model = G.models[String(note.mid)]; if(!model){ nextCard(); return }
  const fieldNames = (model?.flds||[]).map(f=>f.name);
  const fields = (note.flds||'').split('\x1f');
  const tmpl = model?.tmpls?.[card.ord]; if(!tmpl){ nextCard(); return }
  const target = card.ord+1;

  let front = tmpl.qfmt || '';
  front = applyConditionals(front, fields, fieldNames);
  front = substituteTokens(front, fields, fieldNames, { side:'front', targetCloze:target, templateForScan:tmpl.qfmt });
  front = sanitize(front); front = G.replaceMedia(front); front = collapseExactDuplicate(front);

  let back  = tmpl.afmt || '';
  back = back.replace(/\{\{FrontSide\}\}/g, front);
  back = applyConditionals(back, fields, fieldNames);
  back = substituteTokens(back, fields, fieldNames, { side:'back', targetCloze:target, templateForScan:tmpl.afmt });
  back = sanitize(back); back = G.replaceMedia(back); back = collapseExactDuplicate(back);

  els.front.innerHTML = front || '<span class="tag">(empty front)</span>';
  els.back.innerHTML  = back  || '<span class="tag">(empty back)</span>';
  els.front.style.display='block'; els.back.style.display='none';
  els.title.textContent = `${G.idx+1} / ${G.queue.length}`;
}

/* transitions */
function reveal(){
  const f=els.front, b=els.back;
  if(b.style.display==='block'){ f.style.display='block'; b.style.display='none' }
  else { f.style.display='none'; b.style.display='block' }
}
function nextCard(){
  G.idx++;
  if(G.idx>=G.queue.length){ finishSession(); return }
  setProgress(); renderCurrent();
}

/* session control */
function startSession(){
  G.seen=0; G.got=0; G.missed.length=0; setCounts();
  G.idx=0; setProgress(); renderCurrent();
  els.pauseBtn.disabled=false;
  if(!G.untimed){ G.endAt=nowMs()+G.sessionMs; tickTimer(); G.timerHandle=setInterval(tickTimer, 250) }
  els.title.textContent='Go!';
}
function finishSession(){
  clearInterval(G.timerHandle); G.timerHandle=null;
  els.sumSeen.textContent=G.seen; els.sumGot.textContent=G.got; els.sumMiss.textContent=G.missed.length;
  els.summary.style.display='flex';
}

function tickTimer(){
  if(G.untimed){ els.timer.textContent='⏱️ Untimed'; return }
  const rem = Math.max(0, G.endAt - nowMs());
  const mm = Math.floor(rem/60000), ss = Math.floor((rem%60000)/1000);
  els.timer.textContent = `⏱️ ${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  if(rem<=0){ finishSession() }
}

/* answer handlers */
function handleAnswer(ok, evt){
  G.seen++; ok? G.got++ : G.missed.push({ id:G.queue[G.idx].id, front:els.front.innerHTML, back:els.back.innerHTML });
  setCounts(); renderMissed();
  if(evt){ pulseBurst(evt.clientX, evt.clientY, ok? 'rgba(37,211,102,.25)': 'rgba(255,77,109,.25)') }
  nextCard();
}

/* export missed */
function download(filename, bytes){
  const url=URL.createObjectURL(new Blob([bytes],{type:'application/octet-stream'}));
  const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}
function exportMissedCSV(){
  const rows = [['card_id','front_text','back_text']];
  for(const m of G.missed){
    rows.push([m.id, stripHtml(m.front).replace(/\s+/g,' ').trim(), stripHtml(m.back).replace(/\s+/g,' ').trim()]);
  }
  const csv = rows.map(r => r.map(v=>{
    const s=String(v??''); if(s.includes('"')||s.includes(',')||s.includes('\n')) return `"${s.replace(/"/g,'""')}"`; return s;
  }).join(',')).join('\n');
  download('missed.csv', new TextEncoder().encode(csv));
}

/* ========== File handling ========== */
els.file.addEventListener('change', async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  if(!SQLReady){ alert('SQLite engine not ready yet.'); return }
  log('Reading file…');
  const buf = new Uint8Array(await file.arrayBuffer());
  if(!(buf[0]===0x50 && buf[1]===0x4b)){ alert('This does not look like a ZIP (.apkg/.colpkg).'); return }
  log('Unzipping…');
  let entries; try{ entries=await unzipWithWatchdog(buf, 20000) }catch(err){ alert('Unzip failed: '+err?.message); return }

  const dbEntry = entries['collection.anki21'] || entries['collection.anki21b'] || entries['collection.anki2'];
  if(!dbEntry){ alert('Could not find collection.anki21/.anki2 in this package. Re-export the deck.'); return }

  // Parse media map (best effort)
  let mediaMap={}; if(entries['media']){
    try{ mediaMap = await parseMediaEntry(entries['media']) }catch(e){ console.warn('media parse failed', e) }
  }
  const fileTable={}; for(const [k,v] of Object.entries(entries)) fileTable[k]=v;
  const replaceMedia = buildMediaReplacer(mediaMap, fileTable);

  log('Opening SQLite…');
  let db; try{ db = new SQL.Database(dbEntry) }catch(e){ alert('SQLite open failed: '+e?.message); return }

  // load col metadata
  let models={}, decks={};
  try{
    const col = db.exec(`SELECT * FROM col LIMIT 1`)[0];
    if(!col) throw new Error('no col rows');
    const row = Object.fromEntries(col.columns.map((c,i)=>[c,col.values[0][i]]));
    models = JSON.parse(row.models); decks = JSON.parse(row.decks);
  }catch(e){ alert('Failed to read collection metadata.'); return }

  // notes
  const notes=[]; try{
    const r=db.exec(`SELECT id,guid,mid,flds,sfld,tags FROM notes`)[0];
    if(r){ for(const v of r.values){ notes.push(Object.fromEntries(r.columns.map((c,i)=>[c,v[i]]))) } }
  }catch(e){ alert('Failed to read notes table.'); return }

  // cards
  const cards=[]; try{
    const r=db.exec(`SELECT id,nid,did,ord FROM cards`)[0];
    if(r){ for(const v of r.values){ cards.push(Object.fromEntries(r.columns.map((c,i)=>[c,v[i]]))) } }
  }catch(e){ alert('Failed to read cards table.'); return }

  // Prepare globals
  G.entries=entries; G.fileTable=fileTable; G.mediaMap=mediaMap; G.replaceMedia=replaceMedia;
  G.decks=decks; G.models=models; G.notes=notes; G.cards=cards;
  G.isClozeByMid={}; for(const [mid, m] of Object.entries(models)){ G.isClozeByMid[mid] = (m?.type===1) }

  buildQueue(G.cards);

  els.showStart.disabled=false;
  els.deckInfo.textContent=`Decks: ${Object.values(decks).length} · Cards: ${cards.length} · Notes: ${notes.length}`;
  els.title.textContent='Ready! Open “Configure & Start”.';
  log('Ready');
});

/* ========== Start / Pause / Summary ========== */
els.showStart.addEventListener('click', openStart);
els.cancelStart.addEventListener('click', closeStart);
els.presets.addEventListener('click', (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  els.presets.querySelectorAll('button').forEach(x=>x.classList.remove('sel'));
  b.classList.add('sel'); els.customMin.value = b.dataset.min || '0';
});
els.startBtn.addEventListener('click', ()=>{
  const m = Math.max(0, parseInt(els.customMin.value||'0',10));
  G.untimed = (m===0); G.sessionMs = m*60*1000;
  closeStart(); startSession();
});
els.pauseBtn.addEventListener('click', ()=>{
  if(G.paused){ // resume
    G.paused=false; showPaused(false);
    if(!G.untimed){ G.endAt = nowMs() + G.remaining; G.timerHandle=setInterval(tickTimer, 250) }
  }else{ // pause
    G.paused=true; showPaused(true);
    if(G.timerHandle){ clearInterval(G.timerHandle); G.timerHandle=null }
    if(!G.untimed) G.remaining = Math.max(0, G.endAt - nowMs());
  }
});
$('#resumeBtn').addEventListener('click', ()=>els.pauseBtn.click());

/* ========== Controls ========== */
els.reveal.addEventListener('click', ()=>reveal());
els.goodBtn.addEventListener('click', (ev)=>handleAnswer(true, ev));
els.badBtn.addEventListener('click', (ev)=>handleAnswer(false, ev));
els.toggleDrawer.addEventListener('click', toggleDrawer);
els.exportMiss.addEventListener('click', exportMissedCSV);
els.studyMissed.addEventListener('click', ()=>{
  if(!G.missed.length){ alert('No missed items yet.'); return }
  // rebuild queue from missed
  const missIds = new Set(G.missed.map(m=>m.id));
  const missCards = G.cards.filter(c=>missIds.has(c.id));
  buildQueue(missCards); G.seen=0; G.got=0; G.missed.length=0; setCounts(); renderMissed();
  els.drawer.classList.remove('open'); renderCurrent();
});

els.restartBtn.addEventListener('click', ()=>{
  els.summary.style.display='none';
  buildQueue(G.cards); startSession();
});
els.missOnlyBtn.addEventListener('click', ()=>{
  els.summary.style.display='none';
  const missIds = new Set(G.missed.map(m=>m.id));
  const missCards = G.cards.filter(c=>missIds.has(c.id));
  if(!missCards.length){ alert('No missed items to study.'); return }
  buildQueue(missCards); startSession();
});
els.closeSummary.addEventListener('click', ()=>{ els.summary.style.display='none' });

/* Keyboard shortcuts */
window.addEventListener('keydown', (e)=>{
  if(e.key===' '){ e.preventDefault(); reveal(); return }
  if(e.key==='ArrowLeft'){ e.preventDefault(); els.badBtn.click(); return }
  if(e.key==='ArrowRight'){ e.preventDefault(); els.goodBtn.click(); return }
  if(e.key==='p' || e.key==='P'){ e.preventDefault(); els.pauseBtn.click(); return }
  if(e.key==='m' || e.key==='M'){ e.preventDefault(); toggleDrawer(); return }
});

/* Cloze tap-to-reveal inside front */
$('#card').addEventListener('click', (ev)=>{
  const c = ev.target.closest('.cloze'); if(!c) return;
  const inner = c.querySelector('span'); if(!inner) return;
  const hidden = inner.style.display==='none';
  inner.style.display = hidden ? 'inline' : 'none';
  c.firstChild.textContent = hidden ? '' : '[ tap to reveal ]';
});

/* Initial state */
els.reveal.disabled=false; els.goodBtn.disabled=false; els.badBtn.disabled=false;
</script>
</body>
</html>