<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>Come Follow Me 2026</title>
  <style>
    :root {
      --bg: #121212;
      --card-bg: #1e1e1e;
      --text: #e0e0e0;
      --accent: #bb86fc;
      --input-bg: #272727;
      --input-border: #444;
      --radius: 8px;
      --spacing: 16px;
      --font: 16px;
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, h1 { touch-action: manipulation; }
    body {
      margin:0; padding:0;
      background: var(--bg);
      color: var(--text);
      font: var(--font)/1.5 system-ui, sans-serif;
      min-height:100vh;
      display:flex; justify-content:center; align-items:flex-start;
      padding:var(--spacing);
    }
    .container {
      width:100%; max-width:600px;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: var(--spacing);
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }
    .title-nav { position: relative; text-align: center; margin-bottom: 10px; }
    .title-nav h1 {
      margin: 0; cursor: pointer; display: inline-block; font-size: 1.5rem;
      user-select: none;
    }
    .top-row {
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      margin-top: 6px; margin-bottom: var(--spacing);
    }

    /* Pill with full-size transparent date input overlay */
    .pill {
      position: relative;
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; border:1px solid var(--input-border);
      background: var(--input-bg); color: var(--text); font-size:.95rem;
    }
    .pill-input-overlay {
      position:absolute; inset:0; /* top/right/bottom/left = 0 */
      width:100%; height:100%;
      opacity:0; /* invisible, still clickable */
      border:none; background:transparent;
      -webkit-appearance:none; appearance:none;
      cursor:pointer;
      z-index: 2; /* above pill contents */
      pointer-events:auto;
    }
    .pill strong { position: relative; z-index: 1; } /* stay above background */

    /* Dropdown / accordion */
    .dropdown-menu {
      display: none;
      position: absolute;
      top: calc(100% + 4px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-bg);
      border: 1px solid var(--input-border);
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
      z-index: 10;
      min-width: 250px;
      text-align: left;
      padding: 6px 0;
      overflow: hidden;
    }
    .dropdown-menu ul { list-style: none; margin: 0; padding: 0; }
    .dropdown-menu li { border-bottom: 1px solid var(--input-border); }
    .dropdown-menu li:last-child { border-bottom: none; }
    .dropdown-menu a, .dropdown-menu .submenu-trigger {
      display: flex; align-items: center; padding: 12px 20px;
      color: var(--text); text-decoration: none; font-size: 0.95rem; cursor: pointer;
      transition: background-color 0.2s ease;
    }
    .dropdown-menu a:hover, .dropdown-menu .submenu-trigger:hover { background: var(--input-bg); }
    .submenu-trigger::after {
      content: '›'; margin-left: auto; font-weight: bold; font-size: 1.2em; color: var(--accent);
      transition: transform 0.3s ease-in-out;
    }
    .submenu { max-height: 0; overflow: hidden; background: rgba(0, 0, 0, 0.2); transition: max-height 0.3s ease-in-out; }
    .menu-item-open > .submenu { max-height: 500px; }
    .menu-item-open > .submenu-trigger::after { transform: rotate(90deg); }

    /* Floating YouTube-style button */
    .floating-play-btn {
      position: fixed;
      top: 12px;
      right: 12px;
      width: 46px;
      height: 32px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.25);
      background: linear-gradient(180deg, #ff0000 0%, #e00000 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.35);
      cursor: pointer;
      z-index: 2000;
      padding: 0;
    }
    .floating-play-btn:active { transform: translateY(1px); }
    .floating-play-btn .play-icon {
      width: 0;
      height: 0;
      border-top: 7px solid transparent;
      border-bottom: 7px solid transparent;
      border-left: 12px solid #fff;
      margin-left: 2px;
      filter: none;
    }

    /* Favorites menu */
    .favorite-menu {
      position: fixed;
      top: 56px;
      right: 12px;
      width: min(260px, 90vw);
      background: #b71c1c;
      color: #fff;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      border: 1px solid rgba(0,0,0,0.35);
      display: none;
      z-index: 1900;
      overflow: hidden;
    }
    .favorite-menu.open { display: block; }
    .favorite-menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: rgba(0,0,0,0.2);
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .favorite-menu-close {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 1.2rem;
      cursor: pointer;
      line-height: 1;
    }
    .favorite-menu ul {
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 260px;
      overflow-y: auto;
    }
    .favorite-menu li {
      border-top: 1px solid rgba(255,255,255,0.12);
    }
    .favorite-menu li:first-child { border-top: none; }
    .favorite-menu a {
      color: #fff;
      text-decoration: none;
      display: block;
      padding: 12px;
      font-weight: 600;
    }
    .favorite-menu a:hover { background: rgba(0,0,0,0.12); }
    .favorite-menu .empty-state {
      padding: 14px 12px;
      font-size: 0.95rem;
      opacity: 0.9;
      text-align: center;
    }

    .youtube-highlight {
      box-shadow: 0 0 0 2px rgba(255, 82, 82, 0.8), 0 0 12px rgba(255, 82, 82, 0.9);
      border-radius: var(--radius);
    }

    .youtube-option-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
    }
    .youtube-option-row .youtube-entry {
      padding: 0;
      flex: 1;
    }
    .youtube-option-row .favorite-checkbox {
      accent-color: var(--accent);
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* Fullscreen embed */
    .embed-modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.85); z-index: 1000; padding: 40px;
    }
    .embed-modal iframe {
      width: 100%; height: 100%; background-color: #fff; border-radius: var(--radius); border: none;
    }
    .embed-close {
      position: absolute; top: 5px; right: 15px; background: none; border: none;
      color: #fff; font-size: 2.5rem; font-weight: bold; cursor: pointer; line-height: 1;
    }

    /* Info / actions */
    #week-info, #day-info {
      white-space: pre-line; margin-bottom: var(--spacing);
      font-size: 0.95rem; line-height: 1.4;
    }
    .actions {
      display: flex; flex-wrap: wrap; gap: 8px;
      margin-bottom: var(--spacing); justify-content:center;
    }
    .actions button {
      flex: 1 1 120px; padding: 10px; font-size: .95rem; font-weight:500;
      color: var(--bg); background: var(--accent); border:none; border-radius: var(--radius);
      cursor: pointer;
    }
    .actions button:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Segmented toggle */
    .segmented {
      display:flex; background: var(--input-bg); border:1px solid var(--input-border);
      border-radius:999px; padding:4px; gap:4px; justify-content:center; margin-bottom: 8px;
    }
    .seg-btn {
      flex:1; padding:8px 10px; border:none; border-radius:999px; background:transparent; color: var(--text);
      font-weight:600; cursor:pointer;
    }
    .seg-btn[aria-selected="true"] { background: var(--accent); color: var(--bg); }

    #content-text {
      width: 100%; padding: var(--spacing); background: var(--input-bg); color: var(--text);
      border: 1px solid var(--input-border); border-radius: var(--radius); resize: none;
      font-size: 0.9rem; line-height: 1.4; white-space: pre-wrap; overflow: hidden; height: auto;
    }
    #scripture-links, #manual-links {
      margin-bottom: var(--spacing); text-align: center; font-size: 0.95rem; line-height: 1.4;
    }
    #scripture-links a, #manual-links a {
      color: var(--accent); background: var(--input-bg); padding: 4px 8px;
      border-radius: var(--radius); text-decoration: none; margin: 0 4px; font-weight: 500;
    }
    #scripture-links a:hover, #manual-links a:hover { background: var(--input-border); opacity: 0.9; }

    /* Version picker modal */
    .version-modal {
      position: fixed; inset: 0;
      display: none; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.7);
      z-index: 1200; padding: 16px;
    }
    .version-modal.open { display: flex; }
    .version-card {
      width: min(380px, 100%);
      background: var(--card-bg);
      border: 1px solid var(--input-border);
      border-radius: var(--radius);
      box-shadow: 0 12px 30px rgba(0,0,0,0.6);
      padding: 18px;
    }
    .version-card h2 { margin: 0 0 10px; font-size: 1.1rem; }
    .version-options { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    .version-option {
      padding: 10px 16px; border-radius: 999px;
      border: 1px solid var(--input-border); background: var(--input-bg);
      color: var(--text); font-weight: 600; text-align: center; cursor: pointer;
      flex: 0 0 auto; min-width: 90px;
    }
    .version-option[aria-current="true"] { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
    .version-option:hover { background: #2d2d2d; }

    @media (min-width:600px) { .actions { justify-content: space-between; } }

    /* Copy modal */
    .copy-modal .version-card { max-width: 420px; }
    .copy-options { flex-direction: column; gap: 8px; }
    .copy-options .version-option { width: 100%; }
  </style>
</head>
<body>
  <button id="quick-youtube-btn" class="floating-play-btn" aria-label="Open YouTube menu">
    <span class="play-icon" aria-hidden="true"></span>
  </button>
  <div id="favorite-menu" class="favorite-menu" aria-label="Favorite YouTube links" aria-hidden="true">
    <div class="favorite-menu-header">
      <span>Favorites</span>
      <button id="favorite-menu-close" class="favorite-menu-close" aria-label="Close favorite menu">×</button>
    </div>
    <ul id="favorite-list"></ul>
    <div class="empty-state">No favorites yet. Mark YouTube links to add them here.</div>
  </div>
  <div class="container">
    <div class="title-nav">
      <h1 id="dropdown-btn">Come Follow Me 2026 ▾</h1>
      <nav id="dropdown-menu" class="dropdown-menu" aria-label="Quick links">
        <ul>
          <li><a href="index.html">Scripture Copier</a></li>
          <li><a href="bible-project-copier.html">Bible Project Copier</a></li>
          <li class="has-submenu">
            <span class="submenu-trigger">Learn It</span>
            <ul class="submenu">
              <li><a href="chatgpt://chat.openai.com/chat" target="_blank" rel="noopener">ChatGPT</a></li>
              <li><a href="https://quiz-duel.lovable.app/" target="_blank" rel="noopener">Face-to-Face Quiz</a></li>
              <li><a href="https://yt2anki.onrender.com/reviewer" target="_blank" rel="noopener">Anki Card Editor</a></li>
              <li><a href="https://yt2anki.onrender.com/" target="_blank" rel="noopener">Anki / Short Quiz Generator</a></li>
              <li><a href="https://starfox1230.github.io/The-Library/apps/quiz-generator/index.html" target="_blank" rel="noopener">Long Quiz Generator</a></li>
              <li><a href="https://starfox1230.github.io/memorize/" target="_blank" rel="noopener">Memorize</a></li>
            </ul>
          </li>
          <li class="has-submenu youtube-menu">
            <span class="submenu-trigger">YouTube</span>
            <ul class="submenu">
              <li>
                <div class="youtube-option-row">
                  <input type="checkbox" class="favorite-checkbox" data-title="Follow Him" data-href="youtube://www.youtube.com/playlist?list=PLmwhKQDUQ16h9rvianjjfidUUAYSjLW4y&si=fdzsWmgpHnsf6nvN" aria-label="Favorite Follow Him">
                  <a class="youtube-entry" href="youtube://www.youtube.com/playlist?list=PLmwhKQDUQ16h9rvianjjfidUUAYSjLW4y&si=fdzsWmgpHnsf6nvN">Follow Him</a>
                </div>
              </li>
              <li>
                <div class="youtube-option-row">
                  <input type="checkbox" class="favorite-checkbox" data-title="Finding Christ in the Old Testament" data-href="youtube://www.youtube.com/playlist?list=PLhfh21X9suLeJgxN1WpXSDs5RFKCU4601&si=7X0m6VoGbbmXbalZ" aria-label="Favorite Finding Christ in the Old Testament">
                  <a class="youtube-entry" href="youtube://www.youtube.com/playlist?list=PLhfh21X9suLeJgxN1WpXSDs5RFKCU4601&si=7X0m6VoGbbmXbalZ">Finding Christ in the Old Testament</a>
                </div>
              </li>
              <li>
                <div class="youtube-option-row">
                  <input type="checkbox" class="favorite-checkbox" data-title="Bible Project" data-href="youtube://www.youtube.com/playlist?list=PLH0Szn1yYNeeVFodkI9J_WEATHQCwRZ0u" aria-label="Favorite Bible Project">
                  <a class="youtube-entry" href="youtube://www.youtube.com/playlist?list=PLH0Szn1yYNeeVFodkI9J_WEATHQCwRZ0u">Bible Project</a>
                </div>
              </li>
              <li>
                <div class="youtube-option-row">
                  <input type="checkbox" class="favorite-checkbox" data-title="CFM with FAIR" data-href="youtube://youtube.com/playlist?list=PLw_Vkm1zYbIErlYwD_spUSOn800Mo6Ed_&si=-Xf75yPmim7KRfdB" aria-label="Favorite CFM with FAIR">
                  <a class="youtube-entry" href="youtube://youtube.com/playlist?list=PLw_Vkm1zYbIErlYwD_spUSOn800Mo6Ed_&si=-Xf75yPmim7KRfdB">CFM with FAIR</a>
                </div>
              </li>
              <li class="has-submenu">
                <span class="submenu-trigger">Copy YouTube Transcript</span>
                <ul class="submenu">
                  <li>
                    <div class="youtube-option-row">
                      <input type="checkbox" class="favorite-checkbox" data-title="YouTube Transcript.io" data-href="https://www.youtube-transcript.io/" aria-label="Favorite YouTube Transcript.io">
                      <a href="#" class="embed-link youtube-entry" data-url="https://www.youtube-transcript.io/">YouTube Transcript.io</a>
                    </div>
                  </li>
                  <li>
                    <div class="youtube-option-row">
                      <input type="checkbox" class="favorite-checkbox" data-title="Tactiq.io" data-href="https://tactiq.io/tools/youtube-transcript" aria-label="Favorite Tactiq.io">
                      <a class="youtube-entry" href="https://tactiq.io/tools/youtube-transcript" target="_blank" rel="noopener">Tactiq.io</a>
                    </div>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </nav>

      <div class="top-row">
        <div id="today-pill" class="pill" title="Tap to change date">
          <input id="date-input" type="date" class="pill-input-overlay" aria-label="Choose date">
          <span>Today:</span>
          <strong id="today-date">MM/DD/YYYY</strong> ▾
        </div>

        <div class="segmented" role="tablist" aria-label="View mode">
          <button class="seg-btn" id="mode-day" role="tab" aria-selected="true" data-mode="day">Day</button>
          <button class="seg-btn" id="mode-week" role="tab" aria-selected="false" data-mode="week">Week</button>
          <button class="seg-btn" id="mode-manual" role="tab" aria-selected="false" data-mode="manual">Manual</button>
        </div>
      </div>
    </div>

    <div id="week-info">Loading week…</div>
    <div id="day-info"></div>

    <div class="actions">
      <button id="prev-btn" disabled>← Previous Day</button>
      <button id="next-btn" disabled>Next Day →</button>
    </div>

    <div class="actions">
      <button id="toggle-btn" disabled>Show Chapters</button>
      <button id="copy-btn" disabled>Copy</button>
    </div>

    <div id="scripture-links"></div>
    <div id="manual-links" style="display:none;"></div>
    <textarea id="content-text" readonly placeholder="Content will appear here…"></textarea>
  </div>

  <div id="embed-modal" class="embed-modal" aria-hidden="true">
    <button id="embed-close" class="embed-close" aria-label="Close">×</button>
    <iframe id="embed-iframe" src="" allow="fullscreen"></iframe>
  </div>

  <div id="version-modal" class="version-modal" aria-hidden="true">
    <div class="version-card" role="dialog" aria-modal="true" aria-labelledby="version-modal-title">
      <h2 id="version-modal-title">Choose Bible version</h2>
      <div class="version-options">
        <button class="version-option" data-version="KJV">KJV</button>
        <button class="version-option" data-version="NRSVUE">NRSVUE</button>
        <button class="version-option" data-version="NIV">NIV</button>
        <button class="version-option" data-version="NIRV">NIRV</button>
      </div>
    </div>
  </div>

  <div id="copy-modal" class="version-modal copy-modal" aria-hidden="true">
    <div class="version-card copy-card" role="dialog" aria-modal="true" aria-labelledby="copy-modal-title">
      <h2 id="copy-modal-title">Copy options</h2>
      <div class="version-options copy-options">
        <button id="copy-manual-only" class="version-option">Copy manual</button>
        <button id="copy-manual-reading" class="version-option">Copy manual + weekly reading</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    /* ===== Menu / embed ===== */
    const ddTitle = document.getElementById('dropdown-btn');
    const ddMenu = document.getElementById('dropdown-menu');
    const youtubeMenuItem = ddMenu.querySelector('.youtube-menu');
    const youtubeEntries = Array.from(ddMenu.querySelectorAll('.youtube-entry'));
    const quickYoutubeBtn = document.getElementById('quick-youtube-btn');
    const favoriteMenu = document.getElementById('favorite-menu');
    const favoriteList = document.getElementById('favorite-list');
    const favoriteMenuClose = document.getElementById('favorite-menu-close');
    const favoriteEmpty = favoriteMenu.querySelector('.empty-state');
    const favoriteCheckboxes = Array.from(document.querySelectorAll('.favorite-checkbox'));

    function closeMenu(){
      ddMenu.style.display = 'none';
      youtubeMenuItem?.classList.remove('menu-item-open');
      youtubeEntries.forEach(a => a.classList.remove('youtube-highlight'));
    }

    function openMenu(opts = {}){
      const { expandYoutube = false, highlightYoutube = false } = opts;
      closeFavoriteMenu();
      ddMenu.style.display = 'block';
      if (expandYoutube && youtubeMenuItem){
        youtubeMenuItem.classList.add('menu-item-open');
      }
      if (highlightYoutube){
        youtubeEntries.forEach(a => a.classList.add('youtube-highlight'));
      }
    }

    const favoriteStorageKey = 'cfm-2026-favorite-youtube';
    let favoriteLinks = loadFavoritesFromStorage();

    function loadFavoritesFromStorage(){
      try {
        const parsed = JSON.parse(localStorage.getItem(favoriteStorageKey) || '[]');
        if (Array.isArray(parsed)) return parsed.filter(item => item && item.href);
      } catch {}
      return [];
    }

    function saveFavorites(){
      localStorage.setItem(favoriteStorageKey, JSON.stringify(favoriteLinks));
    }

    function closeFavoriteMenu(){
      favoriteMenu.classList.remove('open');
      favoriteMenu.setAttribute('aria-hidden', 'true');
    }

    function openFavoriteMenu(){
      closeMenu();
      renderFavoritesMenu();
      favoriteMenu.classList.add('open');
      favoriteMenu.setAttribute('aria-hidden', 'false');
    }

    function syncFavoriteCheckboxes(){
      favoriteCheckboxes.forEach(cb => {
        cb.checked = favoriteLinks.some(item => item.href === cb.dataset.href);
      });
    }

    function renderFavoritesMenu(){
      favoriteList.innerHTML = '';
      if (!favoriteLinks.length){
        favoriteEmpty.style.display = 'block';
        return;
      }
      favoriteEmpty.style.display = 'none';

      favoriteLinks.forEach(item => {
        const li = document.createElement('li');
        const link = document.createElement('a');
        link.href = item.href;
        link.textContent = item.title || 'Favorite link';
        link.className = 'youtube-entry';
        li.appendChild(link);
        favoriteList.appendChild(li);
      });
    }

    function updateFavoriteListFromCheckbox(cb){
      const href = cb.dataset.href;
      const title = cb.dataset.title || cb.closest('.youtube-option-row')?.querySelector('.youtube-entry')?.textContent?.trim() || 'Favorite link';

      if (cb.checked){
        if (!favoriteLinks.some(item => item.href === href)) {
          favoriteLinks.push({ href, title });
        }
      } else {
        favoriteLinks = favoriteLinks.filter(item => item.href !== href);
      }
      saveFavorites();
      renderFavoritesMenu();
    }

    ddTitle.addEventListener('click', e => {
      e.stopPropagation();
      const isOpen = ddMenu.style.display === 'block';
      isOpen ? closeMenu() : openMenu();
    });
    document.addEventListener('click', () => {
      closeMenu();
      closeFavoriteMenu();
    });
    ddMenu.addEventListener('click', e => {
      e.stopPropagation();
      const trigger = e.target.closest('.submenu-trigger');
      if (!trigger) return;
      const parentLi = trigger.parentElement;
      Array.from(parentLi.parentElement.children).forEach(sib => {
        if (sib !== parentLi) { sib.classList.remove('menu-item-open'); sib.querySelector('.menu-item-open')?.classList.remove('menu-item-open'); }
      });
      parentLi.classList.toggle('menu-item-open');
    });

    quickYoutubeBtn.addEventListener('click', e => {
      e.stopPropagation();
      if (favoriteMenu.classList.contains('open')) closeFavoriteMenu();
      else openFavoriteMenu();
    });

    favoriteMenuClose.addEventListener('click', e => {
      e.stopPropagation();
      closeFavoriteMenu();
    });

    favoriteMenu.addEventListener('click', e => e.stopPropagation());

    favoriteCheckboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        updateFavoriteListFromCheckbox(cb);
      });
    });

    syncFavoriteCheckboxes();
    renderFavoritesMenu();

    const embedModal = document.getElementById('embed-modal');
    const embedIframe = document.getElementById('embed-iframe');
    const embedCloseBtn = document.getElementById('embed-close');
    function openEmbed(url){ embedIframe.src = url; embedModal.style.display='block'; closeMenu(); closeFavoriteMenu(); }
    function closeEmbed(){ embedIframe.src='about:blank'; embedModal.style.display='none'; }
    document.querySelectorAll('.embed-link').forEach(link=>{
      link.addEventListener('click', e=>{ e.preventDefault(); openEmbed(link.dataset.url); });
    });
    embedCloseBtn.addEventListener('click', closeEmbed);

    /* ===== Bible version picker ===== */
    const versionModal = document.getElementById('version-modal');
    const versionOptions = Array.from(document.querySelectorAll('.version-option'));
    let pendingScriptureHref = null;
    const versionStorageKey = 'cfm-bible-version-choice';

    const YOUVERSION_TRANSLATIONS = {
      NRSVUE: { bibleId: 3523, versionCode: 'NRSVUE' },
      NIV:    { bibleId: 111,  versionCode: 'NIV' },
      NIRV:   { bibleId: 110,  versionCode: 'NIRV' }
    };

    // YouVersion/Bible.com format: https://www.bible.com/bible/{bibleId}/{USFM}.{chapter}[.{verseOrRange}].{versionCode}
    const CHURCH_SLUG_TO_USFM = {
      // Old Testament
      'gen':'GEN','ex':'EXO','lev':'LEV','num':'NUM','deut':'DEU','josh':'JOS','judg':'JDG','ruth':'RUT',
      '1-sam':'1SA','2-sam':'2SA','1-kgs':'1KI','2-kgs':'2KI','1-chr':'1CH','2-chr':'2CH','ezra':'EZR','neh':'NEH',
      'esth':'EST','job':'JOB','ps':'PSA','prov':'PRO','eccl':'ECC','song':'SNG','isa':'ISA','jer':'JER','lam':'LAM',
      'ezek':'EZK','dan':'DAN','hosea':'HOS','joel':'JOL','amos':'AMO','obad':'OBA','jonah':'JON','micah':'MIC',
      'nahum':'NAM','hab':'HAB','zeph':'ZEP','hag':'HAG','zech':'ZEC','mal':'MAL',

      // New Testament
      'matt':'MAT','mark':'MRK','luke':'LUK','john':'JHN','acts':'ACT','rom':'ROM','1-cor':'1CO','2-cor':'2CO',
      'gal':'GAL','eph':'EPH','philip':'PHP','col':'COL','1-thes':'1TH','2-thes':'2TH','1-tim':'1TI','2-tim':'2TI',
      'titus':'TIT','philem':'PHM','heb':'HEB','james':'JAS','1-pet':'1PE','2-pet':'2PE','1-jn':'1JN','2-jn':'2JN',
      '3-jn':'3JN','jude':'JUD','rev':'REV'
    };

    // FIX: Use window.location.href instead of window.open to prevent blank tabs when app intercepts link
    function openScriptureInGospelLibrary(href){ window.location.href = href; }

    function buildYouVersionUrl(churchHref, versionKey){
      const cfg = YOUVERSION_TRANSLATIONS[versionKey];
      if (!cfg) return null;
      let url;
      try { url = new URL(churchHref, window.location.origin); }
      catch { return null; }
      const parts = url.pathname.split('/').filter(Boolean);
      const idx = parts.findIndex(p => p === 'ot' || p === 'nt');
      if (idx === -1 || !parts[idx+1] || !parts[idx+2]) return null;
      const bookSlug = parts[idx+1];
      const chapterSegment = parts[idx+2];
      const usfm = CHURCH_SLUG_TO_USFM[bookSlug];
      if (!usfm) return null;

      let chapter = chapterSegment;
      let verseRange = '';
      if (chapter.includes('.')){
        const [ch, rest] = chapter.split('.', 2);
        chapter = ch;
        verseRange = rest;
      }
      const chapterNum = parseInt(chapter, 10);
      if (!Number.isFinite(chapterNum)) return null;
      const ref = verseRange ? `${usfm}.${chapterNum}.${verseRange}` : `${usfm}.${chapterNum}`;
      return `https://www.bible.com/bible/${cfg.bibleId}/${ref}.${cfg.versionCode}`;
    }

    function openVersionPicker(href){
      pendingScriptureHref = href;
      const lastChoice = localStorage.getItem(versionStorageKey);
      versionOptions.forEach(btn => btn.setAttribute('aria-current', String(btn.dataset.version === lastChoice)));
      versionModal.classList.add('open');
      versionModal.setAttribute('aria-hidden', 'false');
    }
    function closeVersionPicker(){
      versionModal.classList.remove('open');
      versionModal.setAttribute('aria-hidden', 'true');
      pendingScriptureHref = null;
    }

    versionOptions.forEach(btn => {
      btn.addEventListener('click', () => {
        const hrefToOpen = pendingScriptureHref;
        if (!hrefToOpen) { closeVersionPicker(); return; }
        
        const choice = btn.dataset.version;
        localStorage.setItem(versionStorageKey, choice);
        closeVersionPicker();
        
        if (choice === 'KJV') {
          openScriptureInGospelLibrary(hrefToOpen);
          return;
        }
        
        const youVersionUrl = buildYouVersionUrl(hrefToOpen, choice);
        if (youVersionUrl) {
          window.location.href = youVersionUrl; 
        } else {
          openScriptureInGospelLibrary(hrefToOpen);
        }
      });
    });

    versionModal.addEventListener('click', e => { if (e.target === versionModal) closeVersionPicker(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && versionModal.classList.contains('open')) closeVersionPicker(); });

      document.addEventListener('click', evt => {
        const anchor = evt.target.closest('a');
        if (!anchor) return;

        const targetHref = anchor.getAttribute('href');
        if (!targetHref || targetHref === '#') return;

        // Preserve the original attribute-based href when the element already has an absolute href set
        if (anchor.href !== targetHref) {
          anchor.href = targetHref;
        }

        if (!targetHref.includes('/study/scriptures/')) return;
        const isBible = targetHref.includes('/study/scriptures/ot/') || targetHref.includes('/study/scriptures/nt/');
        if (!isBible) return;
        evt.preventDefault();
        evt.stopPropagation();
        openVersionPicker(targetHref);
      }, true);

    /* ===== Helpers ===== */
    const parseDate = s => { const [y,m,d] = s.split('-').map(Number); return new Date(y, m-1, d); };
    const toISODate = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const fmtDate = d => `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}/${d.getFullYear()}`;
    function clamp(val, min, max){ return Math.max(min, Math.min(max, val)); }

    const defaultLinkBases = {
      doctrineandcovenants: { doctrineandcovenants: 'dc-testament/dc' },
      oldtestament: {
        genesis: 'ot/gen', exodus: 'ot/ex', leviticus: 'ot/lev', numbers: 'ot/num',
        deuteronomy: 'ot/deut', joshua: 'ot/josh', judges: 'ot/judg', ruth: 'ot/ruth',
        '1samuel': 'ot/1-sam', '2samuel': 'ot/2-sam', '1kings': 'ot/1-kgs', '2kings': 'ot/2-kgs',
        '1chronicles': 'ot/1-chr', '2chronicles': 'ot/2-chr', ezra: 'ot/ezra', nehemiah: 'ot/neh',
        esther: 'ot/esth', job: 'ot/job', psalms: 'ot/ps', proverbs: 'ot/prov',
        ecclesiastes: 'ot/eccl', songofsolomon: 'ot/song', isaiah: 'ot/isa', jeremiah: 'ot/jer',
        lamentations: 'ot/lam', ezekiel: 'ot/ezek', daniel: 'ot/dan', hosea: 'ot/hosea',
        joel: 'ot/joel', amos: 'ot/amos', obadiah: 'ot/obad', jonah: 'ot/jonah',
        micah: 'ot/micah', nahum: 'ot/nahum', habakkuk: 'ot/hab', zephaniah: 'ot/zeph',
        haggai: 'ot/hag', zechariah: 'ot/zech', malachi: 'ot/mal'
      },
      pearlofgreatprice: {
        moses: 'pgp/moses', abraham: 'pgp/abr', josephsmithhistory: 'pgp/js-h',
        josephsmithmatthew: 'pgp/js-m', articlesoffaith: 'pgp/a-of-f'
      }
    };

    function showCopiedMessage(){
      copyBtn.textContent = 'Copied!';
      setTimeout(()=>copyBtn.textContent='Copy', 1500);
    }

    function fallbackCopy(text){
      const temp = document.createElement('textarea');
      temp.value = text;
      temp.setAttribute('readonly','');
      temp.style.position = 'absolute';
      temp.style.left = '-9999px';
      document.body.appendChild(temp);
      temp.select();
      document.execCommand('copy');
      document.body.removeChild(temp);
    }

    async function copyTextToClipboard(text){
      if (!text.trim()) return;
      try {
        if (navigator.clipboard?.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          fallbackCopy(text);
        }
        showCopiedMessage();
      } catch {
        fallbackCopy(text);
        showCopiedMessage();
      }
    }

    /* ===== State ===== */
    const today = new Date(); today.setHours(0,0,0,0);
    const schedule = await fetch('cfm-schedule-2026.json').then(r=>r.json());
    let currentDate = new Date(today);
    let cw = findWeekIndexForDate(currentDate);
    let dayIdx = computeDayIdx(currentDate, cw);
    let viewMode = 'day';            // 'day' | 'week' | 'manual'
    let displayMode = 'verses';      // 'verses' | 'sections'
    const weekCache = {};
    const manualCache = {};

    /* ===== Elements ===== */
    const weekInfo = document.getElementById('week-info');
    const dayInfo = document.getElementById('day-info');
    const scriptureLinks = document.getElementById('scripture-links');
    const manualLinks = document.getElementById('manual-links');
    const contentTA = document.getElementById('content-text');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const toggleBtn = document.getElementById('toggle-btn');
    const copyBtn = document.getElementById('copy-btn');
    const copyModal = document.getElementById('copy-modal');
    const copyManualOnlyBtn = document.getElementById('copy-manual-only');
    const copyManualReadingBtn = document.getElementById('copy-manual-reading');

    const segBtns = Array.from(document.querySelectorAll('.seg-btn'));
    const todayDateSpan = document.getElementById('today-date');
    const dateInput = document.getElementById('date-input');

    /* ---- Place manual links above scripture links without changing markup ---- */
    if (scriptureLinks && manualLinks && scriptureLinks.parentNode) {
      scriptureLinks.parentNode.insertBefore(manualLinks, scriptureLinks);
    }

    /* ===== Init ===== */
    todayDateSpan.textContent = fmtDate(currentDate);
    dateInput.value = toISODate(currentDate);

    // IMPORTANT: clicking anywhere on the pill actually clicks the input (native picker).
    // We only need to react to "change" events.
    dateInput.addEventListener('change', () => {
      if (!dateInput.value) return;
      setCurrentDate(parseDate(dateInput.value));
    });

    segBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        segBtns.forEach(b=>b.setAttribute('aria-selected','false'));
        btn.setAttribute('aria-selected','true');
        viewMode = btn.dataset.mode;
        updateNavLabels();
        render();
      });
    });

    prevBtn.addEventListener('click', ()=>{
      if (viewMode === 'day') {
        if (dayIdx > 0) dayIdx--;
        else if (cw > 0) { cw--; dayIdx = 6; currentDate = parseDate(schedule[cw].start); currentDate.setDate(currentDate.getDate()+dayIdx); }
      } else {
        if (cw > 0) { cw--; const s = parseDate(schedule[cw].start); setCurrentDate(s, {keepMode:true}); }
      }
      render();
    });

    nextBtn.addEventListener('click', ()=>{
      if (viewMode === 'day') {
        if (dayIdx < 6) dayIdx++;
        else if (cw < schedule.length - 1) { cw++; dayIdx = 0; currentDate = parseDate(schedule[cw].start); }
      } else {
        if (cw < schedule.length - 1) { cw++; const s = parseDate(schedule[cw].start); setCurrentDate(s, {keepMode:true}); }
      }
      render();
    });

    toggleBtn.addEventListener('click', ()=>{
      if (toggleBtn.disabled) return;
      displayMode = (displayMode === 'verses') ? 'sections' : 'verses';
      render();
    });

    copyBtn.addEventListener('click', async ()=>{
      if (viewMode === 'manual') {
        openCopyModal();
        return;
      }
      await copyTextToClipboard(contentTA.value || '');
    });

    copyModal.addEventListener('click', (e)=>{
      if (e.target === copyModal) closeCopyModal();
    });

    copyManualOnlyBtn.addEventListener('click', async ()=>{
      const text = await getManualTextForCopy();
      await copyTextToClipboard(text);
      closeCopyModal();
    });

    copyManualReadingBtn.addEventListener('click', async ()=>{
      const manualPlusReading = await getManualAndWeeklyReadingText();
      await copyTextToClipboard(manualPlusReading);
      closeCopyModal();
    });

    // Initial render
    updateNavLabels();
    render();

    /* ===== Core ===== */
    function findWeekIndexForDate(d){
      const day = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      for (let i=0;i<schedule.length;i++){
        const s = parseDate(schedule[i].start), e = parseDate(schedule[i].end);
        if (day >= s && day <= e) return i;
      }
      if (day < parseDate(schedule[0].start)) return 0;
      return schedule.length - 1;
    }
    function computeDayIdx(d, weekIndex){
      const wk = schedule[weekIndex];
      const s = parseDate(wk.start);
      const diff = Math.floor((d - s)/(1000*60*60*24));
      return Math.max(0, Math.min(6, diff));
    }
    function setCurrentDate(d, opts={}){
      d.setHours(0,0,0,0);
      currentDate = d;
      todayDateSpan.textContent = fmtDate(currentDate);
      dateInput.value = toISODate(currentDate);
      cw = findWeekIndexForDate(currentDate);
      dayIdx = computeDayIdx(currentDate, cw);
      if (!opts.keepMode) {
        viewMode = 'day';
        document.querySelectorAll('.seg-btn').forEach(b=>b.setAttribute('aria-selected', String(b.dataset.mode==='day')));
      }
      updateNavLabels();
      render();
    }
    function updateNavLabels(){
      if (viewMode === 'day') {
        prevBtn.textContent = '← Previous Day';
        nextBtn.textContent = 'Next Day →';
      } else {
        prevBtn.textContent = '← Previous Week';
        nextBtn.textContent = 'Next Week →';
      }
    }
    function autoResizeTA(){
      contentTA.style.height = 'auto';
      contentTA.style.height = contentTA.scrollHeight + 'px';
    }

    function openCopyModal(){
      copyModal.classList.add('open');
      copyModal.setAttribute('aria-hidden','false');
    }

    function closeCopyModal(){
      copyModal.classList.remove('open');
      copyModal.setAttribute('aria-hidden','true');
    }

    function buildReadings(wk){
      if (Array.isArray(wk.readings) && wk.readings.length) return wk.readings;
      if (wk.book && wk.chapStart && wk.chapEnd) {
        return [{ volume:wk.volume, book:wk.book, chapStart:wk.chapStart, chapEnd:wk.chapEnd, linkBase:wk.linkBase, display:wk.bookDisplay }];
      }
      return [];
    }

    async function loadWeek(i){
      if (weekCache[i]) return weekCache[i];
      const wk = schedule[i];
      const readings = buildReadings(wk);
      const flat = [];
      const sources = [];
      async function addReading(reading){
        const { volume, book, chapStart, chapEnd } = reading;
        if (!volume || !book || !chapStart || !chapEnd) return;
        const data = await fetch(`data/${volume}/${book}.json`).then(r=>r.json());
        const display = reading.display || data.title || book;
        const linkBase = reading.linkBase || (defaultLinkBases[volume] && defaultLinkBases[volume][book]) || '';
        sources.push({ display, start: chapStart, end: chapEnd, linkBase, volume, book });
        for (let c=chapStart; c<=chapEnd; c++){
          const ch = data.chapters.find(x=>x.number===c);
          if (!ch) continue;
          ch.verses.forEach((v,j)=> flat.push({ volume, book, bookDisplay: display, linkBase, chapter:c, verse:j+1, text:v.text }));
        }
      }
      for (const rd of readings) await addReading(rd);

      const total = flat.length;
      const assigns = Array.from({length:7}, ()=>[]);
      if (total){
        const per = Math.floor(total/7);
        const ext = total % 7;
        let pos = 0;
        for (let d=0; d<7; d++){
          const cnt = per + (d<ext ? 1:0);
          assigns[d] = flat.slice(pos, pos+cnt);
          pos += cnt;
        }
      }
      weekCache[i] = { wk, flat, assigns, sources };
      return weekCache[i];
    }

    async function loadManual(i){
      if (manualCache[i]) return manualCache[i];
      const wk = schedule[i];
      const manualUrl = wk.manualUrl || wk.manualLink;
      const path = wk.manualPath || `manual/2026/week-${String(i+1).padStart(2,'0')}.txt`;
      try {
        const res = await fetch(path);
        if (!res.ok) throw new Error('missing');
        const text = await res.text();
        manualCache[i] = { ok:true, text, path, url: manualUrl };
      } catch {
        const msg = [
          `Manual text not found for this week.`,
          `Add a UTF-8 .txt file at: ${path}`,
          `Or set "manualPath" / "manualUrl" on this week in cfm-schedule-2026.json.`
        ].join('\n');
        manualCache[i] = { ok:false, text: msg, path, url: manualUrl };
      }
      return manualCache[i];
    }

    async function getManualTextForCopy(){
      const man = await loadManual(cw);
      return man.text || '';
    }

    async function getManualAndWeeklyReadingText(){
      const manualText = await getManualTextForCopy();
      const { flat } = await loadWeek(cw);
      const readingText = buildWeekReadingText(flat);
      return [manualText, readingText].filter(Boolean).join('\n\n');
    }

    /* ---- Manual link helper: compute CFM 2026 Old Testament manual URL for a week ---- */
    function getManualUrlForWeek(i){
      const wk = schedule[i] || {};
      const override = wk.manualUrl || wk.manualLink;
      if (override) return override;
      const nn = String(i+1).padStart(2,'0');
      return `https://www.churchofjesuschrist.org/study/manual/come-follow-me-for-home-and-church-old-testament-2026/${nn}?lang=eng`;
    }

    function buildHeaderRange(arr){
      const ranges = [];
      arr.forEach((it,i)=>{
        const prev = arr[i-1];
        if (!prev || it.bookDisplay!==prev.bookDisplay || it.chapter!==prev.chapter || it.verse!==prev.verse+1){
          ranges.push({ book:it.bookDisplay, chapter:it.chapter, start:it.verse, end:it.verse });
        } else {
          ranges[ranges.length-1].end = it.verse;
        }
      });
      return ranges.map(r => `${r.book} ${r.chapter}:${r.start}` + (r.end>r.start ? `–${r.end}`:'')).join(', ');
    }

    function groupByChapter(list){
      const map = new Map();
      for (const v of list){
        const key = `${v.bookDisplay}|${v.chapter}`;
        if (!map.has(key)) map.set(key, { bookDisplay:v.bookDisplay, chapter:v.chapter, verses:[] });
        map.get(key).verses.push(v);
      }
      return Array.from(map.values()).sort((a,b)=>{
        if (a.bookDisplay !== b.bookDisplay) return a.bookDisplay.localeCompare(b.bookDisplay);
        return a.chapter - b.chapter;
      });
    }

    function buildWeekReadingText(flat){
      if (!flat || !flat.length) return '';
      const groups = groupByChapter(flat);
      let out = '';
      for (const g of groups){
        out += `${g.bookDisplay} ${g.chapter}\n\n` + g.verses.map(v=>`${v.verse}. ${v.text}`).join('\n') + '\n\n';
      }
      return out.trim();
    }

    function renderLinksForDay(arr){
      const linkMap = new Map();
      arr.forEach(({ bookDisplay, chapter, linkBase })=>{
        if (!linkBase) return;
        const key = `${linkBase}|${chapter}`;
        if (!linkMap.has(key)) {
          const href = `https://www.churchofjesuschrist.org/study/scriptures/${linkBase}/${chapter}?lang=eng`;
          linkMap.set(key, `<a href="${href}" target="_blank" rel="noopener">${bookDisplay} ${chapter}</a>`);
        }
      });
      scriptureLinks.innerHTML = [...linkMap.values()].join(' | ');
    }

    function renderLinksForWeek(sources){
      const links = [];
      for (const src of sources){
        if (!src.linkBase) continue;
        for (let c=src.start; c<=src.end; c++){
          const href = `https://www.churchofjesuschrist.org/study/scriptures/${src.linkBase}/${c}?lang=eng`;
          links.push(`<a href="${href}" target="_blank" rel="noopener">${src.display} ${c}</a>`);
        }
      }
      scriptureLinks.innerHTML = links.join(' | ');
    }

    async function render(){
      const { wk, assigns, flat, sources } = await loadWeek(cw);

      const rangeLine = `Week: ${fmtDate(parseDate(wk.start))} – ${fmtDate(parseDate(wk.end))}`;
      const extra = [];
      if (wk.title) extra.push(wk.title);
      if (wk.note) extra.push(wk.note);
      if (sources.length){
        const s = sources.map(src => `${src.display} ${src.end>src.start?`${src.start}–${src.end}`:src.start}`).join('; ');
        extra.push(`Readings: ${s}`);
      }
      weekInfo.textContent = extra.length ? `${rangeLine}\n${extra.join('\n')}` : rangeLine;

      const dt = new Date(parseDate(wk.start)); dt.setDate(dt.getDate()+dayIdx);
      dayInfo.textContent = (viewMode==='day')
        ? `Today's date: ${fmtDate(dt)}`
        : `Week view: ${fmtDate(parseDate(wk.start))} – ${fmtDate(parseDate(wk.end))}`;

      if (viewMode === 'day'){
        prevBtn.disabled = (cw===0 && dayIdx===0);
        nextBtn.disabled = (cw===schedule.length-1 && dayIdx===6);
      } else {
        prevBtn.disabled = (cw===0);
        nextBtn.disabled = (cw===schedule.length-1);
      }

      /* ---- Always show manual link above chapter links in Day/Week views ---- */
      const weekNumLabel = String(cw+1).padStart(2,'0');
      const manualUrlForCW = getManualUrlForWeek(cw);
      const manualAnchor = `<a href="${manualUrlForCW}" target="_blank" rel="noopener">Open Manual (Week ${weekNumLabel})</a>`;

      if (viewMode==='day'){
        const arr = assigns[dayIdx] || [];
        const hasContent = arr.length>0;
        toggleBtn.disabled = !hasContent;
        toggleBtn.textContent = (displayMode==='verses') ? 'Show Chapters' : 'Show Verses';
        copyBtn.disabled = !hasContent;

        manualLinks.style.display = '';
        manualLinks.innerHTML = manualAnchor;
        scriptureLinks.style.display = '';
        renderLinksForDay(arr);

        if (!hasContent){
          contentTA.value = wk.title || 'No reading assignment for this week yet. Check back soon!';
          autoResizeTA();
          return;
        }
        if (displayMode==='verses'){
          const hdr = buildHeaderRange(arr);
          const body = arr.map(it=>`${it.verse}. ${it.text}`).join('\n');
          contentTA.value = hdr ? `${hdr}\n\n${body}` : body;
        } else {
          const chapMap = new Map();
          arr.forEach(it=>{
            const key = `${it.bookDisplay}|${it.chapter}`;
            if (!chapMap.has(key)) chapMap.set(key, { bookDisplay:it.bookDisplay, chapter:it.chapter });
          });
          let out = '';
          for (const { bookDisplay, chapter } of chapMap.values()){
            const verses = flat.filter(x=>x.bookDisplay===bookDisplay && x.chapter===chapter);
            out += `${bookDisplay} ${chapter}\n\n` + verses.map(v=>`${v.verse}. ${v.text}`).join('\n') + '\n\n';
          }
          contentTA.value = out.trim();
        }
        autoResizeTA();
        return;
      }

      if (viewMode==='week'){
        const hasContent = flat.length>0;
        toggleBtn.disabled = true;
        toggleBtn.textContent = 'Show Chapters';
        copyBtn.disabled = !hasContent;

        manualLinks.style.display = '';
        manualLinks.innerHTML = manualAnchor;
        scriptureLinks.style.display = '';
        renderLinksForWeek(sources);

        if (!hasContent){
          contentTA.value = 'No scripture readings listed for this week.';
          autoResizeTA();
          return;
        }

        const groups = groupByChapter(flat);
        let out = '';
        for (const g of groups){
          out += `${g.bookDisplay} ${g.chapter}\n\n` + g.verses.map(v=>`${v.verse}. ${v.text}`).join('\n') + '\n\n';
        }
        contentTA.value = out.trim();
        autoResizeTA();
        return;
      }

      if (viewMode==='manual'){
        toggleBtn.disabled = true;
        toggleBtn.textContent = 'Show Chapters';
        scriptureLinks.style.display = 'none';
        manualLinks.style.display = '';

        const man = await loadManual(cw);
        const fallbackUrl = getManualUrlForWeek(cw);
        if (man.url){
          manualLinks.innerHTML = `<a href="${man.url}" target="_blank" rel="noopener">Open Manual (web)</a>`;
        } else if (fallbackUrl){
          manualLinks.innerHTML = `<a href="${fallbackUrl}" target="_blank" rel="noopener">Open Manual (Week ${weekNumLabel})</a>`;
        } else {
          manualLinks.innerHTML = `<span style="opacity:.8;">No manual URL set for this week.</span>`;
        }
        contentTA.value = man.text || '';
        copyBtn.disabled = !(man.text && man.text.trim().length>0);
        autoResizeTA();
        return;
      }
    }
  });
  </script>
</body>
</html>
