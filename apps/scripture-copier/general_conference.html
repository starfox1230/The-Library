<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>General Conference Tracker</title>
<style>
  :root {
    --bg: #0b0f14;
    --card: #101823;
    --card-2: #0e1520;
    --text: #e6f1ff;
    --muted: #9fb3c8;
    --accent: #37e3ff;
    --accent-2: #6df2ff;
    --danger: #ff6b6b;
    --good: #2fe6a5;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius: 18px;
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0; background: var(--bg); color: var(--text);
    font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
    -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  }
  a { color: var(--accent); text-decoration: none; }
  .wrap { max-width: 860px; margin: 0 auto; padding: 16px; }

  header { display: grid; gap: 12px; margin-bottom: 12px; }
  .titlebar { display:flex; align-items:center; justify-content:space-between; }
  .titlebar h1 { margin:0; font-size: 20px; letter-spacing:.3px; }
  .btn {
    background: var(--card);
    color: var(--text);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 12px; padding: 10px 12px; box-shadow: var(--shadow);
    display:inline-flex; align-items:center; gap:8px; cursor:pointer;
    transition: transform .06s ease, background .2s ease, border-color .2s ease;
    -webkit-tap-highlight-color: transparent;
  }
  .btn:active { transform: scale(.98); }
  .btn.ghost { background: transparent; border-color: rgba(255,255,255,.12); }
  .btn.small { padding: 8px 10px; border-radius: 10px; font-size: 14px; }
  .btn.icon { padding: 8px; width: 40px; height: 40px; justify-content: center; }

  .bar { background: var(--card); border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); padding: 10px; box-shadow: var(--shadow); }
  .controls { display:flex; gap:8px; flex-wrap: wrap; }

  /* Progress */
  .progress { display:flex; align-items:center; gap:10px; padding: 10px 12px; background: var(--card); border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); box-shadow: var(--shadow); }
  .progress-bar { flex:1; height: 10px; background: #0a0f18; border-radius: 999px; overflow: hidden; position: relative; }
  .progress-bar > span { position:absolute; left:0; top:0; height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); box-shadow: 0 0 16px rgba(55,227,255,.35) inset; transition: width .25s ease; }
  .progress pct { font-variant-numeric: tabular-nums; }

  /* Next Up */
  .nextup { margin: 14px 0 8px; background: var(--card); border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); overflow:hidden; box-shadow: var(--shadow); }
  .nextup .thumb { position: relative; aspect-ratio: 16/9; background: #06111a; overflow: hidden; }
  .nextup img { width:100%; height:100%; object-fit:cover; display:block; }
  .nextup .chip { position:absolute; left:10px; top:10px; background: rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.15); color:#dbf7ff; padding:4px 8px; border-radius:999px; font-size:12px; backdrop-filter: blur(6px); }
  .nextup .meta { padding: 12px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .nextup .meta .t { font-size: 18px; font-weight: 600; }

  /* Filter bar */
  .filters { display: grid; grid-template-columns: repeat(3, 1fr); gap:8px; margin: 10px 0 12px; }
  .seg { padding: 10px; text-align:center; border-radius: 12px; border:1px solid rgba(255,255,255,.08); background: var(--card-2); color: var(--muted); cursor:pointer; user-select:none; }
  .seg.active { color: var(--text); border-color: rgba(55,227,255,.5); box-shadow: 0 0 0 2px rgba(55,227,255,.12) inset; }

  /* Talks list */
  .list { display: grid; gap:8px; }
  .row { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; padding: 10px 12px; background: var(--card); border:1px solid rgba(255,255,255,.06); border-radius: 14px; }
  .row-left { display:flex; align-items:center; gap:10px; min-width:0; }
  .dot { width:10px; height:10px; border-radius:999px; background: #193246; box-shadow: 0 0 0 2px rgba(55,227,255,.15) inset; }
  .row .title { font-weight:600; color:var(--text); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .row .title button { all:unset; color: var(--text); cursor:pointer; }
  .row-right { display:flex; align-items:center; gap:6px; }
  .iconbtn { background: var(--card-2); border:1px solid rgba(255,255,255,.08); border-radius: 10px; padding: 8px 10px; display:flex; align-items:center; gap:6px; cursor:pointer; color:var(--muted); }
  .iconbtn:hover { color:var(--text); border-color: rgba(255,255,255,.18); }
  .star { font-size:18px; line-height:1; color:#bcd; }
  .star.fav { color: #ffe08a; text-shadow: 0 0 10px rgba(255,224,138,.35); }
  .check { width:22px; height:22px; border-radius:6px; display:inline-grid; place-items:center; border:1px solid rgba(255,255,255,.18); background: #0a0f18; color:#88ffd1; cursor:pointer; }
  .check.on { background: rgba(47,230,165,.12); border-color: rgba(47,230,165,.55); }

  /* Watch count pill */
  .countpill { display:flex; align-items:center; gap:6px; background: #0a121b; border:1px solid rgba(255,255,255,.08); border-radius: 999px; padding: 6px 8px; }
  .countpill input { width: 40px; background: transparent; border: none; color:var(--text); text-align:center; font-variant-numeric: tabular-nums; outline:none; }
  .countpill button { background:transparent; border:none; color:var(--text); width:24px; height:24px; border-radius:8px; cursor:pointer; }
  .countpill button:active { transform: scale(.95); }

  /* Footer controls */
  .settings { margin: 12px 0 24px; display:flex; flex-wrap: wrap; gap:8px; }

  /* Modal */
  dialog { border:none; padding:0; border-radius: 16px; background: var(--card); color:var(--text); width:min(720px, 92vw); box-shadow: var(--shadow); }
  dialog::backdrop { background: rgba(4,8,12,.55); backdrop-filter: blur(2px); }
  .modal-head { padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,.06); display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .modal-body { padding: 12px; }
  textarea.notes { width:100%; min-height: 220px; resize: vertical; background: #0a121b; color: var(--text); border:1px solid rgba(255,255,255,.12); border-radius: 12px; padding: 12px; line-height:1.4; }

  /* Toast */
  .toast { position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); background: rgba(0,0,0,.7); color: #dbf7ff; padding: 10px 14px; border-radius: 999px; border:1px solid rgba(255,255,255,.15); opacity:0; pointer-events:none; transition: opacity .2s ease, transform .2s ease; z-index: 999; }
  .toast.show { opacity:1; transform: translateX(-50%) translateY(-4px); }

  /* Fine tweaks */
  @media (min-width: 680px) {
    .row { grid-template-columns: 1fr auto auto; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="titlebar">
        <h1>General Conference Tracker</h1>
        <div class="controls">
          <button class="btn small ghost" id="btnSettings">Settings</button>
        </div>
      </div>
      <div class="progress" aria-label="Overall progress">
        <div class="progress-bar" aria-hidden="true"><span id="progFill"></span></div>
        <div class="pct" id="progPct">0%</div>
      </div>
    </header>

    <!-- Next Up Card -->
    <section class="nextup" id="nextUp" hidden>
      <div class="thumb">
        <img id="nextThumb" alt="Next up thumbnail" />
        <div class="chip">Next Up</div>
      </div>
      <div class="meta">
        <div class="t" id="nextTitle">&nbsp;</div>
        <button class="btn" id="btnPlayNext">Open</button>
      </div>
    </section>

    <!-- Filters -->
    <div class="filters" role="tablist" aria-label="Filter talks">
      <div class="seg active" data-filter="need" role="tab" aria-selected="true">Need to Watch</div>
      <div class="seg" data-filter="seen" role="tab" aria-selected="false">Already Seen</div>
      <div class="seg" data-filter="faves" role="tab" aria-selected="false">Favorites</div>
    </div>

    <!-- Talks List -->
    <section class="list" id="list"></section>

    <!-- Settings / Exports -->
    <section class="settings">
      <button class="btn small" id="btnDownload">Download All</button>
      <label class="btn small" for="fileRestore" style="cursor:pointer;">Upload / Restore</label>
      <input id="fileRestore" type="file" accept="application/json" hidden />
      <button class="btn small" id="btnEmail">Email Export</button>
      <button class="btn small" id="btnNotesDownload">Notes → File</button>
      <button class="btn small" id="btnNotesCopy">Notes → Clipboard</button>
    </section>
  </div>

  <!-- Notes Modal -->
  <dialog id="notesModal">
    <div class="modal-head">
      <div id="notesTitle" style="font-weight:600;">Notes</div>
      <button class="btn small ghost" id="closeNotes">Close</button>
    </div>
    <div class="modal-body">
      <textarea class="notes" id="notesArea" placeholder="Quick thoughts…"></textarea>
    </div>
  </dialog>

  <div class="toast" id="toast"></div>

<script>
// -----------------------------
// Data: October 2025 Talks
// -----------------------------
const talks = [
  {title:"Dallin H. Oaks", videoId:"_IoztgCi99w", youtubeUrl:"https://www.youtube.com/watch?v=_IoztgCi99w&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=1&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/01 - Dallin H. Oaks October 2025 General Conference.txt"},
  {title:"Gary E. Stevenson", videoId:"b0Bax6NvKbo", youtubeUrl:"https://www.youtube.com/watch?v=b0Bax6NvKbo&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=3&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/02 - Gary E. Stevenson October 2025 General Conference.txt"},
  {title:"Tracy Y. Browning", videoId:"Nr2kTHPRf_E", youtubeUrl:"https://www.youtube.com/watch?v=Nr2kTHPRf_E&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=4&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/03 - Tracy Y. Browning October 2025 General Conference.txt"},
  {title:"Ronald M. Barcellos", videoId:"_b1Of0jF6LE", youtubeUrl:"https://www.youtube.com/watch?v=_b1Of0jF6LE&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=5&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/04 - Ronald M. Barcellos October 2025 General Conference.txt"},
  {title:"Brik V. Eyre", videoId:"xmLvB0dHMOk", youtubeUrl:"https://www.youtube.com/watch?v=xmLvB0dHMOk&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=6&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/05 - Brik V. Eyre October 2025 General Conference.txt"},
  {title:"Kelly R. Johnson", videoId:"9mfczYq3AL8", youtubeUrl:"https://www.youtube.com/watch?v=9mfczYq3AL8&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=7&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/06 - Kelly R. Johnson October 2025 General Conference.txt"},
  {title:"Dieter F. Uchtdorf", videoId:"amasL9HJzp8", youtubeUrl:"https://www.youtube.com/watch?v=amasL9HJzp8&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=8&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/07 - Dieter F. Uchtdorf October 2025 General Conference.txt"},
  {title:"Ronald A. Rasband", videoId:"gRS5jLgte6U", youtubeUrl:"https://www.youtube.com/watch?v=gRS5jLgte6U&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=10&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/08 - Ronald A. Rasband October 2025 General Conference.txt"},
  {title:"Chad H Webb", videoId:"w_tzZXJuonQ", youtubeUrl:"https://www.youtube.com/watch?v=w_tzZXJuonQ&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=11&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/09 - Chad H Webb October 2025 General Conference.txt"},
  {title:"Jeremy R. Jaggi", videoId:"OBsXV3YgH8Y", youtubeUrl:"https://www.youtube.com/watch?v=OBsXV3YgH8Y&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=12&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/10 - Jeremy R. Jaggi October 2025 General Conference.txt"},
  {title:"Kevin G. Brown", videoId:"1G3wEjr3_Go", youtubeUrl:"https://www.youtube.com/watch?v=1G3wEjr3_Go&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=13&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/11 - Kevin G. Brown October 2025 General Conference.txt"},
  {title:"Gerrit W. Gong", videoId:"X1h_-av587w", youtubeUrl:"https://www.youtube.com/watch?v=X1h_-av587w&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=14&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/12 - Gerrit W. Gong October 2025 General Conference.txt"},
  {title:"Michael Cziesla", videoId:"SVXJ-Qb1SLk", youtubeUrl:"https://www.youtube.com/watch?v=SVXJ-Qb1SLk&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=15&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/13 - Michael Cziesla October 2025 General Conference.txt"},
  {title:"Quentin L. Cook", videoId:"dASOQLRL5g8", youtubeUrl:"https://www.youtube.com/watch?v=dASOQLRL5g8&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=16&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/14 - Quentin L. Cook October 2025 General Conference.txt"},
  {title:"Patrick Kearon", videoId:"0ztxXiDuHRg", youtubeUrl:"https://www.youtube.com/watch?v=0ztxXiDuHRg&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=17&t=6s&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/15 - Patrick Kearon October 2025 General Conference.txt", startSeconds:6},
  {title:"J. Anette Dennis", videoId:"shE1883vdwE", youtubeUrl:"https://www.youtube.com/watch?v=shE1883vdwE&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=18&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/16 - J. Anette Dennis October 2025 General Conference.txt"},
  {title:"Steven C. Barlow", videoId:"RoDepB4mUGg", youtubeUrl:"https://www.youtube.com/watch?v=RoDepB4mUGg&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=19&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/17 - Steven C. Barlow October 2025 General Conference.txt"},
  {title:"William K. Jackson", videoId:"Ov-cVobM8NI", youtubeUrl:"https://www.youtube.com/watch?v=Ov-cVobM8NI&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=20&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/18 - William K. Jackson October 2025 General Conference.txt"},
  {title:"Neil L. Andersen", videoId:"F8mOflZr2pY", youtubeUrl:"https://www.youtube.com/watch?v=F8mOflZr2pY&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=21&t=29s&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/19 - Neil L. Andersen October 2025 General Conference.txt", startSeconds:29},
  {title:"Jeffrey R. Holland", videoId:"V7ubmkqtoDY", youtubeUrl:"https://www.youtube.com/watch?v=V7ubmkqtoDY&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=23&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/20 - Jeffrey R. Holland October 2025 General Conference.txt"},
  {title:"James E. Evanson", videoId:"ftyWyNcA3aY", youtubeUrl:"https://www.youtube.com/watch?v=ftyWyNcA3aY&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=24&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/21 - James E. Evanson October 2025 General Conference.txt"},
  {title:"Ulisses Soares", videoId:"pBpvcq4QhAE", youtubeUrl:"https://www.youtube.com/watch?v=pBpvcq4QhAE&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=25&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/22 - Ulisses Soares October 2025 General Conference.txt"},
  {title:"Peter M. Johnson", videoId:"0Alsi--py9M", youtubeUrl:"https://www.youtube.com/watch?v=0Alsi--py9M&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=26&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/23 - Peter M. Johnson October 2025 General Conference.txt"},
  {title:"D. Todd Christofferson", videoId:"JlxOKRH6ClI", youtubeUrl:"https://www.youtube.com/watch?v=JlxOKRH6ClI&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=27&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/24 - D. Todd Christofferson October 2025 General Conference.txt"},
  {title:"Andrea M. Spannaus", videoId:"T1agpjsCfao", youtubeUrl:"https://www.youtube.com/watch?v=T1agpjsCfao&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=28&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/25 - Andrea M. Spannaus October 2025 General Conference.txt"},
  {title:"Henry B. Eyring", videoId:"OLlaNGKuTiY", youtubeUrl:"https://www.youtube.com/watch?v=OLlaNGKuTiY&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=29&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/26 - Henry B. Eyring October 2025 General Conference.txt"},
  {title:"David A. Bednar", videoId:"OZBEZvrnQvs", youtubeUrl:"https://www.youtube.com/watch?v=OZBEZvrnQvs&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=31&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/27 - David A. Bednar October 2025 General Conference.txt"},
  {title:"B. Corey Cuvelier", videoId:"uAA2zF00GEw", youtubeUrl:"https://www.youtube.com/watch?v=uAA2zF00GEw&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=32&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/28 - B. Corey Cuvelier October 2025 General Conference.txt"},
  {title:"Matthew S. Holland", videoId:"crBvm9a6Tzo", youtubeUrl:"https://www.youtube.com/watch?v=crBvm9a6Tzo&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=33&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/29 - Matthew S. Holland October 2025 General Conference.txt"},
  {title:"Carlos A. Godoy", videoId:"mCmn6_Zw4rU", youtubeUrl:"https://www.youtube.com/watch?v=mCmn6_Zw4rU&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=34&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/30 - Carlos A. Godoy October 2025 General Conference.txt"},
  {title:"Dale G. Renlund", videoId:"Jj6cpBwVnvE", youtubeUrl:"https://www.youtube.com/watch?v=Jj6cpBwVnvE&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=35&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/31 - Dale G. Renlund October 2025 General Conference.txt"},
  {title:"John D. Amos", videoId:"3JIzrxbKero", youtubeUrl:"https://www.youtube.com/watch?v=3JIzrxbKero&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=36&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/32 - John D. Amos October 2025 General Conference.txt"},
  {title:"Ozani Farias", videoId:"WSmX0D7JX9U", youtubeUrl:"https://www.youtube.com/watch?v=WSmX0D7JX9U&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=37&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/33 - Ozani Farias October 2025 General Conference.txt"},
  {title:"Dallin H. Oaks", videoId:"BfdoxwmJFdQ", youtubeUrl:"https://www.youtube.com/watch?v=BfdoxwmJFdQ&list=PLClOO0BdaFaP7-YfLVAd-qDCD5jnKwuM2&index=38&pp=iAQB", transcriptPath:"GC_Transcripts_October_2025/34 - Dallin H. Oaks October 2025 General Conference.txt"}
];

// -----------------------------
// State & Persistence
// -----------------------------
const STORAGE_KEY = "gc:oct-2025:state";
const DEFAULT_STATE = {
  version: 2,
  conferenceId: "oct-2025",
  watched: [], // current round only
  favorites: [],
  notes: {},
  watchCounts: {}, // videoId -> total count (across all rounds)
  round: 1,
  ui: { filter: 'need' }
};

function loadState(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { ...DEFAULT_STATE };
    const obj = JSON.parse(raw);
    // Migrations
    if(!obj.watchCounts) obj.watchCounts = {};
    if(!obj.round) obj.round = 1;
    if(!obj.version || obj.version < 2) obj.version = 2;
    return obj;
  } catch(e){
    console.warn('Failed to parse state', e); return { ...DEFAULT_STATE };
  }
}

function saveState(next){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
}

let state = loadState();

// Helpers
const isWatched = (id) => state.watched.includes(id);
const setWatched = (id, val, {incrementCount=false}={}) => {
  const was = isWatched(id);
  if(val && !was){
    state.watched.push(id);
    if(incrementCount){
      state.watchCounts[id] = (state.watchCounts[id]||0)+1;
    }
  }
  if(!val && was){
    state.watched = state.watched.filter(x => x!==id);
    // Do not auto-decrement count on undo; user can edit.
  }
  // If after marking we finished the round, reset visuals for a new round.
  if(state.watched.length === talks.length){
    state.round += 1;
    state.watched = [];
    toast(`Round ${state.round-1} complete! Starting round ${state.round}.`);
  }
  saveState(state);
  renderAll();
};

const isFav = (id) => state.favorites.includes(id);
const toggleFav = (id) => { state.favorites = isFav(id) ? state.favorites.filter(x=>x!==id) : [...state.favorites, id]; saveState(state); renderAll(); };

function nextUnwatched(){
  for(const t of talks){ if(!isWatched(t.videoId)) return t; }
  return null; // when finishing a round, render will reset and compute again
}

// -----------------------------
// UI Rendering
// -----------------------------
const listEl = document.getElementById('list');
const progFill = document.getElementById('progFill');
const progPct = document.getElementById('progPct');
const nextUp = document.getElementById('nextUp');
const nextThumb = document.getElementById('nextThumb');
const nextTitle = document.getElementById('nextTitle');
const btnPlayNext = document.getElementById('btnPlayNext');

function percent(){ return Math.round((state.watched.length / talks.length) * 100); }

// Robust thumbnail loader: tries multiple sizes + webp; sets no-referrer to avoid hotlink quirks
function loadThumb(img, videoId){
  const candidates = [
    `https://i.ytimg.com/vi/${videoId}/maxresdefault.jpg`,
    `https://i.ytimg.com/vi_webp/${videoId}/maxresdefault.webp`,
    `https://i.ytimg.com/vi/${videoId}/sddefault.jpg`,
    `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`,
    `https://i.ytimg.com/vi/${videoId}/mqdefault.jpg`,
    `https://i.ytimg.com/vi/${videoId}/default.jpg`
  ];
  img.setAttribute('referrerpolicy','no-referrer');
  let i = 0;
  img.onerror = () => { if(++i < candidates.length) img.src = candidates[i]; };
  img.src = candidates[0];
}

function renderProgress(){
  const p = percent();
  progFill.style.width = p + '%';
  progPct.textContent = p + '%';
}

function renderNextUp(){
  const t = nextUnwatched();
  if(!t){ nextUp.hidden = true; return; }
  nextUp.hidden = false;
  nextTitle.textContent = t.title;
  loadThumb(nextThumb, t.videoId);
  btnPlayNext.onclick = () => openYouTubeAppAndMark(t);
  nextUp.querySelector('.thumb').onclick = () => openYouTubeAppAndMark(t);
}

function rowHTML(t){
  const watched = isWatched(t.videoId);
  const fav = isFav(t.videoId);
  const count = state.watchCounts[t.videoId] || 0;
  return `
    <div class="row" data-id="${t.videoId}">
      <div class="row-left">
        <div class="dot" aria-hidden="true"></div>
        <div class="title" title="Open in YouTube">
          <button class="link-open" data-id="${t.videoId}">${t.title}</button>
        </div>
      </div>
      <div class="row-right">
        <div class="countpill" title="Times watched">
          <button class="minus" aria-label="decrease">−</button>
          <input class="count" type="number" inputmode="numeric" min="0" value="${count}" />
          <button class="plus" aria-label="increase">+</button>
        </div>
        <button class="iconbtn copy" title="Copy transcript">📋</button>
        <button class="iconbtn notes" title="Notes">📝</button>
        <button class="iconbtn fav" title="Favorite"><span class="star ${fav?'fav':''}">★</span></button>
        <div class="check ${watched?'on':''}" role="checkbox" aria-checked="${watched}" title="Mark watched">${watched?'✓':''}</div>
      </div>
    </div>
  `;
}

function currentFilter(){ return state.ui.filter || 'need'; }

function filteredTalks(){
  const f = currentFilter();
  if(f==='need') return talks.filter(t=>!isWatched(t.videoId));
  if(f==='seen') return talks.filter(t=>isWatched(t.videoId));
  if(f==='faves') return talks.filter(t=>isFav(t.videoId));
  return talks;
}

function renderList(){
  listEl.innerHTML = filteredTalks().map(rowHTML).join('');
  // Wire per-row handlers
  listEl.querySelectorAll('.row').forEach(row => {
    const id = row.dataset.id;
    const t = talks.find(x=>x.videoId===id);
    row.querySelector('.link-open').onclick = () => openYouTubeAppAndMark(t);
    row.querySelector('.copy').onclick = () => copyTranscript(t.transcriptPath);
    row.querySelector('.notes').onclick = () => openNotes(id, t.title);
    row.querySelector('.fav').onclick = () => toggleFav(id);
    row.querySelector('.check').onclick = () => {
      const now = !isWatched(id);
      setWatched(id, now, {incrementCount: now});
    };
    // Count +/- and manual edit
    const minus = row.querySelector('.minus');
    const plus = row.querySelector('.plus');
    const input = row.querySelector('.count');
    minus.onclick = () => { setCount(id, Math.max(0, (state.watchCounts[id]||0)-1)); input.value = state.watchCounts[id]; };
    plus.onclick = () => { setCount(id, (state.watchCounts[id]||0)+1); input.value = state.watchCounts[id]; };
    input.onchange = () => { let v = parseInt(input.value||'0',10); if(isNaN(v)||v<0) v=0; setCount(id, v); input.value = state.watchCounts[id]; };
  });
}

function setCount(id, n){ state.watchCounts[id] = n; saveState(state); renderProgress(); }

function renderFilters(){
  document.querySelectorAll('.seg').forEach(seg => {
    const is = seg.dataset.filter === currentFilter();
    seg.classList.toggle('active', is);
    seg.setAttribute('aria-selected', String(is));
    seg.onclick = () => { state.ui.filter = seg.dataset.filter; saveState(state); renderAll(); };
  });
}

function renderAll(){
  renderProgress();
  renderNextUp();
  renderFilters();
  renderList();
}

// -----------------------------
// Deep Link + Auto Mark
// -----------------------------
function openYouTubeAppAndMark(t){
  // Mark watched for the *current round* and increment the cumulative count
  setWatched(t.videoId, true, {incrementCount:true});

  const start = t.startSeconds ? t.startSeconds : null;
  const webUrl = `https://www.youtube.com/watch?v=${t.videoId}${start?`&t=${start}s`:``}`;
  const ua = navigator.userAgent || '';
  const isiOS = /iPad|iPhone|iPod/.test(ua);
  const isAndroid = /Android/.test(ua);
  let appUrl = null;
  if(isiOS){ appUrl = `youtube://www.youtube.com/watch?v=${t.videoId}${start?`&t=${start}s`:``}`; }
  else if(isAndroid){ appUrl = `vnd.youtube:${t.videoId}${start?`?t=${start}s`:``}`; }

  if(appUrl){
    const timer = setTimeout(()=>{ window.location.href = webUrl; }, 400);
    window.location.href = appUrl;
  } else {
    window.location.href = webUrl;
  }
}

// -----------------------------
// Clipboard / Transcript (MOBILE-SAFE)
// -----------------------------
async function copyTranscript(path){
  // Resolve relative → absolute for GitHub Pages and similar hosts
  const url = new URL(path, location.href).toString();

  let txt = '';
  try {
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) {
      throw new Error(`Fetch failed: ${res.status} ${res.statusText}`);
    }
    txt = await res.text();
  } catch (e) {
    console.error('Transcript fetch failed:', e);
    toast('Could not load transcript file.');
    return;
  }

  // Try async clipboard first; if blocked (common on iOS/in-app webviews), fallback to textarea.
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(txt);
      toast('Transcript copied.');
      return;
    }
    // No clipboard API -> fallback
    fallbackCopyText(txt);
    toast('Transcript copied (fallback).');
  } catch (e) {
    console.warn('navigator.clipboard.writeText failed; using fallback. Error:', e);
    fallbackCopyText(txt);
    toast('Transcript copied (fallback).');
  }
}

function fallbackCopyText(text){
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.setAttribute('readonly', '');
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  ta.style.left = '-9999px';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try { document.execCommand('copy'); } catch (_) {}
  document.body.removeChild(ta);
}

// -----------------------------
// Notes Modal
// -----------------------------
const notesModal = document.getElementById('notesModal');
const notesTitle = document.getElementById('notesTitle');
const notesArea = document.getElementById('notesArea');
const closeNotesBtn = document.getElementById('closeNotes');
let currentNotesVid = null;

function openNotes(videoId, title){
  currentNotesVid = videoId;
  notesTitle.textContent = title + ' — Notes';
  notesArea.value = state.notes[videoId] || '';
  notesModal.showModal();
}
closeNotesBtn.onclick = () => notesModal.close();
notesModal.addEventListener('close', ()=>{ currentNotesVid = null; });

let notesTimer = null;
notesArea.addEventListener('input', () => {
  if(!currentNotesVid) return;
  clearTimeout(notesTimer);
  notesTimer = setTimeout(()=>{
    state.notes[currentNotesVid] = notesArea.value;
    saveState(state);
  }, 250);
});

// -----------------------------
// Exports / Backup / Restore
// -----------------------------
function getFullState(){ return state; }

function downloadAll(){
  const blob = new Blob([JSON.stringify(getFullState(), null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.download = 'gc-tracker-oct-2025-backup.json';
  a.href = URL.createObjectURL(blob);
  a.click(); URL.revokeObjectURL(a.href);
}

async function emailExport(){
  // Prefer Web Share with file attachment
  try{
    const blob = new Blob([JSON.stringify(getFullState())], {type:'application/json'});
    const file = new File([blob], 'gc-tracker-oct-2025-backup.json', {type:'application/json'});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({ files:[file], title:'GC Backup', text:'My General Conference Tracker backup' });
      return;
    }
  }catch(_){ /* ignore */ }
  // Fallback: mailto (inline body, no attachment possible)
  const body = encodeURIComponent(JSON.stringify(getFullState(), null, 2));
  window.location.href = `mailto:?subject=GC%20Backup&body=${body}`;
}

function restoreFromFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);
      if(data.version>=1 && data.conferenceId==='oct-2025'){
        state = data; // replace entire state
        // Ensure new fields exist
        if(!state.watchCounts) state.watchCounts = {};
        if(!state.round) state.round = 1;
        saveState(state); renderAll(); toast('Restore complete.');
      } else {
        toast('Backup not recognized.');
      }
    }catch(e){ toast('Invalid file.'); }
  };
  reader.readAsText(file);
}

function notesOnlyText(){
  const parts = [];
  for(const t of talks){
    const n = (state.notes[t.videoId]||'').trim();
    if(n){ parts.push(`${t.title}\n${n}\n`); }
  }
  return parts.join('\n');
}

function downloadNotes(){
  const txt = notesOnlyText() || '— No notes yet —';
  const blob = new Blob([txt], {type:'text/plain'});
  const a = document.createElement('a');
  a.download = 'gc-notes-oct-2025.txt';
  a.href = URL.createObjectURL(blob);
  a.click(); URL.revokeObjectURL(a.href);
}

async function copyNotes(){
  const txt = notesOnlyText();
  if(!txt){ toast('No notes yet.'); return; }
  try{
    await navigator.clipboard.writeText(txt);
    toast('Notes copied.');
  } catch(_){
    fallbackCopyText(txt);
    toast('Notes copied (fallback).');
  }
}

// -----------------------------
// Settings / Misc
// -----------------------------
const btnSettings = document.getElementById('btnSettings');
btnSettings.onclick = () => {
  // Tiny hint sheet
  toast('Tips: Long-press titles to open in app; use Settings for backup & notes export.');
};

document.getElementById('btnDownload').onclick = downloadAll;
document.getElementById('btnEmail').onclick = emailExport;
document.getElementById('btnNotesDownload').onclick = downloadNotes;
document.getElementById('btnNotesCopy').onclick = copyNotes;

document.getElementById('fileRestore').addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0]; if(f) restoreFromFile(f);
  e.target.value = '';
});

// -----------------------------
// Toast
// -----------------------------
const toastEl = document.getElementById('toast');
let toastTimer = null;
function toast(msg){
  toastEl.textContent = msg; toastEl.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> toastEl.classList.remove('show'), 1800);
}

// -----------------------------
// Init
// -----------------------------
renderAll();
</script>
</body>
</html>
