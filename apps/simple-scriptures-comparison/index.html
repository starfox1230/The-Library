<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Verse Side-by-Side Comparator</title>
  <style>
    :root{
      --bg:#0b0e14;
      --panel:#121826;
      --panel2:#0f1422;
      --border:rgba(255,255,255,0.10);
      --border2:rgba(255,255,255,0.07);
      --text:#e7ecf5;
      --muted:#aab3c5;
      --accent:#7aa2ff;
      --danger:#ff6b6b;
      --chip:#1b2741;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, #141b2d 0%, var(--bg) 45%) fixed;
      color:var(--text);
    }

    .wrap{
      max-width: 1200px;
      margin:0 auto;
      padding:20px 12px 40px;
    }

    /* Inputs */
    .inputGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      align-items: start;
    }
    .card{
      background: linear-gradient(180deg, rgba(18,24,38,0.92), rgba(12,16,26,0.92));
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      box-shadow: var(--shadow);
    }
    .card .title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.15);
    }
    .card .title .label{
      font-size:12.5px;
      color:var(--muted);
      font-weight:650;
    }
    .card .title .meta{
      font-size:12px;
      color:var(--muted);
    }
    .card textarea{
      width:100%;
      min-height:160px;
      resize:vertical;
      padding:12px;
      border:0;
      outline:0;
      color:var(--text);
      background: transparent;
      font-size:13px;
      line-height:1.45;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Buttons */
    .actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin:12px 0 10px;
    }
    .btnrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    button{
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(122,162,255,0.18);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:700;
      font-size:12.5px;
      cursor:pointer;
      transition: transform 0.05s ease, background 0.15s ease, border-color 0.15s ease;
      user-select:none;
    }
    button:hover{ background: rgba(122,162,255,0.24); border-color: rgba(122,162,255,0.35); }
    button:active{ transform: translateY(1px); }
    .btn-ghost{ background: rgba(255,255,255,0.06); }
    .btn-warn{
      background: rgba(255,107,107,0.14);
      border-color: rgba(255,107,107,0.22);
    }
    .btn-warn:hover{
      background: rgba(255,107,107,0.20);
      border-color: rgba(255,107,107,0.33);
    }

    .status{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      color:var(--muted);
      font-size:12px;
    }
    .chip{
      display:inline-flex;
      gap:6px;
      align-items:center;
      background: rgba(27,39,65,0.85);
      border:1px solid rgba(255,255,255,0.08);
      padding:6px 10px;
      border-radius:999px;
      color: var(--muted);
    }
    .dot{
      width:8px;height:8px;border-radius:999px;background: var(--accent);
      box-shadow: 0 0 0 2px rgba(122,162,255,0.18);
    }

    /* Output: phone-first */
    .outputArea{ display:none; gap:12px; }
    
    .toggleBar{
      position: sticky;
      top: 10px; 
      z-index: 99; /* High z-index to stay on top */
      backdrop-filter: blur(12px);
      background: rgba(11,14,20,0.85);
      border:1px solid var(--border2);
      border-radius:14px;
      padding:6px; /* Slimmer padding */
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
      margin-bottom: 12px;
    }
    
    .seg{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:6px;
    }
    .seg button{
      width:100%;
      padding:8px 10px; /* Slimmer buttons */
      border-radius:10px;
      background: rgba(255,255,255,0.04);
      border:1px solid transparent;
      font-weight:700;
      color: var(--muted);
    }
    .seg button.active{
      background: rgba(122,162,255,0.22);
      border-color: rgba(122,162,255,0.38);
      color: var(--text);
    }

    /* Stacked verse rows on phone */
    .verseList{
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--border2);
      background: rgba(0,0,0,0.16);
    }
    .vrow{
      padding:10px 12px 12px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background: rgba(15,20,34,0.28);
      scroll-margin-top: 70px; /* Important for scroll snapping below header */
    }
    .vrow:nth-child(2n){ background: rgba(15,20,34,0.16); }
    .vhead{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .vnum{
      font-weight:900;
      color: var(--accent);
      letter-spacing:0.2px;
      font-size:13px;
    }
    .vmicro{
      display:flex;
      gap:6px;
      align-items:center;
      color: var(--muted);
      font-size:11.5px;
    }
    .pill{
      background: rgba(27,39,65,0.7);
      border:1px solid rgba(255,255,255,0.08);
      padding:3px 8px;
      border-radius:999px;
      color: var(--muted);
      white-space:nowrap;
    }

    /* THE PAIR GRID */
    /* Default: Stacked (Portrait behavior) */
    .pair{
      display:grid;
      grid-template-columns: 1fr; 
      gap:10px;
    }

    /* Landscape Mode Tweaks for Phone/Tablets */
    @media (orientation: landscape) {
      .verseList:not(.single-col) .pair {
        grid-template-columns: 1fr 1fr; 
      }
    }

    .pane{
      border:1px solid rgba(255,255,255,0.08);
      border-radius:12px;
      overflow:hidden;
      background: rgba(0,0,0,0.14);
      display:flex; 
      flex-direction:column;
    }
    .pane .phead{
      padding:8px 10px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      display:flex;
      justify-content:space-between;
      align-items:center;
      background: rgba(0,0,0,0.18);
      gap:10px;
    }
    .pane .phead .plabel{
      font-size:12px;
      font-weight:800;
      color: var(--text);
    }
    .pane .phead .psub{
      font-size:11.5px;
      color: var(--muted);
      white-space:nowrap;
    }
    .pane .pbody{
      padding:10px;
      font-size:13.5px;
      line-height:1.45;
      white-space:pre-wrap;
      word-break:break-word;
      flex-grow:1;
    }
    .missing{
      border:1px dashed rgba(255,107,107,0.45);
      background: rgba(255,107,107,0.10);
    }
    .missing .pbody{ color: rgba(231,236,245,0.78); }

    /* Desktop Columns (For large screens only) */
    .columns{
      display:none;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:start;
      margin-top:10px;
    }
    .col{
      border-radius:14px;
      overflow:hidden;
      border:1px solid var(--border2);
      background: rgba(0,0,0,0.16);
    }
    .col .chead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.22);
      position: sticky;
      top: 0;
      z-index: 2;
      backdrop-filter: blur(10px);
    }
    .col .chead .clabel{ font-size:12.5px; font-weight:900; }
    .col .chead .cmeta{ font-size:12px; color: var(--muted); }
    .col .cbody{ max-height: 80vh; overflow:auto; }
     
    .row{
      padding:10px 12px 12px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background: rgba(15,20,34,0.28);
    }
    .row:nth-child(2n){ background: rgba(15,20,34,0.16); }
    .row .rtop{ display:flex; align-items:baseline; gap:10px; margin-bottom:6px; }
    .row .rnum{ min-width:34px; font-weight:900; color: var(--accent); font-size:13px; }
    .row .rtag{
      font-size:11px;
      color: var(--muted);
      background: rgba(27,39,65,0.6);
      border:1px solid rgba(255,255,255,0.08);
      padding:3px 7px;
      border-radius:999px;
    }
    .row .rtext{
      margin:0;
      font-size:13.5px;
      line-height:1.45;
      white-space:pre-wrap;
      word-break:break-word;
    }

    /* BREAKPOINTS */
    @media (max-width: 900px){
      .outputArea{ display:flex; flex-direction: column; }
      .columns{ display:none; }
      .inputGrid{ grid-template-columns: 1fr; }
    }
    @media (min-width: 901px){
      .inputGrid{ grid-template-columns: 1fr 1fr; }
      .actions{ flex-direction:row; align-items:center; justify-content:space-between; }
      .outputArea{ display:none; }
      .columns{ display:grid; }
      .toggleBar{ display:none; }
    }

    .note{
      margin-top:10px;
      font-size:12.5px;
      color: var(--muted);
      line-height:1.5;
    }
    code{ color: var(--text); }
  </style>
</head>
<body>
  
  <div class="wrap">
    <div class="inputGrid">
      <div class="card">
        <div class="title">
          <div class="label">Left text (Original)</div>
          <div class="meta" id="leftCount">—</div>
        </div>
        <textarea id="leftInput" placeholder="Paste the original here...&#10;&#10;1. ...&#10;2. ..."></textarea>
      </div>

      <div class="card">
        <div class="title">
          <div class="label">Right text (New version)</div>
          <div class="meta" id="rightCount">—</div>
        </div>
        <textarea id="rightInput" placeholder="Paste the simplified version here...&#10;&#10;1. ...&#10;2. ..."></textarea>
      </div>
    </div>

    <div class="actions">
      <div class="btnrow">
        <button id="renderBtn">Render</button>
        <button class="btn-ghost" id="swapBtn">Swap</button>
        <button class="btn-ghost" id="clearBtn">Clear</button>
        <button class="btn-ghost" id="copyCodeBtn" title="Copies a compressed share code">Copy share code</button>
        <button class="btn-ghost" id="pasteCodeBtn" title="Paste a share code to load content">Paste share code</button>
        <button class="btn-warn" id="demoBtn">Load demo</button>
      </div>

      <div class="status">
        <span class="chip"><span class="dot"></span><span id="statusText">Ready</span></span>
        <span class="chip" id="rangeChip" style="display:none;"></span>
        <span class="chip" id="missingChip" style="display:none;"></span>
      </div>
    </div>

    <div class="outputArea" id="phoneOutput" style="display:none;">
      <div class="toggleBar">
        <div class="seg">
          <button id="showBothBtn" class="active">Both</button>
          <button id="showLeftBtn">Left</button>
          <button id="showRightBtn">Right</button>
        </div>
      </div>

      <div class="verseList" id="verseList"></div>
    </div>

    <div class="columns" id="columnsOutput" style="display:none;">
      <div class="col">
        <div class="chead">
          <div class="clabel">Left (Original)</div>
          <div class="cmeta" id="leftMeta">0 parsed</div>
        </div>
        <div class="cbody" id="leftCol"></div>
      </div>

      <div class="col">
        <div class="chead">
          <div class="clabel">Right (New)</div>
          <div class="cmeta" id="rightMeta">0 parsed</div>
        </div>
        <div class="cbody" id="rightCol"></div>
      </div>
    </div>

    <div class="note">
      Parsing rule: a verse starts on a new line with <code>number + period</code> (example: <code>7.</code>). Missing verses are highlighted but rows stay aligned. Use <code>Copy share code</code> + <code>Paste share code</code> to share large passages without URL length limits.
    </div>
  </div>

  <script>
    // ---------------- LZW Compression (Shorten URLs) ----------------
    // Simple implementation to make shared links ~50% smaller
    const LZW={compress:function(e){if(null==e)return"";var r,n,o,t={},i=(o=256,[]),u=e.charAt(0),a=u;for(r=1;r<e.length;r++)null!=(n=t[u+e.charAt(r)])?u+=e.charAt(r):(i.push(a.length>1?t[a]:a.charCodeAt(0)),t[u+e.charAt(r)]=o,o++,u=e.charAt(r),a=u);return i.push(a.length>1?t[a]:a.charCodeAt(0)),i.map(function(e){return String.fromCharCode(e)}).join("")},decompress:function(e){if(null==e||""===e)return"";var r,n,o=[],t=256,i=e.charAt(0),u=i,a=e.charAt(0);for(r=1;r<e.length;r++)o[r]=e.charCodeAt(r),n=o[r]<256?e.charAt(r):t[o[r]]?t[o[r]]:u+i,a+=n,u+=i,i=n.charAt(0),t[n]=t[u]+i,t++;return a}};

    // ---------------- Parsing ----------------
    function parseVerses(raw) {
      const text = (raw || "").replace(/\r\n/g, "\n");
      const lines = text.split("\n");
      const verses = new Map(); // num -> text
      let currentNum = null;
      let buf = [];
      const verseStart = /^\s*(\d+)\.\s*(.*)$/;

      function flush() {
        if (currentNum !== null) {
          verses.set(currentNum, buf.join("\n").trim());
        }
        buf = [];
      }

      for (const line of lines) {
        const m = line.match(verseStart);
        if (m) {
          flush();
          currentNum = parseInt(m[1], 10);
          buf.push((m[2] || "").trim());
        } else {
          if (currentNum !== null) buf.push(line);
        }
      }
      flush();
      return verses;
    }

    function unionKeys(a, b) {
      const s = new Set();
      for (const k of a.keys()) s.add(k);
      for (const k of b.keys()) s.add(k);
      return Array.from(s).sort((x,y)=>x-y);
    }

    // ---------------- UI helpers ----------------
    function el(tag, cls, text) {
      const n = document.createElement(tag);
      if (cls) n.className = cls;
      if (text !== undefined) n.textContent = text;
      return n;
    }

    function makePhoneVerseCard(num, leftText, rightText, missingLeft, missingRight) {
      const row = el("div", "vrow");
      row.id = "vrow-" + num; // Add ID for scroll targeting

      const head = el("div", "vhead");
      head.appendChild(el("div", "vnum", num + "."));

      const micro = el("div", "vmicro");
      if (missingLeft) micro.appendChild(el("span", "pill", "L missing"));
      if (missingRight) micro.appendChild(el("span", "pill", "R missing"));
      head.appendChild(micro);

      const pair = el("div", "pair");

      const leftPane = el("div", "pane" + (missingLeft ? " missing" : ""));
      const lhead = el("div", "phead");
      lhead.appendChild(el("div", "plabel", "Left"));
      lhead.appendChild(el("div", "psub", missingLeft ? "Missing" : "OK"));
      leftPane.appendChild(lhead);
      leftPane.appendChild(el("div", "pbody", missingLeft ? "(no verse found)" : leftText));
      leftPane.dataset.side = "left";

      const rightPane = el("div", "pane" + (missingRight ? " missing" : ""));
      const rhead = el("div", "phead");
      rhead.appendChild(el("div", "plabel", "Right"));
      rhead.appendChild(el("div", "psub", missingRight ? "Missing" : "OK"));
      rightPane.appendChild(rhead);
      rightPane.appendChild(el("div", "pbody", missingRight ? "(no verse found)" : rightText));
      rightPane.dataset.side = "right";

      pair.appendChild(leftPane);
      pair.appendChild(rightPane);

      row.appendChild(head);
      row.appendChild(pair);
      return row;
    }

    function makeColumnRow(num, text, side, missing) {
      const row = el("div", "row" + (missing ? " missing" : ""));
      const top = el("div", "rtop");
      top.appendChild(el("div", "rnum", num + "."));
      top.appendChild(el("div", "rtag", missing ? "Missing" : (side === "left" ? "Left" : "Right")));
      row.appendChild(top);
      row.appendChild(el("p", "rtext", missing ? "(no verse found)" : text));
      return row;
    }

    // ---------------- Scroll sync for columns ----------------
    let syncing = false;
    function syncScroll(leftBody, rightBody) {
      leftBody.onscroll = () => {
        if (syncing) return;
        syncing = true;
        rightBody.scrollTop = leftBody.scrollTop;
        syncing = false;
      };
      rightBody.onscroll = () => {
        if (syncing) return;
        syncing = true;
        leftBody.scrollTop = rightBody.scrollTop;
        syncing = false;
      };
    }

    // ---------------- Render ----------------
    function render() {
      const leftRaw = document.getElementById("leftInput").value;
      const rightRaw = document.getElementById("rightInput").value;

      const leftMap = parseVerses(leftRaw);
      const rightMap = parseVerses(rightRaw);

      document.getElementById("leftCount").textContent = leftMap.size ? `${leftMap.size} verse(s)` : "—";
      document.getElementById("rightCount").textContent = rightMap.size ? `${rightMap.size} verse(s)` : "—";

      const keys = unionKeys(leftMap, rightMap);

      const statusText = document.getElementById("statusText");
      const rangeChip = document.getElementById("rangeChip");
      const missingChip = document.getElementById("missingChip");

      // clear outputs
      const phoneOutput = document.getElementById("phoneOutput");
      const verseList = document.getElementById("verseList");
      verseList.innerHTML = "";

      const columnsOutput = document.getElementById("columnsOutput");
      const leftCol = document.getElementById("leftCol");
      const rightCol = document.getElementById("rightCol");
      leftCol.innerHTML = "";
      rightCol.innerHTML = "";

      if (!keys.length) {
        phoneOutput.style.display = "none";
        columnsOutput.style.display = "none";
        statusText.textContent = "No verses found. Use lines that start with “1.”, “2.”, etc.";
        rangeChip.style.display = "none";
        missingChip.style.display = "none";
        return;
      }

      let missingLeft = 0, missingRight = 0;

      // build both render modes
      for (const k of keys) {
        const l = leftMap.get(k);
        const r = rightMap.get(k);
        const ml = (l === undefined);
        const mr = (r === undefined);
        if (ml) missingLeft++;
        if (mr) missingRight++;

        verseList.appendChild(makePhoneVerseCard(k, l ?? "", r ?? "", ml, mr));
        leftCol.appendChild(makeColumnRow(k, l ?? "", "left", ml));
        rightCol.appendChild(makeColumnRow(k, r ?? "", "right", mr));
      }

      // show both containers
      phoneOutput.style.display = "flex"; // Changed to flex for sticky column
      columnsOutput.style.display = "grid";

      // meta chips
      const min = keys[0], max = keys[keys.length - 1];
      statusText.textContent = "Rendered";
      rangeChip.style.display = "inline-flex";
      rangeChip.textContent = `Verses: ${min}–${max} (${keys.length})`;

      if (missingLeft || missingRight) {
        missingChip.style.display = "inline-flex";
        missingChip.textContent = `Missing — left: ${missingLeft}, right: ${missingRight}`;
      } else {
        missingChip.style.display = "none";
      }

      document.getElementById("leftMeta").textContent = `${leftMap.size} parsed`;
      document.getElementById("rightMeta").textContent = `${rightMap.size} parsed`;

      // scroll sync for columns
      const leftBody = leftCol.parentElement;  // .cbody
      const rightBody = rightCol.parentElement;
      syncScroll(leftBody, rightBody);

      // apply current phone view mode
      applyPhoneMode(currentPhoneMode);
    }

    // ---------------- Phone view mode (Both / Left / Right) ----------------
    let currentPhoneMode = "both"; // "both" | "left" | "right"

    function setActive(btnId) {
      ["showBothBtn","showLeftBtn","showRightBtn"].forEach(id=>{
        document.getElementById(id).classList.toggle("active", id === btnId);
      });
    }

    function applyPhoneMode(mode) {
      // 1. Capture current visual context (Which verse is at the top?)
      const verseList = document.getElementById("verseList");
      const rows = Array.from(document.querySelectorAll('.vrow'));
      const headerOffset = 60; // Approx height of sticky header
      
      let pivotRow = null;
      
      // Find the first row that is currently visible or just above
      for(let r of rows){
        const rect = r.getBoundingClientRect();
        if(rect.top >= headerOffset - 20) { // -20 tolerance
          pivotRow = r;
          break;
        }
      }
      // If we are at the very bottom, keep the last row as pivot
      if(!pivotRow && rows.length > 0) pivotRow = rows[rows.length-1];

      // 2. Switch Mode
      currentPhoneMode = mode;
      
      if (mode === 'both') {
        verseList.classList.remove('single-col');
      } else {
        verseList.classList.add('single-col');
      }

      const panes = document.querySelectorAll("#verseList .pane");
      panes.forEach(p => {
        const side = p.dataset.side;
        if (mode === "both") {
          p.style.display = "";
        } else if (mode === "left") {
          p.style.display = (side === "left") ? "" : "none";
        } else if (mode === "right") {
          p.style.display = (side === "right") ? "" : "none";
        }
      });

      // 3. Restore Context (Scroll back to the pivot verse)
      if(pivotRow) {
        // We use scrollIntoView. The CSS scroll-margin-top handles the sticky header offset!
        pivotRow.scrollIntoView({behavior: "auto", block: "start"});
      }
    }

    document.getElementById("showBothBtn").addEventListener("click", () => {
      setActive("showBothBtn");
      applyPhoneMode("both");
    });
    document.getElementById("showLeftBtn").addEventListener("click", () => {
      setActive("showLeftBtn");
      applyPhoneMode("left");
    });
    document.getElementById("showRightBtn").addEventListener("click", () => {
      setActive("showRightBtn");
      applyPhoneMode("right");
    });

    // ---------------- Share link (Compressed) ----------------
    function toBase64Url(input) {
      return input.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
    }

    function fromBase64Url(input) {
      const padded = input.replace(/-/g, "+").replace(/_/g, "/");
      const padding = "=".repeat((4 - (padded.length % 4)) % 4);
      return padded + padding;
    }

    function encodeForUrl(str) {
      const compressed = LZW.compress(str);
      const bytes = new TextEncoder().encode(compressed);
      let bin = "";
      bytes.forEach(b => bin += String.fromCharCode(b));
      return toBase64Url(btoa(bin));
    }
    
    function decodeFromUrl(b64) {
      try {
        const bin = atob(fromBase64Url(b64));
        const bytes = new Uint8Array(bin.length);
        for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
        const compressed = new TextDecoder().decode(bytes);
        return LZW.decompress(compressed);
      } catch(e) { console.error(e); return ""; }
    }

    function buildShareCode() {
      const l = document.getElementById("leftInput").value || "";
      const r = document.getElementById("rightInput").value || "";
      if (!l && !r) return "";
      const payload = JSON.stringify({ l, r });
      const b64 = encodeForUrl(payload);
      return `ssc:${b64}`;
    }

    function loadFromShareCode(rawCode) {
      if (!rawCode) return;
      const trimmed = rawCode.trim();
      const code = trimmed.startsWith("ssc:") ? trimmed.slice(4) : trimmed;
      loadFromSharedValue(code);
    }

    document.getElementById("copyCodeBtn").addEventListener("click", async () => {
      const code = buildShareCode();
      if (!code) return;

      try{
        await navigator.clipboard.writeText(code);
        document.getElementById("statusText").textContent = "Share code copied!";
      }catch(e){
        const tmp = document.createElement("textarea");
        tmp.value = code;
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand("copy");
        tmp.remove();
        document.getElementById("statusText").textContent = "Share code copied!";
      }
      
      setTimeout(() => document.getElementById("statusText").textContent = "Ready", 3000);
    });

    document.getElementById("pasteCodeBtn").addEventListener("click", async () => {
      const existing = buildShareCode() ? "Replace current text with a share code?" : "Paste a share code to load:";
      const promptText = buildShareCode() ? `${existing}\n(This will overwrite the current inputs.)` : existing;
      const input = window.prompt(promptText);
      if (!input) return;
      loadFromShareCode(input);
      document.getElementById("statusText").textContent = "Share code loaded!";
      setTimeout(() => document.getElementById("statusText").textContent = "Ready", 3000);
    });

    function loadFromSharedValue(rawValue) {
      if (!rawValue) return;
      
      try{
        const payload = decodeFromUrl(rawValue);
        const obj = JSON.parse(payload);
        if (typeof obj.l === "string") document.getElementById("leftInput").value = obj.l;
        if (typeof obj.r === "string") document.getElementById("rightInput").value = obj.r;
        render();
      }catch(e){
        // Try legacy uncompressed loading if new method fails
        try {
           const legacyPayload = atob(fromBase64Url(rawValue)); // Plain base64
           const obj = JSON.parse(legacyPayload);
           if (typeof obj.l === "string") document.getElementById("leftInput").value = obj.l;
           if (typeof obj.r === "string") document.getElementById("rightInput").value = obj.r;
           render();
        } catch(e2) {
           console.log("Failed to load hash");
        }
      }
    }

    // ---------------- Controls ----------------
    document.getElementById("renderBtn").addEventListener("click", render);

    document.getElementById("swapBtn").addEventListener("click", () => {
      const l = document.getElementById("leftInput");
      const r = document.getElementById("rightInput");
      const tmp = l.value; l.value = r.value; r.value = tmp;
      render();
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
      document.getElementById("leftInput").value = "";
      document.getElementById("rightInput").value = "";
      document.getElementById("phoneOutput").style.display = "none";
      document.getElementById("columnsOutput").style.display = "none";
      document.getElementById("statusText").textContent = "Ready";
      document.getElementById("rangeChip").style.display = "none";
      document.getElementById("missingChip").style.display = "none";
      document.getElementById("leftCount").textContent = "—";
      document.getElementById("rightCount").textContent = "—";
      const nextUrl = location.origin + location.pathname;
      history.replaceState(null, "", nextUrl);
    });

    document.getElementById("demoBtn").addEventListener("click", () => {
      document.getElementById("leftInput").value =
`1. And it came to pass that Enoch continued his speech...
2. And from that time forth Enoch began to prophesy...
3. And it came to pass that I turned and went up on the mount...
4. And I saw the Lord; and he stood before my face...`;

      document.getElementById("rightInput").value =
`1. Enoch said: Adam taught people about God. Some listened, some did not.
2. Enoch said: God told me to go up a mountain.
3. Enoch went up the mountain and saw wonderful things.
4. Enoch saw God and talked with Him like a friend.`;

      render();
    });

    // auto-render after paste
    ["leftInput","rightInput"].forEach(id=>{
      document.getElementById(id).addEventListener("paste", () => {
        setTimeout(() => {
          const l = document.getElementById("leftInput").value.trim();
          const r = document.getElementById("rightInput").value.trim();
          if (l && r) render();
        }, 0);
      });
    });

    function loadFromSharedLink() {
      const params = new URLSearchParams(location.search);
      const queryValue = params.get("v");
      if (queryValue) {
        loadFromSharedValue(decodeURIComponent(queryValue));
        return;
      }

      const h = location.hash || "";
      const m = h.match(/#v=([\s\S]+)$/);
      if (m) loadFromSharedValue(m[1]);
    }

    // load shared link if present
    loadFromSharedLink();
  </script>
</body>
</html>
