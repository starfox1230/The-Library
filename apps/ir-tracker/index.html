<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consult Rounding Sheet</title>
  <style>
    /* === Reset & Layout === */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: #121212;
      color: #e0e0e0;
      font-family: sans-serif;
      padding: 1rem;
      padding-bottom: 5rem; /* Add padding for floating button */
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1rem;
    }
    #filter-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
        margin-bottom: 1rem;
        border-top: 1px solid #333;
        padding-top: 1rem;
    }
    button, .filter-btn {
      background: #1a1a2e;
      border: none;
      color: #e0e0e0;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.1s, background 0.2s, box-shadow 0.2s;
    }
    button:hover, .filter-btn:hover {
      background: #29295a;
      box-shadow: 0 4px 8px rgba(0,255,255,0.2);
      transform: scale(1.05);
    }
    button:active, .filter-btn:active { transform: scale(0.95); }

    /* === Rows & Collapsibles === */
    #rows { display: flex; flex-direction: column; gap: 1rem; }
    details.row {
      border: 1px solid #333;
      border-radius: 6px;
      overflow: hidden;
      transition: background-color 0.3s; /* For color coding */
    }
    summary.row-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 1rem;
      background: #1a1a2e; /* Default background */
      list-style: none;
      cursor: pointer;
      position: relative;
      transition: background 0.2s;
    }
    /* Custom arrow */
    summary.row-summary::-webkit-details-marker { display: none; }
    summary.row-summary::after {
      content: '‚ñ∏';
      font-size: 1.2rem;
      transition: transform 0.2s;
      margin-left: 0.5rem; /* Space between text and arrow */
    }
    details.row[open] summary.row-summary::after {
      transform: rotate(90deg);
    }
    details.row[open] summary.row-summary {
      background: #29295a; /* Slightly different background when open */
    }
    /* Status Color Coding */
    details.row.status-incomplete-order summary.row-summary { background-color: #5a1a1a; } /* Reddish if order needed */
    details.row.status-incomplete-note summary.row-summary { background-color: #5a5a1a; } /* Yellowish if note needed */
    details.row.status-complete summary.row-summary { background-color: #1a5a1a; } /* Greenish if all done */
    details.row[open].status-incomplete-order summary.row-summary { background-color: #7a2a2a; }
    details.row[open].status-incomplete-note summary.row-summary { background-color: #7a7a2a; }
    details.row[open].status-complete summary.row-summary { background-color: #2a7a2a; }


    .overview {
      font-weight: 500;
      flex-grow: 1;
      margin-right: 0.5rem; /* Space between text and delete btn */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
     .summary-status-icons {
        font-size: 0.8em;
        margin-right: 0.5rem;
        opacity: 0.8;
     }
    .delete-btn {
      background: transparent;
      border: none;
      color: #ff4d4d;
      font-size: 1.2rem;
      padding: 0 0.3rem; /* Easier touch target */
      margin-left: auto; /* Push delete button to the right */
      flex-shrink: 0; /* Prevent shrinking */
      transition: transform 0.1s;
    }
    .delete-btn:hover { transform: scale(1.2); }

    .row-content {
      background: #222240;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .row-content input,
    .row-content textarea {
      background: #121229;
      border: none;
      border-radius: 4px;
      padding: 0.7rem; /* Increased padding for touch */
      color: #e0e0e0;
      font-size: 0.9rem;
      transition: background 0.2s;
    }
    .row-content input:focus,
    .row-content textarea:focus {
      background: #29295a;
      outline: none;
    }
    .checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem 1rem; /* More horizontal gap */
    }
    .checkboxes label {
      display: flex;
      align-items: center;
      gap: 0.35rem; /* Slightly more gap */
      font-size: 0.9rem;
      padding: 0.3rem 0; /* Vertical padding for touch */
      cursor: pointer;
    }
    .checkboxes input[type="checkbox"] {
        width: 1.1em; /* Slightly larger checkbox */
        height: 1.1em;
    }
    .last-edited {
        font-size: 0.75rem;
        color: #aaa;
        text-align: right;
        margin-top: 0.5rem;
    }

    /* === Floating Add Button === */
    #addRow {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 1000;
      border-radius: 50%; /* Make it circular */
      width: 50px;
      height: 50px;
      font-size: 1.8rem; /* Larger '+' sign */
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }
    #addRow:hover {
        box-shadow: 0 6px 16px rgba(0,255,255,0.3);
    }

  </style>
</head>
<body>
  <div id="controls">
    <!-- Removed Add Row from here -->
    <!-- Combined Expand/Collapse Button -->
    <button id="toggleExpandCollapse">‚Æù Expand All</button>
    <button id="download">Download</button>
    <button id="uploadTrigger">Upload</button>
    <input type="file" id="fileInput" accept=".json" style="display:none;">
  </div>

  <!-- Filter Controls -->
  <div id="filter-controls">
    <button class="filter-btn" data-filter="all">Show All</button>
    <button class="filter-btn" data-filter="round">Needs Round</button>
    <button class="filter-btn" data-filter="consent">Needs Consent</button>
    <button class="filter-btn" data-filter="note">Needs Note</button>
    <button class="filter-btn" data-filter="order">Needs Order</button>
  </div>

  <div id="rows"></div>

  <!-- Floating Add Button -->
  <button id="addRow">+</button>

  <script>
    const STORAGE_KEY = 'roundingData';
    let saveDataTimeout; // For debouncing

    // --- Debounced Save Function ---
    function debouncedSaveData() {
      clearTimeout(saveDataTimeout);
      saveDataTimeout = setTimeout(saveData, 500); // Save after 500ms of inactivity
    }

    function saveData() {
      console.log("Saving data..."); // Log saving action
      const data = [];
      document.querySelectorAll('details.row').forEach(det => {
        const c = det.querySelector.bind(det);
        data.push({
          // Checkboxes
          round: c('[name="round"]').checked,
          consent: c('[name="consent"]').checked,
          note: c('[name="note"]').checked,
          order: c('[name="order"]').checked,
          // Text fields
          location: c('[name="location"]').value,
          name: c('[name="name"]').value,
          mrn: c('[name="mrn"]').value,
          procedure: c('[name="procedure"]').value,
          history: c('[name="history"]').value,
          labs: c('[name="labs"]').value,
          contactName: c('[name="contactName"]').value,
          contactPhone: c('[name="contactPhone"]').value,
          // Metadata
          lastEdited: det.dataset.lastEdited || new Date().toISOString(), // Store timestamp
          isOpen: det.open // Preserve open/closed state
        });
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    // --- Update Summary Text & Status ---
    function updateSummary(detailsElement) {
      const c = detailsElement.querySelector.bind(detailsElement);
      const location = c('[name="location"]').value || 'No Loc';
      const name = c('[name="name"]').value || 'No Name';
      const mrn = c('[name="mrn"]').value || 'No MRN';
      const overviewSpan = detailsElement.querySelector('.overview');
      const statusSpan = detailsElement.querySelector('.summary-status-icons');

      // Basic Info
      overviewSpan.textContent = `${location} | ${name} | ${mrn}`;

      // Status Icons (Example)
      const needsRound = !c('[name="round"]').checked;
      const needsConsent = !c('[name="consent"]').checked;
      const needsNote = !c('[name="note"]').checked;
      const needsOrder = !c('[name="order"]').checked;

      let icons = '';
      if (needsRound) icons += 'üö∂'; // Person walking = round
      if (needsConsent) icons += '‚úçÔ∏è'; // Pen = consent
      if (needsNote) icons += 'üìù'; // Memo = note
      if (needsOrder) icons += 'üõí'; // Cart = order (or use üíä pill, ‚öïÔ∏è staff)

      statusSpan.textContent = icons || '‚úÖ'; // Checkmark if all done

      // Update Color Coding Class
      detailsElement.classList.remove('status-incomplete-order', 'status-incomplete-note', 'status-complete');
      if (!needsOrder && !needsNote && !needsConsent && !needsRound) {
          detailsElement.classList.add('status-complete');
      } else if (needsOrder) {
           detailsElement.classList.add('status-incomplete-order');
      } else if (needsNote) {
           detailsElement.classList.add('status-incomplete-note');
      }
      // Update timestamp
      const timestamp = new Date().toISOString();
      detailsElement.dataset.lastEdited = timestamp;
      const timestampEl = detailsElement.querySelector('.last-edited');
      if (timestampEl) {
          timestampEl.textContent = `Last edit: ${new Date(timestamp).toLocaleString()}`;
      }
    }


    function createRow(data = {}) {
      const det = document.createElement('details');
      det.className = 'row';
      // Restore open state (respect saved state over default logic below)
      if (typeof data.isOpen === 'boolean') {
          det.open = data.isOpen;
      }

      // Set initial timestamp if available
      det.dataset.lastEdited = data.lastEdited || new Date().toISOString();

      // Build the summary
      const summ = document.createElement('summary');
      summ.className = 'row-summary';

      const statusIcons = document.createElement('span'); // Span for status icons
      statusIcons.className = 'summary-status-icons';
      summ.appendChild(statusIcons);

      const overview = document.createElement('span');
      overview.className = 'overview';
      // Initial text set by updateSummary later
      summ.appendChild(overview);

      // Delete button
      const del = document.createElement('button');
      del.className = 'delete-btn';
      del.textContent = '√ó';
      del.setAttribute('aria-label', 'Delete row');
      del.addEventListener('click', e => {
        e.preventDefault(); // Prevent details toggle
        e.stopPropagation();
        if (confirm('Are you sure you want to delete this row?')) {
            det.remove();
            debouncedSaveData(); // Save after deletion
        }
      });
      summ.appendChild(del);
      det.appendChild(summ);

      // Content panel
      const content = document.createElement('div');
      content.className = 'row-content';
      const lastEditedTimestamp = data.lastEdited ? new Date(data.lastEdited).toLocaleString() : 'Never';
      content.innerHTML = `
        <div class="checkboxes">
          <label><input type="checkbox" name="round" ${data.round?'checked':''}> Round</label>
          <label><input type="checkbox" name="consent" ${data.consent?'checked':''}> Consent</label>
          <label><input type="checkbox" name="note" ${data.note?'checked':''}> Note</label>
          <label><input type="checkbox" name="order" ${data.order?'checked':''}> Order</label>
        </div>
        <input type="text" name="location" placeholder="Location (e.g., Room 501)" value="${data.location||''}">
        <input type="text" name="name" placeholder="Patient Name" value="${data.name||''}">
        <input type="text" name="mrn" placeholder="MRN" value="${data.mrn||''}">
        <input type="text" name="procedure" placeholder="Procedure" value="${data.procedure||''}">
        <textarea name="history" rows="3" placeholder="History / Indication">${data.history||''}</textarea>
        <textarea name="labs" rows="3" placeholder="Relevant Labs / Meds / Vitals">${data.labs||''}</textarea>
        <input type="text" name="contactName" placeholder="Contact Name (e.g., Dr. Smith)" value="${data.contactName||''}">
        <input type="text" name="contactPhone" placeholder="Phone / Pager" value="${data.contactPhone||''}">
        <div class="last-edited">Last edit: ${lastEditedTimestamp}</div>
      `;
      det.appendChild(content);

      // Wire up input listeners for text/textarea
      content.querySelectorAll('input[type="text"], input[type="tel"], input[type="email"], textarea').forEach(el => {
        el.addEventListener('input', () => {
          updateSummary(det);
          debouncedSaveData();
        });
      });
      // Wire up listeners for checkboxes
       content.querySelectorAll('input[type="checkbox"]').forEach(el => {
        el.addEventListener('change', () => {
            updateSummary(det);
            debouncedSaveData();
        });
       });

       // Listener for details toggle to save state
       det.addEventListener('toggle', () => {
           // Only save if it was toggled by user interaction (not initial load)
           if (document.readyState === 'complete') { // Avoid saving during initial load potentially
               debouncedSaveData();
           }
       });


      // Set initial summary text and status color
      updateSummary(det);

      document.getElementById('rows').appendChild(det);
    }

    function loadData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      const rowsContainer = document.getElementById('rows');
      rowsContainer.innerHTML = ''; // Clear existing rows before loading

      let data = [];

      if (raw) {
        try {
          data = JSON.parse(raw);
          if (!Array.isArray(data)) {
              console.error("Stored data is not an array.");
              data = []; // Reset if format is wrong
          }
        } catch (e) {
            console.error("Error parsing stored data:", e);
            data = []; // Reset on error
        }
      }

      if (data.length > 0) {
          data.forEach(item => createRow(item));
      } else {
        // Default: Add ONE empty row if storage is empty
        createRow(); // << CHANGED: Only create one row by default
        // Optionally open the default row:
        // const firstRow = rowsContainer.firstChild;
        // if (firstRow) {
        //     firstRow.open = true;
        // }
      }

      // After loading, set the initial state of the toggle button
      updateToggleExpandCollapseButtonState();
    }

    // --- Filter Function ---
    function filterRows(filterType) {
        console.log("Filtering by:", filterType);
        document.querySelectorAll('details.row').forEach(det => {
            if (filterType === 'all') {
                det.style.display = ''; // Show all
            } else {
                // Check if the specific task is *not* checked
                const checkbox = det.querySelector(`[name="${filterType}"]`);
                if (checkbox && !checkbox.checked) {
                    det.style.display = ''; // Show if task is needed
                } else {
                    det.style.display = 'none'; // Hide otherwise
                }
            }
        });
        // Highlight active filter button (optional visual feedback)
        document.querySelectorAll('#filter-controls .filter-btn').forEach(btn => {
            btn.style.fontWeight = (btn.dataset.filter === filterType) ? 'bold' : 'normal';
            btn.style.boxShadow = (btn.dataset.filter === filterType) ? '0 0 5px rgba(0,255,255,0.4)' : 'none';
        });
         // Update expand/collapse button state after filtering as visibility changes
         updateToggleExpandCollapseButtonState();
    }

    // --- Update Toggle Button State ---
    function updateToggleExpandCollapseButtonState() {
        const toggleBtn = document.getElementById('toggleExpandCollapse');
        const allDetails = document.querySelectorAll('details.row');
        const visibleDetails = document.querySelectorAll('details.row:not([style*="display: none"])'); // Select only visible rows

        if (visibleDetails.length === 0) {
            // No visible rows, maybe default to Expand or disable
            toggleBtn.textContent = '‚Æù Expand All';
            toggleBtn.disabled = true; // Disable if no rows shown
            return;
        } else {
             toggleBtn.disabled = false;
        }

        // Check if ANY visible detail is collapsed
        let anyCollapsed = false;
        visibleDetails.forEach(d => {
            if (!d.open) {
                anyCollapsed = true;
            }
        });

        // If any are collapsed, the next action is to expand
        if (anyCollapsed) {
            toggleBtn.textContent = '‚Æù Expand All';
        } else {
            // If all visible details are already expanded, the next action is to collapse
            toggleBtn.textContent = '‚Æü Collapse All';
        }
    }


    // --- Controls Event Listeners ---
    document.getElementById('addRow').onclick = () => {
        createRow();
        const newRow = document.getElementById('rows').lastChild;
        if(newRow) {
            newRow.open = true; // Open the new row by default
            newRow.querySelector('input[name="location"]').focus(); // Focus first field
        }
        updateToggleExpandCollapseButtonState(); // Update button state after adding
        debouncedSaveData(); // Save after adding
    };

    // NEW: Combined Expand/Collapse Button Handler
    document.getElementById('toggleExpandCollapse').onclick = () => {
      const toggleBtn = document.getElementById('toggleExpandCollapse');
      const allDetails = document.querySelectorAll('details.row');
      if (allDetails.length === 0) return; // No rows to toggle

      // Determine action based on current button text
      const shouldExpand = toggleBtn.textContent.includes('Expand');

      allDetails.forEach(d => {
        // Note: We are expanding/collapsing ALL rows, regardless of filter.
        // If you only wanted to affect VISIBLE rows, you'd iterate over `visibleDetails` from the update function.
        d.open = shouldExpand;
      });

      // Update button text for the *next* action
      if (shouldExpand) {
        toggleBtn.textContent = '‚Æü Collapse All';
      } else {
        toggleBtn.textContent = '‚Æù Expand All';
      }

      debouncedSaveData(); // Save the new open/closed states
    };

    // REMOVED old expand/collapse listeners
    // document.getElementById('expandAll').onclick = ...
    // document.getElementById('collapseAll').onclick = ...

    document.getElementById('download').onclick = () => {
      // Ensure latest data is captured before download
      saveData(); // Use immediate save here, not debounced
      const data = localStorage.getItem(STORAGE_KEY) || '[]';
      const blob = new Blob([data], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const timestamp = new Date().toISOString().slice(0, 16).replace(/[:T]/g, '-');
      a.download = `roundingData-${timestamp}.json`;
      a.click();
      URL.revokeObjectURL(a.href); // Clean up
    };
    document.getElementById('uploadTrigger').onclick = () =>
      document.getElementById('fileInput').click();

    document.getElementById('fileInput').onchange = e => {
      const f = e.target.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onload = ev => {
        try {
          const arr = JSON.parse(ev.target.result);
          if (Array.isArray(arr)) {
            // Basic validation of first item structure (optional)
            if (arr.length > 0 && typeof arr[0].name === 'undefined' && typeof arr[0].mrn === 'undefined') {
                 if (!confirm("File structure might be different. Proceed with loading?")) {
                     e.target.value = null; // Reset file input if user cancels
                     return;
                 }
            }
            localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
            loadData(); // Reload the UI with new data
            filterRows('all'); // Reset filter after upload
            updateToggleExpandCollapseButtonState(); // Update button state after load
          } else {
              alert('Upload failed: Invalid format (must be a JSON array).');
            }
        } catch(err) {
          alert('Error reading or parsing file: ' + err.message);
        } finally {
            // Reset file input to allow uploading the same file again only if successful load didn't happen
            if (e.target.value) { // Check if it wasn't reset earlier
                 e.target.value = null;
            }
        }
      };
      r.onerror = () => {
          alert('Error reading file.');
           e.target.value = null;
      }
      r.readAsText(f);
    };

    // --- Filter Button Listeners ---
    document.querySelectorAll('#filter-controls .filter-btn').forEach(button => {
        button.addEventListener('click', () => {
            filterRows(button.dataset.filter);
            // updateToggleExpandCollapseButtonState(); // Already called within filterRows
        });
    });


    // --- Init ---
    loadData();
    filterRows('all'); // Apply default 'Show All' filter state on load
    // updateToggleExpandCollapseButtonState(); // Already called within loadData and filterRows
  </script>
</body>
</html>
