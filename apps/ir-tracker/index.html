<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Consult Rounding Sheet</title>

  <!-- jQuery + tristate plugin -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://unpkg.com/tristate@1.2.1/jquery.tristate.js"></script>
  <!-- SortableJS for drag-and-drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>

  <style>
    * { box-sizing: border-box; margin:0; padding:0 }
    body {
      background:#121212; color:#e0e0e0; font-family:sans-serif;
      padding:1rem 1rem 5rem;
    }

    /* Remove that focus/glow on buttons */
    button:focus, .filter-btn:focus {
      outline: none;
      box-shadow: none;
    }

    /* Controls bar */
    #controls {
      display:flex; flex-wrap:wrap; gap:.5rem;
      justify-content:center; margin-bottom:1rem;
    }
    button, .filter-btn {
      background:#1a1a2e; border:none; color:#e0e0e0;
      padding:.6rem 1.2rem; border-radius:6px; font-size:1rem;
      cursor:pointer; transition:transform .1s,background .2s,box-shadow .2s;
    }
    button:hover, .filter-btn:hover {
      background:#29295a; box-shadow:0 4px 8px rgba(0,255,255,.2);
      transform:scale(1.05);
    }
    button:active, .filter-btn:active { transform:scale(.95) }

    /* Filter dropdown */
    .filter-dropdown { position:relative; }
    #filterBtn.active-filter {
      background:#3366ff; color:#fff;
    }
    .filter-menu {
      position:absolute; top:100%; left:0; background:#1a1a2e;
      border:1px solid #333; list-style:none; margin:0; padding:0;
      z-index:100; display:none; min-width:140px;
    }
    .filter-dropdown.open .filter-menu { display:block; }
    .filter-menu li {
      padding:.6rem 1rem; cursor:pointer; white-space:nowrap;
    }
    .filter-menu li:hover { background:#29295a; }

    /* Reorder button states */
    #toggleReorder.editing {
      background:#ffcc00; color:#121212;
    }
    #toggleReorder.locked {
      background:#33aa33; color:#fff;
    }

    /* Rows & summaries */
    #rows { display:flex; flex-direction:column; gap:1rem; }
    details.row {
      border:1px solid #333; border-radius:6px;
      overflow:hidden; transition:background-color .3s;
    }
    summary.row-summary {
      display:flex; flex-direction:column;
      padding:.8rem 1rem; cursor:pointer; transition:background .2s;
    }
    summary.row-summary::-webkit-details-marker { display:none; }

    .summary-top {
      display:flex; align-items:center;
    }
    .overview {
      flex-grow:1; margin:0 .5rem; font-weight:500;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .summary-status-icons { font-size:.9em; opacity:.8; }
    .delete-btn {
      background:transparent; border:none; color:#ff4d4d;
      font-size:1.2rem; padding:0 .3rem; margin-left:auto;
      transition:transform .1s;
    }
    .delete-btn:hover { transform:scale(1.2); }

    .summary-bottom {
      margin-top:.25rem; font-size:.9rem; color:#ccc;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    details.row[open] > summary .summary-bottom {
      display:none;
    }

    /* Status colors */
    details.row.status-incomplete-order summary.row-summary {
      background:#5a1a1a;
    }
    details.row[open].status-incomplete-order summary.row-summary {
      background:#7a2a2a;
    }
    details.row.status-complete summary.row-summary {
      background:#1a5a1a;
    }
    details.row[open].status-complete summary.row-summary {
      background:#2a7a2a;
    }
    details.row.status-complete-na summary.row-summary {
      background:#555 !important;
    }
    details.row[open].status-complete-na summary.row-summary {
      background:#777 !important;
    }

    /* Row content */
    .row-content {
      background:#222240; padding:1rem;
      display:flex; flex-direction:column; gap:.75rem;
    }
    .row-content input, .row-content textarea {
      background:#121229; border:none; border-radius:4px;
      padding:.7rem; color:#e0e0e0; font-size:.9rem;
      transition:background .2s;
    }
    .row-content input:focus, .row-content textarea:focus {
      background:#29295a; outline:none;
    }
    .checkboxes {
      display:flex; flex-wrap:wrap; gap:.5rem 1rem;
    }
    .checkboxes label {
      display:flex; align-items:center; gap:.35rem;
      font-size:.9rem; cursor:pointer;
    }
    .checkboxes input[type="checkbox"] {
      width:1.1em; height:1.1em;
    }
    .last-edited {
      font-size:.75rem; color:#aaa; text-align:right; margin-top:.5rem;
    }

    /* Add button */
    #addRow {
      position:fixed; bottom:1.5rem; right:1.5rem; z-index:1000;
      border-radius:50%; width:50px; height:50px; font-size:1.8rem;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 4px 12px rgba(0,0,0,.4);
    }
    #addRow:hover {
      box-shadow:0 6px 16px rgba(0,255,255,.3);
    }
  </style>
</head>
<body>
  <div id="controls">
    <button id="toggleExpandCollapse">‚Æù Expand All</button>

    <div class="filter-dropdown">
      <button id="filterBtn">Filter: Show All</button>
      <ul id="filterMenu" class="filter-menu">
        <li data-filter="all">Show All</li>
        <li data-filter="round">Needs Round</li>
        <li data-filter="consent">Needs Consent</li>
        <li data-filter="note">Needs Note</li>
        <li data-filter="order">Needs Order</li>
      </ul>
    </div>

    <button id="toggleReorder">üîÄ Reorder</button>
    <button id="download">Download</button>
    <button id="uploadTrigger">Upload</button>
    <input type="file" id="fileInput" accept=".json" style="display:none;">
  </div>

  <div id="rows"></div>
  <button id="addRow">+</button>

  <script>
    const STORAGE_KEY = 'roundingData';
    let originalItems = [], reorderState = 0, customOrder = null, sortableInstance = null;
    let currentFilter='all', saveTimeout;

    function makeID() {
      return crypto?.randomUUID?.() || 'id-'+Date.now()+'-'+Math.random().toString(36).slice(2);
    }

    function saveAll() {
      originalItems = originalItems.map(item=>{
        const det=document.querySelector(`details.row[data-id="${item.id}"]`);
        if(!det) return item;
        const q=sel=>det.querySelector(sel);
        return {
          ...item,
          round: q('[name="round"]').indeterminate?null:q('[name="round"]').checked,
          consent: q('[name="consent"]').indeterminate?null:q('[name="consent"]').checked,
          note: q('[name="note"]').indeterminate?null:q('[name="note"]').checked,
          order: q('[name="order"]').indeterminate?null:q('[name="order"]').checked,
          location: q('[name="location"]').value,
          name: q('[name="name"]').value,
          mrn: q('[name="mrn"]').value,
          procedure: q('[name="procedure"]').value,
          history: q('[name="history"]').value,
          labs: q('[name="labs"]').value,
          contactName: q('[name="contactName"]').value,
          contactPhone: q('[name="contactPhone"]').value,
          lastEdited: det.dataset.lastEdited,
          isOpen: det.open
        };
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        items: originalItems,
        customOrder,
        reorderState
      }));
    }
    function debouncedSave(){
      clearTimeout(saveTimeout);
      saveTimeout=setTimeout(saveAll,500);
    }

    function updateSummary(det) {
      const q=sel=>det.querySelector(sel);
      const loc=q('[name="location"]').value||'No Loc';
      const nm=q('[name="name"]').value||'No Name';
      const idNo=q('[name="mrn"]').value||'No MRN';
      det.querySelector('.overview').textContent=`${loc} | ${nm} | ${idNo}`;

      const keys=['round','consent','note','order'];
      const hasFalse=keys.some(k=>{
        const cb=q(`[name="${k}"]`);
        return cb.checked===false&&cb.indeterminate===false;
      });

      let ico='';
      if(!hasFalse) ico='‚úÖ';
      else {
        if(q('[name="round"]').checked===false&&q('[name="round"]').indeterminate===false) ico+='üö∂';
        if(q('[name="consent"]').checked===false&&q('[name="consent"]').indeterminate===false) ico+='‚úçÔ∏è';
        if(q('[name="note"]').checked===false&&q('[name="note"]').indeterminate===false) ico+='üìù';
        if(q('[name="order"]').checked===false&&q('[name="order"]').indeterminate===false) ico+='üõí';
      }
      det.querySelector('.summary-status-icons').textContent=ico;

      const proc=q('[name="procedure"]').value||'No Procedure';
      const hist=q('[name="history"]').value||'';
      det.querySelector('.summary-bottom').textContent=`${proc} ‚Äì ${hist}`;

      det.classList.remove('status-incomplete-order','status-complete','status-complete-na');
      if(hasFalse) det.classList.add('status-incomplete-order');
      else {
        if(q('[name="order"]').checked===true) det.classList.add('status-complete');
        else det.classList.add('status-complete-na');
      }

      const ts=new Date().toISOString();
      det.dataset.lastEdited=ts;
      det.querySelector('.last-edited').textContent=`Last edit: ${new Date(ts).toLocaleString()}`;
    }

    function createRow(data={}) {
      const det=document.createElement('details');
      det.className='row';
      det.dataset.id=data.id||makeID();
      if(data.isOpen) det.open=true;
      det.dataset.lastEdited=data.lastEdited||new Date().toISOString();

      const summ=document.createElement('summary');
      summ.className='row-summary';
      summ.innerHTML=`
        <div class="summary-top">
          <span class="summary-status-icons"></span>
          <span class="overview"></span>
          <button class="delete-btn" aria-label="Delete row">√ó</button>
        </div>
        <div class="summary-bottom"></div>
      `;
      summ.querySelector('.delete-btn').addEventListener('click',e=>{
        e.preventDefault(); e.stopPropagation();
        if(confirm('Delete this row?')){
          det.remove(); debouncedSave();
        }
      });
      det.appendChild(summ);

      const content=document.createElement('div');
      content.className='row-content';
      const tsDisp=data.lastEdited
        ? new Date(data.lastEdited).toLocaleString():'Never';
      content.innerHTML=`
        <div class="checkboxes">
          <label><input type="checkbox" name="round"> Round</label>
          <label><input type="checkbox" name="consent"> Consent</label>
          <label><input type="checkbox" name="note"> Note</label>
          <label><input type="checkbox" name="order"> Order</label>
        </div>
        <input type="text" name="location" placeholder="Location (e.g., Room 501)" value="${data.location||''}">
        <input type="text" name="name"     placeholder="Patient Name"                    value="${data.name||''}">
        <input type="text" name="mrn"      placeholder="MRN"                             value="${data.mrn||''}">
        <input type="text" name="procedure"placeholder="Procedure"                       value="${data.procedure||''}">
        <textarea name="history" rows="3"  placeholder="History / Indication">${data.history||''}</textarea>
        <textarea name="labs"    rows="3"  placeholder="Relevant Labs / Meds / Vitals">${data.labs||''}</textarea>
        <input type="text" name="contactName" placeholder="Contact Name (e.g., Dr. Smith)" value="${data.contactName||''}">
        <input type="text" name="contactPhone"placeholder="Phone / Pager"                value="${data.contactPhone||''}">
        <div class="last-edited">Last edit: ${tsDisp}</div>
      `;
      det.appendChild(content);

      $(content).find('input[type="checkbox"]').each((_,cb)=>{
        $(cb).tristate();
        cb.checked=data[cb.name]===true;
        cb.indeterminate=data[cb.name]===null;
        cb.addEventListener('change',()=>{
          updateSummary(det); debouncedSave();
        });
      });

      content.querySelectorAll('input[type="text"],textarea')
        .forEach(el=>el.addEventListener('input',()=>{
          updateSummary(det); debouncedSave();
        }));

      det.addEventListener('toggle',()=>{
        if(document.readyState==='complete') debouncedSave();
      });

      updateSummary(det);
      document.getElementById('rows').appendChild(det);
    }

    function enableSort(){
      sortableInstance=Sortable.create(document.getElementById('rows'),{
        animation:150,
        onEnd:()=>{
          customOrder=Array.from(document.getElementById('rows').children)
                            .map(d=>d.dataset.id);
          saveAll();
        }
      });
    }
    function disableSort(){
      if(sortableInstance){ sortableInstance.destroy(); sortableInstance=null; }
    }
    function applyOrder(){
      const container=document.getElementById('rows');
      const ids=(reorderState>0 && customOrder) 
        ? customOrder 
        : originalItems.map(i=>i.id);
      ids.forEach(id=>{
        const d=container.querySelector(`details.row[data-id="${id}"]`);
        if(d) container.appendChild(d);
      });
    }

    document.getElementById('toggleExpandCollapse').onclick=()=>{
      const anyClosed=Array.from(document.querySelectorAll('details.row'))
        .some(d=>!d.open);
      document.querySelectorAll('details.row')
        .forEach(d=>d.open=anyClosed);
      document.getElementById('toggleExpandCollapse').textContent=
        anyClosed?'‚Æü Collapse All':'‚Æù Expand All';
      saveAll();
    };

    document.getElementById('toggleReorder').onclick=()=>{
      // cycle 0‚Üí1‚Üí2‚Üí0
      reorderState=(reorderState+1)%3;
      const btn=document.getElementById('toggleReorder');
      btn.classList.toggle('editing', reorderState===1);
      btn.classList.toggle('locked',  reorderState===2);
      if(reorderState===1) enableSort(); else disableSort();
      applyOrder();
      saveAll();
    };

    const filterBtn=document.getElementById('filterBtn');
    const dropdown=filterBtn.parentElement;
    filterBtn.onclick=e=>{
      e.stopPropagation();
      dropdown.classList.toggle('open');
    };
    document.addEventListener('click',e=>{
      if(!dropdown.contains(e.target)) dropdown.classList.remove('open');
    });
    document.querySelectorAll('#filterMenu li').forEach(li=>{
      li.onclick=()=>{
        currentFilter=li.dataset.filter;
        filterRows(currentFilter);
        dropdown.classList.remove('open');
        filterBtn.textContent='Filter: '+li.textContent;
        filterBtn.classList.toggle('active-filter',currentFilter!=='all');
      };
    });

    function filterRows(type){
      document.querySelectorAll('details.row').forEach(det=>{
        if(type==='all') det.style.display=''; 
        else {
          const cb=det.querySelector(`[name="${type}"]`);
          det.style.display=
            (cb && cb.checked===false && cb.indeterminate===false)?'':'none';
        }
      });
      saveAll();
      const visible=Array.from(document.querySelectorAll('details.row'))
        .filter(d=>d.style.display==='');
      const anyClosed=visible.some(d=>!d.open);
      const btn=document.getElementById('toggleExpandCollapse');
      btn.disabled=!visible.length;
      btn.textContent=anyClosed?'‚Æù Expand All':'‚Æü Collapse All';
    }

    document.getElementById('download').onclick=()=>{
      saveAll();
      const blob=new Blob([localStorage.getItem(STORAGE_KEY)||'{}'],
                          {type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`roundingData-${new Date().toISOString().slice(0,16).replace(/[:T]/g,'-')}.json`;
      a.click(); URL.revokeObjectURL(a.href);
    };
    document.getElementById('uploadTrigger').onclick=()=>document.getElementById('fileInput').click();
    document.getElementById('fileInput').onchange=e=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=ev=>{
        try{
          const p=JSON.parse(ev.target.result);
          localStorage.setItem(STORAGE_KEY,JSON.stringify(p));
          init();
        }catch(err){ alert('Upload error: '+err.message) }
        finally{ e.target.value='' }
      };
      r.readAsText(f);
    };

    document.getElementById('addRow').onclick=()=>{
      const newItem={ id:makeID() };
      originalItems.push(newItem);
      createRow(newItem);
      applyOrder();
      const det=document.querySelector(`details.row[data-id="${newItem.id}"]`);
      det.open=true; det.querySelector('[name="location"]').focus();
      debouncedSave();
    };

    function init(){
      let saved=localStorage.getItem(STORAGE_KEY), obj;
      try{ obj=JSON.parse(saved) }catch{ obj=null }
      if(obj && Array.isArray(obj.items)){
        originalItems=obj.items;
        customOrder=obj.customOrder||null;
        reorderState=obj.reorderState||0;
      } else {
        originalItems=obj||[];
        originalItems.forEach(i=>i.id=i.id||makeID());
        customOrder=null; reorderState=0;
      }
      document.getElementById('rows').innerHTML='';
      if(originalItems.length){
        originalItems.forEach(i=>createRow(i));
      } else {
        createRow({});
        originalItems=[{id:document.querySelector('details.row').dataset.id}];
      }
      const btn=document.getElementById('toggleReorder');
      btn.classList.toggle('editing',reorderState===1);
      btn.classList.toggle('locked', reorderState===2);
      if(reorderState===1) enableSort(); else disableSort();
      applyOrder();
      filterRows(currentFilter);
    }

    init();
  </script>
</body>
</html>