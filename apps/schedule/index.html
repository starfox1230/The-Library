<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Rotation Scheduler (Calendar Grid)</title>
  <style>
    :root{
      --bg:#0b1020;
      /* Default dark card (Week 1, 3) */
      --panel:rgba(255,255,255,.05);
      
      /* Lighter card for alternating weeks (Week 2, 4) */
      --panel-even: rgba(255,255,255,.11);
      
      --border:rgba(255,255,255,.10);
      --text:#eef3ff;
      --muted:rgba(255,255,255,.72);

      --ir:    rgba(37, 99, 235, .42);
      --ir-b:  rgba(37, 99, 235, .85);

      --flu:   rgba(21, 128, 61, .42);
      --flu-b: rgba(21, 128, 61, .85);

      --msk:   rgba(109, 40, 217, .42);
      --msk-b: rgba(109, 40, 217, .85);

      --us:    rgba(180, 83, 9, .42);
      --us-b:  rgba(180, 83, 9, .85);

      --float: rgba(3, 105, 161, .42);
      --float-b: rgba(3, 105, 161, .85);

      --danger: rgba(239, 68, 68, .90);
      --danger2: rgba(239, 68, 68, .22);

      --ok: rgba(34,197,94,.86);

      --chip: rgba(0,0,0,.22);
      --chip-b: rgba(255,255,255,.10);

      --shadow: 0 14px 40px rgba(0,0,0,.30);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 650px at 15% 10%, rgba(37,99,235,.16), transparent 60%),
        radial-gradient(850px 600px at 85% 0%, rgba(109,40,217,.14), transparent 55%),
        radial-gradient(900px 650px at 70% 90%, rgba(21,128,61,.12), transparent 55%),
        linear-gradient(180deg, #070a16, var(--bg));
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .wrap{
      width: 100%;
      padding: 14px 12px 18px;
    }

    .top{
      border:1px solid var(--border);
      border-radius:18px;
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow);
      overflow:hidden;
      margin-bottom: 20px;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .topHead{
      padding: 12px 12px 10px;
      border-bottom:1px solid var(--border);
      background: rgba(0,0,0,.18);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .title .h1{
      font-weight: 950;
      font-size: 15px;
      letter-spacing:.2px;
    }
    .title .sub{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      max-width: 46rem;
    }

    .btnRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
    }

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      font-size: 12px;
      padding: 9px 10px;
      border-radius: 12px;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ background: rgba(255,255,255,.06); }
    .btn.danger{ border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.12); }
    .btn.toggled{
      border-color: rgba(34,197,94,.35);
      background: rgba(34,197,94,.14);
    }

    .statsWrap{
      padding: 10px 12px 12px;
      display:grid;
      gap:10px;
    }

    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:7px;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      font-size: 12px;
      color: rgba(255,255,255,.86);
      user-select:none;
      white-space:nowrap;
    }
    .swatch{ width:12px; height:12px; border-radius:999px; box-shadow:0 0 0 3px rgba(255,255,255,.06); }

    .statsCard{
      border:1px solid var(--border);
      background: rgba(0,0,0,.14);
      border-radius: 16px;
      overflow:hidden;
    }
    .statsHead{
      padding: 10px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .statsHead .label{
      font-weight: 950;
      font-size: 12px;
      letter-spacing: .8px;
      text-transform: uppercase;
      color: rgba(255,255,255,.86);
    }
    .statsHead .hint{
      font-size: 11px;
      color: var(--muted);
      font-weight: 800;
      text-align:right;
      line-height:1.3;
    }
    .tableWrap{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      max-height: 25vh;
    }
    table{ width:100%; border-collapse:collapse; min-width: 820px; }
    th, td{
      padding: 9px 9px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 12px;
      text-align:right;
      vertical-align:top;
    }
    th{
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .8px;
      color: rgba(255,255,255,.72);
      font-weight: 950;
      background: rgba(0,0,0,.10);
      white-space:nowrap;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    td.name, th.name{ text-align:left; font-weight:950; white-space:nowrap; }
    td.absDates{
      text-align:left;
      color: rgba(255,255,255,.78);
      font-weight: 800;
      font-size: 11px;
      line-height: 1.35;
      min-width: 320px;
      white-space: normal;
    }

    /* GRID SCROLL CONTAINER */
    .gridScroll {
      overflow-x: auto;
      padding-bottom: 20px;
      -webkit-overflow-scrolling: touch;
    }

    /* THE GRID ITSELF */
    .main{
      display:grid;
      /* 5 Columns (Mon-Fri) */
      grid-template-columns: repeat(5, 1fr);
      /* Increased row-gap to help separate weeks */
      row-gap: 24px;
      column-gap: 12px;
      min-width: 1500px; 
    }

    /* COLUMN HEADERS */
    .colHead {
      text-align: center;
      font-weight: 950;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      padding-bottom: 6px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 4px;
    }

    /* DAY CARDS */
    .dayCard{
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
    }
    
    /* DEFAULT (Odd Weeks): Darker */
    .dayCard.oddWeek {
      background: var(--panel);
    }
    
    /* ALTERNATE (Even Weeks): Lighter/Tinted */
    .dayCard.evenWeek {
      background: var(--panel-even);
      border-color: rgba(255,255,255,.16);
    }

    .dayCard.issue{
      outline: 3px solid var(--danger);
      outline-offset: -1px;
      box-shadow: 0 18px 65px rgba(239,68,68,.10);
    }

    /* Week Label (Only on Mondays) */
    .weekLabel {
      position: absolute;
      top: 0;
      left: 0;
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      font-size: 10px;
      font-weight: 900;
      padding: 2px 6px;
      border-bottom-right-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      z-index: 2;
    }
    .dayCard.evenWeek .weekLabel {
      background: rgba(255,255,255,0.2);
      color: #fff;
    }

    .dayTop{
      padding: 8px 10px;
      padding-top: 14px; /* Space for week label on Mon */
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .dateBlock .md{ font-size: 13px; color: var(--text); font-weight: 900; }

    .badges{ display:flex; gap:4px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }

    .badge{
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size: 10px;
      font-weight: 950;
      letter-spacing: .2px;
      white-space:nowrap;
    }
    .badge.closed{ border-color: rgba(148,163,184,.40); background: rgba(148,163,184,.12); }
    .badge.issue{ border-color: rgba(239,68,68,.55); background: rgba(239,68,68,.12); }
    .badge.ok{ border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.10); }
    .badge.linked{ border-color: rgba(255,255,255,.18); background: rgba(0,0,0,.20); cursor:pointer; user-select:none; }
    .badge.locked{ border-color: rgba(148,163,184,.35); background: rgba(148,163,184,.10); }

    .dayBody{
      padding: 8px;
      display:grid;
      gap: 8px;
      flex: 1;
    }

    .half{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
      border-radius: 8px;
      overflow:hidden;
    }
    .halfHead{
      padding: 6px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 5px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .halfHead .label{
      font-weight: 950;
      font-size: 11px;
      letter-spacing: .5px;
      text-transform: uppercase;
      color: rgba(255,255,255,.86);
    }
    .halfHead .abs{
      font-size: 10px;
      font-weight: 850;
      color: var(--muted);
      text-align:right;
      line-height: 1.1;
      max-width: 120px;
    }

    .roles{
      padding: 6px;
      display:grid;
      gap: 5px;
    }

    .roleRow{
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .roleRow.missing{
      outline: 2px solid var(--danger);
      outline-offset: 1px;
      background: var(--danger2);
    }

    .roleBar{
      padding: 4px 6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 4px;
      font-weight: 950;
      letter-spacing: .5px;
      text-transform: uppercase;
      font-size: 10px;
    }
    .roleBar .right{
      display:flex;
      gap:4px;
      align-items:center;
    }

    .miniBtn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.92);
      font-weight: 950;
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 6px;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }

    .slot{
      padding: 4px;
      background: rgba(0,0,0,.12);
      display:flex;
      flex-wrap:wrap;
      gap: 4px;
      min-height: 38px;
    }
    .slot.dropTarget{
      outline: 2px dashed rgba(255,255,255,.35);
      outline-offset: -2px;
      background: rgba(255,255,255,.06);
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid var(--chip-b);
      background: var(--chip);
      color: rgba(255,255,255,.94);
      font-weight: 950;
      font-size: 11px;
      letter-spacing: .2px;
      user-select:none;
      cursor: grab;
      touch-action: none;
    }
    .chip:active{ cursor:grabbing; }

    .chip.selected{
      outline: 2px solid rgba(255,255,255,.55);
      outline-offset: 1px;
      background: rgba(255,255,255,.10);
    }

    .chip.disabled{
      opacity: .38;
      cursor: not-allowed;
      text-decoration: line-through;
    }

    .xbtn{
      appearance:none;
      border:none;
      background: rgba(255,255,255,.08);
      color: rgba(255,255,255,.92);
      width: 16px;
      height: 16px;
      border-radius: 999px;
      font-weight: 950;
      font-size: 10px;
      line-height: 16px;
      text-align:center;
      cursor:pointer;
      touch-action: manipulation;
    }

    .hintBar{
      margin-top: 8px;
      padding: 10px 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      border-radius: 16px;
      color: rgba(255,255,255,.78);
      font-size: 12px;
      line-height: 1.35;
    }
    .hintBar b{ color: rgba(255,255,255,.90); }

    .sheetBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 12px 12px calc(12px + env(safe-area-inset-bottom));
      z-index: 50;
    }
    .sheetBackdrop.show{ display:flex; }

    .sheet{
      width: min(860px, 100%);
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(10,14,28,.94);
      backdrop-filter: blur(10px);
      border-radius: 18px;
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .sheetHead{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .sheetHead .t{
      font-weight: 950;
      font-size: 13px;
      letter-spacing:.2px;
    }
    .sheetHead .s{
      margin-top: 3px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 850;
      line-height:1.35;
    }
    .sheetBody{
      padding: 12px 12px 14px;
      display:grid;
      gap: 10px;
    }
    .peopleGrid{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
    }
    .sheetFoot{
      padding: 10px 12px 12px;
      border-top: 1px solid rgba(255,255,255,.12);
      display:flex;
      gap:8px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(14px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 12px;
      font-weight: 900;
      letter-spacing:.2px;
      z-index: 90;
      display:none;
      max-width: 92vw;
      text-align:center;
    }
    .toast.show{ display:block; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="topHead">
        <div class="title">
          <div class="h1">Rotation Scheduler</div>
          <div class="sub">
            <b>View:</b> 5-Day Calendar Grid (Scroll horizontally).<br>
            Alternating bands and "Week" labels indicate weekly blocks.
          </div>
        </div>
        <div class="btnRow">
          <button class="btn toggled" id="lockBtn" type="button">Defaults: ON</button>
          <button class="btn" id="copyBtn" type="button">Mode: Move</button>
          <button class="btn secondary" id="exportBtn" type="button">Export</button>
          <button class="btn secondary" id="importBtn" type="button">Import</button>
          <button class="btn secondary" id="resetBtn" type="button">Reset</button>
          <button class="btn danger" id="clearBtn" type="button">Clear all</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </div>
      </div>

      <div class="statsWrap">
        <div class="legend">
          <span class="tag"><span class="swatch" style="background:var(--ir);border:1px solid var(--ir-b)"></span> IR</span>
          <span class="tag"><span class="swatch" style="background:var(--flu);border:1px solid var(--flu-b)"></span> Fluoro</span>
          <span class="tag"><span class="swatch" style="background:var(--msk);border:1px solid var(--msk-b)"></span> MSK</span>
          <span class="tag"><span class="swatch" style="background:var(--us);border:1px solid var(--us-b)"></span> US</span>
          <span class="tag"><span class="swatch" style="background:var(--float);border:1px solid var(--float-b)"></span> Float</span>
          <span class="tag"><span class="swatch" style="background:rgba(239,68,68,.45);border:1px solid rgba(239,68,68,.80)"></span> Coverage issue</span>
        </div>

        <div class="statsCard">
          <div class="statsHead">
            <div class="label">Totals by person</div>
            <div class="hint">Days (a.m./p.m. = 0.5) • Absence excludes Closed days</div>
          </div>
          <div class="tableWrap" id="stats"></div>
        </div>

        <div class="hintBar" id="pickHint">
          <b>Selected:</b> none • <b>Mode:</b> Move • Tap a role slot to place.
        </div>
      </div>
    </div>

    <!-- Calendar Grid Wrap -->
    <div class="gridScroll">
      <div class="main" id="days"></div>
    </div>
  </div>

  <!-- Picker sheet -->
  <div class="sheetBackdrop" id="sheetBackdrop" role="dialog" aria-modal="true">
    <div class="sheet">
      <div class="sheetHead">
        <div>
          <div class="t" id="sheetTitle">Add person</div>
          <div class="s" id="sheetSub">Pick a person to add.</div>
        </div>
        <button class="btn" id="sheetClose" type="button">Close</button>
      </div>
      <div class="sheetBody">
        <div class="peopleGrid" id="sheetPeople"></div>
      </div>
      <div class="sheetFoot">
        <button class="btn secondary" id="sheetCancel" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /******************************************************************
     * DATA
     ******************************************************************/

    const PEOPLE = ["Zach","Daniel","Caroline","Mina","Sterling","Omid"];
    const ROLES = ["IR","Fluoro","MSK","US","Float"];
    const REQUIRED = ["IR","Fluoro","MSK","US"];

    const ROLE_META = {
      IR:     { bg:"rgba(37, 99, 235, .42)",  bd:"rgba(37, 99, 235, .85)" },
      Fluoro: { bg:"rgba(21, 128, 61, .42)",  bd:"rgba(21, 128, 61, .85)" },
      MSK:    { bg:"rgba(109, 40, 217, .42)", bd:"rgba(109, 40, 217, .85)" },
      US:     { bg:"rgba(180, 83, 9, .42)",   bd:"rgba(180, 83, 9, .85)" },
      Float:  { bg:"rgba(3, 105, 161, .42)",  bd:"rgba(3, 105, 161, .85)" },
    };

    const DAYS_ORDER = [
      "2025-12-15","2025-12-16","2025-12-17","2025-12-18","2025-12-19",
      "2025-12-22","2025-12-23","2025-12-24","2025-12-25","2025-12-26",
      "2025-12-29","2025-12-30","2025-12-31","2026-01-01","2026-01-02",
      "2026-01-05","2026-01-06","2026-01-07","2026-01-08","2026-01-09"
    ];

    const CLOSED_DATES = new Set(["2025-12-25","2025-12-26","2026-01-01","2026-01-02"]);

    const ABSENCES = {};
    function addAbs(date, patch){
      const cur = ABSENCES[date] || { am:[], pm:[] };
      ABSENCES[date] = {
        am: Array.from(new Set([...(cur.am||[]), ...((patch.am)||[])])),
        pm: Array.from(new Set([...(cur.pm||[]), ...((patch.pm)||[])])),
      };
    }

    // Zach: half sick p.m. 12/22; full sick day 1/9
    addAbs("2025-12-22", { pm:["Zach"] });
    addAbs("2026-01-09", { am:["Zach"], pm:["Zach"] });

    // Sterling: vacation 12/22–12/24 (full days)
    addAbs("2025-12-22", { am:["Sterling"], pm:["Sterling"] });
    addAbs("2025-12-23", { am:["Sterling"], pm:["Sterling"] });
    addAbs("2025-12-24", { am:["Sterling"], pm:["Sterling"] });

    // Omid: dr appt a.m. 12/22; half admin a.m. 12/24; vacation 12/29–12/31
    addAbs("2025-12-22", { am:["Omid"] });
    addAbs("2025-12-24", { am:["Omid"] });
    addAbs("2025-12-29", { am:["Omid"], pm:["Omid"] });
    addAbs("2025-12-30", { am:["Omid"], pm:["Omid"] });
    addAbs("2025-12-31", { am:["Omid"], pm:["Omid"] });

    // Daniel: vacation 12/29–12/31; academic half-day Jan 6 (p.m.)
    addAbs("2025-12-29", { am:["Daniel"], pm:["Daniel"] });
    addAbs("2025-12-30", { am:["Daniel"], pm:["Daniel"] });
    addAbs("2025-12-31", { am:["Daniel"], pm:["Daniel"] });
    addAbs("2026-01-06", { pm:["Daniel"] });

    // Mina: half academic day 12/24 (p.m.); off Jan 6–9
    addAbs("2025-12-24", { pm:["Mina"] });
    addAbs("2026-01-06", { am:["Mina"], pm:["Mina"] });
    addAbs("2026-01-07", { am:["Mina"], pm:["Mina"] });
    addAbs("2026-01-08", { am:["Mina"], pm:["Mina"] });
    addAbs("2026-01-09", { am:["Mina"], pm:["Mina"] });

    // Caroline: academic half day Jan 6 (full day off per earlier note) + Dec 24 full day off from calendar snapshot
    addAbs("2025-12-24", { am:["Caroline"], pm:["Caroline"] });

    function isAbsent(person, date, half){
      if(CLOSED_DATES.has(date)) return false;
      const a = ABSENCES[date];
      if(!a) return false;
      return (a[half] || []).includes(person);
    }
    function absentList(date, half){
      if(CLOSED_DATES.has(date)) return [];
      const a = ABSENCES[date];
      if(!a) return [];
      return (a[half] || []).slice().sort((x,y)=>x.localeCompare(y));
    }

    function dayMustSplit(date){
      if(CLOSED_DATES.has(date)) return true;
      const am = absentList(date, "am");
      const pm = absentList(date, "pm");
      if(am.length !== pm.length) return true;
      for(let i=0;i<am.length;i++){
        if(am[i] !== pm[i]) return true;
      }
      return false; // absences identical => no reason to split the day
    }

    function emptyHalf(){
      return { IR:[], Fluoro:[], MSK:[], US:[], Float:[] };
    }
    function clone(obj){ return JSON.parse(JSON.stringify(obj)); }

    function normalizeLinkedDays(schedule, dayMode){
      for(const date of DAYS_ORDER){
        if(CLOSED_DATES.has(date)) continue;
        if(dayMustSplit(date)) continue; // must keep halves independent
        const mode = (dayMode && dayMode[date]) ? dayMode[date] : "linked";
        if(mode !== "linked") continue;

        // Mirror: p.m. assignments must match a.m.
        schedule[date].pm = clone(schedule[date].am);
      }
    }

    /******************************************************************
     * DEFAULT SCHEDULE
     ******************************************************************/
    const DEFAULT_SCHEDULE = (() => {
      const s = {};
      for(const d of DAYS_ORDER){
        if(CLOSED_DATES.has(d)){
          s[d] = { closed:true };
        }else{
          s[d] = { closed:false, am: emptyHalf(), pm: emptyHalf() };
        }
      }

      // Week 1
      for(const d of ["2025-12-15","2025-12-16","2025-12-17","2025-12-18","2025-12-19"]){
        s[d].am.IR = ["Zach","Daniel"];
        s[d].am.Fluoro = ["Caroline"];
        s[d].am.MSK = ["Mina"];
        s[d].am.US = ["Omid"];
        s[d].am.Float = ["Sterling"];
      }

      // 12/22
      s["2025-12-22"].am.IR = ["Zach"];
      s["2025-12-22"].am.Fluoro = ["Mina"];
      s["2025-12-22"].am.MSK = ["Daniel"];
      s["2025-12-22"].am.US = ["Caroline"];
      s["2025-12-22"].am.Float = [];
      s["2025-12-22"].pm.IR = ["Mina"];
      s["2025-12-22"].pm.Fluoro = ["Daniel"];
      s["2025-12-22"].pm.MSK = ["Caroline"];
      s["2025-12-22"].pm.US = ["Omid"];
      s["2025-12-22"].pm.Float = [];

      // 12/23
      s["2025-12-23"].am.IR = ["Zach"];
      s["2025-12-23"].am.Fluoro = ["Mina"];
      s["2025-12-23"].am.MSK = ["Daniel"];
      s["2025-12-23"].am.US = ["Caroline"];
      s["2025-12-23"].am.Float = ["Omid"];

      // 12/24
      s["2025-12-24"].am.IR = ["Zach"];
      s["2025-12-24"].am.Fluoro = ["Mina"];
      s["2025-12-24"].am.MSK = ["Daniel"];
      s["2025-12-24"].am.US = [];
      s["2025-12-24"].am.Float = [];
      s["2025-12-24"].pm.IR = ["Zach"];
      s["2025-12-24"].pm.Fluoro = ["Daniel"];
      s["2025-12-24"].pm.MSK = ["Omid"];
      s["2025-12-24"].pm.US = [];
      s["2025-12-24"].pm.Float = [];

      // 12/29–12/31
      for(const d of ["2025-12-29","2025-12-30","2025-12-31"]){
        s[d].am.IR = ["Zach"];
        s[d].am.Fluoro = ["Sterling"];
        s[d].am.MSK = ["Caroline"];
        s[d].am.US = ["Mina"];
        s[d].am.Float = [];
      }

      // 1/5
      s["2026-01-05"].am.IR = ["Zach"];
      s["2026-01-05"].am.Fluoro = ["Daniel"];
      s["2026-01-05"].am.MSK = ["Mina"];
      s["2026-01-05"].am.US = ["Caroline"];
      s["2026-01-05"].am.Float = ["Omid","Sterling"];

      // 1/6
      s["2026-01-06"].am.IR = ["Zach"];
      s["2026-01-06"].am.Fluoro = ["Daniel"];
      s["2026-01-06"].am.MSK = ["Sterling"];
      s["2026-01-06"].am.US = ["Omid"];
      s["2026-01-06"].am.Float = ["Caroline"];
      s["2026-01-06"].pm.IR = ["Zach"];
      s["2026-01-06"].pm.Fluoro = ["Omid"];
      s["2026-01-06"].pm.MSK = ["Sterling"];
      s["2026-01-06"].pm.US = [];
      s["2026-01-06"].pm.Float = ["Caroline"];

      // 1/7
      s["2026-01-07"].am.IR = ["Zach"];
      s["2026-01-07"].am.Fluoro = ["Daniel"];
      s["2026-01-07"].am.MSK = ["Caroline"];
      s["2026-01-07"].am.US = ["Omid"];
      s["2026-01-07"].am.Float = ["Sterling"];

      // 1/8
      s["2026-01-08"].am.IR = ["Zach"];
      s["2026-01-08"].am.Fluoro = ["Daniel"];
      s["2026-01-08"].am.MSK = ["Caroline"];
      s["2026-01-08"].am.US = ["Omid"];
      s["2026-01-08"].am.Float = ["Sterling"];

      // 1/9
      s["2026-01-09"].am.IR = ["Omid"];
      s["2026-01-09"].am.Fluoro = ["Daniel"];
      s["2026-01-09"].am.MSK = ["Caroline"];
      s["2026-01-09"].am.US = ["Sterling"];
      s["2026-01-09"].am.Float = [];

      return s;
    })();

    const FIRST_WEEK_DATES = new Set(["2025-12-15","2025-12-16","2025-12-17","2025-12-18","2025-12-19"]);

    function enforceDefaults(schedule, defaultsOn){
      normalizeLinkedDays(schedule, state.dayMode);

      if(!defaultsOn) return;

      for(const date of DAYS_ORDER){
        if(CLOSED_DATES.has(date)) continue;
        const day = schedule[date];
        for(const half of ["am","pm"]){
          const h = day[half];
          for(const role of ROLES){
            h[role] = h[role].filter(p => !isAbsent(p, date, half));
          }
          const zachPresent = !isAbsent("Zach", date, half);
          if(zachPresent){
            if(!h.IR.includes("Zach")) h.IR.unshift("Zach");
          }else{
            h.IR = h.IR.filter(p => p !== "Zach");
          }
          if(FIRST_WEEK_DATES.has(date)){
            const danPresent = !isAbsent("Daniel", date, half);
            if(danPresent){
              if(!h.IR.includes("Daniel")) h.IR.push("Daniel");
            }else{
              h.IR = h.IR.filter(p => p !== "Daniel");
            }
          }
        }
      }
      normalizeLinkedDays(schedule, state.dayMode);
    }

    /******************************************************************
     * STATE
     ******************************************************************/

    const STORAGE_KEY = "rotation_scheduler_v4_grid";
    let state = {
      schedule: clone(DEFAULT_SCHEDULE),
      defaultsOn: true,
      copyMode: false,
      selected: null,
      sheetCtx: null,
      dayMode: {}
    };

    function getDayMode(date){
      if(dayMustSplit(date)) return "split";
      return state.dayMode[date] || "linked";
    }

    function setDayMode(date, mode){
      if(dayMustSplit(date)) return;
      state.dayMode[date] = mode;
      save();
    }

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          if(parsed && parsed.schedule){
            state.schedule = parsed.schedule;
            state.defaultsOn = !!parsed.defaultsOn;
            state.copyMode = !!parsed.copyMode;
            state.dayMode = parsed.dayMode || {};
          }
        }
      }catch(e){}
      enforceDefaults(state.schedule, state.defaultsOn);
    }

    function save(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          schedule: state.schedule,
          defaultsOn: state.defaultsOn,
          copyMode: state.copyMode,
          dayMode: state.dayMode
        }));
      }catch(e){}
    }

    /******************************************************************
     * UTIL
     ******************************************************************/

    const esc = (s) => String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

    function dowLabel(iso){
      const d = new Date(iso + "T00:00:00Z");
      return d.toLocaleDateString(undefined, { weekday:"long", timeZone:"UTC" });
    }
    function fmtMDY(iso){
      const d = new Date(iso + "T00:00:00Z");
      return d.toLocaleDateString(undefined, { month:"short", day:"numeric", timeZone:"UTC" });
    }

    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(() => el.classList.remove("show"), 1900);
    }

    function requiredMissingForHalf(dayHalf){
      const missing = [];
      for(const r of REQUIRED){
        if(!dayHalf[r] || dayHalf[r].length === 0) missing.push(r);
      }
      return missing;
    }

    function dayHasIssue(date){
      if(CLOSED_DATES.has(date)) return false;
      const d = state.schedule[date];
      const missAM = requiredMissingForHalf(d.am).length > 0;
      const missPM = requiredMissingForHalf(d.pm).length > 0;
      return missAM || missPM;
    }

    function roleColor(role){ return ROLE_META[role]?.bg || "rgba(255,255,255,.06)"; }
    function roleBorder(role){ return ROLE_META[role]?.bd || "rgba(255,255,255,.16)"; }

    function canPlace(person, date, half){
      if(CLOSED_DATES.has(date)) return false;
      if(isAbsent(person, date, half)) return false;
      return true;
    }

    function removeFromSlot(date, half, role, person){
      const arr = state.schedule[date][half][role];
      state.schedule[date][half][role] = arr.filter(p => p !== person);
    }
    function addToSlot(date, half, role, person){
      const arr = state.schedule[date][half][role];
      state.schedule[date][half][role] = [...arr, person];
    }

    function halvesForEdit(date, half){
      return (getDayMode(date) === "linked") ? ["am","pm"] : [half];
    }

    function canPlaceInAllHalves(person, date, halves){
      for(const h of halves){
        if(!canPlace(person, date, h)) return false;
      }
      return true;
    }

    function moveOrCopy(person, from, to){
      const {date, half, role} = to;
      const targetHalves = halvesForEdit(date, half);

      if(!canPlaceInAllHalves(person, date, targetHalves)){
        toast(`${person} is unavailable for the whole day (linked) or that half-day.`);
        return false;
      }

      if(from && !state.copyMode){
        for(const h of halvesForEdit(from.date, from.half)){
          removeFromSlot(from.date, h, from.role, person);
        }
      }

      for(const h of targetHalves){
        addToSlot(date, h, role, person);
      }

      enforceDefaults(state.schedule, state.defaultsOn);
      save();
      render();
      return true;
    }

    /******************************************************************
     * STATS
     ******************************************************************/

    function compressAbsences(entries){
      const byDate = new Map();
      for(const e of entries){
        if(!byDate.has(e.iso)) byDate.set(e.iso, { am:false, pm:false });
        byDate.get(e.iso)[e.half] = true;
      }
      const dates = Array.from(byDate.keys()).sort();

      const full = [];
      const partial = [];
      for(const iso of dates){
        const f = byDate.get(iso);
        if(f.am && f.pm) full.push(iso);
        else{
          if(f.am) partial.push(`${fmtMDY(iso)} a.m.`);
          if(f.pm) partial.push(`${fmtMDY(iso)} p.m.`);
        }
      }

      const fullRanges = [];
      const toD = (iso)=>new Date(iso+"T00:00:00Z");
      const addDays=(d,n)=>{const x=new Date(d);x.setUTCDate(x.getUTCDate()+n);return x;};
      const isoOf=(d)=>`${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,"0")}-${String(d.getUTCDate()).padStart(2,"0")}`;

      let start=null, prev=null;
      for(const iso of full){
        if(start===null){ start=iso; prev=iso; continue; }
        const next = isoOf(addDays(toD(prev),1));
        if(iso===next){ prev=iso; }
        else{
          fullRanges.push(start===prev ? fmtMDY(start) : `${fmtMDY(start)}–${fmtMDY(prev)}`);
          start=iso; prev=iso;
        }
      }
      if(start!==null){
        fullRanges.push(start===prev ? fmtMDY(start) : `${fmtMDY(start)}–${fmtMDY(prev)}`);
      }

      return { fullRanges, partial };
    }

    function computeStats(){
      const stats = {};
      for(const p of PEOPLE){
        stats[p] = { IR:0, Fluoro:0, MSK:0, US:0, Float:0, Absence:0, absenceEntries:[] };
      }

      for(const date of DAYS_ORDER){
        if(CLOSED_DATES.has(date)) continue;
        for(const half of ["am","pm"]){
          const weight = 0.5;
          const h = state.schedule[date][half];
          for(const role of ROLES){
            for(const p of (h[role] || [])){
              if(stats[p]) stats[p][role] += weight;
            }
          }
        }
      }

      for(const date of DAYS_ORDER){
        if(CLOSED_DATES.has(date)) continue;
        for(const p of PEOPLE){
          for(const half of ["am","pm"]){
            if(isAbsent(p, date, half)){
              stats[p].Absence += 0.5;
              stats[p].absenceEntries.push({ iso:date, half });
            }
          }
        }
      }

      return stats;
    }

    /******************************************************************
     * RENDER
     ******************************************************************/

    const daysEl = document.getElementById("days");
    const statsEl = document.getElementById("stats");
    const pickHint = document.getElementById("pickHint");

    function renderStats(){
      const stats = computeStats();
      const fmt = (n) => (Math.round(n*10)/10).toFixed(1).replace(".0","");

      statsEl.innerHTML = `
        <table>
          <thead>
            <tr>
              <th class="name">Person</th>
              <th>IR</th>
              <th>Fluoro</th>
              <th>MSK</th>
              <th>US</th>
              <th>Float</th>
              <th>Absence</th>
              <th style="text-align:left">Absence dates</th>
            </tr>
          </thead>
          <tbody>
            ${
              PEOPLE.map(p=>{
                const comp = compressAbsences(stats[p].absenceEntries);
                const parts = [];
                if(comp.fullRanges.length) parts.push(comp.fullRanges.join(", "));
                if(comp.partial.length) parts.push(comp.partial.join(", "));
                const dates = parts.length ? parts.join("; ") : "—";
                return `
                  <tr>
                    <td class="name">${esc(p)}</td>
                    <td>${fmt(stats[p].IR)}</td>
                    <td>${fmt(stats[p].Fluoro)}</td>
                    <td>${fmt(stats[p].MSK)}</td>
                    <td>${fmt(stats[p].US)}</td>
                    <td>${fmt(stats[p].Float)}</td>
                    <td>${fmt(stats[p].Absence)}</td>
                    <td class="absDates">${esc(dates)}</td>
                  </tr>
                `;
              }).join("")
            }
          </tbody>
        </table>
      `;
    }

    function renderHint(){
      const sel = state.selected;
      const mode = state.copyMode ? "Copy" : "Move";
      if(!sel){
        pickHint.innerHTML = `<b>Selected:</b> none • <b>Mode:</b> ${esc(mode)} • Tap a role slot to place.`;
        return;
      }
      const fromTxt = sel.from ? `${fmtMDY(sel.from.date)} ${sel.from.half === "am" ? "AM" : "PM"} ${sel.from.role}` : "picker";
      pickHint.innerHTML = `<b>Selected:</b> ${esc(sel.person)} • <b>Mode:</b> ${esc(mode)} • <b>From:</b> ${esc(fromTxt)} • Tap a role slot to place.`;
    }

    function chipHTML(person, ctx, disabled=false){
      const sel = state.selected && state.selected.person === person && state.selected.from
        && state.selected.from.date === ctx.date && state.selected.from.half === ctx.half && state.selected.from.role === ctx.role;

      const cls = ["chip", sel ? "selected" : "", disabled ? "disabled" : ""].join(" ").trim();
      return `
        <span class="${cls}"
              data-chip="1"
              data-person="${esc(person)}"
              data-date="${esc(ctx.date)}"
              data-half="${esc(ctx.half)}"
              data-role="${esc(ctx.role)}"
              draggable="true">
          ${esc(person)}
          <button class="xbtn" data-x="1"
                  data-person="${esc(person)}"
                  data-date="${esc(ctx.date)}"
                  data-half="${esc(ctx.half)}"
                  data-role="${esc(ctx.role)}"
                  type="button">×</button>
        </span>
      `;
    }

    function roleRowHTML(date, half, role){
      const h = state.schedule[date][half];
      const missing = REQUIRED.includes(role) && (!h[role] || h[role].length === 0);
      const rowCls = ["roleRow", missing ? "missing" : ""].join(" ");
      const bg = roleColor(role);
      const bd = roleBorder(role);
      const chips = (h[role] || []).map(p => chipHTML(p, {date,half,role}, isAbsent(p,date,half))).join("");

      return `
        <div class="${rowCls}">
          <div class="roleBar" style="background:${bg};border-bottom:1px solid ${bd}">
            <div>${esc(role)}</div>
            <div class="right">
              <button class="miniBtn" data-add="1" data-date="${esc(date)}" data-half="${esc(half)}" data-role="${esc(role)}" type="button">+</button>
              <button class="miniBtn" data-clear="1" data-date="${esc(date)}" data-half="${esc(half)}" data-role="${esc(role)}" type="button">C</button>
            </div>
          </div>
          <div class="slot"
               data-slot="1"
               data-date="${esc(date)}"
               data-half="${esc(half)}"
               data-role="${esc(role)}">
            ${chips || ``}
          </div>
        </div>
      `;
    }

    function halfHTML(date, half){
      const abs = absentList(date, half);
      const absTxt = abs.length ? `${abs.join(", ")}` : `—`;
      return `
        <div class="half">
          <div class="halfHead">
            <div class="label">${half === "am" ? "AM" : "PM"}</div>
            <div class="abs">Abs: ${esc(absTxt)}</div>
          </div>
          <div class="roles">
            ${ROLES.map(r => roleRowHTML(date, half, r)).join("")}
          </div>
        </div>
      `;
    }

    function dayHeaderBadges(date){
      if(CLOSED_DATES.has(date)) return `<span class="badge closed">Closed</span>`;
      const issue = dayHasIssue(date);
      const mustSplit = dayMustSplit(date);
      const mode = getDayMode(date);

      const modeBadge = mustSplit
        ? `<span class="badge locked">Locked</span>`
        : `<span class="badge linked" data-toggle-daymode="1" data-date="${esc(date)}">${mode === "linked" ? "Link" : "Split"}</span>`;

      return `
        ${issue ? `<span class="badge issue">!</span>` : `<span class="badge ok">OK</span>`}
        ${modeBadge}
      `;
    }

    function dayHTML(date, index){
      // Calculate week number (1-based)
      // Every 5 days = 1 week
      const weekNum = Math.floor(index / 5) + 1;
      const isEvenWeek = (weekNum % 2 === 0);
      const weekClass = isEvenWeek ? "evenWeek" : "oddWeek";
      
      // Add a label for the first day of the week (Monday)
      // index % 5 === 0 means it's the first column
      const showWeekLabel = (index % 5 === 0);
      const weekLabelHTML = showWeekLabel ? `<div class="weekLabel">Week ${weekNum}</div>` : "";

      if(CLOSED_DATES.has(date)){
        return `
          <div class="dayCard ${weekClass}">
            ${weekLabelHTML}
            <div class="dayTop">
              <div class="dateBlock"><div class="md">${esc(fmtMDY(date))}</div></div>
              <div class="badges">${dayHeaderBadges(date)}</div>
            </div>
            <div class="dayBody">
              <div class="hintBar" style="margin:0;">Closed</div>
            </div>
          </div>
        `;
      }
      const issue = dayHasIssue(date);
      return `
        <div class="dayCard ${weekClass} ${issue ? "issue" : ""}">
          ${weekLabelHTML}
          <div class="dayTop">
            <div class="dateBlock"><div class="md">${esc(fmtMDY(date))}</div></div>
            <div class="badges">${dayHeaderBadges(date)}</div>
          </div>
          <div class="dayBody">
            ${halfHTML(date, "am")}
            ${halfHTML(date, "pm")}
          </div>
        </div>
      `;
    }

    function render(){
      enforceDefaults(state.schedule, state.defaultsOn);
      document.getElementById("lockBtn").classList.toggle("toggled", state.defaultsOn);
      document.getElementById("lockBtn").textContent = `Defaults: ${state.defaultsOn ? "ON" : "OFF"}`;
      document.getElementById("copyBtn").textContent = `Mode: ${state.copyMode ? "Copy" : "Move"}`;

      renderStats();
      renderHint();

      // Headers + Days
      const headers = `
        <div class="colHead">Monday</div>
        <div class="colHead">Tuesday</div>
        <div class="colHead">Wednesday</div>
        <div class="colHead">Thursday</div>
        <div class="colHead">Friday</div>
      `;
      // Pass index to dayHTML to calculate weeks
      daysEl.innerHTML = headers + DAYS_ORDER.map((d, i) => dayHTML(d, i)).join("");
      attachHandlers();
    }

    /******************************************************************
     * INTERACTION
     ******************************************************************/

    const sheetBackdrop = document.getElementById("sheetBackdrop");
    const sheetPeople = document.getElementById("sheetPeople");
    const sheetTitle = document.getElementById("sheetTitle");
    const sheetSub = document.getElementById("sheetSub");

    function openSheet(ctx){
      state.sheetCtx = ctx;
      const {date, half, role} = ctx;
      const halves = halvesForEdit(date, half);
      const halfLabel = (halves.length === 2) ? "whole day" : (half === "am" ? "AM" : "PM");

      sheetTitle.textContent = `Add to ${role} (${halfLabel})`;
      sheetSub.textContent = `${fmtMDY(date)} • Unavailable dimmed.`;

      sheetPeople.innerHTML = PEOPLE.map(p=>{
        const disabled = !canPlaceInAllHalves(p, date, halves);
        const already = halves.every(h => state.schedule[date][h][role].includes(p));
        const label = already ? `${p} (in)` : p;

        return `
          <span class="chip ${disabled ? "disabled" : ""}"
                data-pick="1"
                data-person="${esc(p)}"
                data-date="${esc(date)}"
                data-half="${esc(half)}"
                data-role="${esc(role)}"
                style="cursor:${disabled ? "not-allowed" : "pointer"};">
            ${esc(label)}
          </span>
        `;
      }).join("");

      sheetBackdrop.classList.add("show");
    }

    function closeSheet(){
      sheetBackdrop.classList.remove("show");
      state.sheetCtx = null;
    }

    let dragData = null;

    function attachHandlers(){
      document.querySelectorAll("[data-toggle-daymode='1']").forEach(b=>{
        b.addEventListener("click", ()=>{
          const date = b.getAttribute("data-date");
          if(dayMustSplit(date)) return;
          const cur = getDayMode(date);
          const next = (cur === "linked") ? "split" : "linked";
          setDayMode(date, next);
          enforceDefaults(state.schedule, state.defaultsOn);
          save();
          toast(next === "linked" ? "Linked." : "Split.");
          render();
        });
      });

      document.querySelectorAll("[data-x='1']").forEach(btn=>{
        btn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const person = btn.getAttribute("data-person");
          const date = btn.getAttribute("data-date");
          const half = btn.getAttribute("data-half");
          const role = btn.getAttribute("data-role");

          for(const h of halvesForEdit(date, half)){
            removeFromSlot(date, h, role, person);
          }
          enforceDefaults(state.schedule, state.defaultsOn);
          save();
          if(state.selected && state.selected.person === person && state.selected.from
             && state.selected.from.date === date && state.selected.from.half === half && state.selected.from.role === role){
            state.selected = null;
          }
          render();
        }, { passive:false });
      });

      document.querySelectorAll("[data-chip='1']").forEach(ch=>{
        ch.addEventListener("click", (e)=>{
          if(e.target && e.target.closest && e.target.closest("[data-x='1']")) return;
          const person = ch.getAttribute("data-person");
          const date = ch.getAttribute("data-date");
          const half = ch.getAttribute("data-half");
          const role = ch.getAttribute("data-role");
          const same = state.selected && state.selected.person === person && state.selected.from
            && state.selected.from.date === date && state.selected.from.half === half && state.selected.from.role === role;
          state.selected = same ? null : { person, from:{date,half,role} };
          render();
        }, { passive:false });

        ch.addEventListener("dragstart", (e)=>{
          const person = ch.getAttribute("data-person");
          const date = ch.getAttribute("data-date");
          const half = ch.getAttribute("data-half");
          const role = ch.getAttribute("data-role");
          dragData = { person, from:{date,half,role} };
          try{ e.dataTransfer.setData("text/plain", JSON.stringify(dragData)); }catch(_){}
        });
        ch.addEventListener("dragend", ()=>{
          dragData = null;
          document.querySelectorAll(".slot.dropTarget").forEach(x=>x.classList.remove("dropTarget"));
        });
      });

      document.querySelectorAll("[data-slot='1']").forEach(slot=>{
        slot.addEventListener("click", ()=>{
          const date = slot.getAttribute("data-date");
          const half = slot.getAttribute("data-half");
          const role = slot.getAttribute("data-role");
          if(!state.selected) return;
          const person = state.selected.person;
          const from = state.selected.from;
          const ok = moveOrCopy(person, from, {date,half,role});
          if(ok){
            state.selected = null;
            render();
          }
        }, { passive:false });

        slot.addEventListener("dragover", (e)=>{
          e.preventDefault();
          slot.classList.add("dropTarget");
        });
        slot.addEventListener("dragleave", ()=>{
          slot.classList.remove("dropTarget");
        });
        slot.addEventListener("drop", (e)=>{
          e.preventDefault();
          slot.classList.remove("dropTarget");
          let data = dragData;
          if(!data){
            try{ data = JSON.parse(e.dataTransfer.getData("text/plain")); }catch(_){}
          }
          if(!data) return;
          moveOrCopy(data.person, data.from, {date:slot.getAttribute("data-date"), half:slot.getAttribute("data-half"), role:slot.getAttribute("data-role")});
          dragData = null;
          state.selected = null;
          render();
        });
      });

      document.querySelectorAll("[data-add='1']").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          openSheet({
            date: btn.getAttribute("data-date"),
            half: btn.getAttribute("data-half"),
            role: btn.getAttribute("data-role"),
          });
        });
      });

      document.querySelectorAll("[data-clear='1']").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const date = btn.getAttribute("data-date");
          const half = btn.getAttribute("data-half");
          const role = btn.getAttribute("data-role");
          for(const h of halvesForEdit(date, half)){
            state.schedule[date][h][role] = [];
          }
          enforceDefaults(state.schedule, state.defaultsOn);
          save();
          render();
        });
      });
    }

    document.getElementById("sheetClose").addEventListener("click", closeSheet);
    document.getElementById("sheetCancel").addEventListener("click", closeSheet);
    sheetBackdrop.addEventListener("click", (e)=>{
      if(e.target === sheetBackdrop) closeSheet();
    });

    sheetPeople.addEventListener("click", (e)=>{
      const chip = e.target.closest && e.target.closest("[data-pick='1']");
      if(!chip) return;
      const person = chip.getAttribute("data-person");
      const date = chip.getAttribute("data-date");
      const half = chip.getAttribute("data-half");
      const role = chip.getAttribute("data-role");
      const halves = halvesForEdit(date, half);

      if(!canPlaceInAllHalves(person, date, halves)){
        toast(`${person} is unavailable.`);
        return;
      }
      for(const h of halves){
        addToSlot(date, h, role, person);
      }
      enforceDefaults(state.schedule, state.defaultsOn);
      save();
      closeSheet();
      render();
    });

    document.getElementById("lockBtn").addEventListener("click", ()=>{
      state.defaultsOn = !state.defaultsOn;
      enforceDefaults(state.schedule, state.defaultsOn);
      save();
      render();
    });

    document.getElementById("copyBtn").addEventListener("click", ()=>{
      state.copyMode = !state.copyMode;
      save();
      render();
    });

    document.getElementById("resetBtn").addEventListener("click", ()=>{
      state.schedule = clone(DEFAULT_SCHEDULE);
      state.selected = null;
      enforceDefaults(state.schedule, state.defaultsOn);
      save();
      render();
      toast("Reset.");
    });

    document.getElementById("clearBtn").addEventListener("click", ()=>{
      const s = {};
      for(const d of DAYS_ORDER){
        if(CLOSED_DATES.has(d)) s[d] = { closed:true };
        else s[d] = { closed:false, am: emptyHalf(), pm: emptyHalf() };
      }
      state.schedule = s;
      state.selected = null;
      enforceDefaults(state.schedule, state.defaultsOn);
      save();
      render();
      toast("Cleared.");
    });

    document.getElementById("exportBtn").addEventListener("click", ()=>{
      const payload = {
        version: 4,
        exported_at: new Date().toISOString(),
        schedule: state.schedule,
        defaultsOn: state.defaultsOn,
        copyMode: state.copyMode,
        dayMode: state.dayMode
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "rotation_grid.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Exported.");
    });

    const importFile = document.getElementById("importFile");
    document.getElementById("importBtn").addEventListener("click", ()=>{
      importFile.value = "";
      importFile.click();
    });
    importFile.addEventListener("change", async ()=>{
      const file = importFile.files && importFile.files[0];
      if(!file) return;
      try{
        const text = await file.text();
        const obj = JSON.parse(text);
        if(!obj || !obj.schedule) throw new Error("Missing schedule");
        state.schedule = obj.schedule;
        if(typeof obj.defaultsOn === "boolean") state.defaultsOn = obj.defaultsOn;
        if(typeof obj.copyMode === "boolean") state.copyMode = obj.copyMode;
        state.dayMode = obj.dayMode || {};
        state.selected = null;
        enforceDefaults(state.schedule, state.defaultsOn);
        save();
        render();
        toast("Imported.");
      }catch(e){
        toast("Import failed.");
      }
    });

    load();
    render();
  </script>
</body>
</html>
