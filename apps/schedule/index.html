
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rotation Roles (Dec 15, 2025 – Jan 9, 2026)</title>
  <style>
    :root{
      --bg0:#0b1020;
      --bg1:#0f1630;
      --panel:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12);
      --text:#e9eefc;
      --muted:rgba(233,238,252,.72);
      --shadow: 0 18px 45px rgba(0,0,0,.35);

      /* role colors */
      --r-ir:#60a5fa;
      --r-fluoro:#22c55e;
      --r-msk:#a78bfa;
      --r-us:#f59e0b;
      --r-float:#38bdf8;
      --r-absent:#ef4444;
      --r-closed:#94a3b8;

      /* status colors */
      --c-vac:#22c55e;
      --c-away:#f59e0b;
      --c-sick:#ef4444;
      --c-admin:#a78bfa;
      --c-appt:#f472b6;
      --c-note:#38bdf8;
      --c-pending:#fbbf24;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(96,165,250,.16), transparent 60%),
        radial-gradient(1100px 700px at 85% 0%, rgba(167,139,250,.12), transparent 55%),
        radial-gradient(1000px 700px at 70% 90%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .app{max-width:1280px;margin:18px auto 28px;padding:0 14px;}

    .topbar{
      position:sticky;top:0;z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,16,32,.92), rgba(11,16,32,.55));
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: 0 14px 34px rgba(0,0,0,.25);
      border-radius: 22px;
      padding: 12px 12px 10px;
      margin-bottom: 14px;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .brand{display:flex;align-items:center;gap:10px;min-width:260px;}
    .logo{
      width:38px;height:38px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 45%),
        linear-gradient(135deg, rgba(96,165,250,.70), rgba(167,139,250,.55));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 14px 30px rgba(0,0,0,.28);
    }
    .title{line-height:1.1;}
    .title h1{font-size:14px;letter-spacing:.2px;margin:0;font-weight:700;}
    .title .sub{font-size:12px;color:var(--muted);margin-top:2px;}

    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end;}

    .btn{
      appearance:none;border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 8px 10px;border-radius: 14px;
      font-weight: 650;font-size: 12px;letter-spacing:.2px;
      cursor:pointer;user-select:none;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{ background: rgba(255,255,255,.085); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.45), rgba(167,139,250,.35));
      border-color: rgba(255,255,255,.18);
    }
    .btn.danger{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.25);
    }
    .btn.ghost{background:transparent;}

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      font-size: 12px;color: var(--muted);
      padding: 8px 10px;border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;background: rgba(255,255,255,.04);
    }

    .panel{
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.09);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .legend{
      padding: 10px 12px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }
    .legend .left{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding: 6px 8px;border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-size: 11px;color: var(--muted);white-space:nowrap;
    }
    .dot{width:9px;height:9px;border-radius:99px;background:rgba(255,255,255,.4);box-shadow:0 0 0 3px rgba(255,255,255,.06);}

    .metaLine{
      margin-top: 8px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
    }

    .weekGrid{
      display:grid;
      grid-template-columns: repeat(5, minmax(220px, 1fr));
      gap: 12px;
      padding: 12px;
    }
    @media (max-width: 1200px){ .weekGrid{ grid-template-columns: repeat(3, minmax(220px, 1fr)); } }
    @media (max-width: 820px){ .weekGrid{ grid-template-columns: repeat(2, minmax(220px, 1fr)); } }
    @media (max-width: 560px){ .weekGrid{ grid-template-columns: 1fr; } }

    .dayCard{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      box-shadow: 0 14px 30px rgba(0,0,0,.22);
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      position:relative;
    }
    .dayCard:hover{ background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.16); }
    .dayCard:active{ transform: translateY(1px); }

    .dayHeader{
      padding: 10px 12px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
    }
    .dayHeader .d1{font-weight:850;font-size:12px;letter-spacing:.2px;}
    .dayHeader .d2{font-size:12px;color:var(--muted);margin-top:2px;}
    .badgeClosed{
      padding: 6px 8px;border-radius:999px;
      border: 1px solid rgba(148,163,184,.40);
      background: rgba(148,163,184,.12);
      color: rgba(233,238,252,.90);
      font-size: 11px;
      font-weight: 800;
      letter-spacing:.2px;
      white-space:nowrap;
    }

    .slots{padding: 10px 12px 12px;display:grid;gap:8px;}
    .slot{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      padding: 8px 10px;
    }
    .slotLeft{display:flex;align-items:center;gap:10px;min-width:0;}
    .slotPill{
      width:10px;height:10px;border-radius:99px;
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
      flex: 0 0 auto;
    }
    .slotLabel{
      font-size: 11px;
      letter-spacing:.9px;
      text-transform: uppercase;
      color: rgba(233,238,252,.76);
      flex: 0 0 auto;
    }
    .slotValue{
      font-size: 12px;
      font-weight: 850;
      letter-spacing:.2px;
      color: rgba(233,238,252,.92);
      white-space:nowrap;
    }
    .slotValue.muted{color: rgba(233,238,252,.55); font-weight: 750;}
    .slotValueWrap{display:flex;flex-wrap:wrap;gap:6px;justify-content:flex-end;}

    .chip{
      display:inline-flex;align-items:center;gap:6px;
      padding: 6px 8px;border-radius: 999px;
      font-size: 11px;font-weight: 800;letter-spacing:.2px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      white-space:nowrap;
    }
    .chip.pending{
      border-style:dashed;
      border-color: rgba(251,191,36,.45);
      background: rgba(251,191,36,.10);
    }
    .chip.note{ border-color: rgba(56,189,248,.45); background: rgba(56,189,248,.10); color: rgba(233,238,252,.92); }
    .chip.vac{ border-color: rgba(34,197,94,.40); background: rgba(34,197,94,.12); }
    .chip.away{ border-color: rgba(245,158,11,.45); background: rgba(245,158,11,.12); }
    .chip.sick{ border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.12); }
    .chip.admin{ border-color: rgba(167,139,250,.45); background: rgba(167,139,250,.12); }
    .chip.appt{ border-color: rgba(244,114,182,.45); background: rgba(244,114,182,.12); }

    /* modals */
    .modalBackdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      z-index: 50; padding: 16px;
    }
    .modal{
      width: min(980px, 100%);
      border-radius: 22px;
      background: rgba(15,22,48,.92);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 26px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHeader{
      padding: 12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .modalHeader .h{font-weight: 900; font-size: 13px; letter-spacing:.2px;}
    .modalBody{padding: 12px 14px 14px;}

    textarea.json{
      width: 100%;
      height: 420px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.5;
      outline:none;
      resize: vertical;
    }

    .grid2{display:grid;grid-template-columns: 1.1fr .9fr;gap: 12px;}
    @media (max-width: 900px){ .grid2{ grid-template-columns: 1fr; } }

    .card{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
    }
    .card h3{margin:0 0 10px;font-size:12px;letter-spacing:.2px;color: rgba(233,238,252,.88);}
    .small{font-size: 12px;color: var(--muted);line-height:1.45;}
    .hr{height:1px;background: rgba(255,255,255,.10);margin: 10px 0;}

    .formGrid{
      display:grid;
      grid-template-columns: 130px 1fr;
      gap: 10px 12px;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
    }
    select, input[type="text"]{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 12px;
      outline: none;
    }
    select:focus, input[type="text"]:focus{
      border-color: rgba(96,165,250,.55);
      box-shadow: 0 0 0 3px rgba(96,165,250,.18);
    }
    .multiRow{display:flex;flex-wrap:wrap;gap:8px;}
    .miniBtn{
      appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 6px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 800;
      cursor:pointer;
    }
    .miniBtn.on{
      border-color: rgba(56,189,248,.45);
      background: rgba(56,189,248,.10);
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="row">
        <div class="brand">
          <div class="logo"></div>
          <div class="title">
            <h1>Rotation Roles</h1>
            <div class="sub" id="rangeLabel">Dec 15, 2025 – Jan 9, 2026</div>
          </div>
        </div>

        <div class="controls">
          <button class="btn ghost" id="prevWeek" title="Previous week (←)">←</button>
          <div class="pill" id="weekLabel">Week of …</div>
          <button class="btn ghost" id="nextWeek" title="Next week (→)">→</button>

          <button class="btn" id="autoWeek">Auto-fill week</button>
          <button class="btn danger" id="clearWeek">Clear week</button>

          <button class="btn primary" id="exportMenuBtn">Export</button>
          <button class="btn" id="openEditor">Edit data</button>
        </div>
      </div>

      <div class="metaLine">
        <div id="hint">Click a day to edit assignments. Use ←/→ to switch weeks.</div>
        <div id="unscheduledHint"></div>
      </div>
    </div>

    <div class="panel">
      <div class="legend">
        <div class="left">
          <span class="tag"><span class="dot" style="background:var(--r-ir)"></span> IR</span>
          <span class="tag"><span class="dot" style="background:var(--r-fluoro)"></span> Fluoro</span>
          <span class="tag"><span class="dot" style="background:var(--r-msk)"></span> MSK Proc</span>
          <span class="tag"><span class="dot" style="background:var(--r-us)"></span> US Proc</span>
          <span class="tag"><span class="dot" style="background:var(--r-float)"></span> Float</span>
          <span class="tag"><span class="dot" style="background:var(--r-absent)"></span> Absent</span>
          <span class="tag"><span class="dot" style="background:var(--r-closed)"></span> Closed</span>
          <span class="tag"><span class="dot" style="background:var(--c-pending)"></span> Pending</span>
        </div>
        <div style="color:var(--muted); font-size:12px;">
          Weeks shown: Dec 15, Dec 22, Dec 29, Jan 5
        </div>
      </div>

      <div class="weekGrid" id="weekGrid"></div>
    </div>
  </div>

  <!-- Export menu -->
  <div class="modalBackdrop" id="exportBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="h">Export</div>
        <button class="btn" id="closeExport">Close</button>
      </div>
      <div class="modalBody">
        <div class="grid2">
          <div class="card">
            <h3>Config export (re-import / editing)</h3>
            <div class="small">Downloads editable data (availability + closures + role plan).</div>
            <div class="hr"></div>
            <button class="btn primary" id="exportConfigJson">Download config JSON</button>
          </div>

          <div class="card">
            <h3>Expanded export (day-by-day output)</h3>
            <div class="small">Downloads a flattened schedule across the entire date range.</div>
            <div class="hr"></div>
            <button class="btn" id="exportExpandedCsv">Download expanded CSV</button>
            <button class="btn" id="exportExpandedJson" style="margin-left:6px;">Download expanded JSON</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JSON editor -->
  <div class="modalBackdrop" id="editorBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="h">Edit data (JSON)</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn" id="resetData">Reset to default</button>
          <button class="btn danger" id="discardChanges">Discard</button>
          <button class="btn primary" id="saveChanges">Save</button>
          <button class="btn" id="closeEditor">Close</button>
        </div>
      </div>
      <div class="modalBody">
        <textarea class="json" id="jsonEditor" spellcheck="false"></textarea>
        <div class="small" id="editorMsg" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <!-- Day editor -->
  <div class="modalBackdrop" id="dayBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="h" id="dayTitle">Edit day</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn" id="autoDay">Auto-fill day</button>
          <button class="btn danger" id="clearDay">Clear day</button>
          <button class="btn primary" id="saveDay">Save</button>
          <button class="btn" id="closeDay">Close</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="grid2">
          <div class="card">
            <h3>Role assignments</h3>
            <div class="formGrid">
              <div>IR</div><select id="fIR"></select>
              <div>Fluoro</div><select id="fFluoro"></select>
              <div>MSK Proc</div><select id="fMSK"></select>
              <div>US Proc</div><select id="fUS"></select>
              <div>Float</div><div class="multiRow" id="fFloat"></div>
              <div>Absent</div><div class="multiRow" id="fAbsent"></div>
            </div>
            <div class="hr"></div>
            <div class="small" id="dayWarnings"></div>
          </div>

          <div class="card">
            <h3>Availability notes</h3>
            <div class="small" id="dayNotes"></div>
            <div class="hr"></div>
            <div class="small">
              Tip: Availability is controlled by <code>events</code> and <code>closedDates</code> in the JSON editor.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "rotationScheduleData.v1";

  const defaultData = {
    meta: {
      title: "Rotation Roles",
      rangeStart: "2025-12-15",
      rangeEnd:   "2026-01-09",
      weekStarts: ["2025-12-15","2025-12-22","2025-12-29","2026-01-05"]
    },

    people: [
      { name: "Sc", role: "IR (default)" },
      { name: "P",  role: "" },
      { name: "R",  role: "" },
      { name: "E",  role: "" },
      { name: "J",  role: "" },
      { name: "Sh", role: "" }
    ],

    closedDates: [
      { date: "2025-12-25", label: "Holiday (closed)", source: "manual" },
      { date: "2025-12-26", label: "Holiday (closed)", source: "manual" },
      { date: "2026-01-01", label: "Holiday (closed)", source: "manual" },
      { date: "2026-01-02", label: "Holiday (closed)", source: "manual" }
    ],

    events: [
      { person: "Sc", date: "2025-12-22", segment: "PM",  type: "SICK",  label: "Sick",     status: "confirmed", source: "calendar" },
      { person: "P",  date: "2025-12-24", segment: "ALL", type: "VAC",   label: "Vacation", status: "confirmed", source: "calendar" },

      { person: "J",  date: "2025-12-22", segment: "ALL", type: "VAC",   label: "Vacation", status: "confirmed", source: "calendar" },
      { person: "J",  date: "2025-12-23", segment: "ALL", type: "VAC",   label: "Vacation", status: "confirmed", source: "calendar" },
      { person: "J",  date: "2025-12-24", segment: "ALL", type: "VAC",   label: "Vacation", status: "confirmed", source: "calendar" },
      { person: "J",  date: "2025-12-25", segment: "ALL", type: "AWAY",  label: "Away",     status: "confirmed", source: "calendar" },
      { person: "J",  date: "2025-12-26", segment: "ALL", type: "VAC",   label: "Vacation", status: "confirmed", source: "calendar" },

      { person: "J",  date: "2025-12-17", segment: "NOTE", type: "NOTE", label: "2nd Call Short Weekday", status: "confirmed", source: "calendar" },
      { person: "Sh", date: "2025-12-23", segment: "NOTE", type: "NOTE", label: "2nd Call Short Weekday", status: "confirmed", source: "calendar" },
      { person: "E",  date: "2026-01-05", segment: "NOTE", type: "NOTE", label: "2nd Call Short Weekday", status: "confirmed", source: "calendar" },
      { person: "P",  date: "2026-01-02", segment: "NOTE", type: "NOTE", label: "1st Call Short Week",    status: "confirmed", source: "calendar" },

      { person: "Sh", date: "2025-12-21", segment: "ALL", type: "NOTE", label: "Baylor Shift", status: "confirmed", source: "calendar" },

      { person: "R",  date: "2025-12-29", segment: "ALL", type: "VAC", label: "Vacation", status: "confirmed", source: "email" },
      { person: "R",  date: "2025-12-30", segment: "ALL", type: "VAC", label: "Vacation", status: "confirmed", source: "email" },
      { person: "R",  date: "2025-12-31", segment: "ALL", type: "VAC", label: "Vacation", status: "confirmed", source: "email" },
      { person: "R",  date: "2026-01-06", segment: "TBD", type: "NOTE", label: "Academic half day (requested)", status: "requested", source: "email" },

      { person: "Sh", date: "2025-12-29", segment: "ALL", type: "VAC", label: "Vacation", status: "confirmed", source: "email" },
      { person: "Sh", date: "2025-12-30", segment: "ALL", type: "VAC", label: "Vacation", status: "confirmed", source: "email" },
      { person: "Sh", date: "2025-12-31", segment: "ALL", type: "VAC", label: "Vacation", status: "confirmed", source: "email" },

      { person: "Sh", date: "2025-12-22", segment: "AM", type: "APPT",  label: "Doctor appt", status: "confirmed", source: "email" },
      { person: "Sh", date: "2025-12-24", segment: "AM", type: "ADMIN", label: "Half admin",  status: "requested", source: "email" },

      { person: "Sh", date: null, segment: "TBD", type: "APPT", label: "Dentist appt (not finalized)", status: "tentative", source: "email" },

      /* NEW FROM E (email) */
      { person: "E",  date: "2025-12-24", segment: "PM",  type: "NOTE", label: "Academic half day", status: "requested", source: "email" },
      { person: "E",  date: "2026-01-06", segment: "ALL", type: "VAC",  label: "Vacation", status: "confirmed", source: "email" },
      { person: "E",  date: "2026-01-07", segment: "ALL", type: "VAC",  label: "Vacation", status: "confirmed", source: "email" },
      { person: "E",  date: "2026-01-08", segment: "ALL", type: "VAC",  label: "Vacation", status: "confirmed", source: "email" },
      { person: "E",  date: "2026-01-09", segment: "ALL", type: "VAC",  label: "Vacation", status: "confirmed", source: "email" }
    ],

    rolePlan: {}
  };

  const DAY = 24 * 60 * 60 * 1000;
  const dowNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  const weekdays = ["Mon","Tue","Wed","Thu","Fri"];

  function parseISO(iso){ return new Date(iso + "T00:00:00Z"); }
  function isoDate(d){
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth()+1).padStart(2,"0");
    const da = String(d.getUTCDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function addDays(d, n){ return new Date(d.getTime() + n * DAY); }
  function dayName(iso){ return dowNames[parseISO(iso).getUTCDay()]; }
  function formatDateLong(iso){
    return parseISO(iso).toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric", year:"numeric", timeZone:"UTC" });
  }
  function formatWeekLabel(weekStartISO){
    const start = parseISO(weekStartISO);
    const end = addDays(start, 4);
    const opts = { month:"short", day:"numeric", timeZone:"UTC" };
    const a = start.toLocaleDateString(undefined, opts);
    const b = end.toLocaleDateString(undefined, opts);
    const y = end.getUTCFullYear();
    return `Week of ${a} – ${b}, ${y}`;
  }

  function loadData(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredClone(defaultData);
      const parsed = JSON.parse(raw);
      return {
        ...structuredClone(defaultData),
        ...parsed,
        meta: { ...structuredClone(defaultData.meta), ...(parsed.meta||{}) },
        people: parsed.people || structuredClone(defaultData.people),
        closedDates: parsed.closedDates || structuredClone(defaultData.closedDates),
        events: parsed.events || structuredClone(defaultData.events),
        rolePlan: parsed.rolePlan || {}
      };
    } catch {
      return structuredClone(defaultData);
    }
  }
  function saveData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

  let data = loadData();

  const ABSENT_TYPES = new Set(["VAC","AWAY","SICK"]);
  const NOTE_TYPES = new Set(["NOTE","ADMIN","APPT","SICK"]);

  function isPending(ev){ return ev.status === "requested" || ev.status === "tentative"; }

  function closedLabelForDate(iso){
    const hit = (data.closedDates || []).find(x => x.date === iso);
    return hit ? hit.label : null;
  }

  function eventsForDate(iso){
    return (data.events || []).filter(e => e.date === iso);
  }

  function eventsForPersonDate(person, iso){
    return (data.events || []).filter(e => e.person === person && e.date === iso);
  }

  function allPeople(){
    return (data.people || []).map(p => p.name);
  }

  function absentPeopleForDate(iso){
    const closed = closedLabelForDate(iso);
    if(closed) return new Set(allPeople());

    const absent = new Set();
    for(const p of allPeople()){
      const evs = eventsForPersonDate(p, iso);
      for(const e of evs){
        if(e.segment === "ALL" && ABSENT_TYPES.has(e.type)){
          absent.add(p);
        }
      }
    }
    return absent;
  }

  function notesForDate(iso){
    const out = [];
    for(const e of eventsForDate(iso)){
      if(e.segment === "NOTE" || e.segment === "TBD" || (NOTE_TYPES.has(e.type) && e.segment !== "ALL")){
        out.push(e);
      }
    }
    return out;
  }

  function availabilitySummary(iso){
    const closed = closedLabelForDate(iso);
    const absent = absentPeopleForDate(iso);
    const present = allPeople().filter(p => !absent.has(p));
    const notes = notesForDate(iso);
    return { closed, absent: [...absent], present, notes };
  }

  const ROLE_ORDER = ["IR","Fluoro","MSK","US"];
  const ROLE_COLORS = {
    IR: "var(--r-ir)",
    Fluoro: "var(--r-fluoro)",
    MSK: "var(--r-msk)",
    US: "var(--r-us)",
    Float: "var(--r-float)",
    Absent: "var(--r-absent)"
  };

  function pickFirst(list, usedSet){
    for(const x of list){
      if(x && !usedSet.has(x)) return x;
    }
    return null;
  }

  function autoAssignForDate(iso){
    const { closed, absent, present } = availabilitySummary(iso);

    const base = {
      date: iso,
      roles: { IR:null, Fluoro:null, MSK:null, US:null },
      Float: [],
      Absent: absent.slice().sort()
    };

    if(closed){
      return { ...base, closed: true, closedLabel: closed };
    }

    const presentSet = new Set(present);
    const used = new Set();

    if(presentSet.has("Sc")){
      base.roles.IR = "Sc";
      used.add("Sc");
    }

    const corePool = ["P","R","E"];
    const floatPref = ["Sh","J"];
    const fallback = present.filter(p => !floatPref.includes(p));

    if(!base.roles.IR){
      const pick = pickFirst(corePool.filter(p=>presentSet.has(p)), used)
        || pickFirst(fallback.filter(p=>presentSet.has(p)), used)
        || pickFirst(floatPref.filter(p=>presentSet.has(p)), used)
        || pickFirst(present, used);
      base.roles.IR = pick;
      if(pick) used.add(pick);
    }

    const desired = { Fluoro:"P", MSK:"R", US:"E" };
    for(const role of ["Fluoro","MSK","US"]){
      const want = desired[role];
      if(want && presentSet.has(want) && !used.has(want)){
        base.roles[role] = want;
        used.add(want);
      }
    }

    for(const role of ["Fluoro","MSK","US"]){
      if(base.roles[role]) continue;

      const nonFloat = present.filter(p => !floatPref.includes(p) && !used.has(p));
      const pick =
        pickFirst(nonFloat, used)
        || pickFirst(floatPref.filter(p=>presentSet.has(p)), used)
        || pickFirst(present, used);

      base.roles[role] = pick;
      if(pick) used.add(pick);
    }

    base.Float = present.filter(p => !used.has(p)).sort((a,b)=>{
      const w = (x)=> (x==="Sh"||x==="J") ? 0 : 1;
      return w(a)-w(b) || a.localeCompare(b);
    });

    return base;
  }

  function getPlanForDate(iso){
    const saved = data.rolePlan?.[iso];
    if(saved){
      return {
        date: iso,
        roles: { IR: saved.roles?.IR || null, Fluoro: saved.roles?.Fluoro || null, MSK: saved.roles?.MSK || null, US: saved.roles?.US || null },
        Float: Array.isArray(saved.Float) ? saved.Float.slice() : [],
        Absent: Array.isArray(saved.Absent) ? saved.Absent.slice() : [],
        closed: !!saved.closed,
        closedLabel: saved.closedLabel || null
      };
    }
    return autoAssignForDate(iso);
  }

  function setPlanForDate(iso, plan){
    if(!data.rolePlan) data.rolePlan = {};
    data.rolePlan[iso] = plan;
    saveData(data);
  }

  let weekIndex = 0;
  function currentWeekStart(){
    const list = data.meta.weekStarts || [];
    weekIndex = Math.max(0, Math.min(weekIndex, list.length-1));
    return list[weekIndex];
  }
  function weekDates(weekStartISO){
    const start = parseISO(weekStartISO);
    const out = [];
    for(let i=0;i<7;i++){
      const iso = isoDate(addDays(start, i));
      if(weekdays.includes(dayName(iso))) out.push(iso);
    }
    return out;
  }

  const elWeekLabel = document.getElementById("weekLabel");
  const elRangeLabel = document.getElementById("rangeLabel");
  const elWeekGrid = document.getElementById("weekGrid");
  const elUnscheduledHint = document.getElementById("unscheduledHint");

  function esc(s){
    return String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function pill(color){
    return `<span class="slotPill" style="background:${color}"></span>`;
  }

  function chip(ev){
    const cls = (ev.type||"").toLowerCase();
    const pending = isPending(ev) ? " pending" : "";
    return `<span class="chip ${cls}${pending}" title="${esc([ev.type, ev.segment, ev.status, ev.source].filter(Boolean).join(" • "))}">${esc(ev.person)}: ${esc(ev.label)}${isPending(ev) ? " (pending)" : ""}</span>`;
  }

  function render(){
    elRangeLabel.textContent = `${formatDateLong(data.meta.rangeStart)} – ${formatDateLong(data.meta.rangeEnd)}`;

    const ws = currentWeekStart();
    elWeekLabel.textContent = formatWeekLabel(ws);

    const unscheduled = (data.events || []).filter(e => !e.date);
    elUnscheduledHint.textContent = unscheduled.length
      ? `Unscheduled items: ${unscheduled.map(e => `${e.person}: ${e.label}`).join(" • ")}`
      : "";

    const dates = weekDates(ws);

    let html = "";
    for(const iso of dates){
      const avail = availabilitySummary(iso);
      const plan = getPlanForDate(iso);

      const headerLeft = `
        <div>
          <div class="d1">${esc(dayName(iso))}</div>
          <div class="d2">${esc(formatDateLong(iso).replace(/^[A-Za-z]{3},\s/,""))}</div>
        </div>
      `;
      const headerRight = avail.closed ? `<div class="badgeClosed">Closed</div>` : "";

      const roleLine = (role, person) => {
        const color = ROLE_COLORS[role];
        const value = person ? `<div class="slotValue">${esc(person)}</div>` : `<div class="slotValue muted">—</div>`;
        return `
          <div class="slot">
            <div class="slotLeft">${pill(color)}<div class="slotLabel">${esc(role)}</div></div>
            ${value}
          </div>
        `;
      };

      const listLine = (role, people) => {
        const color = ROLE_COLORS[role];
        const chips = (people && people.length)
          ? people.map(p => `<span class="chip" style="border-color: rgba(255,255,255,.12); background: rgba(255,255,255,.05);">${esc(p)}</span>`).join("")
          : `<span class="slotValue muted">—</span>`;
        return `
          <div class="slot">
            <div class="slotLeft">${pill(color)}<div class="slotLabel">${esc(role)}</div></div>
            <div class="slotValueWrap">${chips}</div>
          </div>
        `;
      };

      const noteChips = (avail.notes || []).length
        ? `<div class="slot" style="justify-content:flex-start; gap:8px;">
             <div class="slotLeft">${pill("var(--c-note)")}<div class="slotLabel">Notes</div></div>
             <div class="slotValueWrap" style="justify-content:flex-start;">${avail.notes.slice(0,4).map(chip).join("")}${avail.notes.length>4?`<span class="chip note">+${avail.notes.length-4}</span>`:""}</div>
           </div>`
        : "";

      const payload = encodeURIComponent(JSON.stringify({ iso }));

      html += `
        <div class="dayCard" data-payload="${payload}">
          <div class="dayHeader">
            ${headerLeft}
            ${headerRight}
          </div>
          <div class="slots">
            ${roleLine("IR", plan.roles.IR)}
            ${roleLine("Fluoro", plan.roles.Fluoro)}
            ${roleLine("MSK", plan.roles.MSK)}
            ${roleLine("US", plan.roles.US)}
            ${listLine("Float", plan.Float || [])}
            ${listLine("Absent", (avail.closed ? allPeople() : plan.Absent || []))}
            ${noteChips}
          </div>
        </div>
      `;
    }

    elWeekGrid.innerHTML = html;

    document.querySelectorAll(".dayCard").forEach(card => {
      card.addEventListener("click", () => {
        const { iso } = JSON.parse(decodeURIComponent(card.dataset.payload));
        openDayEditor(iso);
      });
    });
  }

  document.getElementById("autoWeek").addEventListener("click", () => {
    const ws = currentWeekStart();
    const dates = weekDates(ws);
    for(const iso of dates){
      const plan = autoAssignForDate(iso);
      setPlanForDate(iso, plan);
    }
    render();
  });

  document.getElementById("clearWeek").addEventListener("click", () => {
    const ws = currentWeekStart();
    const dates = weekDates(ws);
    for(const iso of dates){
      if(data.rolePlan && data.rolePlan[iso]) delete data.rolePlan[iso];
    }
    saveData(data);
    render();
  });

  document.getElementById("prevWeek").addEventListener("click", () => {
    weekIndex = Math.max(0, weekIndex - 1);
    render();
  });
  document.getElementById("nextWeek").addEventListener("click", () => {
    const max = (data.meta.weekStarts || []).length - 1;
    weekIndex = Math.min(max, weekIndex + 1);
    render();
  });
  window.addEventListener("keydown", (e) => {
    if(e.key === "ArrowLeft"){ weekIndex = Math.max(0, weekIndex - 1); render(); }
    if(e.key === "ArrowRight"){
      const max = (data.meta.weekStarts || []).length - 1;
      weekIndex = Math.min(max, weekIndex + 1);
      render();
    }
  });

  const dayBackdrop = document.getElementById("dayBackdrop");
  const dayTitle = document.getElementById("dayTitle");
  const dayNotes = document.getElementById("dayNotes");
  const dayWarnings = document.getElementById("dayWarnings");
  const fIR = document.getElementById("fIR");
  const fFluoro = document.getElementById("fFluoro");
  const fMSK = document.getElementById("fMSK");
  const fUS = document.getElementById("fUS");
  const fFloat = document.getElementById("fFloat");
  const fAbsent = document.getElementById("fAbsent");

  let editingISO = null;
  let editingPlan = null;

  function setSelectOptions(sel, people, allowEmpty=true){
    sel.innerHTML = "";
    if(allowEmpty){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "—";
      sel.appendChild(opt);
    }
    for(const p of people){
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      sel.appendChild(opt);
    }
  }

  function toggleMulti(container, people, selectedSet){
    container.innerHTML = "";
    for(const p of people){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "miniBtn" + (selectedSet.has(p) ? " on" : "");
      b.textContent = p;
      b.addEventListener("click", () => {
        if(selectedSet.has(p)) selectedSet.delete(p);
        else selectedSet.add(p);
        toggleMulti(container, people, selectedSet);
      });
      container.appendChild(b);
    }
  }

  function openDayEditor(iso){
    editingISO = iso;

    const avail = availabilitySummary(iso);
    const plan = structuredClone(getPlanForDate(iso));
    editingPlan = plan;

    dayTitle.textContent = `Edit • ${formatDateLong(iso)}`;

    const people = allPeople();

    setSelectOptions(fIR, people);
    setSelectOptions(fFluoro, people);
    setSelectOptions(fMSK, people);
    setSelectOptions(fUS, people);

    fIR.value = plan.roles.IR || "";
    fFluoro.value = plan.roles.Fluoro || "";
    fMSK.value = plan.roles.MSK || "";
    fUS.value = plan.roles.US || "";

    const floatSet = new Set(plan.Float || []);
    const absentSet = new Set(plan.Absent || []);

    toggleMulti(fFloat, people, floatSet);
    toggleMulti(fAbsent, people, absentSet);

    const notes = avail.notes || [];
    const closed = avail.closed;
    const absent = avail.absent || [];
    dayNotes.innerHTML = `
      <div class="small"><b>Present:</b> ${esc(avail.present.join(", ") || "—")}</div>
      <div class="small" style="margin-top:6px;"><b>Absent:</b> ${esc(absent.join(", ") || "—")}${closed ? ` <span class="chip" style="border-color: rgba(148,163,184,.45); background: rgba(148,163,184,.12); margin-left:6px;">Closed</span>` : ""}</div>
      <div class="hr"></div>
      <div class="small"><b>Notes:</b></div>
      <div style="margin-top:6px; display:flex; flex-wrap:wrap; gap:8px;">
        ${notes.length ? notes.map(chip).join("") : `<span class="small">None</span>`}
      </div>
    `;

    function recomputeWarnings(){
      const presentSet = new Set(avail.present);
      const roleVals = {
        IR: fIR.value || null,
        Fluoro: fFluoro.value || null,
        MSK: fMSK.value || null,
        US: fUS.value || null
      };

      const issues = [];

      if(closed){
        issues.push("Day is closed. Assignments are optional.");
      } else {
        for(const r of ROLE_ORDER){
          if(!roleVals[r]) issues.push(`${r} is unassigned.`);
          else if(!presentSet.has(roleVals[r])) issues.push(`${r} assigned to ${roleVals[r]} but they are marked absent.`);
        }

        const used = {};
        for(const [r,p] of Object.entries(roleVals)){
          if(!p) continue;
          used[p] = used[p] ? [...used[p], r] : [r];
        }
        for(const [p,roles] of Object.entries(used)){
          if(roles.length > 1) issues.push(`${p} assigned to multiple roles: ${roles.join(", ")}.`);
        }
      }

      dayWarnings.textContent = issues.length ? issues.join(" ") : "No issues detected.";
    }

    const syncFromUI = () => {
      const floatNow = [...fFloat.querySelectorAll(".miniBtn.on")].map(b => b.textContent);
      const absentNow = [...fAbsent.querySelectorAll(".miniBtn.on")].map(b => b.textContent);
      editingPlan.roles = {
        IR: fIR.value || null,
        Fluoro: fFluoro.value || null,
        MSK: fMSK.value || null,
        US: fUS.value || null
      };
      editingPlan.Float = floatNow;
      editingPlan.Absent = absentNow;
    };

    [fIR,fFluoro,fMSK,fUS].forEach(sel => sel.addEventListener("change", () => { syncFromUI(); recomputeWarnings(); }));
    dayBackdrop.addEventListener("click", (e) => {
      if(e.target.classList && e.target.classList.contains("miniBtn")){
        setTimeout(() => { syncFromUI(); recomputeWarnings(); }, 0);
      }
    });

    syncFromUI();
    recomputeWarnings();

    dayBackdrop.style.display = "flex";
  }

  document.getElementById("closeDay").addEventListener("click", () => dayBackdrop.style.display = "none");
  dayBackdrop.addEventListener("click", (e) => { if(e.target === dayBackdrop) dayBackdrop.style.display = "none"; });

  document.getElementById("autoDay").addEventListener("click", () => {
    if(!editingISO) return;
    editingPlan = autoAssignForDate(editingISO);
    openDayEditor(editingISO);
  });

  document.getElementById("clearDay").addEventListener("click", () => {
    if(!editingISO) return;
    if(data.rolePlan && data.rolePlan[editingISO]) delete data.rolePlan[editingISO];
    saveData(data);
    dayBackdrop.style.display = "none";
    render();
  });

  document.getElementById("saveDay").addEventListener("click", () => {
    if(!editingISO || !editingPlan) return;
    setPlanForDate(editingISO, editingPlan);
    dayBackdrop.style.display = "none";
    render();
  });

  window.addEventListener("keydown", (e) => {
    if(e.key !== "Escape") return;
    if(dayBackdrop.style.display === "flex") dayBackdrop.style.display = "none";
    if(editorBackdrop.style.display === "flex") editorBackdrop.style.display = "none";
    if(exportBackdrop.style.display === "flex") exportBackdrop.style.display = "none";
  });

  const editorBackdrop = document.getElementById("editorBackdrop");
  const jsonEditor = document.getElementById("jsonEditor");
  const editorMsg = document.getElementById("editorMsg");
  const openEditorBtn = document.getElementById("openEditor");
  const closeEditorBtn = document.getElementById("closeEditor");
  const saveChangesBtn = document.getElementById("saveChanges");
  const discardChangesBtn = document.getElementById("discardChanges");
  const resetDataBtn = document.getElementById("resetData");

  let editorOriginal = "";

  function openEditorModal(){
    editorOriginal = JSON.stringify(data, null, 2);
    jsonEditor.value = editorOriginal;
    editorMsg.textContent = "Edits are stored in this browser (local storage).";
    editorBackdrop.style.display = "flex";
    jsonEditor.focus();
  }

  openEditorBtn.addEventListener("click", openEditorModal);
  closeEditorBtn.addEventListener("click", () => editorBackdrop.style.display = "none");
  editorBackdrop.addEventListener("click", (e) => { if(e.target === editorBackdrop) editorBackdrop.style.display = "none"; });

  discardChangesBtn.addEventListener("click", () => {
    jsonEditor.value = editorOriginal;
    editorMsg.textContent = "Discarded changes (not saved).";
  });

  resetDataBtn.addEventListener("click", () => {
    data = structuredClone(defaultData);
    saveData(data);
    editorOriginal = JSON.stringify(data, null, 2);
    jsonEditor.value = editorOriginal;
    editorMsg.textContent = "Reset to default and saved.";
    render();
  });

  saveChangesBtn.addEventListener("click", () => {
    try{
      const parsed = JSON.parse(jsonEditor.value);
      if(!parsed.meta || !parsed.people || !parsed.events || !parsed.closedDates){
        throw new Error("Missing required keys: meta, people, events, closedDates");
      }
      if(!parsed.rolePlan) parsed.rolePlan = {};
      data = parsed;
      saveData(data);
      editorOriginal = JSON.stringify(data, null, 2);
      editorMsg.textContent = "Saved.";
      render();
    } catch(err){
      editorMsg.textContent = "Error: " + err.message;
    }
  });

  const exportBackdrop = document.getElementById("exportBackdrop");
  const exportMenuBtn = document.getElementById("exportMenuBtn");
  const closeExportBtn = document.getElementById("closeExport");
  const exportConfigJsonBtn = document.getElementById("exportConfigJson");
  const exportExpandedCsvBtn = document.getElementById("exportExpandedCsv");
  const exportExpandedJsonBtn = document.getElementById("exportExpandedJson");

  exportMenuBtn.addEventListener("click", () => exportBackdrop.style.display = "flex");
  closeExportBtn.addEventListener("click", () => exportBackdrop.style.display = "none");
  exportBackdrop.addEventListener("click", (e) => { if(e.target === exportBackdrop) exportBackdrop.style.display = "none"; });

  function downloadFile(filename, content, mime){
    const blob = new Blob([content], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }

  exportConfigJsonBtn.addEventListener("click", () => {
    downloadFile("rotation_config.json", JSON.stringify(data, null, 2), "application/json");
  });

  function rangeDatesWeekdays(){
    const start = parseISO(data.meta.rangeStart);
    const end = parseISO(data.meta.rangeEnd);
    const out = [];
    for(let t = start.getTime(); t <= end.getTime(); t += DAY){
      const iso = isoDate(new Date(t));
      if(weekdays.includes(dayName(iso))) out.push(iso);
    }
    return out;
  }

  function expandedRows(){
    const dates = rangeDatesWeekdays();
    const rows = [];
    for(const iso of dates){
      const avail = availabilitySummary(iso);
      const plan = getPlanForDate(iso);
      rows.push({
        date: iso,
        weekday: dayName(iso),
        closed: !!avail.closed,
        IR: plan.roles.IR || "",
        Fluoro: plan.roles.Fluoro || "",
        MSK: plan.roles.MSK || "",
        US: plan.roles.US || "",
        Float: (plan.Float || []).join(" "),
        Absent: (avail.closed ? allPeople() : (plan.Absent || [])).join(" "),
        notes: (avail.notes || []).map(e => `${e.person}:${e.label}${isPending(e) ? "[pending]" : ""}`).join(" | ")
      });
    }
    return rows;
  }

  function toCSV(rows){
    const headers = ["date","weekday","closed","IR","Fluoro","MSK","US","Float","Absent","notes"];
    const escCSV = (v) => {
      const s = String(v ?? "");
      if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    };
    const lines = [];
    lines.push(headers.join(","));
    for(const r of rows){
      lines.push(headers.map(h => escCSV(r[h])).join(","));
    }
    return lines.join("\n");
  }

  exportExpandedCsvBtn.addEventListener("click", () => {
    downloadFile("rotation_expanded_weekdays.csv", toCSV(expandedRows()), "text/csv");
  });

  exportExpandedJsonBtn.addEventListener("click", () => {
    downloadFile("rotation_expanded_weekdays.json", JSON.stringify(expandedRows(), null, 2), "application/json");
  });

  render();
})();
</script>
</body>
</html>