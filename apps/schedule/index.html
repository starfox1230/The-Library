<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rotation Roles (Dec 15, 2025 – Jan 9, 2026)</title>
  <style>
    :root{
      --bg0:#0b1020;
      --bg1:#0f1630;
      --panel:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.12);
      --text:#e9eefc;
      --muted:rgba(233,238,252,.72);
      --shadow: 0 18px 45px rgba(0,0,0,.35);

      /* role colors */
      --r-ir:#60a5fa;
      --r-fluoro:#22c55e;
      --r-msk:#a78bfa;
      --r-us:#f59e0b;
      --r-float:#38bdf8;
      --r-absent:#ef4444;
      --r-closed:#94a3b8;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(96,165,250,.16), transparent 60%),
        radial-gradient(1100px 700px at 85% 0%, rgba(167,139,250,.12), transparent 55%),
        radial-gradient(1000px 700px at 70% 90%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .app{max-width:1280px;margin:18px auto 28px;padding:0 14px;}

    .topbar{
      position:sticky;top:0;z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,16,32,.92), rgba(11,16,32,.55));
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: 0 14px 34px rgba(0,0,0,.25);
      border-radius: 22px;
      padding: 12px 12px 10px;
      margin-bottom: 14px;
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .brand{display:flex;align-items:center;gap:10px;min-width:260px;}
    .logo{
      width:38px;height:38px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), transparent 45%),
        linear-gradient(135deg, rgba(96,165,250,.70), rgba(167,139,250,.55));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 14px 30px rgba(0,0,0,.28);
    }
    .title{line-height:1.1;}
    .title h1{font-size:14px;letter-spacing:.2px;margin:0;font-weight:700;}
    .title .sub{font-size:12px;color:var(--muted);margin-top:2px;}

    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end;}

    .btn{
      appearance:none;border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 8px 10px;border-radius: 14px;
      font-weight: 650;font-size: 12px;letter-spacing:.2px;
      cursor:pointer;user-select:none;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      display:inline-flex;align-items:center;gap:8px;
    }
    .btn:hover{ background: rgba(255,255,255,.085); border-color: rgba(255,255,255,.18); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.45), rgba(167,139,250,.35));
      border-color: rgba(255,255,255,.18);
    }
    .btn.danger{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.25);
    }
    .btn.ghost{background:transparent;}

    .pill{
      display:inline-flex;align-items:center;gap:6px;
      font-size: 12px;color: var(--muted);
      padding: 8px 10px;border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;background: rgba(255,255,255,.04);
    }

    .panel{
      background: var(--panel);
      border: 1px solid rgba(255,255,255,.09);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .legend{
      padding: 10px 12px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }
    .legend .left{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding: 6px 8px;border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-size: 11px;color: var(--muted);white-space:nowrap;
    }
    .dot{width:9px;height:9px;border-radius:99px;background:rgba(255,255,255,.4);box-shadow:0 0 0 3px rgba(255,255,255,.06);}

    .metaLine{
      margin-top: 8px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
    }

    .weekGrid{
      display:grid;
      grid-template-columns: repeat(5, minmax(220px, 1fr));
      gap: 12px;
      padding: 12px;
    }
    @media (max-width: 1200px){ .weekGrid{ grid-template-columns: repeat(3, minmax(220px, 1fr)); } }
    @media (max-width: 820px){ .weekGrid{ grid-template-columns: repeat(2, minmax(220px, 1fr)); } }
    @media (max-width: 560px){ .weekGrid{ grid-template-columns: 1fr; } }

    .dayCard{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      overflow:hidden;
      box-shadow: 0 14px 30px rgba(0,0,0,.22);
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
    }
    .dayCard:hover{ background: rgba(255,255,255,.05); border-color: rgba(255,255,255,.16); }
    .dayCard:active{ transform: translateY(1px); }

    .dayHeader{
      padding: 10px 12px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
    }
    .dayHeader .d1{font-weight:850;font-size:12px;letter-spacing:.2px;}
    .dayHeader .d2{font-size:12px;color:var(--muted);margin-top:2px;}
    .badgeClosed{
      padding: 6px 8px;border-radius:999px;
      border: 1px solid rgba(148,163,184,.40);
      background: rgba(148,163,184,.12);
      color: rgba(233,238,252,.90);
      font-size: 11px;
      font-weight: 800;
      letter-spacing:.2px;
      white-space:nowrap;
    }

    .slots{padding: 10px 12px 12px;display:grid;gap:8px;}
    .slot{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      padding: 8px 10px;
    }
    .slotLeft{display:flex;align-items:center;gap:10px;min-width:0;}
    .slotPill{
      width:10px;height:10px;border-radius:99px;
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
      flex: 0 0 auto;
    }
    .slotLabel{
      font-size: 11px;
      letter-spacing:.9px;
      text-transform: uppercase;
      color: rgba(233,238,252,.76);
      flex: 0 0 auto;
    }
    .slotValueWrap{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap;}
    .slotValue{font-size: 12px;font-weight: 900;letter-spacing:.2px;}
    .slotValue.muted{color: rgba(233,238,252,.55); font-weight: 750;}

    .halfChip{
      display:inline-flex;align-items:center;gap:6px;
      padding: 6px 8px;border-radius: 999px;
      font-size: 11px;font-weight: 900;letter-spacing:.2px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      white-space:nowrap;
    }
    .halfChip .k{
      display:inline-flex;align-items:center;justify-content:center;
      width:18px;height:18px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.12);
      font-size: 10px;
      color: rgba(233,238,252,.85);
      font-weight: 950;
    }

    .chip{
      display:inline-flex;align-items:center;gap:6px;
      padding: 6px 8px;border-radius: 999px;
      font-size: 11px;font-weight: 900;letter-spacing:.2px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      white-space:nowrap;
    }

    /* modals */
    .modalBackdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      z-index: 50; padding: 16px;
    }
    .modal{
      width: min(1020px, 100%);
      border-radius: 22px;
      background: rgba(15,22,48,.92);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 26px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHeader{
      padding: 12px 14px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .modalHeader .h{font-weight: 900; font-size: 13px; letter-spacing:.2px;}
    .modalBody{padding: 12px 14px 14px;}

    textarea.json{
      width: 100%;
      height: 440px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.5;
      outline:none;
      resize: vertical;
    }

    .grid2{display:grid;grid-template-columns: 1.15fr .85fr;gap: 12px;}
    @media (max-width: 960px){ .grid2{ grid-template-columns: 1fr; } }

    .card{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
    }
    .card h3{margin:0 0 10px;font-size:12px;letter-spacing:.2px;color: rgba(233,238,252,.88);}
    .small{font-size: 12px;color: var(--muted);line-height:1.45;}
    .hr{height:1px;background: rgba(255,255,255,.10);margin: 10px 0;}

    .formGrid{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap: 10px 12px;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
    }
    select{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 12px;
      outline: none;
    }
    select:focus{
      border-color: rgba(96,165,250,.55);
      box-shadow: 0 0 0 3px rgba(96,165,250,.18);
    }

    .miniRow{display:flex;flex-wrap:wrap;gap:8px;}
    .miniBtn{
      appearance:none;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 6px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
    }
    .miniBtn.on{
      border-color: rgba(239,68,68,.45);
      background: rgba(239,68,68,.10);
    }
    .miniBtn.half{
      border-style:dashed;
      border-color: rgba(239,68,68,.45);
      background: rgba(239,68,68,.08);
    }

    .halfHeader{
      display:flex;align-items:center;justify-content:space-between;
      padding: 8px 10px;border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      margin-bottom: 10px;
    }
    .halfHeader .t{font-size:12px;font-weight:950;letter-spacing:.2px;color:rgba(233,238,252,.90);}
    .halfHeader .p{font-size:12px;color:var(--muted);}

  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="row">
        <div class="brand">
          <div class="logo"></div>
          <div class="title">
            <h1>Rotation Roles</h1>
            <div class="sub" id="rangeLabel">Dec 15, 2025 – Jan 9, 2026</div>
          </div>
        </div>

        <div class="controls">
          <button class="btn ghost" id="prevWeek" title="Previous week (←)">←</button>
          <div class="pill" id="weekLabel">Week of …</div>
          <button class="btn ghost" id="nextWeek" title="Next week (→)">→</button>

          <button class="btn" id="autoWeek">Auto-fill week</button>
          <button class="btn danger" id="clearWeek">Clear week</button>

          <button class="btn primary" id="exportMenuBtn">Export</button>
          <button class="btn" id="openEditor">Edit data</button>
        </div>
      </div>

      <div class="metaLine">
        <div id="hint">Click a day to edit assignments and AM/PM absences. Use ←/→ to switch weeks.</div>
        <div id="overrideHint"></div>
      </div>
    </div>

    <div class="panel">
      <div class="legend">
        <div class="left">
          <span class="tag"><span class="dot" style="background:var(--r-ir)"></span> IR</span>
          <span class="tag"><span class="dot" style="background:var(--r-fluoro)"></span> Fluoro</span>
          <span class="tag"><span class="dot" style="background:var(--r-msk)"></span> MSK Proc</span>
          <span class="tag"><span class="dot" style="background:var(--r-us)"></span> US Proc</span>
          <span class="tag"><span class="dot" style="background:var(--r-float)"></span> Float</span>
          <span class="tag"><span class="dot" style="background:var(--r-absent)"></span> Absent</span>
          <span class="tag"><span class="dot" style="background:var(--r-closed)"></span> Closed</span>
        </div>
        <div style="color:var(--muted); font-size:12px;">
          AM/PM scheduling is always available (defaults to same person both halves).
        </div>
      </div>

      <div class="weekGrid" id="weekGrid"></div>
    </div>
  </div>

  <!-- Export menu -->
  <div class="modalBackdrop" id="exportBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="h">Export</div>
        <button class="btn" id="closeExport">Close</button>
      </div>
      <div class="modalBody">
        <div class="grid2">
          <div class="card">
            <h3>Config export (re-import / editing)</h3>
            <div class="small">Downloads editable data (closures + base absences + overrides + role plan).</div>
            <div class="hr"></div>
            <button class="btn primary" id="exportConfigJson">Download config JSON</button>
          </div>

          <div class="card">
            <h3>Expanded export (weekday, half-day)</h3>
            <div class="small">Downloads flattened schedule for every weekday in range, with AM/PM columns.</div>
            <div class="hr"></div>
            <button class="btn" id="exportExpandedCsv">Download expanded CSV</button>
            <button class="btn" id="exportExpandedJson" style="margin-left:6px;">Download expanded JSON</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JSON editor -->
  <div class="modalBackdrop" id="editorBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="h">Edit data (JSON)</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn" id="resetData">Reset to default</button>
          <button class="btn danger" id="discardChanges">Discard</button>
          <button class="btn primary" id="saveChanges">Save</button>
          <button class="btn" id="closeEditor">Close</button>
        </div>
      </div>
      <div class="modalBody">
        <textarea class="json" id="jsonEditor" spellcheck="false"></textarea>
        <div class="small" id="editorMsg" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <!-- Day editor -->
  <div class="modalBackdrop" id="dayBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="h" id="dayTitle">Edit day</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <button class="btn" id="autoDay">Auto-fill day</button>
          <button class="btn danger" id="clearDay">Clear day</button>
          <button class="btn primary" id="saveDay">Save</button>
          <button class="btn" id="closeDay">Close</button>
        </div>
      </div>
      <div class="modalBody">
        <div class="grid2">
          <div class="card">
            <h3>AM / PM role assignments</h3>

            <div class="halfHeader">
              <div class="t">AM</div>
              <div class="p" id="amPresence">—</div>
            </div>
            <div class="formGrid" style="margin-bottom:12px;">
              <div>IR</div><select id="amIR"></select>
              <div>Fluoro</div><select id="amFluoro"></select>
              <div>MSK Proc</div><select id="amMSK"></select>
              <div>US Proc</div><select id="amUS"></select>
              <div>Float</div><div class="miniRow" id="amFloat"></div>
              <div>Absent</div><div class="miniRow" id="amAbsent"></div>
            </div>

            <div class="halfHeader">
              <div class="t">PM</div>
              <div class="p" id="pmPresence">—</div>
            </div>
            <div class="formGrid">
              <div>IR</div><select id="pmIR"></select>
              <div>Fluoro</div><select id="pmFluoro"></select>
              <div>MSK Proc</div><select id="pmMSK"></select>
              <div>US Proc</div><select id="pmUS"></select>
              <div>Float</div><div class="miniRow" id="pmFloat"></div>
              <div>Absent</div><div class="miniRow" id="pmAbsent"></div>
            </div>

            <div class="hr"></div>
            <div class="small" id="dayWarnings"></div>
          </div>

          <div class="card">
            <h3>AM / PM absences (edit)</h3>
            <div class="small">Toggle a person absent for AM and/or PM. This updates <b>availabilityOverrides</b> for the day (does not delete your base absences).</div>
            <div class="hr"></div>

            <div class="small" style="margin-bottom:6px;"><b>AM</b></div>
            <div class="miniRow" id="absToggleAM"></div>

            <div class="hr"></div>

            <div class="small" style="margin-bottom:6px;"><b>PM</b></div>
            <div class="miniRow" id="absTogglePM"></div>

            <div class="hr"></div>
            <div class="small" id="overrideStatus"></div>
            <div class="small" style="margin-top:8px;">
              Tip: Closures (holiday) override everything. For closures, assignments are optional.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = "rotationScheduleData.v2_ampm";

  const defaultData = {
    meta: {
      title: "Rotation Roles",
      rangeStart: "2025-12-15",
      rangeEnd:   "2026-01-09",
      weekStarts: ["2025-12-15","2025-12-22","2025-12-29","2026-01-05"]
    },

    people: [
      { name: "Sc" },
      { name: "P"  },
      { name: "R"  },
      { name: "E"  },
      { name: "J"  },
      { name: "Sh" }
    ],

    closedDates: [
      { date: "2025-12-25", label: "Holiday (closed)" },
      { date: "2025-12-26", label: "Holiday (closed)" },
      { date: "2026-01-01", label: "Holiday (closed)" },
      { date: "2026-01-02", label: "Holiday (closed)" }
    ],

    /* Base absences (segment is AM, PM, or ALL). Types are intentionally not tracked. */
    absences: [
      /* From calendar / messages */
      { person: "Sc", date: "2025-12-22", segment: "PM", source: "calendar" },

      { person: "P",  date: "2025-12-24", segment: "ALL", source: "calendar" },

      { person: "J",  date: "2025-12-22", segment: "ALL", source: "calendar" },
      { person: "J",  date: "2025-12-23", segment: "ALL", source: "calendar" },
      { person: "J",  date: "2025-12-24", segment: "ALL", source: "calendar" },
      { person: "J",  date: "2025-12-26", segment: "ALL", source: "calendar" },

      { person: "Sh", date: "2025-12-22", segment: "AM", source: "email" },
      { person: "Sh", date: "2025-12-24", segment: "AM", source: "email" },

      { person: "R",  date: "2025-12-29", segment: "ALL", source: "email" },
      { person: "R",  date: "2025-12-30", segment: "ALL", source: "email" },
      { person: "R",  date: "2025-12-31", segment: "ALL", source: "email" },

      { person: "Sh", date: "2025-12-29", segment: "ALL", source: "email" },
      { person: "Sh", date: "2025-12-30", segment: "ALL", source: "email" },
      { person: "Sh", date: "2025-12-31", segment: "ALL", source: "email" },

      { person: "E",  date: "2025-12-24", segment: "PM", source: "email" },
      { person: "E",  date: "2026-01-06", segment: "ALL", source: "email" },
      { person: "E",  date: "2026-01-07", segment: "ALL", source: "email" },
      { person: "E",  date: "2026-01-08", segment: "ALL", source: "email" },
      { person: "E",  date: "2026-01-09", segment: "ALL", source: "email" },

      /* R academic half day on Jan 6: not specified AM/PM in message, defaulting to PM (edit in overrides if needed) */
      { person: "R",  date: "2026-01-06", segment: "PM", source: "email" }
    ],

    /* Overrides you set in the day editor. Shape:
       availabilityOverrides: { "YYYY-MM-DD": { "Person": { AM: true/false, PM: true/false } } }
       where true means absent that half.
    */
    availabilityOverrides: {},

    /* rolePlan: { "YYYY-MM-DD": { AM:{roles:{...}, Float:[]}, PM:{...}, closed?:bool, closedLabel?:string } } */
    rolePlan: {}
  };

  const DAY = 24 * 60 * 60 * 1000;
  const dowNames = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  const weekdays = ["Mon","Tue","Wed","Thu","Fri"];
  const HALVES = ["AM","PM"];

  const ROLE_COLORS = {
    IR: "var(--r-ir)",
    Fluoro: "var(--r-fluoro)",
    MSK: "var(--r-msk)",
    US: "var(--r-us)",
    Float: "var(--r-float)",
    Absent: "var(--r-absent)"
  };

  function parseISO(iso){ return new Date(iso + "T00:00:00Z"); }
  function isoDate(d){
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth()+1).padStart(2,"0");
    const da = String(d.getUTCDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function addDays(d, n){ return new Date(d.getTime() + n * DAY); }
  function dayName(iso){ return dowNames[parseISO(iso).getUTCDay()]; }
  function formatDateLong(iso){
    return parseISO(iso).toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric", year:"numeric", timeZone:"UTC" });
  }
  function formatWeekLabel(weekStartISO){
    const start = parseISO(weekStartISO);
    const end = addDays(start, 4);
    const opts = { month:"short", day:"numeric", timeZone:"UTC" };
    const a = start.toLocaleDateString(undefined, opts);
    const b = end.toLocaleDateString(undefined, opts);
    const y = end.getUTCFullYear();
    return `Week of ${a} – ${b}, ${y}`;
  }

  function structuredCloneSafe(x){ return JSON.parse(JSON.stringify(x)); }

  function loadData(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredCloneSafe(defaultData);
      const parsed = JSON.parse(raw);
      return {
        ...structuredCloneSafe(defaultData),
        ...parsed,
        meta: { ...structuredCloneSafe(defaultData.meta), ...(parsed.meta||{}) },
        people: parsed.people || structuredCloneSafe(defaultData.people),
        closedDates: parsed.closedDates || structuredCloneSafe(defaultData.closedDates),
        absences: parsed.absences || structuredCloneSafe(defaultData.absences),
        availabilityOverrides: parsed.availabilityOverrides || {},
        rolePlan: parsed.rolePlan || {}
      };
    } catch {
      return structuredCloneSafe(defaultData);
    }
  }
  function saveData(d){ localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); }

  let data = loadData();

  function allPeople(){ return (data.people || []).map(p => p.name); }

  function closedLabelForDate(iso){
    const hit = (data.closedDates || []).find(x => x.date === iso);
    return hit ? hit.label : null;
  }

  function baseAbsentForHalf(iso, half){
    const absent = new Set();
    for(const a of (data.absences || [])){
      if(a.date !== iso) continue;
      if(a.segment === "ALL" || a.segment === half) absent.add(a.person);
    }
    return absent;
  }

  function overrideAbsentForHalf(iso, half){
    const o = data.availabilityOverrides?.[iso] || null;
    const absent = new Set();
    if(!o) return absent;
    for(const p of Object.keys(o)){
      if(o[p]?.[half]) absent.add(p);
    }
    return absent;
  }

  function effectiveAbsentForHalf(iso, half){
    const closed = closedLabelForDate(iso);
    if(closed) return new Set(allPeople());
    const base = baseAbsentForHalf(iso, half);
    const over = overrideAbsentForHalf(iso, half);
    // Overrides add absences; you can also "un-absent" by clearing override and editing base in JSON if needed.
    // (Keeping it simple: overrides only add.)
    for(const p of over) base.add(p);
    return base;
  }

  function presentForHalf(iso, half){
    const absent = effectiveAbsentForHalf(iso, half);
    return allPeople().filter(p => !absent.has(p));
  }

  function availabilitySummary(iso){
    const closed = closedLabelForDate(iso);
    const byHalf = {};
    for(const half of HALVES){
      const absent = [...effectiveAbsentForHalf(iso, half)].sort();
      const present = presentForHalf(iso, half);
      byHalf[half] = { absent, present };
    }
    return { closed, byHalf };
  }

  function pickFirst(list, usedSet){
    for(const x of list){
      if(x && !usedSet.has(x)) return x;
    }
    return null;
  }

  function autoAssignHalf(iso, half){
    const avail = availabilitySummary(iso);
    if(avail.closed){
      return {
        roles: { IR:null, Fluoro:null, MSK:null, US:null },
        Float: [],
        Absent: allPeople().slice().sort()
      };
    }

    const present = avail.byHalf[half].present;
    const absent = avail.byHalf[half].absent;

    const presentSet = new Set(present);
    const used = new Set();

    const plan = {
      roles: { IR:null, Fluoro:null, MSK:null, US:null },
      Float: [],
      Absent: absent.slice()
    };

    // Default IR = Sc if present
    if(presentSet.has("Sc")){
      plan.roles.IR = "Sc";
      used.add("Sc");
    }

    const corePool = ["P","R","E"];
    const floatPref = ["Sh","J"];
    const fallback = present.filter(p => !floatPref.includes(p));

    if(!plan.roles.IR){
      const pick =
        pickFirst(corePool.filter(p=>presentSet.has(p)), used) ||
        pickFirst(fallback.filter(p=>presentSet.has(p)), used) ||
        pickFirst(floatPref.filter(p=>presentSet.has(p)), used) ||
        pickFirst(present, used);
      plan.roles.IR = pick;
      if(pick) used.add(pick);
    }

    // Prefer to keep Sh/J floating by assigning P/R/E to Fluoro/MSK/US when present
    const desired = { Fluoro:"P", MSK:"R", US:"E" };
    for(const role of ["Fluoro","MSK","US"]){
      const want = desired[role];
      if(want && presentSet.has(want) && !used.has(want)){
        plan.roles[role] = want;
        used.add(want);
      }
    }

    for(const role of ["Fluoro","MSK","US"]){
      if(plan.roles[role]) continue;

      const nonFloat = present.filter(p => !floatPref.includes(p) && !used.has(p));
      const pick =
        pickFirst(nonFloat, used) ||
        pickFirst(floatPref.filter(p=>presentSet.has(p)), used) ||
        pickFirst(present, used);

      plan.roles[role] = pick;
      if(pick) used.add(pick);
    }

    plan.Float = present.filter(p => !used.has(p)).sort((a,b)=>{
      const w = (x)=> (x==="Sh"||x==="J") ? 0 : 1;
      return w(a)-w(b) || a.localeCompare(b);
    });

    return plan;
  }

  function autoAssignForDate(iso){
    const avail = availabilitySummary(iso);
    const out = {
      closed: !!avail.closed,
      closedLabel: avail.closed || null,
      AM: autoAssignHalf(iso, "AM"),
      PM: autoAssignHalf(iso, "PM")
    };
    return out;
  }

  function normalizeDayPlan(plan){
    // Ensure required keys exist and values are consistent
    const normHalf = (h) => {
      const roles = h?.roles || {};
      return {
        roles: {
          IR: roles.IR || null,
          Fluoro: roles.Fluoro || null,
          MSK: roles.MSK || null,
          US: roles.US || null
        },
        Float: Array.isArray(h?.Float) ? h.Float.slice() : [],
        Absent: Array.isArray(h?.Absent) ? h.Absent.slice() : []
      };
    };
    return {
      closed: !!plan?.closed,
      closedLabel: plan?.closedLabel || null,
      AM: normHalf(plan?.AM),
      PM: normHalf(plan?.PM)
    };
  }

  function getPlanForDate(iso){
    const saved = data.rolePlan?.[iso];
    if(saved) return normalizeDayPlan(saved);
    return autoAssignForDate(iso);
  }

  function setPlanForDate(iso, plan){
    if(!data.rolePlan) data.rolePlan = {};
    data.rolePlan[iso] = normalizeDayPlan(plan);
    saveData(data);
  }

  function esc(s){
    return String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function pill(color){
    return `<span class="slotPill" style="background:${color}"></span>`;
  }

  function halfValueChip(k, v){
    const value = v ? esc(v) : "—";
    const muted = v ? "" : " style=\"opacity:.65\"";
    return `<span class="halfChip"${muted}><span class="k">${esc(k)}</span>${value}</span>`;
  }

  function listChips(list){
    if(!list || !list.length) return `<span class="slotValue muted">—</span>`;
    return list.map(p => `<span class="chip">${esc(p)}</span>`).join("");
  }

  let weekIndex = 0;
  function currentWeekStart(){
    const list = data.meta.weekStarts || [];
    weekIndex = Math.max(0, Math.min(weekIndex, list.length-1));
    return list[weekIndex];
  }

  function weekDates(weekStartISO){
    const start = parseISO(weekStartISO);
    const out = [];
    for(let i=0;i<7;i++){
      const iso = isoDate(addDays(start, i));
      if(weekdays.includes(dayName(iso))) out.push(iso);
    }
    return out;
  }

  const elWeekLabel = document.getElementById("weekLabel");
  const elRangeLabel = document.getElementById("rangeLabel");
  const elWeekGrid = document.getElementById("weekGrid");
  const elOverrideHint = document.getElementById("overrideHint");

  function render(){
    elRangeLabel.textContent = `${formatDateLong(data.meta.rangeStart)} – ${formatDateLong(data.meta.rangeEnd)}`;

    const ws = currentWeekStart();
    elWeekLabel.textContent = formatWeekLabel(ws);

    const overrideCount = Object.keys(data.availabilityOverrides || {}).length;
    elOverrideHint.textContent = overrideCount ? `Overrides set for ${overrideCount} day(s).` : "";

    const dates = weekDates(ws);
    let html = "";

    for(const iso of dates){
      const avail = availabilitySummary(iso);
      const plan = getPlanForDate(iso);

      const headerLeft = `
        <div>
          <div class="d1">${esc(dayName(iso))}</div>
          <div class="d2">${esc(formatDateLong(iso).replace(/^[A-Za-z]{3},\s/,""))}</div>
        </div>
      `;
      const headerRight = avail.closed ? `<div class="badgeClosed">Closed</div>` : "";

      const roleLine = (roleKey, label) => {
        const color = ROLE_COLORS[roleKey];
        const am = plan.AM.roles[roleKey] || null;
        const pm = plan.PM.roles[roleKey] || null;

        const same = am && pm && am === pm;
        const value = same
          ? `<div class="slotValue">${esc(am)}</div>`
          : `<div class="slotValueWrap">${halfValueChip("A", am)}${halfValueChip("P", pm)}</div>`;

        return `
          <div class="slot">
            <div class="slotLeft">${pill(color)}<div class="slotLabel">${esc(label)}</div></div>
            ${value}
          </div>
        `;
      };

      const listLine = (label, colorVar, amList, pmList) => {
        const same = JSON.stringify(amList||[]) === JSON.stringify(pmList||[]);
        const value = same
          ? `<div class="slotValueWrap">${listChips(amList)}</div>`
          : `<div class="slotValueWrap">${halfValueChip("A", (amList||[]).join(" ") || null)}${halfValueChip("P", (pmList||[]).join(" ") || null)}</div>`;

        return `
          <div class="slot">
            <div class="slotLeft">${pill(colorVar)}<div class="slotLabel">${esc(label)}</div></div>
            ${value}
          </div>
        `;
      };

      const payload = encodeURIComponent(JSON.stringify({ iso }));

      html += `
        <div class="dayCard" data-payload="${payload}">
          <div class="dayHeader">
            ${headerLeft}
            ${headerRight}
          </div>
          <div class="slots">
            ${roleLine("IR","IR")}
            ${roleLine("Fluoro","Fluoro")}
            ${roleLine("MSK","MSK Proc")}
            ${roleLine("US","US Proc")}
            ${listLine("Float", "var(--r-float)", plan.AM.Float || [], plan.PM.Float || [])}
            ${listLine("Absent", "var(--r-absent)", avail.byHalf.AM.absent || [], avail.byHalf.PM.absent || [])}
          </div>
        </div>
      `;
    }

    elWeekGrid.innerHTML = html;

    document.querySelectorAll(".dayCard").forEach(card => {
      card.addEventListener("click", () => {
        const { iso } = JSON.parse(decodeURIComponent(card.dataset.payload));
        openDayEditor(iso);
      });
    });
  }

  document.getElementById("autoWeek").addEventListener("click", () => {
    const ws = currentWeekStart();
    const dates = weekDates(ws);
    for(const iso of dates){
      setPlanForDate(iso, autoAssignForDate(iso));
    }
    render();
  });

  document.getElementById("clearWeek").addEventListener("click", () => {
    const ws = currentWeekStart();
    const dates = weekDates(ws);
    for(const iso of dates){
      if(data.rolePlan && data.rolePlan[iso]) delete data.rolePlan[iso];
    }
    saveData(data);
    render();
  });

  document.getElementById("prevWeek").addEventListener("click", () => {
    weekIndex = Math.max(0, weekIndex - 1);
    render();
  });
  document.getElementById("nextWeek").addEventListener("click", () => {
    const max = (data.meta.weekStarts || []).length - 1;
    weekIndex = Math.min(max, weekIndex + 1);
    render();
  });
  window.addEventListener("keydown", (e) => {
    if(e.key === "ArrowLeft"){ weekIndex = Math.max(0, weekIndex - 1); render(); }
    if(e.key === "ArrowRight"){
      const max = (data.meta.weekStarts || []).length - 1;
      weekIndex = Math.min(max, weekIndex + 1);
      render();
    }
    if(e.key === "Escape"){
      if(dayBackdrop.style.display === "flex") dayBackdrop.style.display = "none";
      if(editorBackdrop.style.display === "flex") editorBackdrop.style.display = "none";
      if(exportBackdrop.style.display === "flex") exportBackdrop.style.display = "none";
    }
  });

  // Day editor
  const dayBackdrop = document.getElementById("dayBackdrop");
  const dayTitle = document.getElementById("dayTitle");
  const dayWarnings = document.getElementById("dayWarnings");

  const amPresence = document.getElementById("amPresence");
  const pmPresence = document.getElementById("pmPresence");

  const amIR = document.getElementById("amIR");
  const amFluoro = document.getElementById("amFluoro");
  const amMSK = document.getElementById("amMSK");
  const amUS = document.getElementById("amUS");
  const amFloat = document.getElementById("amFloat");
  const amAbsent = document.getElementById("amAbsent");

  const pmIR = document.getElementById("pmIR");
  const pmFluoro = document.getElementById("pmFluoro");
  const pmMSK = document.getElementById("pmMSK");
  const pmUS = document.getElementById("pmUS");
  const pmFloat = document.getElementById("pmFloat");
  const pmAbsent = document.getElementById("pmAbsent");

  const absToggleAM = document.getElementById("absToggleAM");
  const absTogglePM = document.getElementById("absTogglePM");
  const overrideStatus = document.getElementById("overrideStatus");

  let editingISO = null;
  let editingPlan = null;
  let editingOverrides = null; // { person: {AM:boolean, PM:boolean} }

  function setSelectOptions(sel, people){
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "—";
    sel.appendChild(opt0);
    for(const p of people){
      const opt = document.createElement("option");
      opt.value = p;
      opt.textContent = p;
      sel.appendChild(opt);
    }
  }

  function toggleMulti(container, people, selectedSet){
    container.innerHTML = "";
    for(const p of people){
      const b = document.createElement("button");
      b.type = "button";
      b.className = "miniBtn" + (selectedSet.has(p) ? " on" : "");
      b.textContent = p;
      b.addEventListener("click", () => {
        if(selectedSet.has(p)) selectedSet.delete(p);
        else selectedSet.add(p);
        toggleMulti(container, people, selectedSet);
      });
      container.appendChild(b);
    }
  }

  function renderAbsenceToggles(half, container){
    const people = allPeople();
    container.innerHTML = "";
    for(const p of people){
      const on = !!editingOverrides?.[p]?.[half];
      const b = document.createElement("button");
      b.type = "button";
      b.className = "miniBtn" + (on ? " on" : "") + " half";
      b.textContent = p;
      b.addEventListener("click", () => {
        if(!editingOverrides[p]) editingOverrides[p] = { AM:false, PM:false };
        editingOverrides[p][half] = !editingOverrides[p][half];
        renderAbsenceToggles("AM", absToggleAM);
        renderAbsenceToggles("PM", absTogglePM);
        updatePresenceLabels();
        recomputeWarnings();
      });
      container.appendChild(b);
    }
  }

  function effectiveAbsentUsingEditing(iso, half){
    const closed = closedLabelForDate(iso);
    if(closed) return new Set(allPeople());

    const base = baseAbsentForHalf(iso, half);
    const over = new Set();
    for(const p of Object.keys(editingOverrides || {})){
      if(editingOverrides[p]?.[half]) over.add(p);
    }
    for(const p of over) base.add(p);
    return base;
  }

  function presentUsingEditing(iso, half){
    const absent = effectiveAbsentUsingEditing(iso, half);
    return allPeople().filter(p => !absent.has(p));
  }

  function updatePresenceLabels(){
    const closed = closedLabelForDate(editingISO);
    if(closed){
      amPresence.textContent = "Present: —";
      pmPresence.textContent = "Present: —";
      overrideStatus.textContent = `Closed: ${closed}`;
      return;
    }
    const amP = presentUsingEditing(editingISO, "AM");
    const pmP = presentUsingEditing(editingISO, "PM");
    amPresence.textContent = `Present: ${amP.join(", ") || "—"}`;
    pmPresence.textContent = `Present: ${pmP.join(", ") || "—"}`;

    const hasAny = Object.values(editingOverrides || {}).some(v => v?.AM || v?.PM);
    overrideStatus.textContent = hasAny ? "Overrides will be saved for this day." : "No overrides currently set for this day.";
  }

  function openDayEditor(iso){
    editingISO = iso;

    const people = allPeople();
    const avail = availabilitySummary(iso);
    const closed = !!avail.closed;

    editingPlan = structuredCloneSafe(getPlanForDate(iso));
    // Start overrides from stored overrides for day, or empty.
    const existing = data.availabilityOverrides?.[iso] ? structuredCloneSafe(data.availabilityOverrides[iso]) : {};
    editingOverrides = existing;

    dayTitle.textContent = `Edit • ${formatDateLong(iso)}`;

    // Selects
    [amIR,amFluoro,amMSK,amUS,pmIR,pmFluoro,pmMSK,pmUS].forEach(sel => setSelectOptions(sel, people));

    amIR.value = editingPlan.AM.roles.IR || "";
    amFluoro.value = editingPlan.AM.roles.Fluoro || "";
    amMSK.value = editingPlan.AM.roles.MSK || "";
    amUS.value = editingPlan.AM.roles.US || "";

    pmIR.value = editingPlan.PM.roles.IR || "";
    pmFluoro.value = editingPlan.PM.roles.Fluoro || "";
    pmMSK.value = editingPlan.PM.roles.MSK || "";
    pmUS.value = editingPlan.PM.roles.US || "";

    // Multi-select lists
    const amFloatSet = new Set(editingPlan.AM.Float || []);
    const amAbsentSet = new Set(editingPlan.AM.Absent || []);
    toggleMulti(amFloat, people, amFloatSet);
    toggleMulti(amAbsent, people, amAbsentSet);

    const pmFloatSet = new Set(editingPlan.PM.Float || []);
    const pmAbsentSet = new Set(editingPlan.PM.Absent || []);
    toggleMulti(pmFloat, people, pmFloatSet);
    toggleMulti(pmAbsent, people, pmAbsentSet);

    // Absence toggles (overrides)
    renderAbsenceToggles("AM", absToggleAM);
    renderAbsenceToggles("PM", absTogglePM);

    function syncFromUI(){
      editingPlan.AM.roles = { IR: amIR.value||null, Fluoro: amFluoro.value||null, MSK: amMSK.value||null, US: amUS.value||null };
      editingPlan.PM.roles = { IR: pmIR.value||null, Fluoro: pmFluoro.value||null, MSK: pmMSK.value||null, US: pmUS.value||null };

      editingPlan.AM.Float = [...amFloat.querySelectorAll(".miniBtn.on")].map(b=>b.textContent);
      editingPlan.AM.Absent = [...amAbsent.querySelectorAll(".miniBtn.on")].map(b=>b.textContent);

      editingPlan.PM.Float = [...pmFloat.querySelectorAll(".miniBtn.on")].map(b=>b.textContent);
      editingPlan.PM.Absent = [...pmAbsent.querySelectorAll(".miniBtn.on")].map(b=>b.textContent);
    }

    function recomputeWarnings(){
      if(closed){
        dayWarnings.textContent = "Day is closed. Assignments are optional.";
        return;
      }

      const issues = [];
      for(const half of HALVES){
        const presentSet = new Set(presentUsingEditing(iso, half));
        const roles = (half==="AM" ? editingPlan.AM.roles : editingPlan.PM.roles);

        for(const [roleKey, person] of Object.entries(roles)){
          if(!person) issues.push(`${half}: ${roleKey} is unassigned.`);
          else if(!presentSet.has(person)) issues.push(`${half}: ${roleKey} assigned to ${person} but they are absent ${half}.`);
        }

        const used = {};
        for(const [r,p] of Object.entries(roles)){
          if(!p) continue;
          used[p] = used[p] ? [...used[p], r] : [r];
        }
        for(const [p,rs] of Object.entries(used)){
          if(rs.length > 1) issues.push(`${half}: ${p} assigned to multiple roles (${rs.join(", ")}).`);
        }
      }

      dayWarnings.textContent = issues.length ? issues.join(" ") : "No issues detected.";
    }

    [amIR,amFluoro,amMSK,amUS,pmIR,pmFluoro,pmMSK,pmUS].forEach(sel => {
      sel.addEventListener("change", () => { syncFromUI(); recomputeWarnings(); });
    });

    dayBackdrop.addEventListener("click", (e) => {
      if(e.target.classList && e.target.classList.contains("miniBtn")){
        setTimeout(() => { syncFromUI(); recomputeWarnings(); }, 0);
      }
    });

    syncFromUI();
    updatePresenceLabels();
    recomputeWarnings();

    dayBackdrop.style.display = "flex";
  }

  document.getElementById("closeDay").addEventListener("click", () => dayBackdrop.style.display = "none");
  dayBackdrop.addEventListener("click", (e) => { if(e.target === dayBackdrop) dayBackdrop.style.display = "none"; });

  document.getElementById("autoDay").addEventListener("click", () => {
    if(!editingISO) return;
    editingPlan = autoAssignForDate(editingISO);
    // keep overrides as-is
    openDayEditor(editingISO);
  });

  document.getElementById("clearDay").addEventListener("click", () => {
    if(!editingISO) return;
    if(data.rolePlan && data.rolePlan[editingISO]) delete data.rolePlan[editingISO];
    if(data.availabilityOverrides && data.availabilityOverrides[editingISO]) delete data.availabilityOverrides[editingISO];
    saveData(data);
    dayBackdrop.style.display = "none";
    render();
  });

  document.getElementById("saveDay").addEventListener("click", () => {
    if(!editingISO || !editingPlan) return;

    // Save role plan
    setPlanForDate(editingISO, editingPlan);

    // Save overrides (only if any toggles on)
    const cleaned = {};
    for(const p of Object.keys(editingOverrides || {})){
      const v = editingOverrides[p] || {};
      if(!!v.AM || !!v.PM) cleaned[p] = { AM: !!v.AM, PM: !!v.PM };
    }
    if(!data.availabilityOverrides) data.availabilityOverrides = {};
    if(Object.keys(cleaned).length) data.availabilityOverrides[editingISO] = cleaned;
    else if(data.availabilityOverrides[editingISO]) delete data.availabilityOverrides[editingISO];

    saveData(data);

    dayBackdrop.style.display = "none";
    render();
  });

  // JSON editor
  const editorBackdrop = document.getElementById("editorBackdrop");
  const jsonEditor = document.getElementById("jsonEditor");
  const editorMsg = document.getElementById("editorMsg");
  const openEditorBtn = document.getElementById("openEditor");
  const closeEditorBtn = document.getElementById("closeEditor");
  const saveChangesBtn = document.getElementById("saveChanges");
  const discardChangesBtn = document.getElementById("discardChanges");
  const resetDataBtn = document.getElementById("resetData");

  let editorOriginal = "";

  function openEditorModal(){
    editorOriginal = JSON.stringify(data, null, 2);
    jsonEditor.value = editorOriginal;
    editorMsg.textContent = "Edits are stored in this browser (local storage).";
    editorBackdrop.style.display = "flex";
    jsonEditor.focus();
  }

  openEditorBtn.addEventListener("click", openEditorModal);
  closeEditorBtn.addEventListener("click", () => editorBackdrop.style.display = "none");
  editorBackdrop.addEventListener("click", (e) => { if(e.target === editorBackdrop) editorBackdrop.style.display = "none"; });

  discardChangesBtn.addEventListener("click", () => {
    jsonEditor.value = editorOriginal;
    editorMsg.textContent = "Discarded changes (not saved).";
  });

  resetDataBtn.addEventListener("click", () => {
    data = structuredCloneSafe(defaultData);
    saveData(data);
    editorOriginal = JSON.stringify(data, null, 2);
    jsonEditor.value = editorOriginal;
    editorMsg.textContent = "Reset to default and saved.";
    render();
  });

  saveChangesBtn.addEventListener("click", () => {
    try{
      const parsed = JSON.parse(jsonEditor.value);
      if(!parsed.meta || !parsed.people || !parsed.absences || !parsed.closedDates){
        throw new Error("Missing required keys: meta, people, absences, closedDates");
      }
      if(!parsed.availabilityOverrides) parsed.availabilityOverrides = {};
      if(!parsed.rolePlan) parsed.rolePlan = {};
      data = parsed;
      saveData(data);
      editorOriginal = JSON.stringify(data, null, 2);
      editorMsg.textContent = "Saved.";
      render();
    } catch(err){
      editorMsg.textContent = "Error: " + err.message;
    }
  });

  // Export
  const exportBackdrop = document.getElementById("exportBackdrop");
  const exportMenuBtn = document.getElementById("exportMenuBtn");
  const closeExportBtn = document.getElementById("closeExport");
  const exportConfigJsonBtn = document.getElementById("exportConfigJson");
  const exportExpandedCsvBtn = document.getElementById("exportExpandedCsv");
  const exportExpandedJsonBtn = document.getElementById("exportExpandedJson");

  exportMenuBtn.addEventListener("click", () => exportBackdrop.style.display = "flex");
  closeExportBtn.addEventListener("click", () => exportBackdrop.style.display = "none");
  exportBackdrop.addEventListener("click", (e) => { if(e.target === exportBackdrop) exportBackdrop.style.display = "none"; });

  function downloadFile(filename, content, mime){
    const blob = new Blob([content], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }

  exportConfigJsonBtn.addEventListener("click", () => {
    downloadFile("rotation_config_ampm.json", JSON.stringify(data, null, 2), "application/json");
  });

  function rangeDatesWeekdays(){
    const start = parseISO(data.meta.rangeStart);
    const end = parseISO(data.meta.rangeEnd);
    const out = [];
    for(let t = start.getTime(); t <= end.getTime(); t += DAY){
      const iso = isoDate(new Date(t));
      if(weekdays.includes(dayName(iso))) out.push(iso);
    }
    return out;
  }

  function expandedRows(){
    const dates = rangeDatesWeekdays();
    const rows = [];
    for(const iso of dates){
      const avail = availabilitySummary(iso);
      const plan = getPlanForDate(iso);

      rows.push({
        date: iso,
        weekday: dayName(iso),
        closed: !!avail.closed,

        IR_AM: plan.AM.roles.IR || "",
        Fluoro_AM: plan.AM.roles.Fluoro || "",
        MSK_AM: plan.AM.roles.MSK || "",
        US_AM: plan.AM.roles.US || "",
        Float_AM: (plan.AM.Float || []).join(" "),
        Absent_AM: (avail.byHalf.AM.absent || []).join(" "),

        IR_PM: plan.PM.roles.IR || "",
        Fluoro_PM: plan.PM.roles.Fluoro || "",
        MSK_PM: plan.PM.roles.MSK || "",
        US_PM: plan.PM.roles.US || "",
        Float_PM: (plan.PM.Float || []).join(" "),
        Absent_PM: (avail.byHalf.PM.absent || []).join(" ")
      });
    }
    return rows;
  }

  function toCSV(rows){
    const headers = [
      "date","weekday","closed",
      "IR_AM","Fluoro_AM","MSK_AM","US_AM","Float_AM","Absent_AM",
      "IR_PM","Fluoro_PM","MSK_PM","US_PM","Float_PM","Absent_PM"
    ];
    const escCSV = (v) => {
      const s = String(v ?? "");
      if(/[",\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
      return s;
    };
    const lines = [];
    lines.push(headers.join(","));
    for(const r of rows){
      lines.push(headers.map(h => escCSV(r[h])).join(","));
    }
    return lines.join("\n");
  }

  exportExpandedCsvBtn.addEventListener("click", () => {
    downloadFile("rotation_expanded_weekdays_ampm.csv", toCSV(expandedRows()), "text/csv");
  });

  exportExpandedJsonBtn.addEventListener("click", () => {
    downloadFile("rotation_expanded_weekdays_ampm.json", JSON.stringify(expandedRows(), null, 2), "application/json");
  });

  // Init
  render();
})();
</script>
</body>
</html>