<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CT Findings LibraryÂ //Â NightÂ Mode</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
/* ==== NIGHTâ€‘MODE AESTHETIC ==== */
:root{
  --bg:#0a0a0f;
  --panel:#14141d;
  --card:#1e1e29;
  --text:#e8e8ff;
  --accent:#00ff9c;
  --muted:#7f7fa3;
  --radius:8px;
  font-family:'Poppins',sans-serif;
}
*{box-sizing:border-box}
body{margin:0;padding:1.2rem;background:var(--bg);color:var(--text)}
h1{font-weight:600;margin:0 0 .6rem;font-size:1.4rem;color:var(--accent)}
a{color:var(--accent)}
/* Controls */
#controls{background:var(--panel);padding:1rem;border-radius:var(--radius);margin-bottom:1rem}
#controls button{margin:.25rem .4rem .25rem 0;padding:.35rem .8rem;border:none;border-radius:var(--radius);cursor:pointer;font-weight:600;color:var(--text);background:var(--card)}
#controls button:hover{background:var(--accent);color:#000}
textarea{width:100%;height:140px;background:var(--card);border:1px solid var(--muted);border-radius:var(--radius);color:var(--text);padding:.6rem;font-family:monospace;margin-top:.4rem}
input[type="text"]{width:100%;padding:.5rem;border-radius:var(--radius);border:1px solid var(--muted);background:var(--card);color:var(--text);margin-bottom:.8rem}
/* Sections */
details{background:var(--panel);border-radius:var(--radius);margin:.4rem 0;padding:.2rem .6rem}
details summary{cursor:pointer;font-weight:600;color:var(--accent);list-style:none;padding:.4rem 0}
details summary::-webkit-details-marker{display:none}
ul{margin:0 0 .6rem 1.2rem;padding:0;list-style-type:disc}
li{margin:.15rem 0;line-height:1.4}
.finding-label{
  font-weight:600;
  list-style-type:none;          /* remove bullet */
  margin-left:-1.2rem;
}
.finding-label::marker{content:''}
.report-sentence{
  font-style:italic;
}
.report-sentence::before{content:"â€œ";}
.report-sentence::after{content:"â€";}
.pearl{font-style:italic;color:var(--muted)}
.tag-chip{display:inline-block;padding:0 .4em;border-radius:4px;background:var(--card);color:var(--accent);font-size:.75rem;margin-left:.4em}
.hidden{display:none}
</style>
</head>
<body>

<h1>CT Findings Library</h1>

<div id="controls">
  <label for="jsonInput"><strong>Paste JSON for new finding(s)</strong> â†’ <em>hitÂ Add</em></label>
  <textarea id="jsonInput" placeholder='{"section":"LIVER", â€¦ }  OR  [ {...},{...} ]'></textarea>
  <br>
  <button id="btnAdd">Add</button>

  <!-- fullâ€‘library actions -->
  <button id="btnUploadReset">ResetÂ &Â UploadÂ JSON</button>
  <button id="btnUploadCombine">UploadÂ &Â CombineÂ JSON</button>
  <button id="btnDownload">DownloadÂ JSON</button>
  <input type="file" id="fileInput" accept=".json" class="hidden">
</div>

<input type="text" id="filterBox" placeholder="Filter by any text, tag, or labelâ€¦">

<div id="ui"></div>

<script>
/* ===== Data schema & storage ===== */
const SECTIONS=[
"LOWER NECK","LUNGS / AIRWAYS / PLEURA","HEART / VESSELS","MEDIASTINUM / ESOPHAGUS","DIAPHRAGM",
"LYMPH NODES","CHEST WALL","LIVER","BILIARY TRACT","GALLBLADDER","PANCREAS","SPLEEN","ADRENALS",
"KIDNEYS","STOMACH / SMALL BOWEL","COLON / APPENDIX","PERITONEUM / MESENTERY","RETROPERITONEUM",
"VESSELS","URINARY BLADDER","REPRODUCTIVE ORGANS","BODY WALL","MUSCULOSKELETAL","CONCLUSION"];
const STORAGE_KEY="ctFindings_v1";
let library={};

/* ===== Utilities ===== */
function resetLibrary(){library={};SECTIONS.forEach(s=>library[s]=[]);}
function load(){try{library=JSON.parse(localStorage.getItem(STORAGE_KEY))||{};}catch{resetLibrary()}}
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(library));}
function normalizeSection(sec){return SECTIONS.includes(sec)?sec:null;}
function uniqueKey(obj){return JSON.stringify(obj);} // quick dedup

/* ===== Rendering ===== */
const ui=document.getElementById("ui");
let globalBlockCounter=0;
function renderAll(){
  ui.innerHTML="";
  globalBlockCounter=0;
  SECTIONS.forEach(sec=>{
    const items=library[sec]||[];
    if(items.length===0)return;
    const det=document.createElement("details");
    det.dataset.section=sec;
    const sum=document.createElement("summary");
    sum.textContent=`${sec}  (${items.length})`;
    det.appendChild(sum);
    const ul=document.createElement("ul");
    items.forEach(item=>{
      const blockId="b"+(++globalBlockCounter);
      /* label row */
      const liLabel=document.createElement("li");
      liLabel.className="finding-label";
      liLabel.dataset.blockId=blockId;
      liLabel.dataset.search=(item.label+" "+(item.sentences||[]).join(" ")+" "+(item.pearls||[]).join(" ")+" "+(item.tags||[]).join(" ")).toLowerCase();
      liLabel.innerHTML=item.label || "<i>[no label]</i>";
      if(item.tags) item.tags.forEach(t=>{
        const span=document.createElement("span");
        span.className="tag-chip";span.textContent=t;liLabel.appendChild(span);
      });
      ul.appendChild(liLabel);

      /* sentence rows */
      (item.sentences||[]).forEach(txt=>{
        const li=document.createElement("li");
        li.className="report-sentence";
        li.dataset.blockId=blockId;
        li.textContent=txt;
        ul.appendChild(li);
      });

      /* pearls */
      if(item.pearls?.length){
        const li=document.createElement("li");
        li.className="pearl";
        li.dataset.blockId=blockId;
        li.innerHTML="ğŸ’¡ "+item.pearls.join("<br>ğŸ’¡ ");
        ul.appendChild(li);
      }
    });
    det.appendChild(ul);
    ui.appendChild(det);
  });
  applyFilter();
}

/* ===== Filter ===== */
const filterBox=document.getElementById("filterBox");
filterBox.addEventListener("input",applyFilter);
function applyFilter(){
  const term=filterBox.value.trim().toLowerCase();
  let anyVisible=false;
  ui.querySelectorAll("details").forEach(det=>{
    let sectionVisible=false;

    /* operate per block */
    det.querySelectorAll(".finding-label").forEach(labelLi=>{
      const matchText=labelLi.dataset.search||"";
      const show=!term||matchText.includes(term);
      const blockId=labelLi.dataset.blockId;
      det.querySelectorAll(`[data-block-id="${blockId}"]`).forEach(el=>{
        el.style.display=show?"":"none";
      });
      if(show)sectionVisible=true;
    });

    /* section collapse / expand */
    det.style.display=sectionVisible?"":"none";
    if(term){
      det.open=sectionVisible;          // expand visible sections while filtering
    }else{
      det.open=false;                   // collapse everything when filter cleared
    }
    if(sectionVisible)anyVisible=true;
  });
  if(!anyVisible&&term){
    if(!document.getElementById("nores")){
      const p=document.createElement("p");p.id="nores";p.style.textAlign="center";
      p.textContent="No matches.";ui.appendChild(p);
    }
  }else{
    document.getElementById("nores")?.remove();
  }
}

/* ===== Add pasted JSON ===== */
document.getElementById("btnAdd").onclick=()=>{
  const txt=document.getElementById("jsonInput").value.trim();
  if(!txt)return alert("Nothing to add.");
  try{
    const parsed=JSON.parse(txt);
    const arr=Array.isArray(parsed)?parsed:[parsed];
    let added=0, dupe=0;
    arr.forEach(obj=>{
      const sec=normalizeSection(obj.section);
      if(!sec)return;
      if(!library[sec])library[sec]=[];
      const key=uniqueKey(obj);
      const exists=library[sec].some(b=>uniqueKey(b)===key);
      if(exists){dupe++;return;}
      library[sec].push(obj);added++;
    });
    save();renderAll();
    document.getElementById("jsonInput").value="";
    alert(`Added ${added} new item(s)${dupe?`, skipped ${dupe} duplicate(s)`:''}.`);
  }catch(e){alert("JSON parse error: "+e.message);}
};

/* ===== Upload / download ===== */
const fileInput=document.getElementById("fileInput");
document.getElementById("btnDownload").onclick=function(){
  const str=JSON.stringify(library,null,2);
  const blob=new Blob([str],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  const dt=new Date();const ts=dt.toISOString().slice(0,10);
  a.download=`ctFindings_${ts}.json`;
  document.body.appendChild(a);a.click();a.remove();
};
function handleUpload(mode,jsonData){
  if(mode==="reset")resetLibrary();
  let added=0;
  SECTIONS.forEach(sec=>{
    if(jsonData[sec])jsonData[sec].forEach(obj=>{
      if(!library[sec])library[sec]=[];
      const key=uniqueKey(obj);
      if(library[sec].some(b=>uniqueKey(b)===key))return;
      library[sec].push(obj);added++;
    });
  });
  save();renderAll();
  alert(`${mode==="reset"?"Reset &":"Combined &"} added ${added} new item(s).`);
}
["btnUploadReset","btnUploadCombine"].forEach(id=>{
  document.getElementById(id).onclick=()=>{
    fileInput.click();fileInput.dataset.mode=id==="btnUploadReset"?"reset":"combine";
  };
});
fileInput.onchange=e=>{
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=evt=>{
    try{
      handleUpload(fileInput.dataset.mode,JSON.parse(evt.target.result));
    }catch(err){alert("Bad JSON: "+err.message);}
  };
  reader.readAsText(file);
  e.target.value="";
};

/* ===== Boot ===== */
resetLibrary();load();renderAll();
</script>
</body>
</html>
