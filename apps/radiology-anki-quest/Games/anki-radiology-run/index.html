<!DOCTYPE html>


<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Anki Radiology Run</title>
  <style>
    :root {
      --bg: #050814;
      --bg-panel: #0d1224;
      --bg-card: #151a2f;
      --accent: #4dd0e1;
      --accent-soft: rgba(77, 208, 225, 0.2);
      --accent-strong: #00e5ff;
      --danger: #ff5252;
      --danger-soft: rgba(244, 67, 54, 0.15);
      --text-main: #f5f7ff;
      --text-muted: #a2a8d3;
      --correct: #69f0ae;
      --wrong: #ff8a80;
      --border-soft: rgba(255, 255, 255, 0.08);
    }


* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: radial-gradient(circle at top, #18213d 0, #050814 55%);
  color: var(--text-main);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: stretch;
}

.app-shell {
  width: 100%;
  max-width: 1100px;
  margin: 18px auto;
  border-radius: 16px;
  background: radial-gradient(circle at top left, rgba(77,208,225,0.12), transparent 56%), radial-gradient(circle at bottom right, rgba(129,140,248,0.12), transparent 52%), #050814;
  box-shadow: 0 26px 60px rgba(0, 0, 0, 0.75);
  border: 1px solid rgba(255, 255, 255, 0.06);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

header.app-header {
  padding: 12px 18px 10px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  display: flex;
  justify-content: space-between;
  align-items: center;
  backdrop-filter: blur(10px);
  background: linear-gradient(to right, rgba(10, 22, 48, 0.94), rgba(19, 23, 46, 0.9));
}

.app-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 18px;
  font-weight: 600;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  color: var(--accent-strong);
}

.app-title span.icon {
  width: 26px;
  height: 26px;
  border-radius: 8px;
  background: radial-gradient(circle at 30% 30%, #ffffff, #4dd0e1);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 17px;
  color: #02040a;
  box-shadow: 0 0 20px rgba(77, 208, 225, 0.9);
}

.subtitle {
  font-size: 11px;
  color: var(--text-muted);
  opacity: 0.9;
}

.top-stats {
  display: flex;
  align-items: center;
  gap: 16px;
  font-size: 12px;
  color: var(--text-muted);
}

.pill {
  border-radius: 999px;
  padding: 4px 10px;
  border: 1px solid var(--border-soft);
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: rgba(4, 8, 24, 0.96);
}

.pill strong {
  font-weight: 600;
  color: var(--accent);
}

.health-hearts {
  display: inline-flex;
  gap: 3px;
  font-size: 15px;
}

main.app-main {
  display: flex;
  flex: 1;
  min-height: 420px;
}

.left-column {
  flex: 1.8;
  border-right: 1px solid rgba(255, 255, 255, 0.04);
  display: flex;
  flex-direction: column;
  background: radial-gradient(circle at top, rgba(77,208,225,0.09), transparent 65%);
}

.right-column {
  flex: 1.2;
  display: flex;
  flex-direction: column;
  background: radial-gradient(circle at bottom, rgba(129,140,248,0.14), transparent 62%);
}

.progress-bar-container {
  padding: 12px 18px 4px;
}

.progress-label-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 4px;
  font-size: 11px;
  color: var(--text-muted);
}

.progress-label-row span strong {
  color: var(--accent);
}

.progress-bar-outer {
  width: 100%;
  height: 9px;
  border-radius: 999px;
  background: rgba(12, 17, 38, 0.9);
  overflow: hidden;
  position: relative;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
}

.progress-bar-inner {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #4dd0e1, #00e5ff, #69f0ae);
  box-shadow: 0 0 18px rgba(77,208,225,0.9);
  transition: width 0.15s ease-out;
}

.progress-bar-glow {
  position: absolute;
  inset: 0;
  box-shadow: 0 0 16px rgba(77, 208, 225, 0.7);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease-out;
}

.progress-bar-outer.glow .progress-bar-glow {
  opacity: 1;
}

.tower-wrapper {
  flex: 1;
  padding: 4px 18px 10px;
  display: flex;
  gap: 14px;
}

.tower {
  width: 54px;
  border-radius: 999px;
  background: linear-gradient(to top, #090d1d, #151a2f);
  border: 1px solid rgba(255, 255, 255, 0.06);
  padding: 8px 6px;
  display: flex;
  flex-direction: column-reverse;
  gap: 2px;
  position: relative;
  overflow: hidden;
}

.tower-floor {
  flex: 1;
  margin: 2px 0;
  border-radius: 999px;
  background: radial-gradient(circle at left, rgba(77, 208, 225, 0.18), rgba(9, 13, 29, 1));
  opacity: 0.23;
}

.tower-floor.done {
  opacity: 0.85;
  background: radial-gradient(circle at left, rgba(77, 208, 225, 0.55), rgba(9, 13, 29, 1));
}

.tower-floor.current {
  opacity: 1;
  box-shadow: 0 0 12px rgba(77, 208, 225, 0.95);
  background: radial-gradient(circle at left, #4dd0e1, #151a2f);
}

.tower-hero {
  position: absolute;
  left: 50%;
  transform: translate(-50%, 4px);
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: radial-gradient(circle at 30% 30%, #ffffff, #69f0ae);
  box-shadow: 0 0 24px rgba(105, 240, 174, 0.95);
  border: 2px solid rgba(7, 11, 30, 0.9);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 17px;
  color: #020409;
}

.tower-hero::after {
  content: "PGY";
  position: absolute;
  bottom: -11px;
  font-size: 9px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--text-muted);
}

.tower-badge {
  position: absolute;
  top: 6px;
  left: 6px;
  font-size: 10px;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  opacity: 0.8;
}

.tower-shadow {
  position: absolute;
  inset: 0;
  background: radial-gradient(circle at 50% -18%, rgba(255,255,255,0.3), transparent 70%);
  opacity: 0.2;
  pointer-events: none;
}

.tower-side-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
  font-size: 12px;
  color: var(--text-muted);
}

.metric-row {
  display: flex;
  gap: 10px;
}

.metric {
  flex: 1;
  padding: 7px 9px;
  border-radius: 10px;
  background: rgba(6, 12, 32, 0.95);
  border: 1px solid rgba(255,255,255,0.05);
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.metric-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--text-muted);
}

.metric-value {
  font-size: 13px;
  font-weight: 600;
  color: var(--accent);
  display: flex;
  align-items: center;
  gap: 4px;
}

.metric-subvalue {
  font-size: 10px;
  color: var(--text-muted);
}

.streak-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 7px;
  border-radius: 999px;
  background: rgba(29, 233, 182, 0.12);
  border: 1px solid rgba(105, 240, 174, 0.45);
  font-size: 10px;
  color: var(--correct);
}

.streak-badge.shake {
  animation: streakPulse 0.4s ease-out;
}

@keyframes streakPulse {
  0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(105,240,174,0.7);}
  60% { transform: scale(1.08); box-shadow: 0 0 16px 2px rgba(105,240,174,0.7);}
  100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(105,240,174,0);}
}

.health-pulse {
  animation: healthBlink 0.35s ease-out;
}

@keyframes healthBlink {
  0% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(244,67,54,0)); }
  50% { transform: scale(1.08); filter: drop-shadow(0 0 12px rgba(244,67,54,0.9)); }
  100% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(244,67,54,0)); }
}

.card-panel {
  margin: 4px 18px 16px;
  padding: 14px 16px 16px;
  border-radius: 14px;
  background: radial-gradient(circle at top left, rgba(77,208,225,0.2), rgba(9,14,29,0.98));
  border: 1px solid rgba(255, 255, 255, 0.07);
  display: flex;
  flex-direction: column;
  gap: 10px;
  position: relative;
  overflow: hidden;
}

.card-panel.correct-flash {
  box-shadow: 0 0 22px rgba(105, 240, 174, 0.7);
}

.card-panel.wrong-flash {
  box-shadow: 0 0 22px rgba(244, 67, 54, 0.7);
}

.card-header-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  font-size: 12px;
}

.card-header-row-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.card-tag {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--accent);
  opacity: 0.9;
}

.card-counter {
  font-size: 11px;
  color: var(--text-muted);
}

.card-header-row-right {
  font-size: 11px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  gap: 6px;
}

.keyboard-hint {
  font-family: "SF Mono", Menlo, Consolas, monospace;
  padding: 2px 6px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.08);
  background: rgba(4,7,20,0.95);
  font-size: 10px;
  color: var(--text-muted);
}

.question-area {
  padding: 10px 0 8px;
  border-bottom: 1px dashed rgba(255,255,255,0.08);
  font-size: 15px;
  line-height: 1.5;
}

.answer-area {
  padding-top: 9px;
  min-height: 42px;
  font-size: 14px;
  line-height: 1.5;
  color: var(--correct);
  display: none;
}

.answer-area.visible {
  display: block;
}

.answer-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  color: var(--text-muted);
  margin-bottom: 2px;
}

.answer-text {
  font-size: 14px;
}

.controls-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 8px;
  gap: 10px;
}

.btn-row-left, .btn-row-right {
  display: flex;
  gap: 8px;
}

button {
  border: none;
  background: none;
  cursor: pointer;
  font-family: inherit;
}

.btn-main {
  padding: 7px 14px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.1);
  background: linear-gradient(to right, rgba(37, 99, 235, 0.2), rgba(56, 189, 248, 0.18));
  color: #e0f7fa;
  font-size: 13px;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: background 0.12s ease-out, transform 0.06s ease-out, box-shadow 0.12s ease-out;
}

.btn-main:hover {
  background: linear-gradient(to right, rgba(59,130,246,0.32), rgba(56,189,248,0.3));
  box-shadow: 0 0 16px rgba(56,189,248,0.3);
  transform: translateY(-0.5px);
}

.btn-main:active {
  transform: translateY(0.5px) scale(0.99);
  box-shadow: 0 0 8px rgba(56,189,248,0.35);
}

.btn-main.primary {
  background: linear-gradient(90deg, #4dd0e1, #00e5ff);
  color: #001019;
  box-shadow: 0 0 16px rgba(77,208,225,0.8);
  border-color: rgba(0,0,0,0.92);
}

.btn-main.primary:hover {
  background: linear-gradient(90deg, #69f0ae, #00e5ff);
}

.btn-main.success {
  background: linear-gradient(90deg, rgba(105,240,174,0.16), rgba(24,179,119,0.25));
  border-color: rgba(105,240,174,0.8);
  color: var(--correct);
}

.btn-main.success:hover {
  background: linear-gradient(90deg, rgba(105,240,174,0.3), rgba(24,179,119,0.32));
}

.btn-main.danger {
  background: linear-gradient(90deg, rgba(244,67,54,0.16), rgba(239,83,80,0.26));
  border-color: rgba(239,83,80,0.8);
  color: var(--wrong);
}

.btn-main.danger:hover {
  background: linear-gradient(90deg, rgba(244,67,54,0.28), rgba(239,83,80,0.34));
}

.btn-main.small {
  padding: 5px 10px;
  font-size: 11px;
}

.btn-disabled {
  opacity: 0.4;
  pointer-events: none;
}

.shortcut-key {
  font-family: "SF Mono", Menlo, Consolas, monospace;
  font-size: 11px;
  padding: 1px 5px;
  border-radius: 6px;
  border: 1px solid rgba(255,255,255,0.24);
  background: rgba(3,5,16,0.9);
}

/* Right column / Results */

.right-header {
  padding: 10px 16px 8px;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
}

.right-header-title {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.14em;
  color: var(--text-muted);
}

.tab-row {
  display: inline-flex;
  padding: 2px;
  border-radius: 999px;
  background: rgba(8,10,26,0.96);
  border: 1px solid rgba(255,255,255,0.07);
}

.tab {
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  color: var(--text-muted);
  cursor: pointer;
  border: none;
  background: none;
  transition: background 0.12s ease-out, color 0.12s ease-out;
}

.tab.active {
  background: radial-gradient(circle at top, rgba(77,208,225,0.4), rgba(11,15,34,1));
  color: #e0f7fa;
  box-shadow: 0 0 10px rgba(77,208,225,0.8);
}

.right-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 10px 12px 10px;
  gap: 8px;
  font-size: 12px;
}

.summary-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px;
}

.summary-card {
  padding: 7px 8px;
  border-radius: 10px;
  background: rgba(7, 11, 32, 0.98);
  border: 1px solid rgba(255,255,255,0.06);
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.summary-label {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-muted);
}

.summary-value {
  font-size: 13px;
  font-weight: 600;
  color: var(--accent);
}

.summary-subvalue {
  font-size: 11px;
  color: var(--text-muted);
}

.results-controls {
  display: flex;
  justify-content: space-between;
  gap: 6px;
  align-items: center;
  margin-top: 2px;
}

.filter-row {
  display: inline-flex;
  gap: 6px;
  align-items: center;
  font-size: 11px;
  color: var(--text-muted);
}

.filter-pill {
  border-radius: 999px;
  padding: 2px 7px;
  border: 1px solid rgba(255,255,255,0.08);
  cursor: pointer;
  background: rgba(6,10,28,0.95);
}

.filter-pill.active {
  border-color: rgba(77,208,225,0.8);
  background: rgba(77,208,225,0.18);
  color: var(--accent-strong);
}

.results-table-container {
  flex: 1;
  min-height: 140px;
  border-radius: 12px;
  background: radial-gradient(circle at top right, rgba(77,208,225,0.16), rgba(4,7,22,0.98));
  border: 1px solid rgba(255,255,255,0.06);
  padding: 6px 6px 6px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.results-header-row {
  display: grid;
  grid-template-columns: 34px 34px minmax(0, 1fr) 24px;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--text-muted);
  padding: 4px 6px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.results-list {
  flex: 1;
  overflow-y: auto;
  padding: 3px 2px 3px;
  scrollbar-width: thin;
  scrollbar-color: rgba(77,208,225,0.55) rgba(9,11,26,0.96);
}

.results-list::-webkit-scrollbar {
  width: 5px;
}
.results-list::-webkit-scrollbar-track {
  background: rgba(5,7,20,0.96);
}
.results-list::-webkit-scrollbar-thumb {
  background-color: rgba(77,208,225,0.7);
  border-radius: 999px;
}

.result-row {
  display: grid;
  grid-template-columns: 34px 34px minmax(0, 1fr) 24px;
  align-items: flex-start;
  gap: 4px;
  padding: 4px 6px;
  border-radius: 8px;
  font-size: 11px;
  cursor: pointer;
  transition: background 0.12s ease-out, transform 0.05s ease-out;
}

.result-row:nth-child(2n) {
  background: rgba(10,14,30,0.78);
}

.result-row:hover {
  background: rgba(28, 37, 83, 0.95);
  transform: translateY(-0.5px);
}

.result-row.correct {
  border-left: 3px solid rgba(105,240,174,0.85);
}

.result-row.wrong {
  border-left: 3px solid rgba(244,67,54,0.85);
}

.result-status {
  font-size: 13px;
}

.result-status.correct {
  color: var(--correct);
}

.result-status.wrong {
  color: var(--wrong);
}

.result-card-index {
  color: var(--text-muted);
}

.result-question-snippet {
  color: var(--text-main);
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
}

.result-tag-icon {
  font-size: 12px;
  opacity: 0.9;
  text-align: right;
}

.results-empty {
  padding: 16px 10px 10px;
  font-size: 11px;
  color: var(--text-muted);
  text-align: center;
}

.footer-hints {
  padding: 6px 14px 8px;
  border-top: 1px solid rgba(255,255,255,0.06);
  font-size: 11px;
  color: var(--text-muted);
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
  background: radial-gradient(circle at bottom, rgba(15,23,42,0.98), #020512);
}

.footer-hints small {
  font-size: 11px;
}

.footer-hints-right {
  display: flex;
  gap: 8px;
  align-items: center;
}

.hint-key {
  font-family: "SF Mono", Menlo, Consolas, monospace;
  border-radius: 6px;
  border: 1px solid rgba(148,163,184,0.7);
  padding: 1px 4px;
  font-size: 10px;
}

.badge-live {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.18em;
  border-radius: 999px;
  padding: 2px 8px;
  border: 1px solid rgba(244,67,54,0.8);
  color: var(--danger);
  background: rgba(244,67,54,0.12);
}

/* Modal for detail from result row */

.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(2,4,12,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 40;
}

.modal-backdrop.visible {
  display: flex;
}

.modal {
  width: min(560px, 94vw);
  max-height: 80vh;
  border-radius: 14px;
  background: radial-gradient(circle at top left, rgba(77,208,225,0.18), rgba(5,7,20,0.98));
  border: 1px solid rgba(255,255,255,0.12);
  box-shadow: 0 24px 70px rgba(0,0,0,0.9);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.modal-header {
  padding: 10px 14px 8px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 12px;
}

.modal-title {
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.12em;
  color: var(--text-muted);
}

.modal-body {
  padding: 10px 14px 12px;
  font-size: 13px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow-y: auto;
}

.modal-section-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.16em;
  color: var(--text-muted);
  margin-bottom: 2px;
}

.modal-question, .modal-answer {
  padding: 7px 8px;
  border-radius: 10px;
  background: rgba(9,12,32,0.98);
  border: 1px solid rgba(255,255,255,0.06);
}

.modal-answer {
  border-color: rgba(105,240,174,0.7);
  background: rgba(10,26,24,0.96);
  color: var(--correct);
}

.modal-footer {
  padding: 7px 14px 8px;
  border-top: 1px solid rgba(255,255,255,0.08);
  display: flex;
  justify-content: flex-end;
}

.badge-correct {
  border-radius: 999px;
  padding: 2px 7px;
  font-size: 11px;
  border: 1px solid rgba(105,240,174,0.9);
  color: var(--correct);
  background: rgba(10,25,20,0.96);
}

.badge-wrong {
  border-radius: 999px;
  padding: 2px 7px;
  font-size: 11px;
  border: 1px solid rgba(244,67,54,0.9);
  color: var(--wrong);
  background: rgba(30,8,10,0.96);
}

/* Session complete banner */

.session-complete-banner {
  position: absolute;
  right: 14px;
  top: 12px;
  border-radius: 999px;
  padding: 4px 10px;
  font-size: 11px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: radial-gradient(circle at left, rgba(105,240,174,0.5), rgba(13,25,25,0.98));
  color: var(--text-main);
  border: 1px solid rgba(105,240,174,0.9);
  box-shadow: 0 0 18px rgba(105,240,174,0.8);
  display: none;
  z-index: 3;
}

.session-complete-banner.visible {
  display: inline-flex;
}

@media (max-width: 880px) {
  main.app-main {
    flex-direction: column;
  }
  .left-column {
    border-right: none;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .tower-wrapper {
    padding-bottom: 4px;
  }
  .right-column {
    min-height: 210px;
  }
  .app-shell {
    margin: 0;
    border-radius: 0;
  }
}

@media (max-width: 640px) {
  header.app-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }
  .top-stats {
    width: 100%;
    justify-content: space-between;
  }
  .tower-wrapper {
    flex-direction: row;
  }
  .card-panel {
    margin-inline: 10px;
  }
  .progress-bar-container {
    padding-inline: 10px;
  }
  .footer-hints {
    flex-direction: column;
    align-items: flex-start;
  }
}

  </style>
</head>
<body>
<div class="app-shell" id="appShell">
  <header class="app-header">
    <div>
      <div class="app-title">
        <span class="icon">CT</span>
        <span>Radiology Run</span>
      </div>
      <div class="subtitle">Honor-system Anki sprint Â· 40 cards Â· Tower climb mode</div>
    </div>
    <div class="top-stats">
      <div class="pill">
        <span>Score</span>
        <strong id="scoreDisplay">0</strong>
      </div>
      <div class="pill">
        <span>Streak</span>
        <strong id="streakDisplay">0</strong>
      </div>
      <div class="pill">
        <span>Health</span>
        <span class="health-hearts" id="healthDisplay"></span>
      </div>
    </div>
  </header>


  <main class="app-main">
    <section class="left-column">
      <div class="progress-bar-container">
        <div class="progress-label-row">
          <span>Progress Â· <strong id="progressPercent">0%</strong></span>
          <span id="cardCountLabel">Card 1 / 40</span>
        </div>
        <div class="progress-bar-outer" id="progressOuter">
          <div class="progress-bar-inner" id="progressInner"></div>
          <div class="progress-bar-glow"></div>
        </div>
      </div>


  <div class="tower-wrapper">
    <div class="tower" id="tower">
      <div class="tower-shadow"></div>
      <div class="tower-badge">Tower 1</div>
      <div class="tower-hero" id="towerHero">R</div>
    </div>
    <div class="tower-side-info">
      <div class="metric-row">
        <div class="metric">
          <div class="metric-label">Combo</div>
          <div class="metric-value">
            <span id="comboValue">0x</span>
            <span class="metric-subvalue" id="comboDescriptor">Warm up</span>
          </div>
        </div>
        <div class="metric">
          <div class="metric-label">Best streak</div>
          <div class="metric-value">
            <span id="bestStreakValue">0</span>
            <span class="metric-subvalue">Personal best this run</span>
          </div>
        </div>
      </div>
      <div class="metric-row">
        <div class="metric">
          <div class="metric-label">Answered</div>
          <div class="metric-value">
            <span id="answeredCount">0</span>
            <span class="metric-subvalue" id="accuracySummary">0 right Â· 0 wrong</span>
          </div>
        </div>
        <div class="metric">
          <div class="metric-label">Streak buff</div>
          <div class="metric-value">
            <span class="streak-badge" id="streakBadge">
              +0% score Â· 0ðŸ”¥
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <article class="card-panel" id="cardPanel">
    <div class="session-complete-banner" id="sessionCompleteBanner">
      <span>Session complete</span>
      <span>âœ”  Tap "Results" to review</span>
    </div>
    <div class="card-header-row">
      <div class="card-header-row-left">
        <div class="card-tag" id="cardTag">Question</div>
        <div class="card-counter" id="cardCounter">Card 1 of 40</div>
      </div>
      <div class="card-header-row-right">
        <span>Reveal & grade</span>
        <span class="keyboard-hint">Space â†’ reveal Â· R/W to grade</span>
      </div>
    </div>

    <div class="question-area" id="questionArea"></div>

    <div class="answer-area" id="answerArea">
      <div class="answer-label">Answer</div>
      <div class="answer-text" id="answerText"></div>
    </div>

    <div class="controls-row">
      <div class="btn-row-left">
        <button class="btn-main primary" id="revealBtn">
          <span>Show answer</span>
          <span class="shortcut-key">Space</span>
        </button>
      </div>
      <div class="btn-row-right">
        <button class="btn-main success btn-disabled" id="rightBtn">
          <span>Got it</span>
          <span class="shortcut-key">R</span>
        </button>
        <button class="btn-main danger btn-disabled" id="wrongBtn">
          <span>Missed it</span>
          <span class="shortcut-key">W</span>
        </button>
      </div>
    </div>
  </article>
</section>

<section class="right-column">
  <div class="right-header">
    <div>
      <div class="right-header-title">Session dashboard</div>
    </div>
    <div class="tab-row">
      <button class="tab active" id="tabSummary">Summary</button>
      <button class="tab" id="tabResults">Results</button>
    </div>
  </div>

  <div class="right-content" id="summaryView">
    <div class="summary-grid">
      <div class="summary-card">
        <div class="summary-label">Cards done</div>
        <div class="summary-value" id="summaryCardsDone">0 / 40</div>
        <div class="summary-subvalue">Keep climbing the tower</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Accuracy</div>
        <div class="summary-value" id="summaryAccuracy">0%</div>
        <div class="summary-subvalue" id="summaryRightWrong">0 right Â· 0 wrong</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Best streak</div>
        <div class="summary-value" id="summaryBestStreak">0</div>
        <div class="summary-subvalue">Longer streaks = bigger score</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Final score</div>
        <div class="summary-value" id="summaryScore">0</div>
        <div class="summary-subvalue">Score is streak-weighted</div>
      </div>
    </div>
    <div class="results-controls">
      <div class="filter-row">
        <span>Review mode:</span>
        <button class="filter-pill active" id="btnFilterAll">All attempts</button>
        <button class="filter-pill" id="btnFilterWrong">Only wrong</button>
      </div>
      <div>
        <button class="btn-main small" id="btnReviewWrongSession">
          Replay wrong-only run
        </button>
      </div>
    </div>

    <div class="results-table-container">
      <div class="results-header-row">
        <div>#</div>
        <div>Card</div>
        <div>Question snippet</div>
        <div></div>
      </div>
      <div class="results-list" id="resultsList">
        <div class="results-empty" id="resultsEmpty">
          No attempts logged yet. As you blaze through cards, they will appear here for quick review.
        </div>
      </div>
    </div>
  </div>

  <div class="right-content" id="resultsView" style="display:none;">
    <div class="results-controls">
      <div class="filter-row">
        <span>Filter:</span>
        <button class="filter-pill active" id="btnFilterAll2">All</button>
        <button class="filter-pill" id="btnFilterWrong2">Wrong only</button>
      </div>
      <div>
        <button class="btn-main small" id="btnBackToSummary">
          Back to summary
        </button>
      </div>
    </div>
    <div class="results-table-container">
      <div class="results-header-row">
        <div>#</div>
        <div>Card</div>
        <div>Question snippet</div>
        <div></div>
      </div>
      <div class="results-list" id="resultsList2">
        <div class="results-empty" id="resultsEmpty2">
          No attempts logged yet.
        </div>
      </div>
    </div>
  </div>
</section>

  </main>


  <footer class="footer-hints">
    <div>
      <small>
        <span class="badge-live">Live</span>
        Â·Honor system: think of the answer first, then reveal and mark yourself right or wrong.
      </small>
    </div>
    <div class="footer-hints-right">
      <small>Shortcuts:</small>
      <span class="hint-key">Space</span><small>reveal / next</small>
      <span class="hint-key">R</span><small>got it</small>
      <span class="hint-key">W</span><small>missed it</small>
    </div>
  </footer>
</div>


<!-- Modal for attempt detail -->


<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title">Attempt details</div>
      </div>
      <div>
        <button class="btn-main small" id="modalCloseBtn">Close</button>
      </div>
    </div>
    <div class="modal-body">
      <div>
        <div class="modal-section-label">Card</div>
        <div id="modalMeta" style="font-size:12px; color:var(--text-muted);"></div>
      </div>
      <div>
        <div class="modal-section-label">Question</div>
        <div class="modal-question" id="modalQuestion"></div>
      </div>
      <div>
        <div class="modal-section-label">Answer</div>
        <div class="modal-answer" id="modalAnswer"></div>
      </div>
    </div>
    <div class="modal-footer">
      <span id="modalBadge"></span>
    </div>
  </div>
</div>


<script>
  const cards = [
    {
      id: 1,
      question: "What is the second most common cause of sudden cardiac death in young patients (after hypertrophic cardiomyopathy)?",
      answer: "Interarterial course of an anomalous left coronary artery arising from the right coronary cusp."
    },
    {
      id: 2,
      question: "On a lateral chest radiograph, the left main pulmonary artery courses where with respect to the left upper lobe bronchus?",
      answer: "Posterior to the left upper lobe bronchus."
    },
    {
      id: 4,
      question: "Functional pancreatic neuroendocrine tumors often present when small because...",
      answer: "Hormone secretion produces clinical symptoms that trigger early imaging."
    },
    {
      id: 5,
      question: "The two most common intramedullary neoplasms of the spinal cord are...",
      answer: "Ependymoma and astrocytoma."
    },
    {
      id: 6,
      question: "What procedure is shown?",
      answer: "Hemiarthroplasty."
    },
    {
      id: 7,
      question: "A practical way to reduce chemical shift artifact is to...",
      answer: "Increase the receiver bandwidth."
    },
    {
      id: 8,
      question: "Lymphocytic interstitial pneumonia (LIP) in an adult is classically associated with what disease?",
      answer: "Sjogren's syndrome."
    },
    {
      id: 9,
      question: "A Ghon complex is defined as...",
      answer: "A Ghon focus alongside ipsilateral mediastinal lymphadenopathy."
    },
    {
      id: 10,
      question: "List the intracranial segments of the facial nerve in order from the internal auditory canal to exit at the stylomastoid foramen.",
      answer: "Labyrinthine â†’ geniculate ganglion (first genu) â†’ tympanic segment â†’ mastoid segment."
    },
    {
      id: 11,
      question: "Among posterior fossa tumors, which is most associated with drop metastases?",
      answer: "Medulloblastoma."
    },
    {
      id: 12,
      question: "The two classic benign asbestos-related changes are...",
      answer: "Pleural effusion and pleural plaques."
    },
    {
      id: 13,
      question: "What percentage of adrenal adenomas are lipid poor?",
      answer: "30%."
    },
    {
      id: 14,
      question: "The term \"bone contusion\" refers to what?",
      answer: "Trabecular microfractures that manifest as a pattern of bone marrow edema on MR images, without contour abnormalities or a discrete fracture line."
    },
    {
      id: 15,
      question: "Child with short stature (especially limbs), delayed closure of cranial sutures, frontal and occipital bossing, short broad hands with hypoplastic nails, and multiple long bone fractures after minimal trauma. What is the diagnosis?",
      answer: "Pyknodysostosis."
    },
    {
      id: 16,
      question: "For a mobile C-arm, the minimum focus-to-skin distance should be how many centimeters?",
      answer: "30 cm."
    },
    {
      id: 17,
      question: "Idiopathic retroperitoneal fibrosis is also called what, and many cases are now recognized as part of which disease spectrum?",
      answer: "Ormond disease; many cases are now recognized as part of IgG4-related disease."
    },
    {
      id: 19,
      question: "In a 65-year-old with chondrocalcinosis and arthropathy, what is the most likely diagnosis?",
      answer: "CPPD crystal deposition disease."
    },
    {
      id: 20,
      question: "What is the diagnosis?",
      answer: "Hibernoma."
    },
    {
      id: 21,
      question: "Pyknodysostosis combines what two key skeletal features?",
      answer: "Generalized osteosclerosis with brittle bones and fractures."
    },
    {
      id: 22,
      question: "What is the diagnosis?",
      answer: "Polyarteritis nodosa."
    },
    {
      id: 23,
      question: "Which liposarcoma subtype typically appears as a large deep soft-tissue mass with necrosis and only small foci of fat?",
      answer: "Pleomorphic liposarcoma."
    },
    {
      id: 24,
      question: "What is the hallmark CT enhancement pattern for pancreatic neuroendocrine tumors?",
      answer: "Hyper-enhancement on the pancreatic parenchymal or arterial phase."
    },
    {
      id: 25,
      question: "In renal cell carcinoma TNM staging, what does T4 mean?",
      answer: "Tumor invades beyond the Gerota fascia or involves the ipsilateral adrenal gland."
    },
    {
      id: 26,
      question: "In the Doctrine and Covenants, which sections were written during Liberty Jail?",
      answer: "Sections 121â€“123."
    },
    {
      id: 28,
      question: "The anterior meniscofemoral ligament, also known as the ligament of Humphry, arises from where and passes where relative to the PCL?",
      answer: "It arises from the posterior horn of the lateral meniscus and passes anterior to the PCL."
    },
    {
      id: 29,
      question: "Myocardial bridging refers to what?",
      answer: "An intramyocardial course of a coronary artery, most commonly the LAD."
    },
    {
      id: 30,
      question: "For the foot and ankle, the most common causes of neuropathic arthropathy are...",
      answer: "Diabetes mellitus and alcoholism."
    },
    {
      id: 31,
      question: "What is the overall limb pattern in thanatophoric dysplasia?",
      answer: "Micromelia (per AIRP lecture; rhizomelia per Crack the Core)."
    },
    {
      id: 32,
      question: "What is the diagnosis?",
      answer: "Filum fibrolipoma."
    },
    {
      id: 33,
      question: "Most common manifestation of cardiac metastases is what, and the second most is what?",
      answer: "Most common is pericardial effusion; the second most is pericardial lymph node involvement."
    },
    {
      id: 35,
      question: "Compared with intraductal papillary mucinous neoplasms (IPMNs), cystic pancreatic neuroendocrine tumors are distinguished by what CT feature?",
      answer: "A solid hyper-enhancing rim rather than a purely cystic lesion without a prominent enhancing wall."
    },
    {
      id: 36,
      question: "In a neonate with germinal matrix hemorrhage, what is the diagnosis when there is extension into the lateral ventricles without ventricular dilatation?",
      answer: "Grade 2 germinal matrix hemorrhage."
    },
    {
      id: 37,
      question: "When you see polyostotic aggressive bone lesions, what three entities should you think of first?",
      answer: "Metastases, multiple myeloma, and lymphoma."
    },
    {
      id: 41,
      question: "When lipomatosis affects a nerve territory with associated bone hypertrophy, what is it called?",
      answer: "Macrodystrophia lipomatosa."
    },
    {
      id: 42,
      question: "What is the hallmark MRI appearance of myxoid liposarcoma?",
      answer: "A highâ€“water-content mass that contains only a small amount of intrinsic fat, often less than ten percent of the tumor volume."
    },
    {
      id: 43,
      question: "The anterior inferior tibiofibular ligament (AITFL) is also known as what?",
      answer: "The anterior syndesmosis."
    },
    {
      id: 44,
      question: "Important causes of a hyper-enhancing pancreatic lesion on arterial phase imaging include which entities?",
      answer: "Pancreatic neuroendocrine tumor, metastatic renal cell carcinoma, duodenal gastrointestinal stromal tumor, solid appearing serous cystadenoma, and intrapancreatic accessory spleen."
    },
    {
      id: 45,
      question: "In renal cell carcinoma TNM staging, what does T2 mean?",
      answer: "Tumor limited to the kidney and greater than seven centimeters."
    },
    {
      id: 46,
      question: "Myxoid liposarcoma tends to occur in what age group and most often arises where?",
      answer: "Younger adults; most often in intermuscular locations of the thigh and popliteal fossa."
    },
    {
      id: 47,
      question: "Transmasculine patients on long-term testosterone therapy with arterially hyperenhancing liver lesions are more likely to have what type of hepatocellular adenoma?",
      answer: "Beta-cateninâ€“associated hepatocellular adenomas."
    }
  ];

  // State
  let currentIndex = 0;
  let showingAnswer = false;
  let score = 0;
  let streak = 0;
  let bestStreak = 0;
  let answeredRight = 0;
  let answeredWrong = 0;
  let health = 3;
  const maxHealth = 3;
  let attempts = [];
  let attemptCounter = 0;
  let sessionFinished = false;
  let reviewWrongQueue = null; // array of indices into attempts for wrong-only replay
  let reviewWrongPointer = 0;

  const STORAGE_KEY = "ankiRadiologyRunSession";

  // Elements
  const scoreDisplay = document.getElementById("scoreDisplay");
  const streakDisplay = document.getElementById("streakDisplay");
  const healthDisplay = document.getElementById("healthDisplay");
  const comboValue = document.getElementById("comboValue");
  const comboDescriptor = document.getElementById("comboDescriptor");
  const bestStreakValue = document.getElementById("bestStreakValue");
  const answeredCount = document.getElementById("answeredCount");
  const accuracySummary = document.getElementById("accuracySummary");
  const progressInner = document.getElementById("progressInner");
  const progressOuter = document.getElementById("progressOuter");
  const progressPercent = document.getElementById("progressPercent");
  const cardTag = document.getElementById("cardTag");
  const cardCounter = document.getElementById("cardCounter");
  const cardCountLabel = document.getElementById("cardCountLabel");
  const questionArea = document.getElementById("questionArea");
  const answerArea = document.getElementById("answerArea");
  const answerText = document.getElementById("answerText");
  const revealBtn = document.getElementById("revealBtn");
  const rightBtn = document.getElementById("rightBtn");
  const wrongBtn = document.getElementById("wrongBtn");
  const cardPanel = document.getElementById("cardPanel");
  const sessionCompleteBanner = document.getElementById("sessionCompleteBanner");
  const tower = document.getElementById("tower");
  const towerHero = document.getElementById("towerHero");
  const streakBadge = document.getElementById("streakBadge");

  const tabSummary = document.getElementById("tabSummary");
  const tabResults = document.getElementById("tabResults");
  const summaryView = document.getElementById("summaryView");
  const resultsView = document.getElementById("resultsView");

  const summaryCardsDone = document.getElementById("summaryCardsDone");
  const summaryAccuracy = document.getElementById("summaryAccuracy");
  const summaryRightWrong = document.getElementById("summaryRightWrong");
  const summaryBestStreak = document.getElementById("summaryBestStreak");
  const summaryScore = document.getElementById("summaryScore");

  const btnFilterAll = document.getElementById("btnFilterAll");
  const btnFilterWrong = document.getElementById("btnFilterWrong");
  const btnFilterAll2 = document.getElementById("btnFilterAll2");
  const btnFilterWrong2 = document.getElementById("btnFilterWrong2");
  const btnReviewWrongSession = document.getElementById("btnReviewWrongSession");
  const btnBackToSummary = document.getElementById("btnBackToSummary");

  const resultsList = document.getElementById("resultsList");
  const resultsList2 = document.getElementById("resultsList2");
  const resultsEmpty = document.getElementById("resultsEmpty");
  const resultsEmpty2 = document.getElementById("resultsEmpty2");

  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalCloseBtn = document.getElementById("modalCloseBtn");
  const modalMeta = document.getElementById("modalMeta");
  const modalQuestion = document.getElementById("modalQuestion");
  const modalAnswer = document.getElementById("modalAnswer");
  const modalBadge = document.getElementById("modalBadge");

  let filterMode = "all";

  function initHealthDisplay() {
    renderHealthHearts();
  }

  function renderHealthHearts(pulse = false) {
    const hearts = [];
    for (let i = 0; i < maxHealth; i++) {
      if (i < health) {
        hearts.push("â¤");
      } else {
        hearts.push("â™¡");
      }
    }
    healthDisplay.innerHTML = hearts.join(" ");
    if (pulse) {
      healthDisplay.classList.remove("health-pulse");
      void healthDisplay.offsetWidth;
      healthDisplay.classList.add("health-pulse");
    }
  }

  function getComboDescriptor(streak) {
    if (streak >= 10) return "On fire";
    if (streak >= 7) return "Scanner humming";
    if (streak >= 4) return "In the zone";
    if (streak >= 2) return "Locked in";
    return "Warm up";
  }

  function updateComboDisplay() {
    const multiplier = 1 + Math.floor(streak / 3);
    comboValue.textContent = multiplier + "x";
    comboDescriptor.textContent = getComboDescriptor(streak);

    const bonusPercent = (multiplier - 1) * 25;
    streakBadge.textContent = `+${bonusPercent}% score Â· ${streak}ðŸ”¥`;

    streakBadge.classList.remove("shake");
    void streakBadge.offsetWidth;
    if (streak >= 2) streakBadge.classList.add("shake");
  }

  function updateScoreAndStats() {
    scoreDisplay.textContent = score;
    streakDisplay.textContent = streak;
    bestStreakValue.textContent = bestStreak;
    const totalAnswers = answeredRight + answeredWrong;
    answeredCount.textContent = totalAnswers;
    accuracySummary.textContent = `${answeredRight} right Â· ${answeredWrong} wrong`;

    summaryCardsDone.textContent = `${totalAnswers} / ${cards.length}`;
    const accuracy = totalAnswers ? Math.round((answeredRight / totalAnswers) * 100) : 0;
    summaryAccuracy.textContent = `${accuracy}%`;
    summaryRightWrong.textContent = `${answeredRight} right Â· ${answeredWrong} wrong`;
    summaryBestStreak.textContent = bestStreak.toString();
    summaryScore.textContent = score.toString();

    const percent = Math.round((totalAnswers / cards.length) * 100);
    progressPercent.textContent = percent + "%";
    progressInner.style.width = percent + "%";
    progressOuter.classList.remove("glow");
    void progressOuter.offsetWidth;
    if (totalAnswers > 0) {
      progressOuter.classList.add("glow");
      setTimeout(() => progressOuter.classList.remove("glow"), 200);
    }

    cardCountLabel.textContent = `Card ${Math.min(currentIndex + 1, cards.length)} / ${cards.length}`;
  }

  function buildTower() {
    tower.innerHTML = `
      <div class="tower-shadow"></div>
      <div class="tower-badge">Tower 1</div>
      <div class="tower-hero" id="towerHero">R</div>
    `;
    const totalFloors = cards.length;
    for (let i = 0; i < totalFloors; i++) {
      const floor = document.createElement("div");
      floor.className = "tower-floor";
      floor.dataset.index = i;
      tower.appendChild(floor);
    }
    const hero = document.getElementById("towerHero");
    hero.style.bottom = "4px";
  }

  function updateTower() {
    const floors = Array.from(tower.querySelectorAll(".tower-floor"));
    floors.forEach((floor, idx) => {
      floor.classList.remove("done", "current");
      if (idx < currentIndex) {
        floor.classList.add("done");
      } else if (idx === currentIndex) {
        floor.classList.add("current");
      }
    });

    const hero = document.getElementById("towerHero");
    const step = (tower.clientHeight - 36) / Math.max(cards.length - 1, 1);
    hero.style.bottom = (4 + currentIndex * step) + "px";
  }

  function renderCard() {
    if (currentIndex >= cards.length) {
      currentIndex = cards.length - 1;
      finishSession();
      return;
    }

    const card = cards[currentIndex];
    questionArea.textContent = card.question;
    answerText.textContent = card.answer;

    if (!sessionFinished) {
      cardTag.textContent = reviewWrongQueue ? "Review: wrong card" : "Question";
    } else {
      cardTag.textContent = "Session complete";
    }

    cardCounter.textContent = `Card ${currentIndex + 1} of ${cards.length}`;

    answerArea.classList.remove("visible");
    showingAnswer = false;
    revealBtn.classList.remove("btn-disabled");
    rightBtn.classList.add("btn-disabled");
    wrongBtn.classList.add("btn-disabled");

    cardPanel.classList.remove("correct-flash", "wrong-flash");

    updateTower();
  }

  function logAttempt(correct) {
    const baseCardIndex = reviewWrongQueue ? attempts[reviewWrongQueue[reviewWrongPointer]].cardIndex : currentIndex;
    const card = cards[baseCardIndex];
    attemptCounter += 1;
    const entry = {
      attemptNumber: attemptCounter,
      cardIndex: baseCardIndex,
      cardId: card.id,
      question: card.question,
      answer: card.answer,
      correct: !!correct,
      timestamp: new Date().toISOString()
    };
    attempts.push(entry);
    saveSession();
    renderResults();
  }

  function handleGrade(correct) {
    if (!showingAnswer) return;
    const card = cards[currentIndex];
    const multiplier = 1 + Math.floor(streak / 3);
    const basePoints = 100;

    if (correct) {
      answeredRight += 1;
      streak += 1;
      bestStreak = Math.max(bestStreak, streak);
      score += basePoints * multiplier;

      cardPanel.classList.remove("correct-flash");
      void cardPanel.offsetWidth;
      cardPanel.classList.add("correct-flash");
      setTimeout(() => cardPanel.classList.remove("correct-flash"), 160);
    } else {
      answeredWrong += 1;
      streak = 0;
      health = Math.max(0, health - 1);
      renderHealthHearts(true);

      cardPanel.classList.remove("wrong-flash");
      void cardPanel.offsetWidth;
      cardPanel.classList.add("wrong-flash");
      setTimeout(() => cardPanel.classList.remove("wrong-flash"), 160);
    }

    updateComboDisplay();
    updateScoreAndStats();
    logAttempt(correct);

    if (!correct && health === 0) {
      cardTag.textContent = "Critical fatigue";
    }

    const usingReviewQueue = !!reviewWrongQueue;
    if (usingReviewQueue) {
      reviewWrongPointer += 1;
      if (reviewWrongPointer >= reviewWrongQueue.length) {
        reviewWrongQueue = null;
        reviewWrongPointer = 0;
        if (!sessionFinished && currentIndex < cards.length) {
          currentIndex = attempts.filter(a => a.correct || (!a.correct && a.cardIndex < currentIndex)).length;
        }
      }
    } else {
      currentIndex += 1;
    }

    if (currentIndex >= cards.length && !reviewWrongQueue) {
      finishSession();
    }

    revealBtn.classList.remove("btn-disabled");
    rightBtn.classList.add("btn-disabled");
    wrongBtn.classList.add("btn-disabled");
    showingAnswer = false;

    if (currentIndex < cards.length) {
      renderCard();
    } else if (reviewWrongQueue) {
      const baseCardIndex = attempts[reviewWrongQueue[Math.max(reviewWrongPointer, 0)]].cardIndex;
      currentIndex = baseCardIndex;
      renderCard();
    }
  }

  function finishSession() {
    if (sessionFinished) return;
    sessionFinished = true;
    sessionCompleteBanner.classList.add("visible");
    cardTag.textContent = "Session complete";

    if (answeredWrong > 0) {
      btnReviewWrongSession.classList.remove("btn-disabled");
    }

    renderCard();
  }

  function saveSession() {
    try {
      const data = {
        attempts,
        score,
        streak,
        bestStreak,
        answeredRight,
        answeredWrong,
        health,
        currentIndex,
        attemptCounter,
        sessionFinished
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
      // ignore
    }
  }

  function loadSession() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const data = JSON.parse(raw);
      if (!Array.isArray(data.attempts)) return;

      attempts = data.attempts || [];
      score = data.score || 0;
      streak = data.streak || 0;
      bestStreak = data.bestStreak || 0;
      answeredRight = data.answeredRight || 0;
      answeredWrong = data.answeredWrong || 0;
      health = typeof data.health === "number" ? data.health : maxHealth;
      currentIndex = typeof data.currentIndex === "number" ? data.currentIndex : 0;
      attemptCounter = data.attemptCounter || attempts.length;
      sessionFinished = !!data.sessionFinished;

      if (currentIndex >= cards.length) currentIndex = cards.length - 1;
    } catch (e) {
      // ignore
    }
  }

  function clearSession() {
    attempts = [];
    score = 0;
    streak = 0;
    bestStreak = 0;
    answeredRight = 0;
    answeredWrong = 0;
    health = maxHealth;
    currentIndex = 0;
    attemptCounter = 0;
    sessionFinished = false;
    reviewWrongQueue = null;
    reviewWrongPointer = 0;
    try { localStorage.removeItem(STORAGE_KEY); } catch(e){}
  }

  function renderResults() {
    const total = attempts.length;
    const containers = [
      { list: resultsList, empty: resultsEmpty },
      { list: resultsList2, empty: resultsEmpty2 }
    ];

    containers.forEach(({ list, empty }) => {
      list.innerHTML = "";
      if (!total) {
        empty.style.display = "block";
        list.appendChild(empty);
        return;
      }
      empty.style.display = "none";
    });

    const buildRows = (container, mode) => {
      const filtered = attempts.filter(a => mode === "wrong" ? !a.correct : true);

      if (!filtered.length) {
        const emptyDiv = mode === "wrong" ? resultsEmpty2.cloneNode(true) : resultsEmpty.cloneNode(true);
        emptyDiv.style.display = "block";
        emptyDiv.textContent = "No attempts in this filter yet.";
        container.appendChild(emptyDiv);
        return;
      }

      filtered.forEach((a, idx) => {
        const row = document.createElement("div");
        row.className = "result-row " + (a.correct ? "correct" : "wrong");
        row.dataset.attemptIndex = attempts.indexOf(a);

        const cardNum = a.cardIndex + 1;
        const snippet = a.question.length > 70 ? a.question.slice(0, 70) + "â€¦" : a.question;

        const colAttempt = document.createElement("div");
        colAttempt.textContent = idx + 1;
        const colCard = document.createElement("div");
        colCard.textContent = cardNum;
        colCard.className = "result-card-index";
        const colSnippet = document.createElement("div");
        colSnippet.className = "result-question-snippet";
        colSnippet.textContent = snippet;
        const colStatus = document.createElement("div");
        colStatus.className = "result-tag-icon";

        const statusSpan = document.createElement("span");
        statusSpan.className = "result-status " + (a.correct ? "correct" : "wrong");
        statusSpan.textContent = a.correct ? "âœ“" : "âœ•";
        colStatus.appendChild(statusSpan);

        row.appendChild(colAttempt);
        row.appendChild(colCard);
        row.appendChild(colSnippet);
        row.appendChild(colStatus);

        row.addEventListener("click", () => openModalForAttempt(row.dataset.attemptIndex));

        container.appendChild(row);
      });
    };

    buildRows(resultsList, filterMode);
    buildRows(resultsList2, filterMode);
  }

  function setFilterMode(mode) {
    filterMode = mode;
    [btnFilterAll, btnFilterAll2].forEach(btn => btn.classList.toggle("active", mode === "all"));
    [btnFilterWrong, btnFilterWrong2].forEach(btn => btn.classList.toggle("active", mode === "wrong"));
    renderResults();
  }

  function switchTab(tab) {
    if (tab === "summary") {
      tabSummary.classList.add("active");
      tabResults.classList.remove("active");
      summaryView.style.display = "flex";
      resultsView.style.display = "none";
    } else {
      tabSummary.classList.remove("active");
      tabResults.classList.add("active");
      summaryView.style.display = "none";
      resultsView.style.display = "flex";
    }
  }

  function openModalForAttempt(attemptIndex) {
    const idx = Number(attemptIndex);
    const a = attempts[idx];
    if (!a) return;
    const humanAttempt = idx + 1;
    const cardNum = a.cardIndex + 1;
    modalMeta.textContent = `Attempt ${humanAttempt} Â· Card ${cardNum} (ID ${a.cardId})`;
    modalQuestion.textContent = a.question;
    modalAnswer.textContent = a.answer;
    modalBadge.innerHTML = "";
    const badge = document.createElement("span");
    if (a.correct) {
      badge.className = "badge-correct";
      badge.textContent = "Marked right";
    } else {
      badge.className = "badge-wrong";
      badge.textContent = "Marked wrong";
    }
    modalBadge.appendChild(badge);
    modalBackdrop.classList.add("visible");
  }

  function closeModal() {
    modalBackdrop.classList.remove("visible");
  }

  function startWrongOnlyReview() {
    const wrongAttempts = attempts
      .map((a, idx) => ({ a, idx }))
      .filter(x => !x.a.correct)
      .map(x => x.idx);

    if (!wrongAttempts.length) {
      reviewWrongQueue = null;
      reviewWrongPointer = 0;
      return;
    }

    reviewWrongQueue = wrongAttempts;
    reviewWrongPointer = 0;
    const firstAttempt = attempts[reviewWrongQueue[0]];
    currentIndex = firstAttempt.cardIndex;
    sessionFinished = false;
    sessionCompleteBanner.classList.remove("visible");
    cardTag.textContent = "Review: wrong card";
    renderCard();
    switchTab("summary");
  }

  function handleReveal() {
    if (sessionFinished && !reviewWrongQueue) return;
    if (!showingAnswer) {
      showingAnswer = true;
      answerArea.classList.add("visible");
      revealBtn.classList.add("btn-disabled");
      rightBtn.classList.remove("btn-disabled");
      wrongBtn.classList.remove("btn-disabled");
    } else {
      if (!rightBtn.classList.contains("btn-disabled")) {
        handleGrade(true);
      }
    }
  }

  function setupListeners() {
    revealBtn.addEventListener("click", handleReveal);
    rightBtn.addEventListener("click", () => handleGrade(true));
    wrongBtn.addEventListener("click", () => handleGrade(false));

    document.addEventListener("keydown", (e) => {
      const tag = e.target.tagName.toLowerCase();
      if (tag === "input" || tag === "textarea") return;

      if (e.code === "Space") {
        e.preventDefault();
        handleReveal();
      } else if (e.key === "r" || e.key === "R") {
        e.preventDefault();
        if (!rightBtn.classList.contains("btn-disabled")) handleGrade(true);
      } else if (e.key === "w" || e.key === "W") {
        e.preventDefault();
        if (!wrongBtn.classList.contains("btn-disabled")) handleGrade(false);
      } else if (e.key === "Escape") {
        if (modalBackdrop.classList.contains("visible")) {
          closeModal();
        }
      }
    });

    tabSummary.addEventListener("click", () => switchTab("summary"));
    tabResults.addEventListener("click", () => switchTab("results"));
    btnBackToSummary.addEventListener("click", () => switchTab("summary"));

    btnFilterAll.addEventListener("click", () => setFilterMode("all"));
    btnFilterWrong.addEventListener("click", () => setFilterMode("wrong"));
    btnFilterAll2.addEventListener("click", () => setFilterMode("all"));
    btnFilterWrong2.addEventListener("click", () => setFilterMode("wrong"));

    btnReviewWrongSession.addEventListener("click", () => startWrongOnlyReview());

    modalCloseBtn.addEventListener("click", closeModal);
    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) closeModal();
    });
  }

  function init() {
    buildTower();
    initHealthDisplay();
    loadSession();
    updateComboDisplay();
    updateScoreAndStats();
    renderCard();
    renderResults();
    setupListeners();
  }

  init();
</script>


</body>
</html>
