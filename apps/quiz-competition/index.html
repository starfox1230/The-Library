<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quiz HTML Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #12121f;
            color: #e0e0fc;
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 30px 20px;
            box-sizing: border-box;
        }

        .generator-container {
            background-color: #1a1a2e;
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 0 25px rgba(74, 74, 245, 0.4),
                        0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 900px;
            text-align: center;
            border: 1px solid #3a3a5e;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            color: #8a8aff;
            margin-bottom: 20px;
            text-shadow: 0 0 8px rgba(138, 138, 255, 0.5);
        }

        p, label {
            color: #c0c0fa;
            line-height: 1.6;
            margin-bottom: 15px;
            text-align: left;
        }

        .prompt-section {
            background-color: #202035;
            border: 1px solid #3a3a5e;
            border-radius: 8px;
            padding: 25px;
            margin-top: 20px;
            margin-bottom: 30px;
            text-align: left;
        }

        .prompt-section strong {
             color: #8a8aff;
        }

        .prompt-generator-ui {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .prompt-generator-ui .control-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
        }

        .prompt-generator-ui label {
            font-family: 'Orbitron', sans-serif;
            color: #c0c0fa;
            font-size: 1.1em;
            margin-bottom: 0;
        }

        .difficulty-buttons, .question-count-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .difficulty-btn {
            background-color: #2a2a4e;
            border: 1px solid #4a4a7e;
            color: #d0d0fc;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95em;
        }

        .difficulty-btn:hover {
            background-color: #3a3a5e;
            border-color: #6a6aff;
        }

        .difficulty-btn.selected {
            background-color: #4a4af5;
            border-color: #8a8aff;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(74, 74, 245, 0.5);
        }

        #questionCount {
            background-color: #2a2a4e;
            color: #d0d0fc;
            border: 1px solid #4a4a7e;
            border-radius: 6px;
            padding: 10px;
            font-family: monospace;
            font-size: 1.2em;
            width: 80px;
            text-align: center;
        }

        .prompt-output-area {
            margin-top: 20px;
        }

        #prompt-display-container {
            background-color: #12121f;
            border: 1px dashed #3a3a5e;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        #prompt-display-container code {
            white-space: pre-wrap;
            color: #f0f0ff;
            font-family: monospace;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .prompt-actions {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            background-color: #2a2a4e;
            color: #d0d0fc;
            border: 1px solid #4a4a7e;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 0.9em;
            margin-bottom: 20px;
            box-sizing: border-box;
            resize: vertical;
        }

        .action-button, .copy-button, .toggle-prompt-btn {
            background: linear-gradient(45deg, #4a4af5, #8a8aff);
            color: white;
            border: none;
            padding: 10px 25px;
            font-size: 1em;
            font-family: 'Orbitron', sans-serif;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.3s ease, background 0.3s ease;
            box-shadow: 0 4px 10px rgba(74, 74, 245, 0.3);
            text-align: center;
            min-width: 100px;
        }

        .toggle-prompt-btn {
             background: transparent;
             border: 1px solid #4a4a7e;
             color: #c0c0fa;
             box-shadow: none;
        }
        
        #pastGamesBtn {
            background: transparent;
            border: 1px solid #ff79c6;
            color: #ff79c6;
            box-shadow: none;
        }
        #pastGamesBtn:hover {
            background-color: #ff79c6;
            color: white;
            box-shadow: 0 6px 15px rgba(255, 121, 198, 0.5);
        }

        .action-button:hover:not(:disabled),
        .copy-button:hover:not(:disabled),
        .toggle-prompt-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(74, 74, 245, 0.5);
        }
        .toggle-prompt-btn:hover {
            background-color: #3a3a5e;
        }


         .action-button:disabled,
         .copy-button:disabled {
            background: #5a5a7e;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
            transform: none;
        }

        .link-style {
            color: #a0a0ff;
            text-decoration: none;
            transition: color 0.2s ease;
            margin-left: 10px;
        }
        .link-style:hover {
            color: #c0c0ff;
            text-decoration: underline;
        }

        .button-group {
             display: flex;
             justify-content: center;
             flex-wrap: wrap;
             gap: 15px;
             margin-top: 10px;
             margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .generator-container {
                padding: 20px;
                width: 95%;
            }
            h1 {
                font-size: 1.5em;
            }
             .action-button, .copy-button, .toggle-prompt-btn {
                 padding: 8px 18px;
                 font-size: 0.9em;
                 width: 100%;
                 justify-content: center;
             }
             .prompt-actions {
                 flex-direction: column;
                 align-items: stretch;
             }
             textarea {
                 min-height: 150px;
             }
        }

        .copied-feedback {
            background-color: #1f7a3f !important;
        }

        /* --- Past Games Modal Styles --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(18, 18, 31, 0.95); z-index: 2000;
            display: flex; justify-content: center; align-items: center; text-align: center;
        }
        .overlay-content {
            background-color: #1a1a2e; padding: 40px; border-radius: 15px;
            border: 1px solid #3a3a5e; box-shadow: 0 0 30px rgba(0,0,0,0.5);
            width: 90%; max-width: 700px;
            max-height: 80vh;
            display: flex; flex-direction: column;
        }
         .overlay-content h2 { 
            font-family: 'Orbitron', sans-serif; color: #8a8aff; 
            font-size: 2em; margin-top: 0; margin-bottom: 20px; 
        }
        .overlay-content .close-btn {
            position: absolute; top: 20px; right: 20px;
            background: none; border: none; font-size: 2em; color: #c0c0fa;
            cursor: pointer; line-height: 1;
        }

        #past-games-list {
            list-style: none; padding: 0; margin: 0;
            overflow-y: auto; text-align: left;
            flex-grow: 1;
        }
        #past-games-list li {
            background-color: #2a2a4e;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #4a4af5;
        }
        #past-games-list .game-info {
            display: flex;
            flex-direction: column;
        }
        #past-games-list .game-name {
            font-weight: bold;
            color: #e0e0fc;
            font-size: 1.1em;
        }
        #past-games-list .game-date {
            font-size: 0.8em;
            color: #c0c0fa;
        }
        #past-games-list .load-btn {
             background: transparent; border: 1px solid #00fddc; color: #00fddc;
             padding: 8px 15px; border-radius: 20px; cursor: pointer;
             transition: all 0.2s ease;
        }
        #past-games-list .load-btn:hover {
            background-color: #00fddc; color: #12121f;
        }

    </style>
</head>
<body>
    <div class="generator-container">
        <h1>Quiz HTML Generator</h1>
        <p>This tool generates a self-contained, two-player HTML quiz file. First, build your AI prompt, then paste the generated questions below. The quiz will replace this page.</p>

        <div class="prompt-section">
            <div class="prompt-generator-ui">
                <!-- Step 1: Difficulty -->
                <div class="control-group">
                    <label>1. Choose Question Difficulty:</label>
                    <div class="difficulty-buttons">
                        <button class="difficulty-btn" data-difficulty="elementary">Elementary</button>
                        <button class="difficulty-btn" data-difficulty="high_school">High School</button>
                        <button class="difficulty-btn selected" data-difficulty="hard">Boards-Level (Hard)</button>
                    </div>
                </div>

                <!-- Step 2: Number of Questions -->
                <div class="control-group">
                    <label for="questionCount">2. Choose Number of Questions:</label>
                    <div class="question-count-controls">
                        <input type="number" id="questionCount" value="10" min="1" max="50">
                    </div>
                </div>

                <!-- Step 3: Copy Prompt -->
                <div class="control-group">
                     <label>3. Copy the Generated Prompt:</label>
                    <p style="margin-bottom: 0;">Use the generated prompt with an AI Chat tool (like Google's AI Studio) and your source material to get your quiz.</p>
                     <div class="prompt-actions">
                        <button id="copyPromptBtn" class="copy-button">Copy Prompt</button>
                        <button id="togglePromptBtn" class="toggle-prompt-btn">Show Prompt</button>
                        <a href="https://aistudio.google.com/prompts/new_chat" target="_blank" class="link-style">Paste prompt at: Google AI Studio</a>
                    </div>
                </div>
            </div>

            <!-- Hidden Prompt Display -->
            <div class="prompt-output-area">
                <div id="prompt-display-container" style="display: none;">
                    <code id="promptText"></code>
                </div>
            </div>
        </div>

        <label for="questionInput">Paste Formatted Quiz Data Here:</label>
        <textarea id="questionInput" placeholder="Paste your JavaScript object here, starting with { and ending with }..."></textarea>

        <div class="button-group">
            <button id="generateBtn" class="action-button">Generate & View Quiz</button>
            <button id="pastGamesBtn" class="action-button">Past Games</button>
        </div>
    </div>
    
    <!-- Past Games Modal -->
    <div id="past-games-overlay" class="overlay" style="display: none;">
        <div class="overlay-content">
            <button id="close-past-games-btn" class="close-btn">&times;</button>
            <h2>Past Games</h2>
            <ul id="past-games-list">
                <!-- Games will be populated by JavaScript -->
            </ul>
        </div>
    </div>


    <script>
        // --- PROMPT GENERATOR LOGIC ---
        const difficultyButtons = document.querySelectorAll('.difficulty-btn');
        const questionCountInput = document.getElementById('questionCount');
        const promptTextElement = document.getElementById('promptText');
        const copyPromptBtn = document.getElementById('copyPromptBtn');
        const togglePromptBtn = document.getElementById('togglePromptBtn');
        const promptDisplayContainer = document.getElementById('prompt-display-container');

        const promptTemplates = {
            hard: "generate **{count} board-exam–level** multiple-choice questions that probe deep factual and conceptual mastery of the material. Questions must test understanding of facts and concepts as they apply in general contexts—not recall of the source’s exact wording or examples.",
            high_school: "generate **{count} high-school-level** multiple-choice questions that test a solid, general understanding of the main topics and key facts in the material.",
            elementary: "generate **{count} elementary-school-level** multiple-choice questions using simple language to test basic knowledge of the key points in the material."
        };

        let currentDifficulty = 'hard';
        
        function updatePrompt() {
            const count = questionCountInput.value || 10;
            const difficultyText = promptTemplates[currentDifficulty].replace('{count}', count);

            const fullPrompt = `Based *solely* on the attached source (PDF, YouTube video, or pasted text), ${difficultyText}

The entire output MUST be a single JSON object. This object must contain two properties:
1. "quizName": A short, descriptive title for the quiz (e.g., "Chapter 5: Cell Division").
2. "questions": A JavaScript array of question objects.

For each question object in the "questions" array, include exactly these four properties (use straight double-quotes around every key and string value). If any string value itself needs to contain a double-quote character, ensure it is properly escaped with a backslash (e.g., \\"example of an internal quote\\").
- "question": the question stem.
- "options": an array of **exactly four** distinct answer strings.
- "correctAnswer": the one option that is correct (must match exactly one entry in "options").
- "explanation": a brief, clear rationale citing the source material.

Format the entire output as a single JSON object, like this example:

{
  "quizName": "Sample Science Quiz",
  "questions": [
    {
      "question": "Sample question text here?",
      "options": ["Option A", "Option B", "Correct Option C", "Option D"],
      "correctAnswer": "Correct Option C",
      "explanation": "Brief explanation based on the document content."
    },
    {
      "question": "Another question text?",
      "options": ["Choice 1", "Choice 2", "Choice 3", "Correct Choice 4"],
      "correctAnswer": "Correct Choice 4",
      "explanation": "Another explanation referencing the source."
    }
  ]
}

Do not include any introductory text, concluding remarks, or markdown formatting like \`\`\`javascript before or after the array. Do not include any quotation marks within the questions or answer choices. Do not emphasize extraneous details, like the exact minute or page number something was said. Just output the raw JavaScript array structure starting with \`[\` and ending with \`]\`.`;
            promptTextElement.innerText = fullPrompt;
        }


        difficultyButtons.forEach(button => {
            button.addEventListener('click', () => {
                difficultyButtons.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                currentDifficulty = button.dataset.difficulty;
                updatePrompt();
            });
        });

        questionCountInput.addEventListener('change', updatePrompt);

        togglePromptBtn.addEventListener('click', () => {
            const isHidden = promptDisplayContainer.style.display === 'none';
            promptDisplayContainer.style.display = isHidden ? 'block' : 'none';
            togglePromptBtn.textContent = isHidden ? 'Hide Prompt' : 'Show Prompt';
        });

        copyPromptBtn.addEventListener('click', () => {
             navigator.clipboard.writeText(promptTextElement.innerText)
                .then(() => provideCopyFeedback(copyPromptBtn))
                .catch(err => alert('Failed to copy prompt. Please copy manually.'));
        });


        // --- QUIZ GENERATOR & PAST GAMES LOGIC ---
        // --- Helper Functions ---
        function provideCopyFeedback(button) {
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            button.classList.add('copied-feedback');
            button.disabled = true;

            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('copied-feedback');
                button.disabled = false;
            }, 1500);
        }
        
        // --- Past Games ---
        const pastGamesOverlay = document.getElementById('past-games-overlay');
        const pastGamesBtn = document.getElementById('pastGamesBtn');
        const closePastGamesBtn = document.getElementById('close-past-games-btn');
        const pastGamesList = document.getElementById('past-games-list');
        const STORAGE_KEY = 'pastQuizzes';

        function getPastGames() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        }

        function savePastGame(name, data) {
            const games = getPastGames();
            const newGame = {
                name: name,
                date: new Date().toISOString(),
                data: data // Save the raw JSON string
            };
            games.unshift(newGame); // Add to the beginning
            localStorage.setItem(STORAGE_KEY, JSON.stringify(games.slice(0, 50))); // Limit to 50 games
        }

        function showPastGames() {
            const games = getPastGames();
            pastGamesList.innerHTML = ''; // Clear existing list

            if (games.length === 0) {
                 pastGamesList.innerHTML = '<p>No past games found. Generate a quiz to start!</p>';
            } else {
                games.forEach(game => {
                    const li = document.createElement('li');
                    
                    const gameInfo = document.createElement('div');
                    gameInfo.className = 'game-info';
                    
                    const gameName = document.createElement('span');
                    gameName.className = 'game-name';
                    gameName.textContent = game.name;
                    
                    const gameDate = document.createElement('span');
                    gameDate.className = 'game-date';
                    gameDate.textContent = new Date(game.date).toLocaleString();

                    gameInfo.appendChild(gameName);
                    gameInfo.appendChild(gameDate);

                    const loadBtn = document.createElement('button');
                    loadBtn.className = 'load-btn';
                    loadBtn.textContent = 'Load Quiz';
                    loadBtn.onclick = () => {
                        questionInput.value = game.data;
                        pastGamesOverlay.style.display = 'none';
                        generateBtn.click(); // Programmatically trigger generation
                    };

                    li.appendChild(gameInfo);
                    li.appendChild(loadBtn);
                    pastGamesList.appendChild(li);
                });
            }
            pastGamesOverlay.style.display = 'flex';
        }
        
        pastGamesBtn.addEventListener('click', showPastGames);
        closePastGamesBtn.addEventListener('click', () => {
            pastGamesOverlay.style.display = 'none';
        });

        // --- Main script logic ---
        const questionInput = document.getElementById('questionInput');
        const generateBtn = document.getElementById('generateBtn');

        if (generateBtn && questionInput) {
            generateBtn.addEventListener('click', () => {
                const quizDataInput = questionInput.value.trim();

                if (!quizDataInput) {
                    alert('Please paste the quiz data into the input area first.');
                    return;
                }
                 if (!quizDataInput.startsWith('{') || !quizDataInput.endsWith('}')) {
                    alert('Validation Error: Input must be a JSON object starting with { and ending with }.');
                    return;
                }


                let parsedData;
                try {
                    parsedData = JSON.parse(quizDataInput);
                } catch (e) {
                    alert(`JSON Parsing Error: ${e.message}. Please use a JSON validator to find the issue.`);
                    return;
                }

                if (typeof parsedData.quizName !== 'string' || !parsedData.quizName.trim()) {
                     alert('Validation Error: The JSON must have a "quizName" property with a non-empty string value.');
                    return;
                }
                
                if (!Array.isArray(parsedData.questions) || parsedData.questions.length === 0) {
                    alert('Validation Error: The data must have a "questions" property containing a non-empty array.');
                    return;
                }
                
                const questionsArray = parsedData.questions;

                for (let i = 0; i < questionsArray.length; i++) {
                    const item = questionsArray[i];
                    const questionNumber = i + 1;
                    const expectedKeys = ["question", "options", "correctAnswer", "explanation"];

                    if (typeof item !== 'object' || item === null) {
                        alert(`Validation Error in Question ${questionNumber}: Entry is not a valid object.`);
                        return;
                    }
                    for (const key of expectedKeys) {
                        if (!item.hasOwnProperty(key)) {
                            alert(`Validation Error in Question ${questionNumber}: Missing required property "${key}".`);
                            return;
                        }
                    }
                    if (!Array.isArray(item.options) || item.options.length !== 4) {
                        alert(`Validation Error in Question ${questionNumber}: "options" must be an array with exactly 4 strings.`);
                        return;
                    }
                    if (item.options.some(opt => typeof opt !== 'string' || opt.trim() === '')) {
                        alert(`Validation Error in Question ${questionNumber}: All options must be non-empty strings.`);
                        return;
                    }
                    if (!item.options.includes(item.correctAnswer)) {
                        alert(`Validation Error in Question ${questionNumber}: "correctAnswer" ("${item.correctAnswer}") does not exactly match any of the provided options.`);
                        return;
                    }
                }
                
                // Save the game before generating it
                savePastGame(parsedData.quizName, quizDataInput);
                
                const quizTitle = parsedData.quizName;
                const quizQuestions = parsedData.questions;
                
                const htmlTemplate = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>${quizTitle} - Head-to-Head Quiz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <style>
        :root {
            --p1-color: #00fddc; /* Neon Teal */
            --p2-color: #ff79c6; /* Neon Light Pink */
            --bg-dark: #12121f;
            --bg-med: #1a1a2e;
            --bg-light: #2a2a4e;
            --border-color: #3a3a5e;
            --text-light: #e0e0fc;
            --text-med: #c0c0fa;
            --correct-color: #28a745;
            --incorrect-color: #dc3545;
        }
        @keyframes pulse-bg {
            0% { background-color: rgba(42, 42, 78, 0.9); transform: scale(1); }
            50% { background-color: rgba(74, 74, 245, 0.7); transform: scale(1.05); }
            100% { background-color: rgba(42, 42, 78, 0.9); transform: scale(1); }
        }
        @keyframes blink { 50% { opacity: 0.5; } }
        html { scroll-behavior: smooth; }
        body {
            background-color: var(--bg-dark); color: var(--text-light); font-family: 'Roboto', sans-serif;
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center;
            min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box;
            overflow-y: auto; padding-bottom: 50px;
        }
        #quiz-header {
            position: fixed; top: 0; left: 0; width: 100%;
            padding: 15px 25px; display: flex; justify-content: space-between;
            align-items: center; z-index: 1001; pointer-events: none;
            box-sizing: border-box;
        }
        #quiz-nav, #question-indicator-wrapper { pointer-events: auto; }
        #quiz-nav { display: flex; gap: 10px; }
        #question-indicator-wrapper {
            position: absolute; left: 50%; transform: translateX(-50%);
        }
        .nav-btn {
            padding: 8px 16px; background: linear-gradient(45deg, #4a4af5, #7a7aff);
            color: white; border: none; border-radius: 20px; font-family: 'Orbitron', sans-serif;
            font-size: 0.9em; cursor: pointer; box-shadow: 0 3px 8px rgba(74, 74, 245, 0.4);
            transition: all 0.2s ease;
        }
        .nav-btn:hover { transform: scale(1.05); box-shadow: 0 5px 12px rgba(74, 74, 245, 0.6); }
        #question-indicator {
            font-family: 'Orbitron', sans-serif; font-size: 1.5em; font-weight: 700;
            color: var(--text-med); text-shadow: 0 0 5px rgba(200, 200, 250, 0.5);
        }
        .scoreboard {
            display: flex; justify-content: space-between; width: 100%;
            max-width: 1200px; margin-bottom: 20px; margin-top: 60px;
        }
        .player-panel {
            background-color: var(--bg-med); border: 2px solid var(--border-color);
            padding: 10px 20px; border-radius: 10px; text-align: center; width: 48%;
            transition: all 0.3s ease; position: relative;
        }
        #player1-panel { border-color: var(--p1-color); box-shadow: 0 0 10px 0px color-mix(in srgb, var(--p1-color) 40%, transparent); }
        #player2-panel { border-color: var(--p2-color); box-shadow: 0 0 10px 0px color-mix(in srgb, var(--p2-color) 40%, transparent); }
        .player-name {
            font-family: 'Orbitron', sans-serif; font-size: 1.2em; font-weight: 700;
            display: block; margin-bottom: 5px; outline: none;
        }
        #player1-panel .player-name { color: var(--p1-color); }
        #player2-panel .player-name { color: var(--p2-color); }
        .player-score { font-size: 1.5em; font-weight: 700; font-family: 'Orbitron', sans-serif; }
        .ready-indicator {
            height: 20px; margin-top: 5px; font-family: 'Orbitron', sans-serif;
            font-weight: 700; color: var(--correct-color); text-shadow: 0 0 8px var(--correct-color);
            transition: opacity 0.3s ease; opacity: 0;
        }
        .ready-indicator.is-ready { opacity: 1; }
        .quiz-container {
            background-color: var(--bg-med); padding: 30px 40px; border-radius: 15px;
            box-shadow: 0 0 25px rgba(74, 74, 245, 0.2), 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 95%; max-width: 1200px; text-align: center; border: 1px solid var(--border-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #quiz-title-display {
            font-family: 'Orbitron', sans-serif; color: #8a8aff; font-size: 1.2em;
            margin-bottom: 15px; text-align: center;
        }
        #timer-container {
            position: relative; width: 120px; height: 120px; margin-bottom: 20px; cursor: pointer; user-select: none;
        }
        #timer-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .timer-ring { fill: none; stroke-width: 10; }
        .timer-bg { stroke: var(--bg-light); }
        .timer-fg { stroke: var(--p1-color); transition: stroke-dashoffset 1s linear, stroke 0.3s ease; }
        .timer-fg.danger { stroke: var(--incorrect-color); animation: blink 1s infinite; }
        #timer-text {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Orbitron', sans-serif; font-size: 2.5em; font-weight: 900;
        }
        #question-text {
            font-size: clamp(1.2rem, 2.8vh, 2.5em); color: var(--text-light); margin-bottom: 30px;
            line-height: 1.4; min-height: 150px; transition: opacity 0.5s ease;
        }
        .options-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%;
            transition: opacity 0.5s ease; align-items: stretch;
        }
        .option-button {
            background-color: var(--bg-light); color: var(--text-med); border: 2px solid var(--border-color);
            padding: 15px; border-radius: 8px;
            transition: all 0.2s ease; text-align: left;
            display: flex; align-items: center; gap: 15px; min-height: 120px;
            word-wrap: break-word; outline: none;
        }
        .option-text { font-size: clamp(1rem, 2.2vh, 2em); line-height: 1.3; }
        
        .controller-icon {
            position: relative; width: 40px; height: 40px; min-width: 40px;
        }
        .controller-icon .btn {
            position: absolute; width: 12px; height: 12px;
            background-color: #3a3a5e; border-radius: 50%;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid #1a1a2e;
        }
        .controller-icon .btn-x { top: 0; left: 50%; transform: translateX(-50%); } /* Top */
        .controller-icon .btn-b { bottom: 0; left: 50%; transform: translateX(-50%); } /* Bottom */
        .controller-icon .btn-y { top: 50%; left: 0; transform: translateY(-50%); } /* Left */
        .controller-icon .btn-a { top: 50%; right: 0; transform: translateY(-50%); } /* Right */
        
        .controller-icon.highlight-x .btn-x { background-color: #00fddc; box-shadow: 0 0 6px #00fddc; }
        .controller-icon.highlight-b .btn-b { background-color: #ff5555; box-shadow: 0 0 6px #ff5555; }
        .controller-icon.highlight-y .btn-y { background-color: #f1fa8c; box-shadow: 0 0 6px #f1fa8c; }
        .controller-icon.highlight-a .btn-a { background-color: #ff79c6; box-shadow: 0 0 6px #ff79c6; }
        
        .player-choice-container {
            display: flex; flex-direction: column; gap: 4px;
            font-family: 'Orbitron', sans-serif; font-weight: 700;
            text-align: right;
        }
        .player-choice-tag {
            padding: 2px 6px; border-radius: 4px; font-size: 0.8em;
            background-color: var(--bg-dark);
        }
        .p1-ans-label { color: var(--p1-color); border: 1px solid var(--p1-color); }
        .p2-ans-label { color: var(--p2-color); border: 1px solid var(--p2-color); }

        .option-button.correct { background-color: color-mix(in srgb, var(--correct-color) 40%, var(--bg-light)); border-color: var(--correct-color) !important; color: white; }
        .option-button.incorrect { background-color: color-mix(in srgb, var(--incorrect-color) 40%, var(--bg-light)); border-color: var(--incorrect-color) !important; color: #ffc0c0; }
        #explanation {
            background-color: var(--bg-dark); border-top: 2px solid var(--border-color);
            padding: 30px; margin-top: 25px; text-align: left;
            width: 100%; box-sizing: border-box;
            border-radius: 0 0 12px 12px;
        }
        #explanation .explanation-text { font-size: clamp(1rem, 2vh, 1.6em); line-height: 1.5; color: var(--text-med); }
        #advance-prompt {
            margin-top: 20px; font-family: 'Orbitron', sans-serif; color: var(--text-light);
            font-size: 1.5em; padding: 15px 30px; border-radius: 10px;
            background-color: var(--bg-light); border: 1px solid var(--border-color);
            text-shadow: none; animation: pulse-bg 2s infinite ease-in-out;
        }
        /* Overlays */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(18, 18, 31, 0.95); z-index: 1000;
            display: flex; justify-content: center; align-items: center; text-align: center;
        }
        .overlay-content {
            background-color: var(--bg-med); padding: 40px; border-radius: 15px;
            border: 1px solid var(--border-color); box-shadow: 0 0 30px rgba(0,0,0,0.5);
            max-height: 80vh;
        }
        .overlay h2 { font-family: 'Orbitron', sans-serif; color: #8a8aff; font-size: 2em; margin-bottom: 20px; }
        .overlay p { text-align: center; color: var(--text-med); font-size: 1.1em; }
        .overlay-button-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 25px; }
        .overlay button, .overlay-button-group button {
            background: linear-gradient(45deg, #4a4af5, #8a8aff); color: white; border: none;
            padding: 12px 30px; font-size: 1.1em; font-family: 'Orbitron', sans-serif;
            border-radius: 25px; cursor: pointer; margin-top: 20px;
            transition: all 0.2s ease; box-shadow: 0 4px 10px rgba(74, 74, 245, 0.3);
        }
        .overlay button:hover, .overlay-button-group button:hover { transform: scale(1.05); box-shadow: 0 6px 15px rgba(74, 74, 245, 0.5); }
        .overlay-content.scrollable { overflow-y: auto; display: flex; flex-direction: column; }
        #history-log { display: flex; flex-direction: column; gap: 15px; min-width: 50vw; text-align: left; }
        .history-item { background-color: var(--bg-light); padding: 15px; border-radius: 8px; border-left: 5px solid var(--border-color); }
        .history-item p { margin: 0 0 8px 0; }
        .history-item .p1-ans { color: var(--p1-color); }
        .history-item .p2-ans { color: var(--p2-color); }
    </style>
</head>
<body>
    <div id="quiz-header">
        <div id="quiz-nav">
            <button id="backToGeneratorBtn" class="nav-btn" title="Return to Generator">← Generator</button>
            <button id="downloadCurrentQuizBtn" class="nav-btn" title="Download This Quiz HTML">Download</button>
            <button id="historyBtn" class="nav-btn" title="View Round History">History</button>
            <button id="pastGamesInGameBtn" class="nav-btn" title="View Past Games">Past Games</button>
        </div>
        <div id="question-indicator-wrapper">
             <div id="question-indicator"></div>
        </div>
    </div>

    <div class="scoreboard">
        <div id="player1-panel" class="player-panel">
            <span id="player1-name" class="player-name" contenteditable="true" spellcheck="false">Player 1</span>
            <span id="player1-score" class="player-score">0</span>
            <div id="player1-ready" class="ready-indicator"></div>
        </div>
        <div id="player2-panel" class="player-panel">
            <span id="player2-name" class="player-name" contenteditable="true" spellcheck="false">Player 2</span>
            <span id="player2-score" class="player-score">0</span>
            <div id="player2-ready" class="ready-indicator"></div>
        </div>
    </div>

    <div class="quiz-container">
        <div id="quiz-title-display">${quizTitle}</div>
        <div id="timer-container" title="Click to pause/resume. Press and hold to change duration.">
            <svg id="timer-svg" viewBox="0 0 100 100">
                <circle class="timer-ring timer-bg" cx="50" cy="50" r="45"></circle>
                <circle id="timer-fg" class="timer-ring timer-fg" cx="50" cy="50" r="45"></circle>
            </svg>
            <div id="timer-text">30</div>
        </div>
        <div id="question-text" style="opacity: 0;"></div>
        <div id="options-container" style="opacity: 0;"></div>
        <div id="explanation" style="display: none;"></div>
        <div id="advance-prompt" style="display: none;"></div>
    </div>

    <div id="game-overlay" class="overlay">
        <div class="overlay-content">
            <h2 id="overlay-title">Welcome!</h2>
            <p id="overlay-text">The first player to answer correctly and quickly earns more points. Press the button to start.</p>
            <button id="overlay-button">Start Quiz</button>
        </div>
    </div>
    
    <div id="history-overlay" class="overlay" style="display: none;">
        <div class="overlay-content scrollable">
            <h2>Round History</h2>
            <div id="history-log"></div>
            <button id="close-history-btn">Close</button>
        </div>
    </div>
    
<script>
    // --- EMBEDDED QUIZ DATA ---
    const quizData = ${JSON.stringify(quizQuestions)};
    const quizTitle = "${quizTitle}";
    const fullQuizObjectString = \`${JSON.stringify(parsedData)}\`;
    
    const ICONS = ['A', 'B', 'C', 'D'];
    const HIGHLIGHT_MAP = ['x', 'y', 'a', 'b']; // Maps index to CSS: 0=Top(x), 1=Left(y), 2=Right(a), 3=Bottom(b)
    const KEY_MAP = {
        Player1: { 'w': 0, 'a': 1, 'd': 2, 's': 3, 'W': 0, 'A': 1, 'D': 2, 'S': 3 },
        Player2: { 'i': 0, 'j': 1, 'l': 2, 'k': 3, 'I': 0, 'J': 1, 'L': 2, 'K': 3 },
    };
    const ADVANCE_KEYS = { P1: 'd', P2: 'l' };

    const quizSettings = {
        timerDuration: 30
    };

    const gameState = {
        currentQuestionIndex: -1,
        player1: { name: 'Player 1', score: 0, answer: null, readyForNext: false },
        player2: { name: 'Player 2', score: 0, answer: null, readyForNext: false },
        timer: { id: null, remaining: quizSettings.timerDuration, isPaused: false, instance: null },
        history: [],
        gameStatus: 'initializing'
    };

    const dom = {
        p1: { panel: document.getElementById('player1-panel'), name: document.getElementById('player1-name'), score: document.getElementById('player1-score'), ready: document.getElementById('player1-ready') },
        p2: { panel: document.getElementById('player2-panel'), name: document.getElementById('player2-name'), score: document.getElementById('player2-score'), ready: document.getElementById('player2-ready') },
        questionIndicator: document.getElementById('question-indicator'),
        questionText: document.getElementById('question-text'),
        optionsContainer: document.getElementById('options-container'),
        explanation: document.getElementById('explanation'),
        advancePrompt: document.getElementById('advance-prompt'),
        timer: { container: document.getElementById('timer-container'), text: document.getElementById('timer-text'), fg: document.getElementById('timer-fg'), radius: document.getElementById('timer-fg').r.baseVal.value },
        overlay: { el: document.getElementById('game-overlay'), title: document.getElementById('overlay-title'), text: document.getElementById('overlay-text'), button: document.getElementById('overlay-button') },
        history: { overlay: document.getElementById('history-overlay'), log: document.getElementById('history-log'), closeBtn: document.getElementById('close-history-btn'), openBtn: document.getElementById('historyBtn') }
    };

    function updateScoreboard() {
        dom.p1.name.textContent = gameState.player1.name;
        dom.p1.score.textContent = gameState.player1.score;
        dom.p2.name.textContent = gameState.player2.name;
        dom.p2.score.textContent = gameState.player2.score;
    }

    function transitionTo(newStatus) {
        gameState.gameStatus = newStatus;
        switch (newStatus) {
            case 'overlay':
                dom.overlay.el.style.display = 'flex';
                break;
            case 'question_reveal':
                dom.overlay.el.style.display = 'none';
                dom.questionText.style.opacity = 1;
                dom.optionsContainer.style.opacity = 0;
                dom.explanation.style.display = 'none';
                dom.advancePrompt.style.display = 'none';
                dom.timer.container.style.visibility = 'hidden';
                setTimeout(() => transitionTo('answering'), 3000);
                break;
            case 'answering':
                renderOptions();
                dom.optionsContainer.style.opacity = 1;
                dom.timer.container.style.visibility = 'visible';
                startTimer();
                break;
            case 'round_end':
                stopTimer();
                revealAnswers();
                dom.advancePrompt.textContent = \`Press Right Button to Ready Up\`;
                dom.advancePrompt.style.display = 'block';
                break;
        }
    }

    function startRound() {
        gameState.currentQuestionIndex++;
        if (gameState.currentQuestionIndex >= quizData.length) {
            endGame();
            return;
        }
        dom.questionIndicator.textContent = \`Question \${gameState.currentQuestionIndex + 1} / \${quizData.length}\`;
        const question = quizData[gameState.currentQuestionIndex];
        dom.questionText.textContent = question.question;
        gameState.player1.answer = null;
        gameState.player2.answer = null;
        gameState.player1.readyForNext = false;
        gameState.player2.readyForNext = false;
        updateReadyStatus();
        transitionTo('question_reveal');
    }

    function renderOptions() {
        const question = quizData[gameState.currentQuestionIndex];
        dom.optionsContainer.innerHTML = '';
        question.options.forEach((optionText, index) => {
            const button = document.createElement('button');
            button.className = 'option-button';
            button.id = \`option-\${index}\`;
            const highlightKey = HIGHLIGHT_MAP[index];
            
            button.innerHTML = '<div class="controller-icon highlight-' + highlightKey + '">' +
                                   '<span class="btn btn-x"></span><span class="btn btn-b"></span>' +
                                   '<span class="btn btn-y"></span><span class="btn btn-a"></span>' +
                               '</div>' +
                               '<span class="option-text">' + optionText + '</span>';
                               
            button.setAttribute('aria-label', \`Option \${ICONS[index]}: \${optionText}\`);
            dom.optionsContainer.appendChild(button);
        });
    }

    function handleAnswer(player, optionIndex) {
        if (gameState.gameStatus !== 'answering') return;
        const playerState = (player === 'Player1') ? gameState.player1 : gameState.player2;
        const playerUI = (player === 'Player1') ? dom.p1 : dom.p2;
        if (playerState.answer !== null) return;
        playerState.answer = {
            choiceIndex: optionIndex,
            choiceText: quizData[gameState.currentQuestionIndex].options[optionIndex],
            time: gameState.timer.remaining
        };
        playerUI.ready.textContent = 'Locked In!';
        playerUI.ready.classList.add('is-ready');
        if (gameState.player1.answer && gameState.player2.answer) {
            transitionTo('round_end');
        }
    }

    function revealAnswers() {
        const question = quizData[gameState.currentQuestionIndex];
        const correctIndex = question.options.indexOf(question.correctAnswer);

        // --- CHANGE 1 START: Clear "Locked In" text ---
        dom.p1.ready.textContent = '';
        dom.p1.ready.classList.remove('is-ready');
        dom.p2.ready.textContent = '';
        dom.p2.ready.classList.remove('is-ready');
        // --- CHANGE 1 END ---
        
        [gameState.player1, gameState.player2].forEach(p => {
            if (p.answer) {
                p.answer.isCorrect = p.answer.choiceText === question.correctAnswer;
                p.answer.points = p.answer.isCorrect ? Math.ceil(p.answer.time) : 0;
                p.score += p.answer.points;
            }
        });
        updateScoreboard();

        const optionButtons = dom.optionsContainer.querySelectorAll('.option-button');
        const selections = {};
        [
            { player: gameState.player1, id: 'p1' },
            { player: gameState.player2, id: 'p2' }
        ].forEach(p_info => {
            if (p_info.player.answer) {
                const idx = p_info.player.answer.choiceIndex;
                if (!selections[idx]) selections[idx] = [];
                selections[idx].push({ name: p_info.player.name, time: p_info.player.answer.time, id: p_info.id });
            }
        });

        optionButtons.forEach((btn, index) => {
            if (selections[index]) {
                selections[index].sort((a, b) => b.time - a.time);
                const nameContainer = document.createElement('div');
                nameContainer.className = 'player-choice-container';
                selections[index].forEach(selection => {
                    const nameTag = document.createElement('div');
                    nameTag.className = \`player-choice-tag \${selection.id}-ans-label\`;
                    nameTag.textContent = selection.name;
                    nameContainer.appendChild(nameTag);
                });
                btn.prepend(nameContainer);
            }
            if (index === correctIndex) btn.classList.add('correct');
            else if (selections[index]) btn.classList.add('incorrect');
        });

        dom.explanation.innerHTML = \`<strong>Explanation:</strong> <span class="explanation-text">\${question.explanation}</span>\`;
        dom.explanation.style.display = 'block';
        logHistory();
    }
    
    function logHistory() {
        const question = quizData[gameState.currentQuestionIndex];
        gameState.history.push({ q: question.question, p1: gameState.player1.answer, p2: gameState.player2.answer });
    }

    function updateReadyStatus() {
        dom.p1.ready.textContent = gameState.player1.readyForNext ? 'Ready!' : '';
        dom.p1.ready.classList.toggle('is-ready', gameState.player1.readyForNext);
        dom.p2.ready.textContent = gameState.player2.readyForNext ? 'Ready!' : '';
        dom.p2.ready.classList.toggle('is-ready', gameState.player2.readyForNext);
        
        if (gameState.player1.readyForNext && gameState.player2.readyForNext) {
            startNextRoundCountdown();
        }
    }

    function startNextRoundCountdown() {
        let countdown = 3;
        const countdownInterval = setInterval(() => {
            dom.advancePrompt.textContent = \`Next Round in \${countdown}...\`;
            countdown--;
            if (countdown < 0) {
                clearInterval(countdownInterval);
                startRound();
            }
        }, 1000);
    }
    
    const fullDash = 2 * Math.PI * dom.timer.radius;
    dom.timer.fg.style.strokeDasharray = fullDash;
    function startTimer() {
        clearInterval(gameState.timer.id);
        gameState.timer.isPaused = false;
        gameState.timer.remaining = quizSettings.timerDuration;
        dom.timer.fg.style.transition = 'stroke-dashoffset 1s linear, stroke 0.3s ease';
        dom.timer.fg.classList.remove('danger');
        gameState.timer.id = setInterval(() => {
            if (gameState.timer.isPaused) return;
            gameState.timer.remaining -= 0.01;
            const offset = (gameState.timer.remaining / quizSettings.timerDuration) * fullDash;
            dom.timer.fg.style.strokeDashoffset = fullDash - offset;
            dom.timer.text.textContent = Math.ceil(gameState.timer.remaining);
            if (gameState.timer.remaining <= 5 && !dom.timer.fg.classList.contains('danger')) dom.timer.fg.classList.add('danger');
            if (gameState.timer.remaining <= 0) {
                stopTimer();
                dom.timer.text.textContent = 0;
                transitionTo('round_end');
            }
        }, 10);
    }
    function stopTimer() { clearInterval(gameState.timer.id); }
    function togglePauseTimer() {
        if (gameState.gameStatus !== 'answering') return;
        gameState.timer.isPaused = !gameState.timer.isPaused;
        dom.timer.container.style.opacity = gameState.timer.isPaused ? 0.7 : 1;
    }

    function promptForNewTimer() {
        if (gameState.gameStatus === 'answering') {
            alert("Cannot change timer during a question. Please wait until the round ends.");
            return;
        }
        const newDuration = prompt("Set new timer duration (5-99 seconds):", quizSettings.timerDuration);
        if (newDuration === null) return;
        const newDurationInt = parseInt(newDuration, 10);
        if (isNaN(newDurationInt) || newDurationInt < 5 || newDurationInt > 99) {
            alert("Invalid input. Please enter a number between 5 and 99.");
            return;
        }
        quizSettings.timerDuration = newDurationInt;
        dom.timer.text.textContent = quizSettings.timerDuration;
        alert(\`Timer set to \${quizSettings.timerDuration} seconds for subsequent rounds.\`);
    }

    function handleKeyDown(e) {
        if (gameState.gameStatus === 'answering') {
            const p1Key = KEY_MAP.Player1[e.key];
            if (p1Key !== undefined) { handleAnswer('Player1', p1Key); return; }
            const p2Key = KEY_MAP.Player2[e.key];
            if (p2Key !== undefined) { handleAnswer('Player2', p2Key); return; }
        }
        if (gameState.gameStatus === 'round_end' && !(gameState.player1.readyForNext && gameState.player2.readyForNext)) {
            if (e.key.toLowerCase() === ADVANCE_KEYS.P1) {
                gameState.player1.readyForNext = !gameState.player1.readyForNext;
                updateReadyStatus();
            }
            if (e.key.toLowerCase() === ADVANCE_KEYS.P2) {
                gameState.player2.readyForNext = !gameState.player2.readyForNext;
                updateReadyStatus();
            }
        }
    }
    
    function endGame() {
        gameState.gameStatus = 'finished';
        stopTimer();
        dom.questionIndicator.style.display = 'none';
        let winnerText = (gameState.player1.score > gameState.player2.score) ? \`\${gameState.player1.name} wins!\` :
                         (gameState.player2.score > gameState.player1.score) ? \`\${gameState.player2.name} wins!\` : "It's a tie!";
        const p1Correct = gameState.history.filter(h => h.p1 && h.p1.isCorrect).length;
        const p2Correct = gameState.history.filter(h => h.p2 && h.p2.isCorrect).length;
        
        const completionOverlay = document.createElement('div');
        completionOverlay.id = 'completion-overlay';
        completionOverlay.className = 'overlay';
        completionOverlay.innerHTML = \`
            <div class="overlay-content">
                <h2>\${winnerText}</h2>
                <p>\${gameState.player1.name}: \${gameState.player1.score} points (\${p1Correct}/\${quizData.length} correct)</p>
                <p>\${gameState.player2.name}: \${gameState.player2.score} points (\${p2Correct}/\${quizData.length} correct)</p>
                <div class="overlay-button-group">
                    <button id="reviewQuizBtn">Review Answers</button>
                    <button id="playAgainBtn">Play Again</button>
                    <button id="newQuizBtn">New Quiz</button>
                </div>
            </div>\`;
        document.body.appendChild(completionOverlay);

        document.getElementById('reviewQuizBtn').addEventListener('click', () => {
             completionOverlay.style.display = 'none';
             showHistory();
        });
        document.getElementById('playAgainBtn').addEventListener('click', () => window.location.reload());
        document.getElementById('newQuizBtn').addEventListener('click', () => window.location.href = window.location.pathname);
    }
    
    function showHistory() {
        const wasPaused = gameState.timer.isPaused;
        stopTimer();
        gameState.timer.isPaused = true;
        
        dom.history.log.innerHTML = gameState.history.length === 0 ? '<p>No rounds completed yet.</p>' : '';
        gameState.history.forEach((item, index) => {
            const p1Answer = item.p1 ? \`\${item.p1.choiceText} (\${item.p1.points} pts)\` : 'No Answer';
            const p2Answer = item.p2 ? \`\${item.p2.choiceText} (\${item.p2.points} pts)\` : 'No Answer';
            const correctAnswer = quizData[index].correctAnswer; // --- Part of CHANGE 2
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            // --- CHANGE 2 START: Add correct answer to history log ---
            historyItem.innerHTML = \`<p><strong>Q\${index+1}:</strong> \${item.q}</p>
                                   <p><strong>Correct Answer:</strong> \${correctAnswer}</p>
                                   <p><strong class="p1-ans">\${gameState.player1.name}:</strong> \${p1Answer}</p>
                                   <p><strong class="p2-ans">\${gameState.player2.name}:</strong> \${p2Answer}</p>\`;
            // --- CHANGE 2 END ---
            dom.history.log.appendChild(historyItem);
        });
        dom.history.overlay.style.display = 'flex';
        // When closing history, restore pause state only if the game is still active
        dom.history.closeBtn.onclick = () => {
             dom.history.overlay.style.display = 'none';
             if (gameState.gameStatus === 'answering') {
                 gameState.timer.isPaused = wasPaused;
                 if(!wasPaused) startTimer();
             }
        };
    }

    // --- Initial Setup & Event Listeners ---
    let holdTimeout;
    let inHold = false;
    dom.timer.container.addEventListener('mousedown', (e) => { e.preventDefault(); inHold = false; holdTimeout = setTimeout(() => { inHold=true; promptForNewTimer(); }, 750); });
    dom.timer.container.addEventListener('mouseup', () => clearTimeout(holdTimeout));
    dom.timer.container.addEventListener('mouseleave', () => clearTimeout(holdTimeout));
    dom.timer.container.addEventListener('touchstart', (e) => { e.preventDefault(); inHold = false; holdTimeout = setTimeout(() => { inHold=true; promptForNewTimer(); }, 750); });
    dom.timer.container.addEventListener('touchend', () => clearTimeout(holdTimeout));
    dom.timer.container.addEventListener('click', () => { if (!inHold) togglePauseTimer(); });

    dom.overlay.button.addEventListener('click', () => startRound());
    document.addEventListener('keydown', handleKeyDown);
    
    [dom.p1.name, dom.p2.name].forEach(el => el.addEventListener('keydown', e => e.key === 'Enter' && e.target.blur()));
    dom.p1.name.addEventListener('blur', e => { gameState.player1.name = e.target.textContent.trim() || 'Player 1'; updateScoreboard(); });
    dom.p2.name.addEventListener('blur', e => { gameState.player2.name = e.target.textContent.trim() || 'Player 2'; updateScoreboard(); });

    dom.history.openBtn.addEventListener('click', showHistory);
    
    document.getElementById('backToGeneratorBtn').addEventListener('click', () => window.location.reload());
    document.getElementById('downloadCurrentQuizBtn').addEventListener('click', () => {
        // We use the fullQuizObjectString which is a pristine copy of the original data.
        const quizFileName = \`\${quizTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.html\`;
        
        // This is a simplified template placeholder replacement.
        // It reconstructs the entire HTML file from scratch for a perfect download.
        const finalHtmlContent = document.documentElement.outerHTML;

        const blob = new Blob([finalHtmlContent], { type: 'text/html' });
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = quizFileName;
        document.body.appendChild(a); 
        a.click(); 
        document.body.removeChild(a); 
        URL.revokeObjectURL(a.href);
    });

    // In-game button to open the Past Games modal from the generator page
    // This is a bit of a hack since the generator page is destroyed. 
    // This button will simply reload to the generator where the user can click "Past Games".
    const pastGamesInGameBtn = document.getElementById('pastGamesInGameBtn');
    if(pastGamesInGameBtn) {
        pastGamesInGameBtn.addEventListener('click', () => {
            if(confirm("This will end the current game and return to the generator. Are you sure?")) {
                window.location.reload();
            }
        });
    }

    updateScoreboard();
    dom.timer.text.textContent = quizSettings.timerDuration;
    transitionTo('overlay');
<\/script>
</body>
</html>
`;
                document.open();
                document.write(htmlTemplate);
                document.close();
            });
        }
        
        // Initial call to set the default prompt on page load
        updatePrompt();

    </script>
</body>
</html>
