<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fact Screensaver Generator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #12121f;
            color: #e0e0fc;
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 30px 20px;
            box-sizing: border-box;
        }

        .generator-container {
            background-color: #1a1a2e;
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 0 25px rgba(212, 68, 68, 0.4),
                        0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 900px;
            text-align: center;
            border: 1px solid #4a3a3e;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            color: #ff8a8a;
            margin-bottom: 20px;
            text-shadow: 0 0 8px rgba(255, 138, 138, 0.5);
        }

        p, label {
            color: #fac0c0;
            line-height: 1.6;
            margin-bottom: 15px;
            text-align: left;
        }

        .prompt-section {
            background-color: #2a2020;
            border: 1px solid #4a3a3e;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
            text-align: left;
            font-size: 0.95em;
            line-height: 1.5;
            color: #fac0c0;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .prompt-section strong {
             color: #ff8a8a;
        }

        .prompt-section code {
            background-color: #1f1212;
            padding: 10px 15px;
            border-radius: 4px;
            font-family: monospace;
            color: #f0f0ff;
            display: block;
            white-space: pre-wrap;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .prompt-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            background-color: #3e2a2a;
            color: #fcd0d0;
            border: 1px solid #7e4a4a;
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 0.9em;
            margin-bottom: 20px;
            box-sizing: border-box;
            resize: vertical;
        }

        .action-button, .copy-button {
            background: linear-gradient(45deg, #f54a4a, #ff8a8a);
            color: white;
            border: none;
            padding: 10px 25px;
            font-size: 1em;
            font-family: 'Orbitron', sans-serif;
            border-radius: 25px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.3s ease, background 0.3s ease;
            box-shadow: 0 4px 10px rgba(245, 74, 74, 0.3);
            text-align: center;
            min-width: 100px;
        }

        .action-button:hover:not(:disabled),
        .copy-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(245, 74, 74, 0.5);
        }

         .action-button:disabled,
         .copy-button:disabled {
            background: #7e5a5a;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
            transform: none;
        }

        .link-style {
            color: #ffa0a0;
            text-decoration: none;
            transition: color 0.2s ease;
        }
        .link-style:hover {
            color: #ffc0c0;
            text-decoration: underline;
        }

        .button-group {
             display: flex;
             justify-content: center;
             flex-wrap: wrap;
             gap: 15px;
             margin-top: 10px;
             margin-bottom: 20px;
        }
        #restored-actions { /* Style for the new button group on restored page */
            justify-content: flex-start; /* Align buttons to the left */
        }


        @media (max-width: 600px) {
            .generator-container {
                padding: 20px;
                width: 95%;
            }
            h1 {
                font-size: 1.5em;
            }
             .prompt-controls {
                 gap: 10px;
             }
             .action-button, .copy-button {
                 padding: 8px 18px;
                 font-size: 0.9em;
             }
             textarea {
                 min-height: 150px;
             }
        }

        .copied-feedback {
            background-color: #1f7a3f !important;
        }

    </style>
</head>
<body>
    <div class="generator-container">
        <h1>Fact Screensaver Generator</h1>
        <p>This tool generates a self-contained HTML screensaver file. Paste your source material into an AI chatbot, use the prompt below to generate a list of key facts, and then paste the resulting JSON data here.</p>

        <div class="prompt-section">
            <strong>Prompt for AI Chat (e.g., Google Gemini):</strong>
            <p>Attach your source document and use the following prompt to generate key facts in the correct format. Review the AI's output for accuracy.</p>
            <code id="promptText">Based *solely* on the attached source material, first create a concise, descriptive title for the subject matter (5-7 words). Then, generate **30 key facts, findings, or critical data points**. These should be hard, verifiable facts, not general statements or definitions.

For each fact, include exactly these two properties (use straight double-quotes around every key and string value):
1. "fact": A concise string containing the key fact itself.
2. "context": A detailed paragraph (2-4 sentences) providing more background, explanation, or the source of the fact.

Format the entire output *only* as a single JSON object. This object must have exactly two top-level properties:
1. "title": The descriptive title you created.
2. "facts": A JavaScript array containing all the fact objects.

Do not include any introductory text, concluding remarks, or markdown formatting like `javascript` before or after the object.
Do not include double-quote characters within any JSON string values; use apostrophes instead if needed.

Example format:
{
  "title": "Fascinating Facts About the Sun",
  "facts": [
    {
      "fact": "The Earth's core is estimated to be approximately 5,200°C (9,392°F).",
      "context": "This temperature is hotter than the surface of the Sun. The estimation is derived from seismic wave data and high-pressure laboratory experiments that simulate the conditions at the planet's center, as direct measurement is impossible."
    },
    {
      "fact": "A photon takes, on average, over 100,000 years to travel from the Sun's core to its surface.",
      "context": "This long journey is due to the 'random walk' a photon takes through the Sun's incredibly dense radiative zone. It is continuously absorbed and re-emitted in random directions by plasma particles, preventing a direct path outward."
    }
  ]
}</code>
            <div class="prompt-controls">
                <button id="copyPromptBtn" class="copy-button">Copy Prompt</button>
                <span>Paste prompt here:</span>
                <a href="https://aistudio.google.com/prompts/new_chat" target="_blank" class="link-style">Google AI Studio Chat</a>
            </div>
        </div>

        <label for="factInput">Paste Formatted Fact Data Here:</label>
        <textarea id="factInput" placeholder="Paste your JavaScript object here, starting with { and ending with }..."></textarea>

        <!-- Buttons for restored screensaver will be injected here by JS -->

        <div class="button-group">
            <button id="generateBtn" class="action-button">Generate Screensaver</button>
        </div>
    </div>

    <script>
        // --- Helper Functions ---
        function provideCopyFeedback(button) {
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            button.classList.add('copied-feedback');
            button.disabled = true;

            setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove('copied-feedback');
                button.disabled = false;
            }, 1500);
        }

        function downloadHTML(content, fileName) {
            const blob = new Blob([content], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }

        function addActionButtonsForPrevious() {
            const lastGeneratedHTML = sessionStorage.getItem('lastGeneratedHTML');
            if (lastGeneratedHTML && !document.getElementById('restored-actions')) {
                const container = document.querySelector('.generator-container');
                const generateGroup = container.querySelector('.button-group');
        
                const buttonsHeader = document.createElement('p');
                buttonsHeader.id = 'restored-actions-header';
                buttonsHeader.textContent = 'Actions for previously generated screensaver:';
                buttonsHeader.style.marginTop = '20px';
                buttonsHeader.style.marginBottom = '10px';
                buttonsHeader.style.textAlign = 'left';
        
                const buttonGroupForRestored = document.createElement('div');
                buttonGroupForRestored.classList.add('button-group');
                buttonGroupForRestored.id = 'restored-actions';
                buttonGroupForRestored.style.justifyContent = 'flex-start';
        
                const copyHtmlBtn = document.createElement('button');
                copyHtmlBtn.textContent = 'Copy HTML';
                copyHtmlBtn.classList.add('action-button');
                copyHtmlBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(lastGeneratedHTML)
                        .then(() => provideCopyFeedback(copyHtmlBtn))
                        .catch(() => alert('Copy failed.'));
                });
        
                const downloadHtmlBtn = document.createElement('button');
                downloadHtmlBtn.textContent = 'Download HTML';
                downloadHtmlBtn.classList.add('action-button');
                downloadHtmlBtn.addEventListener('click', () => {
                    downloadHTML(lastGeneratedHTML, 'generated_screensaver.html');
                });
        
                buttonGroupForRestored.appendChild(copyHtmlBtn);
                buttonGroupForRestored.appendChild(downloadHtmlBtn);
        
                generateGroup.insertAdjacentElement('afterend', buttonsHeader);
                buttonsHeader.insertAdjacentElement('afterend', buttonGroupForRestored);
            }
        }

        // --- Main script logic ---
        const copyPromptBtn = document.getElementById('copyPromptBtn');
        const promptTextElement = document.getElementById('promptText');
        const factInput = document.getElementById('factInput');
        const generateBtn = document.getElementById('generateBtn');

        if (copyPromptBtn && promptTextElement) {
            copyPromptBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(promptTextElement.innerText)
                    .then(() => provideCopyFeedback(copyPromptBtn))
                    .catch(err => {
                        console.error('Failed to copy prompt: ', err);
                        alert('Failed to copy prompt. Please copy manually.');
                    });
            });
        }

        if (generateBtn && factInput) {
            generateBtn.addEventListener('click', () => {
                const headerToRemove = document.getElementById('restored-actions-header');
                if (headerToRemove) headerToRemove.remove();
                const buttonsToRemove = document.getElementById('restored-actions');
                if (buttonsToRemove) buttonsToRemove.remove();

                const factDataInput = factInput.value.trim();

                if (!factDataInput) {
                    alert('Please paste the fact data into the input area first.');
                    return;
                }
                if (!factDataInput.startsWith('{') || !factDataInput.endsWith('}')) {
                    alert('The input data does not seem to be a correctly formatted JSON object. It must start with { and end with }.');
                    return;
                }

                let parsedData;
                try {
                    // Using a safer parsing method than `new Function`
                    parsedData = JSON.parse(factDataInput);
                } catch (e) {
                    alert(`Error parsing data: ${e.message}\n\nThis usually means there's a syntax error (like a missing comma or incorrect quote). You can use a tool like jsonlint.com to validate the structure.`);
                    return;
                }

                // --- Validate the new object structure ---
                if (typeof parsedData !== 'object' || parsedData === null || Array.isArray(parsedData)) {
                    alert('The data must be a single JSON object.');
                    return;
                }
                if (typeof parsedData.title !== 'string' || parsedData.title.trim() === '') {
                    alert('The JSON object is missing a valid "title" string property.');
                    return;
                }
                if (!Array.isArray(parsedData.facts) || parsedData.facts.length === 0) {
                    alert('The JSON object must have a "facts" property that is an array with at least one fact object.');
                    return;
                }

                const expectedKeys = ["fact", "context"];
                for (let i = 0; i < parsedData.facts.length; i++) {
                    const item = parsedData.facts[i];
                    const factNumber = i + 1;
                    if (typeof item !== 'object' || item === null || !expectedKeys.every(key => key in item) || typeof item.fact !== 'string' || item.fact.trim() === '') {
                        alert(`Error in Fact ${factNumber}: Each entry in the 'facts' array must be an object with non-empty "fact" and "context" string properties.`);
                        return;
                    }
                }
                
                // --- Create and Store Session Data ---
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const formattedTitle = `${year}.${month}.${day} ${parsedData.title}`;

                const sessionData = {
                    title: formattedTitle,
                    facts: parsedData.facts
                };

                try {
                    let pastSessions = JSON.parse(localStorage.getItem('pastSessions')) || [];
                    pastSessions = pastSessions.filter(s => s.title !== sessionData.title);
                    pastSessions.push(sessionData);
                    localStorage.setItem('pastSessions', JSON.stringify(pastSessions));
                } catch (e) {
                    console.error("Could not save to localStorage:", e);
                    alert("Could not save session data to browser storage. Your browser might be in private mode or storage is full.");
                }

                const currentGeneratorHTML = document.documentElement.outerHTML;
                sessionStorage.setItem('originalGeneratorHTML', currentGeneratorHTML);
                history.pushState({ view: 'generator_restoration_point' }, document.title, window.location.href);

                const sessionDataJSON = JSON.stringify(sessionData);
                const htmlTemplate = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Key Facts</title>
    <style>
        :root {
            --base-red: #D44; --dim-red: #A33; --bright-red: #F55;
            --bg-color: #000; --font-color: var(--base-red); --fav-color: #ffb833;
        }
        html, body {
            height: 100%; margin: 0; padding: 0; overflow: hidden;
            background-color: var(--bg-color); color: var(--font-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        #live-clock {
            position: fixed; top: 20px; left: 20px; font-size: clamp(3rem, 6vw, 5rem);
            font-weight: 700; color: var(--dim-red); font-variant-numeric: tabular-nums;
            z-index: 50; text-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .screensaver-container {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            width: 100vw; height: 100vh; text-align: center; padding: 5vw; box-sizing: border-box; position: relative;
        }
        .fact-wrapper { max-width: 80vw; }
        #fact-text {
            font-size: clamp(2rem, 5vw, 4.5rem); font-weight: 500; line-height: 1.3;
            margin: 0; transition: opacity 0.5s ease-in-out;
        }
        .nav-overlay { position: fixed; top: 0; height: 100%; width: 25%; z-index: 10; cursor: pointer; }
        #nav-left { left: 0; }
        #nav-right { right: 0; }
        .top-ui-controls {
            position: fixed; top: 20px; right: 20px; display: flex;
            gap: 20px; align-items: center; z-index: 100;
        }
        #counter { font-size: 1.2rem; color: var(--dim-red); font-variant-numeric: tabular-nums; }
        .ui-button {
            background: none; border: 1px solid var(--dim-red); color: var(--dim-red);
            padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: all 0.2s ease;
        }
        .ui-button:hover { background-color: var(--dim-red); color: var(--bg-color); }
        #info-btn { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
        #favorite-zone {
            position: fixed; left: 50%; transform: translateX(-50%); z-index: 15; cursor: pointer;
            width: 96px; height: 96px; border-radius: 50%; display: flex; justify-content: center; align-items: center;
        }
        #favorite-indicator {
            font-size: 2rem; color: transparent; text-shadow: 0 0 var(--dim-red);
            transition: all 0.3s ease; pointer-events: none;
        }
        #favorite-indicator.is-favorite { color: var(--fav-color); text-shadow: 0 0 15px var(--fav-color); transform: scale(1.2); }
        .panel-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.9);
            z-index: 200; display: none; flex-direction: column; justify-content: center;
            align-items: center; padding: 40px; box-sizing: border-box; cursor: pointer;
        }
        .panel-content {
            background-color: #110000; border: 1px solid var(--dim-red); border-radius: 15px; padding: 30px;
            width: 90%; max-width: 700px; max-height: 80vh; overflow-y: auto; position: relative; cursor: default;
        }
        .panel-content h2 { margin-top: 0; padding-right: 30px; color: var(--bright-red); text-align: center; }
        .close-button-x {
            position: absolute; top: 10px; right: 15px; font-size: 2rem; font-weight: bold;
            color: var(--dim-red); background: none; border: none; cursor: pointer; line-height: 1; padding: 5px;
        }
        .close-button-x:hover { color: var(--bright-red); }
        #favorites-list, #past-sessions-list { list-style: none; padding: 0; margin: 0; }
        #favorites-list li, #past-sessions-list li {
            padding: 15px 0; border-bottom: 1px solid #441111; color: var(--font-color); line-height: 1.5;
        }
        #past-sessions-list li { cursor: pointer; transition: background-color 0.2s ease; padding: 15px; }
        #past-sessions-list li:hover { background-color: #331111; }
        #favorites-list li:last-child, #past-sessions-list li:last-child { border-bottom: none; }
        #context-text-panel { color: var(--font-color); line-height: 1.6; font-size: 1.1rem; text-align: left; }
        .panel-controls { margin-top: 20px; display: flex; gap: 15px; justify-content: center; }
        .panel-btn {
            background: none; border: 1px solid var(--base-red); color: var(--base-red); padding: 10px 25px;
            border-radius: 25px; cursor: pointer; font-size: 1rem; transition: all 0.2s ease;
        }
        .panel-btn:hover { background-color: var(--base-red); color: var(--bg-color); }
        .profile-menu-container { display: flex; flex-direction: column; gap: 15px; }
        .profile-menu-container .menu-btn, .profile-menu-container .file-upload-label {
            display: block; width: 100%; text-align: center; background: none; border: 1px solid var(--base-red);
            color: var(--base-red); padding: 12px 20px; border-radius: 25px; cursor: pointer; font-size: 1rem;
            transition: all 0.2s ease; box-sizing: border-box; 
        }
        .profile-menu-container .menu-btn:hover, .profile-menu-container .file-upload-label:hover {
            background-color: var(--base-red); color: var(--bg-color);
        }
        .profile-menu-container input[type="file"] { display: none; }
    </style>
</head>
<body>
    <div id="live-clock"></div>
    <div class="screensaver-container">
        <div class="fact-wrapper" id="fact-wrapper"><h1 id="fact-text"></h1></div>
    </div>
    <div id="nav-left" class="nav-overlay"></div>
    <div id="nav-right" class="nav-overlay"></div>
    <div class="top-ui-controls">
        <span id="counter"></span>
        <button id="profile-btn" class="ui-button">Profile</button>
    </div>
    <button id="info-btn" class="ui-button">More Info</button>
    <div id="favorite-zone"><div id="favorite-indicator">★</div></div>
    
    <div id="context-panel" class="panel-overlay">
        <div class="panel-content">
            <button class="close-button-x" data-target="context-panel">&times;</button>
            <h2>Context</h2><p id="context-text-panel"></p>
        </div>
    </div>
    <div id="favorites-panel" class="panel-overlay">
        <div class="panel-content">
            <button class="close-button-x" data-target="favorites-panel">&times;</button>
            <h2>This Session's Favorites</h2><ul id="favorites-list"></ul>
            <div class="panel-controls"><button id="download-favorites-btn" class="panel-btn">Download .txt</button></div>
        </div>
    </div>
    <div id="profile-panel" class="panel-overlay">
        <div class="panel-content">
            <button class="close-button-x" data-target="profile-panel">&times;</button>
            <h2>Profile & Sessions</h2>
            <div class="profile-menu-container">
                <button id="view-session-favorites-btn" class="menu-btn">View This Session Favorites</button>
                <button id="view-past-sessions-btn" class="menu-btn">View Past Sessions</button>
                <button id="download-current-session-btn" class="menu-btn">Download this Session JSON</button>
                <button id="download-all-sessions-btn" class="menu-btn">Download All Past Sessions JSON</button>
                <label for="upload-single-session" class="file-upload-label">Upload New Session JSON</label>
                <input type="file" id="upload-single-session" accept=".json">
                <label for="upload-multiple-sessions" class="file-upload-label">Merge Past Sessions JSON</label>
                <input type="file" id="upload-multiple-sessions" accept=".json">
            </div>
        </div>
    </div>
    <div id="past-sessions-panel" class="panel-overlay">
        <div class="panel-content">
            <button class="close-button-x" data-target="past-sessions-panel">&times;</button>
            <h2>Select a Past Session</h2><ul id="past-sessions-list"></ul>
        </div>
    </div>

<script>
    let activeSessionData;
    const embeddedSessionData = ${sessionDataJSON};
    const loadTitle = sessionStorage.getItem('loadSessionTitle');
    if (loadTitle) {
        sessionStorage.removeItem('loadSessionTitle');
        const pastSessions = JSON.parse(localStorage.getItem('pastSessions')) || [];
        const sessionToLoad = pastSessions.find(s => s.title === loadTitle);
        activeSessionData = sessionToLoad ? sessionToLoad : embeddedSessionData;
    } else {
        activeSessionData = embeddedSessionData;
    }
    const factsData = activeSessionData.facts;
    document.title = activeSessionData.title;

    const factTextEl = document.getElementById('fact-text'), factWrapperEl = document.getElementById('fact-wrapper'),
          liveClockEl = document.getElementById('live-clock'), counterEl = document.getElementById('counter'),
          favoriteZoneEl = document.getElementById('favorite-zone'), favoriteIndicatorEl = document.getElementById('favorite-indicator'),
          infoBtnEl = document.getElementById('info-btn'), contextPanelEl = document.getElementById('context-panel'),
          contextTextPanelEl = document.getElementById('context-text-panel'), favoritesPanelEl = document.getElementById('favorites-panel'),
          favoritesListEl = document.getElementById('favorites-list'), profileBtnEl = document.getElementById('profile-btn'),
          profilePanelEl = document.getElementById('profile-panel'), pastSessionsPanelEl = document.getElementById('past-sessions-panel'),
          pastSessionsListEl = document.getElementById('past-sessions-list');
    
    let currentFactIndex = 0, autoAdvanceTimer;
    const AUTO_ADVANCE_DELAY = 25000;
    
    let allFavorites = JSON.parse(localStorage.getItem('factFavorites')) || {};
    let sessionFavorites = allFavorites[activeSessionData.title] || [];
    function saveFavorites() {
        allFavorites[activeSessionData.title] = sessionFavorites;
        localStorage.setItem('factFavorites', JSON.stringify(allFavorites));
    }
    
    function downloadFile(content, fileName, contentType) {
        const blob = new Blob([content], { type: contentType });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = fileName;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    }
    function updateClock() {
        const timeString = new Date().toLocaleTimeString(navigator.language, { hour: 'numeric', minute: '2-digit' });
        if (liveClockEl.textContent !== timeString) liveClockEl.textContent = timeString;
    }
    function positionFavoriteIndicator() {
        const factRect = factWrapperEl.getBoundingClientRect();
        favoriteZoneEl.style.top = \`\${factRect.bottom + ((window.innerHeight - factRect.bottom) / 2) - (favoriteZoneEl.offsetHeight / 2)}px\`;
    }
    function renderFact(index) {
        factTextEl.style.opacity = 0;
        setTimeout(() => {
            factTextEl.textContent = factsData[index].fact;
            counterEl.textContent = \`\${index + 1} / \${factsData.length}\`;
            favoriteIndicatorEl.classList.toggle('is-favorite', sessionFavorites.includes(index));
            factTextEl.style.opacity = 1;
            positionFavoriteIndicator();
        }, 400);
        resetAutoAdvanceTimer();
    }
    function nextFact() { renderFact(currentFactIndex = (currentFactIndex + 1) % factsData.length); }
    function prevFact() { renderFact(currentFactIndex = (currentFactIndex - 1 + factsData.length) % factsData.length); }
    function resetAutoAdvanceTimer() { clearTimeout(autoAdvanceTimer); autoAdvanceTimer = setTimeout(nextFact, AUTO_ADVANCE_DELAY); }
    function showPanel(panelEl) { clearTimeout(autoAdvanceTimer); panelEl.style.display = 'flex'; }
    function hidePanel(panelEl) { panelEl.style.display = 'none'; resetAutoAdvanceTimer(); }
    function toggleFavorite() {
        const indexInFavorites = sessionFavorites.indexOf(currentFactIndex);
        if (indexInFavorites > -1) sessionFavorites.splice(indexInFavorites, 1);
        else sessionFavorites.push(currentFactIndex);
        favoriteIndicatorEl.classList.toggle('is-favorite', indexInFavorites === -1);
        saveFavorites();
    }
    function showContextPanel() {
        contextTextPanelEl.textContent = factsData[currentFactIndex].context || "No context available.";
        showPanel(contextPanelEl);
    }
    function showFavoritesPanel() {
        favoritesListEl.innerHTML = sessionFavorites.length === 0 ? '<li>You haven\\'t favorited any facts yet.</li>' :
            sessionFavorites.sort((a,b) => a-b).map(index => \`<li>\${factsData[index].fact}</li>\`).join('');
        showPanel(favoritesPanelEl);
    }
    function downloadSessionFavorites() {
        if (sessionFavorites.length === 0) { alert('No favorites to download.'); return; }
        let textContent = \`Favorite Facts from: \${activeSessionData.title}\\n===================\\n\\n\`;
        sessionFavorites.sort((a,b) => a-b).forEach((index, i) => {
            textContent += \`\${i + 1}. \${factsData[index].fact}\\n(Context: \${factsData[index].context})\\n\\n\`;
        });
        downloadFile(textContent, 'my_favorite_facts.txt', 'text/plain');
    }
    function populateAndShowPastSessions() {
        const pastSessions = JSON.parse(localStorage.getItem('pastSessions')) || [];
        pastSessionsListEl.innerHTML = '';
        if (pastSessions.length === 0) {
            pastSessionsListEl.innerHTML = '<li>No past sessions found.</li>';
        } else {
            pastSessions.forEach(session => {
                const li = document.createElement('li');
                li.textContent = session.title;
                if (session.title === activeSessionData.title) li.style.color = 'var(--bright-red)';
                li.addEventListener('click', () => {
                    sessionStorage.setItem('loadSessionTitle', session.title);
                    location.reload();
                });
                pastSessionsListEl.appendChild(li);
            });
        }
        showPanel(pastSessionsPanelEl);
    }
    function handleFileUpload(event, isMultiple) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                let pastSessions = JSON.parse(localStorage.getItem('pastSessions')) || [];
                if (isMultiple) {
                    if (!Array.isArray(data)) throw new Error("File should contain an array of sessions.");
                    const sessionMap = new Map(pastSessions.map(s => [s.title, s]));
                    data.forEach(newSession => {
                        if (newSession.title && Array.isArray(newSession.facts)) sessionMap.set(newSession.title, newSession);
                    });
                    pastSessions = Array.from(sessionMap.values());
                    alert(\`Merged \${data.length} sessions. Total sessions now: \${pastSessions.length}.\`);
                } else {
                    if (!data.title || !Array.isArray(data.facts)) throw new Error("Invalid session JSON format.");
                    const existingIndex = pastSessions.findIndex(s => s.title === data.title);
                    if (existingIndex > -1) pastSessions[existingIndex] = data; else pastSessions.push(data);
                    alert(\`Session "\${data.title}" was successfully uploaded.\`);
                }
                localStorage.setItem('pastSessions', JSON.stringify(pastSessions));
            } catch (err) { alert('Error processing file: ' + err.message); }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    document.getElementById('nav-left').addEventListener('click', prevFact);
    document.getElementById('nav-right').addEventListener('click', nextFact);
    favoriteZoneEl.addEventListener('click', toggleFavorite);
    infoBtnEl.addEventListener('click', showContextPanel);
    profileBtnEl.addEventListener('click', () => showPanel(profilePanelEl));
    document.getElementById('download-favorites-btn').addEventListener('click', downloadSessionFavorites);
    document.getElementById('view-session-favorites-btn').addEventListener('click', () => { hidePanel(profilePanelEl); showFavoritesPanel(); });
    document.getElementById('view-past-sessions-btn').addEventListener('click', () => { hidePanel(profilePanelEl); populateAndShowPastSessions(); });
    document.getElementById('download-current-session-btn').addEventListener('click', () => downloadFile(JSON.stringify(activeSessionData, null, 2), \`\${activeSessionData.title.replace(/[.\\s]/g, '_')}.json\`, 'application/json'));
    document.getElementById('download-all-sessions-btn').addEventListener('click', () => downloadFile(localStorage.getItem('pastSessions') || '[]', 'all_past_sessions.json', 'application/json'));
    document.getElementById('upload-single-session').addEventListener('change', (e) => handleFileUpload(e, false));
    document.getElementById('upload-multiple-sessions').addEventListener('change', (e) => handleFileUpload(e, true));
    
    document.querySelectorAll('.panel-overlay').forEach(p => p.addEventListener('click', e => e.target === p && hidePanel(p)));
    document.querySelectorAll('.close-button-x').forEach(b => b.addEventListener('click', e => hidePanel(document.getElementById(e.currentTarget.dataset.target))));
    
    window.addEventListener('keydown', (e) => {
        if (Array.from(document.querySelectorAll('.panel-overlay')).some(p => p.style.display === 'flex')) {
            if (e.key === 'Escape') document.querySelectorAll('.panel-overlay').forEach(hidePanel);
            return;
        }
        if (e.key === 'ArrowLeft') prevFact();
        if (e.key === 'ArrowRight') nextFact();
        if (e.key === 'i' || e.key === 'I') showContextPanel();
        if (e.key === 'p' || e.key === 'P') showPanel(profilePanelEl);
        if (e.key === ' ') { e.preventDefault(); toggleFavorite(); }
    });
    window.addEventListener('resize', positionFavoriteIndicator);

    renderFact(currentFactIndex);
    updateClock();
    setInterval(updateClock, 1000);
<\/script>
</body>
</html>`;
                sessionStorage.setItem('lastGeneratedHTML', htmlTemplate);
                document.open();
                document.write(htmlTemplate);
                document.close();
            });
        }
        
        // --- Page Restoration Logic ---
        window.addEventListener('popstate', event => {
            const storedOriginalHTML = sessionStorage.getItem('originalGeneratorHTML');
            if (event.state && event.state.view === 'generator_restoration_point' && storedOriginalHTML) {
                document.open();
                document.write(storedOriginalHTML);
                document.close();
                setTimeout(addActionButtonsForPrevious, 0);
            }
        });
        addActionButtonsForPrevious();
    </script>
</body>
</html>