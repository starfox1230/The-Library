<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Anki Swipe-Reveal Feed</title>
  <style>
    :root {
      --bg: #000;
      --card-bg: #1c1c1e;
      --text: #fff;
      --accent: #00c8ff;
      --extra: #8e8e93;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: sans-serif;
      line-height: 1.4;
    }
    header {
      text-align: center;
      padding: 1rem;
      background: var(--card-bg);
    }
    #fileInput {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--text);
      border-radius: 4px;
    }
    #feed {
      padding: 1rem 0;
    }
    .card {
      position: relative;
      overflow: hidden;
      margin: 1rem auto;
      max-width: 600px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    .card .back {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 0.75rem;
    }
    .card .back-content {
      white-space: pre-wrap;
    }
    .card .extra-content {
      white-space: pre-wrap;
      color: var(--extra);
      font-size: 0.9rem;
    }
    .card .front {
      position: relative;
      padding: 1rem;
      touch-action: pan-y; /* allow vertical scroll */
      user-select: none;
      white-space: pre-wrap;
    }
  </style>

  <!-- JSZip for unzipping -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <!-- sql.js for reading SQLite -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
</head>
<body>
  <header>
    <h1>Anki Swipe-Reveal Feed</h1>
    <input type="file" id="fileInput" accept=".apkg,.zip,application/zip">
  </header>

  <main id="feed">
    <p style="text-align:center;">Upload your .apkg of due cards to begin</p>
  </main>

  <script>
    initSqlJs({
      locateFile: file => 
        'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/' + file
    }).then(SQL => {
      const fileInput = document.getElementById('fileInput');
      const feed = document.getElementById('feed');

      fileInput.addEventListener('change', async e => {
        const file = e.target.files[0];
        if (!file) return;
        feed.innerHTML = '<p style="text-align:center;">Loadingâ€¦</p>';

        // 1. unzip .apkg
        const data = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(data);

        // 2. optional media map (not used here)
        // let mediaMap = {};
        // if (zip.file('media')) {
        //   mediaMap = JSON.parse(await zip.file('media').async('string'));
        // }

        // 3. get SQLite DB
        const dbFile = zip.file('collection.anki2');
        if (!dbFile) {
          feed.innerHTML = '<p style="text-align:center;">Invalid .apkg</p>';
          return;
        }
        const dbData = new Uint8Array(await dbFile.async('arraybuffer'));
        const db = new SQL.Database(dbData);

        // 4. query all note fields (split on cloze sep \u001f)
        const res = db.exec(`
          SELECT n.flds
          FROM cards c
          JOIN notes n ON c.nid = n.id
        `);

        feed.innerHTML = '';
        if (!res.length) {
          feed.innerHTML = '<p style="text-align:center;">No cards found</p>';
          return;
        }

        // 5. build cards
        res[0].values.forEach(row => {
          const fields = row[0].split('\u001f');
          const frontText = fields[0] || '';
          const backText  = fields[1] || '';
          const extraText = fields[2] || '';

          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="back">
              <div class="back-content">${backText}</div>
              ${ extraText
                ? `<div class="extra-content">${extraText}</div>`
                : ''
              }
            </div>
            <div class="front">${frontText}</div>
          `;

          // swipe-to-reveal on the front
          const frontEl = card.querySelector('.front');
          let startX = 0, deltaX = 0;

          frontEl.addEventListener('pointerdown', e => {
            startX = e.clientX;
            frontEl.setPointerCapture(e.pointerId);
            frontEl.style.transition = 'none';
          });
          frontEl.addEventListener('pointermove', e => {
            if (!frontEl.hasPointerCapture(e.pointerId)) return;
            deltaX = e.clientX - startX;
            // only allow left drag
            if (deltaX < 0) {
              frontEl.style.transform = `translateX(${deltaX}px)`;
            }
          });
          frontEl.addEventListener('pointerup', e => {
            if (!frontEl.hasPointerCapture(e.pointerId)) return;
            frontEl.releasePointerCapture(e.pointerId);
            frontEl.style.transition = 'transform 0.3s ease';
            const width = card.offsetWidth;
            // if dragged left beyond 1/3 width, slide off; else snap back
            if (deltaX < -width / 3) {
              frontEl.style.transform = `translateX(-${width}px)`;
            } else {
              frontEl.style.transform = 'translateX(0)';
            }
          });
          frontEl.addEventListener('pointercancel', e => {
            if (!frontEl.hasPointerCapture(e.pointerId)) return;
            frontEl.releasePointerCapture(e.pointerId);
            frontEl.style.transition = 'transform 0.3s ease';
            frontEl.style.transform = 'translateX(0)';
          });

          feed.appendChild(card);
        });
      });
    });
  </script>
</body>
</html>