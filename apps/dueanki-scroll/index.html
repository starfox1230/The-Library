<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Anki True-Template Swipe Feed</title>
  <style>
    :root {
      --bg: #000;
      --card-bg: #1c1c1e;
      --text: #fff;
      --accent: #00c8ff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: sans-serif;
    }
    header {
      text-align: center;
      padding: 1rem;
      background: var(--card-bg);
    }
    #fileInput {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--text);
      border-radius: 4px;
    }
    #feed {
      padding: 1rem 0;
    }
    .card {
      position: relative;
      overflow: hidden;
      margin: 1rem auto;
      max-width: 600px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    .card .back,
    .card .front {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      padding: 1rem;
      white-space: pre-wrap;
    }
    .card .back {
      /* sits underneath */
    }
    .card .front {
      background: var(--card-bg);
      touch-action: pan-y;
      user-select: none;
      transition: transform 0.3s ease;
    }
  </style>
  <!-- dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
</head>
<body>
  <header>
    <h1>Anki True-Template Swipe Feed</h1>
    <input type="file" id="fileInput" accept=".apkg,.zip">
  </header>
  <main id="feed">
    <p style="text-align:center;">Upload a .apkg/.zip exported from Anki</p>
  </main>

  <script>
  initSqlJs({ locateFile: f =>
    'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/' + f
  }).then(SQL => {
    const fileInput = document.getElementById('fileInput');
    const feed      = document.getElementById('feed');

    fileInput.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;
      feed.innerHTML = '<p style="text-align:center;">Loading…</p>';

      try {
        // 1) Unzip
        const data = await file.arrayBuffer();
        const zip  = await JSZip.loadAsync(data);

        // ** DEBUG: show me exactly what’s inside the zip **
        console.log('ZIP files:', Object.keys(zip.files));

        // 2) Find the DB file anywhere in the zip
        const allPaths = Object.keys(zip.files);
        const dbPath = allPaths.find(p => /collection\.anki2$/i.test(p));
        if (!dbPath) {
          feed.innerHTML = `
            <p style="text-align:center;">
              Could not find <code>collection.anki2</code> in your .apkg/.zip.<br>
              See console for a full directory listing.
            </p>`;
          return;
        }

        // 3) Load and query
        const dbData = new Uint8Array(await zip.file(dbPath).async('arraybuffer'));
        const db     = new SQL.Database(dbData);

        // …then your existing model‐parsing + card‐rendering code…
        // (copy in the same model‐injection + template + swipe logic
        //  from the “True-Template Swipe Feed” example)

      } catch (err) {
        console.error(err);
        feed.innerHTML = `
          <p style="text-align:center;">
            Error processing deck:<br>
            ${err.message}
          </p>`;
      }
    });
  });
</script>
</body>
</html>