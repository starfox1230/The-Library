<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Anki True-Template Swipe Feed</title>
  <style>
    :root {
      --bg: #000;
      --card-bg: #1c1c1e;
      --text: #fff;
      --accent: #00c8ff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: sans-serif;
    }
    header {
      text-align: center;
      padding: 1rem;
      background: var(--card-bg);
    }
    #fileInput {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--text);
      border-radius: 4px;
    }
    #feed {
      padding: 1rem 0;
    }
    .card {
      position: relative;
      overflow: hidden;
      margin: 1rem auto;
      max-width: 600px;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.5);
    }
    .card .back,
    .card .front {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      padding: 1rem;
      white-space: pre-wrap;
    }
    .card .back {
      /* sits underneath */
    }
    .card .front {
      background: var(--card-bg);
      touch-action: pan-y;
      user-select: none;
      transition: transform 0.3s ease;
    }
  </style>
  <!-- dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
</head>
<body>
  <header>
    <h1>Anki True-Template Swipe Feed</h1>
    <input type="file" id="fileInput" accept=".apkg,.zip">
  </header>
  <main id="feed">
    <p style="text-align:center;">Upload a .apkg/.zip exported from Anki</p>
  </main>

  <script>
    initSqlJs({ locateFile: f => 
      'https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/' + f 
    }).then(SQL => {
      const fileInput = document.getElementById('fileInput');
      const feed = document.getElementById('feed');

      fileInput.addEventListener('change', async e => {
        const file = e.target.files[0];
        if (!file) return;
        feed.innerHTML = '<p style="text-align:center;">Loading…</p>';

        // 1) Unzip
        const data = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(data);

        // 2) Load DB
        const dbFile = zip.file('collection.anki2');
        if (!dbFile) {
          feed.innerHTML = '<p style="text-align:center;">No Anki DB found in that file.</p>';
          return;
        }
        const dbData = new Uint8Array(await dbFile.async('arraybuffer'));
        const db = new SQL.Database(dbData);

        // 3) Parse models → inject their CSS
        const mdlRes = db.exec("SELECT models FROM col");
        let models = {};
        if (mdlRes.length) {
          models = JSON.parse(mdlRes[0].values[0][0]);
          const styleEl = document.createElement('style');
          styleEl.textContent = Object.values(models)
            .map(m => m.css)
            .join("\n");
          document.head.appendChild(styleEl);
        }

        // 4) Pull each card’s ord, fields, and model-ID
        const cardRes = db.exec(`
          SELECT c.ord, n.flds, n.mid
          FROM cards c
            JOIN notes n ON c.nid = n.id
        `);

        feed.innerHTML = '';
        if (!cardRes.length) {
          feed.innerHTML = '<p style="text-align:center;">No cards found.</p>';
          return;
        }

        // helper to fill in {{FieldName}}
        function renderTemplate(tmpl, fieldDefs, values) {
          return tmpl.replace(/{{\s*([\w ]+?)\s*}}/g, (_, name) => {
            const def = fieldDefs.find(f => f.name === name);
            return def ? values[def.ord] : '';
          });
        }

        // 5) Render each card
        cardRes[0].values.forEach(([ord, flds, mid]) => {
          const model = models[mid];
          const fieldVals = flds.split('\u001f');
          const tpl = model.tmpls[ord];
          const frontHTML = renderTemplate(tpl.qfmt, model.flds, fieldVals);
          const backHTML  = renderTemplate(tpl.afmt, model.flds, fieldVals);

          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="back">${backHTML}</div>
            <div class="front">${frontHTML}</div>
          `;

          // swipe-left to reveal
          const frontEl = card.querySelector('.front');
          let startX = 0, deltaX = 0;
          frontEl.addEventListener('pointerdown', e => {
            startX = e.clientX;
            frontEl.setPointerCapture(e.pointerId);
            frontEl.style.transition = 'none';
          });
          frontEl.addEventListener('pointermove', e => {
            if (!frontEl.hasPointerCapture(e.pointerId)) return;
            deltaX = e.clientX - startX;
            if (deltaX < 0) frontEl.style.transform = `translateX(${deltaX}px)`;
          });
          frontEl.addEventListener('pointerup', e => {
            frontEl.releasePointerCapture(e.pointerId);
            frontEl.style.transition = 'transform 0.3s ease';
            if (deltaX < -card.offsetWidth/3) {
              frontEl.style.transform = `translateX(-${card.offsetWidth}px)`;
            } else {
              frontEl.style.transform = 'translateX(0)';
            }
          });
          frontEl.addEventListener('pointercancel', () => {
            frontEl.releasePointerCapture();
            frontEl.style.transition = 'transform 0.3s ease';
            frontEl.style.transform = 'translateX(0)';
          });

          feed.appendChild(card);
        });
      });
    });
  </script>
</body>
</html>