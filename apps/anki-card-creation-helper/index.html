<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>Cloze Cards Reviewer ‚Äî JSON ‚Üí Visual ‚Üí Save/Discard</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --surface:#1e222b; --muted:#96a0af; --text:#e7eaf0;
    --accent:#9b87fd; --accent-weak:#b6a9ff; --good:#2ecc71; --bad:#e74c3c; --warn:#f39c12; --info:#3b82f6;
    --ring:0 0 0 2px rgba(155,135,253,.35);
    --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35); --code:#0b0d12;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.35 system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial}
  body.noScroll{overflow:hidden}
  a{color:var(--accent);text-decoration:none}
  a:hover{text-decoration:underline}

  /* One-column layout */
  .wrap{max-width:880px;margin:0 auto;padding:16px}
  header{
    position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.8));
    backdrop-filter: blur(8px); border-bottom:1px solid #262b35;
  }
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;padding:12px}
  .toolbar .title{font-weight:700;font-size:18px;margin-right:auto}

  .btn{
    border:1px solid #2a3140;background:var(--surface);color:var(--text);
    padding:9px 12px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow)
  }
  .btn:focus{outline:none;box-shadow:var(--ring)}
  .btn.primary{background:var(--accent);border-color:transparent;color:#0b0d12}
  .btn.good,.btn.positive{background:var(--good);border-color:transparent;color:#0b0d12}
  .btn.bad,.btn.negative{background:#ff6b6b;border-color:transparent;color:#0b0d12}
  .btn.warn{background:var(--warn);border-color:transparent;color:#0b0d12}
  .btn.info{background:var(--info);border-color:transparent;color:#0b0d12}

  .seg{display:flex;gap:6px;background:var(--panel);padding:6px;border-radius:10px;border:1px solid #293042}
  .seg .segbtn{
    background:transparent;border:0;color:var(--muted);padding:8px 12px;border-radius:8px;cursor:pointer
  }
  .seg .segbtn.active{background:var(--surface);color:var(--text);box-shadow:var(--ring)}
  .searchRow{display:flex;gap:10px;flex-wrap:wrap;width:100%}
  .input, textarea{
    background:#141821;border:1px solid #2b3243;color:var(--text);
    padding:10px 12px;border-radius:10px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.2)
  }
  .input:focus, textarea:focus{outline:none;box-shadow:var(--ring)}
  textarea{width:100%;min-height:160px;resize:vertical}

  .cardlist{display:flex;flex-direction:column;gap:14px;margin-top:14px}
  .card{
    position:relative;background:var(--surface);border:1px solid #2b3243;border-radius:var(--radius);padding:12px;
    box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px
  }
  .meta{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:12px}
  .badge{padding:2px 8px;border-radius:999px;background:#262c39;border:1px solid #31384a;color:#c6cede}
  .tags{display:flex;flex-wrap:wrap;gap:6px}
  .notehtml{line-height:1.55;font-size:16px}
  .notehtml .cloze, .notehtml .cloze b, .notehtml .cloze i, .notehtml .cloze u{
    color:#0b0d12;background:var(--accent);padding:1px 5px;border-radius:6px;font-weight:700
  }
  .notehtml .ghost{
    color:var(--accent-weak);border:1px dashed #3c3f55;padding:1px 5px;border-radius:6px;opacity:.9
  }
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row .btn.small{padding:6px 9px;border-radius:8px;font-size:13px}
  .row.right{margin-left:auto}
  .pill{
    display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#151925;border:1px solid #2b3243;color:#cbd3df;font-size:13px
  }
  .hidden{display:none !important}
  .gridFooter{display:flex;justify-content:space-between;align-items:center;margin-top:14px;color:var(--muted)}

  /* Per-card cloze navigator */
  .clozeNav{
    position:absolute;right:10px;bottom:10px;display:flex;align-items:center;gap:6px;
    background:#151925cc;border:1px solid #2b3243;border-radius:999px;padding:4px 8px
  }
  .clozeNav .miniBtn{
    border:1px solid #2b3243;background:#0f1420;color:#d7e0f6;border-radius:8px;
    padding:2px 6px;cursor:pointer;font-size:12px;line-height:1
  }
  .clozeNav .indicator{font:12px/1.2 ui-monospace,SFMono-Regular,Menlo,Consolas;color:#c7d2e7}

  /* Modal */
  .modalBackdrop{
    position:fixed;inset:0;background:rgba(0,0,0,.45);
    display:none;align-items:center;justify-content:center;z-index:20;
    backdrop-filter: blur(8px) saturate(120%);
  }
  .modal{width:min(760px,94vw);background:var(--panel);border:1px solid #2b3243;border-radius:16px;box-shadow:var(--shadow);padding:16px}
  .modal header{border:0;background:transparent}
  .f1{flex:1}
  .muted{color:var(--muted)}
  .hr{height:1px;background:#2b3243;margin:10px 0;border-radius:1px}
  .mini{font-size:12px}
  .ghostbtn{background:transparent;border:1px dashed #3b4255;color:#aab4c3;border-radius:10px;padding:8px 10px;cursor:pointer}
  code.block{
    display:block;background:var(--code);color:#cfe3ff;border:1px solid #293042;border-radius:10px;
    padding:12px;overflow:auto;white-space:pre-wrap;word-break:break-word
  }
</style>
</head>
<body>
<header>
  <div class="toolbar wrap">
    <div class="title">Cloze Cards Reviewer</div>
    <div class="seg" role="tablist" aria-label="Views">
      <button class="segbtn active" data-view="new">New</button>
      <button class="segbtn" data-view="saved">Saved</button>
      <button class="segbtn" data-view="discarded">Discarded</button>
      <button class="segbtn" data-view="all">All</button>
    </div>
    <button class="btn" id="soloBtn" title="One-at-a-time viewer (optional)">Solo View</button>
    <div class="searchRow">
      <input class="input" id="search" placeholder="Search (live)">
      <input class="input" id="tagFilter" placeholder='Filter by tag (comma: e.g. "neuro, lymph")'>
    </div>
    <div class="row">
      <button class="btn" id="copyAllBtn" title="Copy all visible">Copy Visible</button>
      <div class="seg" aria-label="Export">
        <button class="segbtn" id="expTxt">TXT</button>
        <button class="segbtn" id="expTsv">TSV</button>
        <button class="segbtn" id="expCrowdAnki">CrowdAnki</button>
        <button class="segbtn" id="expApkg">APKG</button>
      </div>
      <button class="btn bad" id="nukeBtn" title="Clear local data">Reset</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="ingest">
    <p class="muted mini">Paste JSON produced by your chatbot and click <b>Load JSON</b>. Accepted shapes:
      <code class="pill">["..."]</code>,
      <code class="pill">[{ "content": "..." }]</code>,
      <code class="pill">[{ "html": "...", "tags": ["‚Ä¶"], "id": "‚Ä¶" }]</code>.
      Each string/object must contain <b>cloze HTML</b> like <code>{{c1::answer}}</code>.
    </p>
    <textarea id="jsonInput" placeholder='[
  "What is the capital of Australia?<br><br>{{c1::Canberra}}",
  {"content": "The three branches are {{c1::executive}}, {{c1::legislative}}, and {{c1::judicial}}.", "tags":["civics"]},
  {"html":"{{c1::Jupiter}} is the largest planet.", "id":"note-42", "tags":["astro","giants"]}
]'></textarea>
    <div class="row" style="margin-top:10px;">
      <button class="btn primary" id="loadBtn">Load JSON</button>
      <button class="btn warn" id="pasteBtn">Paste / Replace</button>
    </div>
  </section>

  <section id="listArea" class="hidden">
    <div class="gridFooter">
      <div><span id="countLabel">0</span> cards</div>
      <div class="muted mini">Click a card body to <span class="pill">Reveal/Hide current cloze</span>. Use ‚≠ê Save, üóëÔ∏è Discard, ‚úèÔ∏è Edit, üìã Copy.</div>
    </div>
    <div id="cards" class="cardlist" aria-live="polite"></div>
  </section>
</main>

<!-- Solo modal -->
<div class="modalBackdrop" id="soloBack" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="soloTitle">
    <header class="row" style="gap:10px;">
      <div id="soloTitle" class="f1">Solo View</div>
      <button class="btn" id="soloPrev"><span class="mini">‚Üê</span> Prev</button>
      <button class="btn" id="soloNext">Next <span class="mini">‚Üí</span></button>
      <button class="btn bad" id="soloClose">Close</button>
    </header>
    <div class="hr"></div>
    <div id="soloCard" class="card"></div>
    <div class="row" style="margin-top:8px">
      <button class="btn good small" id="soloSave">‚≠ê Save</button>
      <button class="btn small" id="soloReveal">Reveal / Hide</button>
      <button class="btn small" id="soloCopy">üìã Copy</button>
      <button class="btn small" id="soloEdit">‚úèÔ∏è Edit</button>
      <button class="btn bad small" id="soloDiscard">üóëÔ∏è Discard</button>
    </div>
    <p class="muted mini">Hints ({{cN::answer::hint}}) render as a pale badge while hidden.</p>
  </div>
</div>

<script>
(() => {
  // ---------- Types / State ----------
  const el = sel => document.querySelector(sel);
  const els = sel => Array.from(document.querySelectorAll(sel));
  const storeKey = "cloze-reviewer-v1";
  let notes = [];        // all notes
  let view = "new";      // 'new' | 'saved' | 'discarded' | 'all'
  let searchTerm = "";
  let tagFilter = [];
  let lastRendered = [];
  let soloIndex = 0;     // index in current filtered view
  const uiState = {};    // { [id]: { nums:number[], idx:number, hidden:boolean } }

  // Load persisted
  try {
    const raw = localStorage.getItem(storeKey);
    if (raw) {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) notes = parsed;
    }
  } catch {}

  // ---------- Utilities ----------
  function uid() { return "n_" + Math.random().toString(36).slice(2,10) + Date.now().toString(36); }
  function save() { localStorage.setItem(storeKey, JSON.stringify(notes)); }
  function trimHtml(s){ return (s||"").toString().trim(); }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function getClozeNumbers(html){
    const set = new Set(); const re=/{{c(\d+)::/g; let m;
    while((m=re.exec(html))){ set.add(parseInt(m[1],10)); }
    return Array.from(set).sort((a,b)=>a-b);
  }
  // Render: hide only target cloze; others shown
  function renderClozeTarget(html, targetNum, hideTarget){
    if (!targetNum) return trimHtml(html);
    const re = /{{c(\d+)::(.*?)(?:::([^}]+))?}}/g;
    return trimHtml(html).replace(re, (_, num, ans, hint) => {
      const n = parseInt(num,10);
      const hintText = hint ? escapeHtml(hint) : "‚Ä¶";
      const ansEsc = escapeHtml(ans);
      if (n === targetNum){
        return hideTarget
          ? `<span class="ghost" data-c="${n}">[${hintText}]</span>`
          : `<span class="cloze" data-c="${n}">${ansEsc}</span>`;
      } else {
        return `<span class="cloze" data-c="${n}">${ansEsc}</span>`;
      }
    });
  }

  // Normalize input to notes[]
  function normalizeInput(input){
    const out = [];
    const tryStr = v => typeof v === "string" ? v : (v && typeof v.content === "string" ? v.content :
                                 (v && typeof v.html === "string" ? v.html : null));
    const tryTags = v => Array.isArray(v?.tags) ? v.tags.map(t=>String(t)) : [];
    (input||[]).forEach((v,i)=>{
      const html = tryStr(v);
      if (!html) return;
      out.push({
        id: (v && v.id) ? String(v.id) : uid(),
        html: String(html),
        tags: tryTags(v),
        status: "new",
        fav: false,
        createdAt: Date.now() + i
      });
    });
    return out;
  }

  function filtered(){
    let arr = notes;
    if (view === "new") arr = arr.filter(n => n.status === "new");
    else if (view === "saved") arr = arr.filter(n => n.status === "saved");
    else if (view === "discarded") arr = arr.filter(n => n.status === "discarded");
    if (searchTerm) {
      const q = searchTerm.toLowerCase();
      arr = arr.filter(n => n.html.toLowerCase().includes(q) || n.tags.some(t=>t.toLowerCase().includes(q)));
    }
    if (tagFilter.length){
      arr = arr.filter(n => tagFilter.every(t => n.tags.map(x=>x.toLowerCase()).includes(t)));
    }
    return arr;
  }

  // ---------- Rendering ----------
  const cardsEl = el("#cards");
  function renderList(){
    const cur = filtered();
    lastRendered = cur.map(n=>n.id);
    el("#countLabel").textContent = String(cur.length);
    el("#listArea").classList.toggle("hidden", cur.length === 0);
    cardsEl.innerHTML = cur.map(noteToCardHtml).join("");
    cur.forEach(n => wireCard(n.id));
  }

  function noteToCardHtml(n){
    const nums = getClozeNumbers(n.html);
    if (!uiState[n.id]) uiState[n.id] = { nums, idx:0, hidden:true };
    else uiState[n.id].nums = nums;

    return `
      <article class="card" id="card-${n.id}" data-id="${n.id}">
        <div class="meta">
          <span class="badge">${n.status.toUpperCase()}</span>
          ${n.tags.length ? `<div class="tags">${n.tags.map(t=>`<span class="pill">#${escapeHtml(t)}</span>`).join("")}</div>` : ""}
          <div class="row right">
            <button class="btn small" data-action="toggle">Reveal</button>
            <button class="btn small" data-action="copy">üìã Copy</button>
            <button class="btn small" data-action="edit">‚úèÔ∏è Edit</button>
            <button class="btn small good" data-action="save">‚≠ê Save</button>
            <button class="btn small bad" data-action="discard">üóëÔ∏è</button>
          </div>
        </div>
        <div class="notehtml"></div>
        <div class="row">
          <button class="ghostbtn" data-action="restore">Restore</button>
          <span class="muted mini">ID: ${n.id}</span>
        </div>
        <div class="clozeNav ${nums.length? "" : "hidden"}">
          <button class="miniBtn" data-action="clozePrev" title="Previous cloze">‚óÄ</button>
          <span class="indicator" data-role="clozeIndicator">1/${Math.max(nums.length,1)}</span>
          <button class="miniBtn" data-action="clozeNext" title="Next cloze">‚ñ∂</button>
        </div>
      </article>
    `;
  }

  function wireCard(id){
    const root = el(`#card-${CSS.escape(id)}`);
    const get = a => root.querySelector(`[data-action="${a}"]`);
    const note = notes.find(x=>x.id===id);
    const htmlBox = root.querySelector(".notehtml");
    const indicator = root.querySelector('[data-role="clozeIndicator"]');
    const nav = root.querySelector('.clozeNav');

    function update(){
      const st = uiState[id];
      const nums = st.nums = getClozeNumbers(note.html); // keep in sync
      const has = nums.length>0;
      if (!has){
        htmlBox.innerHTML = trimHtml(note.html);
        nav.classList.add('hidden');
      } else {
        st.idx = Math.min(st.idx, nums.length-1);
        const targetNum = nums[st.idx] ?? nums[0];
        htmlBox.innerHTML = renderClozeTarget(note.html, targetNum, st.hidden);
        indicator.textContent = `${(st.idx+1)}/${nums.length}`;
        nav.classList.remove('hidden');
      }
      get("toggle").textContent = uiState[id].hidden ? "Reveal" : "Hide";
    }

    if (!uiState[id]) uiState[id] = { nums:getClozeNumbers(note.html), idx:0, hidden:true };
    update();

    get("toggle").addEventListener("click", () => { uiState[id].hidden = !uiState[id].hidden; update(); });

    root.addEventListener("click", e=>{
      if (e.target.closest(".row") || e.target.closest(".btn") || e.target.closest(".clozeNav")) return;
      uiState[id].hidden = !uiState[id].hidden; update();
    });

    get("clozePrev").addEventListener("click", (e)=>{
      e.stopPropagation();
      const st = uiState[id]; const n = st.nums.length; if (!n) return;
      st.idx = (st.idx - 1 + n) % n; st.hidden = true; update();
    });
    get("clozeNext").addEventListener("click", (e)=>{
      e.stopPropagation();
      const st = uiState[id]; const n = st.nums.length; if (!n) return;
      st.idx = (st.idx + 1) % n; st.hidden = true; update();
    });

    get("copy").addEventListener("click", (e) => { e.stopPropagation(); navigator.clipboard.writeText(note.html).then(()=> toast("Copied")); });

    get("edit").addEventListener("click", (e) => { e.stopPropagation(); openEditor(note.id, update); });

    get("save").addEventListener("click", (e) => { e.stopPropagation(); note.status = "saved"; note.fav = true; save(); renderList(); });

    get("discard").addEventListener("click", (e) => {
      e.stopPropagation();
      note.status = "discarded"; note.fav = false; save();
      if (view === "new") root.classList.add("hidden"); else renderList();
    });

    root.querySelector('[data-action="restore"]').addEventListener("click", (e) => {
      e.stopPropagation();
      if (note.status === "discarded") note.status = "new";
      else if (note.status === "saved") { note.status = "new"; note.fav = false; }
      save(); renderList();
    });
  }

  function toast(msg){
    const b = document.createElement("div");
    b.textContent = msg;
    Object.assign(b.style,{
      position:"fixed",left:"50%",bottom:"24px",transform:"translateX(-50%)",
      background:"#111725",color:"#dbe5ff",border:"1px solid #2e3550",padding:"10px 14px",
      borderRadius:"999px",boxShadow:"var(--shadow)",zIndex:50
    });
    document.body.appendChild(b);
    setTimeout(()=>{ b.style.transition="all .35s ease"; b.style.opacity="0"; b.style.transform="translateX(-50%) translateY(10px)"; }, 900);
    setTimeout(()=> b.remove(), 1300);
  }

  // ---------- Editor with per-Cn tools (styled +/‚àí) ----------
  function openEditor(id, onSaved){
    const note = notes.find(n=>n.id===id);
    const prev = note.html;
    const mount = document.createElement("div");
    mount.innerHTML = `
      <div class="modalBackdrop" style="display:flex">
        <div class="modal" role="dialog" aria-modal="true">
          <header class="row">
            <div class="f1">Edit Card</div>
            <button class="btn bad" data-x>Close</button>
          </header>
          <div class="hr"></div>
          <textarea class="input" id="editArea" style="width:100%;min-height:260px;font-size:24px;line-height:1.25">${escapeHtml(prev)}</textarea>

          <div class="row" id="perClozeTools" style="margin-top:10px"></div>

          <div class="row" style="margin-top:10px;">
            <button class="btn negative" data-removeAll>Remove All Clozes</button>
            <button class="btn" data-preview>Preview</button>
            <button class="btn info" data-save>Save</button>
          </div>
          <div class="hr"></div>
          <div id="preview" class="card"></div>
        </div>
      </div>
    `;
    document.body.appendChild(mount);
    document.body.classList.add("noScroll");           // lock background scroll

    const ta = mount.querySelector("#editArea");
    const close = ()=>{ mount.remove(); document.body.classList.remove("noScroll"); };
    mount.querySelector("[data-x]").onclick = close;

    function currentNums(text){ return getClozeNumbers(text); }
    function maxNum(text){ const ns=currentNums(text); return ns.length? ns[ns.length-1]:0; }

    function addClozeWithNumber(n){
      const start = ta.selectionStart, end = ta.selectionEnd;
      if (start===end){ alert("Select text to cloze."); return; }
      const txt = ta.value; const sel = txt.slice(start,end);
      const newCloze = `{{c${n}::${sel}}}`;
      ta.value = txt.slice(0,start) + newCloze + txt.slice(end);
      const pos = start + newCloze.length; ta.focus(); ta.setSelectionRange(pos,pos);
      refreshTools();
    }

    function removeClozeAndReindex(n){
      const pattern = new RegExp("\\{\\{c"+n+"::(.*?)(?:::(?:[^}]+))?\\}\\}","g");
      let v = ta.value.replace(pattern, "$1");
      v = v.replace(/\{\{c(\d+)::/g, (m, num)=>{
        const k = parseInt(num,10);
        return k>n ? "{{c"+(k-1)+"::" : m;
      });
      ta.value = v;
      refreshTools();
    }

    function removeAll(){
      ta.value = ta.value.replace(/{{c\d+::(.*?)(?:::([^}]+))?}}/g, "$1");
      refreshTools();
    }

    function refreshTools(){
      const bar = mount.querySelector("#perClozeTools");
      const nums = currentNums(ta.value);
      const next = (nums.length? nums[nums.length-1] : 0) + 1;
      bar.innerHTML = "";

      // ‚àíC# (red)
      nums.forEach(n=>{
        const b = document.createElement("button");
        b.className = "btn negative";
        b.textContent = `‚àíC${n}`;
        b.title = `Remove all C${n} and reindex`;
        b.onclick = ()=>removeClozeAndReindex(n);
        bar.appendChild(b);
      });

      // +C# for each existing and +next (green)
      nums.concat(next).forEach(n=>{
        const b = document.createElement("button");
        b.className = "btn positive";
        b.textContent = `+C${n}`;
        b.title = `Wrap selection as C${n}`;
        b.onclick = ()=>addClozeWithNumber(n);
        bar.appendChild(b);
      });
    }
    refreshTools();

    // Keep Ctrl/‚åò+Shift+C working (not advertised)
    mount.addEventListener("keydown", (e)=>{
      const key = e.key.toLowerCase();
      if ((e.ctrlKey||e.metaKey) && e.shiftKey && key==="c"){
        e.preventDefault();
        const next = maxNum(ta.value)+1;
        addClozeWithNumber(next);
      }
    });

    ta.addEventListener("input", refreshTools);

    mount.querySelector("[data-preview]").onclick = ()=>{
      const v = ta.value;
      const nums = getClozeNumbers(v);
      const first = nums[0] || null;
      mount.querySelector("#preview").innerHTML = nums.length
        ? (`<div class="notehtml">${renderClozeTarget(v, first, true)}</div>
            <div class="hr"></div>
            <div class="notehtml">${renderClozeTarget(v, first, false)}</div>`)
        : (`<div class="notehtml">${trimHtml(v)}</div>`);
    };

    mount.querySelector("[data-removeAll]").onclick = removeAll;

    mount.querySelector("[data-save]").onclick = ()=>{
      const v = ta.value;
      note.html = v; save();
      uiState[id] = { nums:getClozeNumbers(v), idx:0, hidden:true };
      renderList();
      if (typeof onSaved==="function") onSaved();
      close();
      toast("Saved");
    };

    // Close when clicking dim area outside modal
    mount.addEventListener("click", (e)=>{ if (e.target === mount.firstElementChild) close(); });
  }

  // ---------- Solo (one-at-a-time) ----------
  const soloBack = el("#soloBack");
  const soloCard = el("#soloCard");
  let soloState = { idx:0, hidden:true, nums:[] };

  function openSolo(index=0){
    const cur = filtered();
    if (!cur.length) return;
    soloIndex = Math.max(0, Math.min(index, cur.length-1));
    const n = cur[soloIndex];
    soloState.nums = getClozeNumbers(n.html);
    soloState.idx = 0; soloState.hidden = true;
    drawSolo();
    soloBack.style.display = "flex";
    soloBack.setAttribute("aria-hidden","false");
  }
  function drawSolo(){
    const cur = filtered(); const n = cur[soloIndex];
    const nums = soloState.nums;
    const target = nums[soloState.idx] || null;
    const body = nums.length
      ? renderClozeTarget(n.html, target, soloState.hidden)
      : trimHtml(n.html);
    soloCard.innerHTML = `
      <div class="meta">
        <span class="badge">${n.status.toUpperCase()}</span>
        ${n.tags.length ? `<div class="tags">${n.tags.map(t=>`<span class="pill">#${escapeHtml(t)}</span>`).join("")}</div>` : ""}
        <span class="muted mini f1" style="text-align:right">Card ${soloIndex+1} / ${cur.length}</span>
      </div>
      <div class="notehtml" id="soloHtml">${body}</div>
      <div class="clozeNav ${nums.length? "" : "hidden"}" style="position:static;margin-top:8px;align-self:flex-end">
        <button class="miniBtn" id="soloClozePrev">‚óÄ</button>
        <span class="indicator" id="soloIndicator">${nums.length? (soloState.idx+1)+"/"+nums.length : ""}</span>
        <button class="miniBtn" id="soloClozeNext">‚ñ∂</button>
      </div>
    `;
    const prevBtn = soloCard.querySelector("#soloClozePrev");
    const nextBtn = soloCard.querySelector("#soloClozeNext");
    if (prevBtn) prevBtn.onclick = ()=>{ if (!nums.length) return; soloState.idx=(soloState.idx-1+nums.length)%nums.length; soloState.hidden=true; drawSolo(); };
    if (nextBtn) nextBtn.onclick = ()=>{ if (!nums.length) return; soloState.idx=(soloState.idx+1)%nums.length; soloState.hidden=true; drawSolo(); };
  }
  function closeSolo(){ soloBack.style.display="none"; soloBack.setAttribute("aria-hidden","true"); }

  // ---------- Export Helpers ----------
  function visibleNotes(){
    const ids = new Set(lastRendered);
    return notes.filter(n => ids.has(n.id));
  }
  function download(name, text, type="text/plain"){
    const blob = new Blob([text], {type});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob); a.download = name; a.click();
    URL.revokeObjectURL(a.href);
  }
  function toTSV(arr){
    const header = "Text\n";
    return header + arr.map(n => n.html.replace(/\n/g," ")).join("\n");
  }
  function toCrowdAnki(arr){
    const deck = {
      __type__: "Deck",
      children: [],
      crowdanki_uuid: "deck-" + uid(),
      deck_config_uuid: "cfg-" + uid(),
      deck_configurations: [{
        __type__: "DeckConfig",
        name: "Default",
        autoplay: false,
        bury_new: false,
        bury_review: false,
        crowdanki_uuid: "cfg-" + uid(),
        cloze: true
      }],
      description: "Exported from Cloze Cards Reviewer",
      name: "Saved Cards",
      note_models: [{
        __type__: "NoteModel",
        crowdanki_uuid: "model-" + uid(),
        name: "Cloze (Imported)",
        type: "cloze",
        fields: [{name:"Text"}],
        templates: [{name:"Cloze", qfmt:"{{cloze:Text}}", afmt:"{{cloze:Text}}"}]
      }],
      notes: arr.map(n => ({
        __type__: "Note",
        guid: uid(),
        note_model_uuid: "model-placeholder",
        fields: [n.html],
        tags: n.tags||[]
      }))
    };
    const modelUuid = deck.note_models[0].crowdanki_uuid;
    deck.notes.forEach(nt => nt.note_model_uuid = modelUuid);
    return JSON.stringify(deck, null, 2);
  }

  // ---------- Wire UI ----------
  if (notes.length){ el("#ingest").classList.add("hidden"); el("#listArea").classList.remove("hidden"); }
  renderList();

  els(".segbtn").forEach(b=>{
    if (b.parentElement.getAttribute("aria-label")!=="Views") return;
    b.addEventListener("click", ()=>{
      els('.seg[aria-label="Views"] .segbtn').forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      view = b.dataset.view;
      renderList();
    });
  });

  el("#search").addEventListener("input", e=>{ searchTerm = e.target.value.trim(); renderList(); });
  el("#tagFilter").addEventListener("input", e=>{
    const raw = e.target.value.trim().toLowerCase();
    tagFilter = raw ? raw.split(",").map(s=>s.trim()).filter(Boolean) : [];
    renderList();
  });

  // Load / Paste now live under the textarea
  el("#loadBtn").addEventListener("click", ()=>{
    let parsed;
    try { parsed = JSON.parse(el("#jsonInput").value); }
    catch { alert("Invalid JSON"); return; }
    const normalized = normalizeInput(parsed);
    if (!normalized.length){ alert("No valid cards found."); return; }
    notes = normalized; save();
    el("#ingest").classList.add("hidden");
    el("#listArea").classList.remove("hidden");
    renderList(); toast("Loaded");
  });

  el("#pasteBtn").addEventListener("click", async ()=>{
    try{
      const txt = await navigator.clipboard.readText();
      el("#jsonInput").value = txt;
      toast("Pasted");
    }catch{ alert("Clipboard read blocked by browser."); }
  });

  el("#copyAllBtn").addEventListener("click", ()=>{
    const arr = visibleNotes();
    if (!arr.length) return alert("Nothing visible to copy.");
    navigator.clipboard.writeText(arr.map(n=>n.html).join("\n")).then(()=>toast("Copied visible"));
  });

  el("#expTxt").addEventListener("click", ()=>{
    const arr = visibleNotes(); if (!arr.length) return;
    download("cards.txt", arr.map(n=>n.html).join("\n"), "text/plain");
  });
  el("#expTsv").addEventListener("click", ()=>{
    const arr = visibleNotes(); if (!arr.length) return;
    download("cards.tsv", toTSV(arr), "text/tab-separated-values");
  });
  el("#expCrowdAnki").addEventListener("click", ()=>{
    const arr = visibleNotes(); if (!arr.length) return;
    download("crowdanki.json", toCrowdAnki(arr), "application/json");
  });

  el("#expApkg").addEventListener("click", ()=>{
    const arr = notes.filter(n => n.status==="saved");
    if (!arr.length) { alert("Save some cards first (‚≠ê), then export."); return; }
    fetch("/download_apkg", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ saved_cards: arr.map(n=>n.html) })
    })
    .then(r=> r.ok ? r.blob() : Promise.reject("Server error"))
    .then(blob=>{
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "saved_cards.apkg";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(a.href);
    })
    .catch(e=>{
      console.error(e);
      alert("APKG download failed. Make sure this page is served by the Flask app exposing POST /download_apkg.");
    });
  });

  el("#nukeBtn").addEventListener("click", ()=>{
    if (!confirm("Clear local data and start over?")) return;
    localStorage.removeItem(storeKey);
    notes = []; renderList();
    el("#listArea").classList.add("hidden");
    el("#ingest").classList.remove("hidden");
  });

  // Solo view wiring
  el("#soloBtn").addEventListener("click", ()=> openSolo(0));
  el("#soloClose").addEventListener("click", closeSolo);
  el("#soloPrev").addEventListener("click", ()=> { if (soloIndex>0){ soloIndex--; openSolo(soloIndex); } });
  el("#soloNext").addEventListener("click", ()=> { const m=filtered().length-1; if (soloIndex<m){ soloIndex++; openSolo(soloIndex); } });
  el("#soloReveal").addEventListener("click", ()=>{ soloState.hidden = !soloState.hidden; drawSolo(); });
  el("#soloCopy").addEventListener("click", ()=> {
    const cur = filtered()[soloIndex]; navigator.clipboard.writeText(cur.html).then(()=>toast("Copied"));
  });
  el("#soloSave").addEventListener("click", ()=>{ const cur=filtered()[soloIndex]; cur.status="saved"; cur.fav=true; save(); renderList(); drawSolo(); });
  el("#soloDiscard").addEventListener("click", ()=>{ const cur=filtered()[soloIndex]; cur.status="discarded"; cur.fav=false; save(); renderList(); drawSolo(); });

  window.addEventListener("keydown", (e)=>{
    if (el("#soloBack").style.display==="flex"){
      if (e.key==="Escape"){ closeSolo(); }
      else if (e.key==="ArrowLeft"){ el("#soloPrev").click(); }
      else if (e.key==="ArrowRight"){ el("#soloNext").click(); }
      else if (e.key===" "){ e.preventDefault(); el("#soloReveal").click(); }
      else if (e.key.toLowerCase()==="s"){ el("#soloSave").click(); }
      else if (e.key.toLowerCase()==="d"){ el("#soloDiscard").click(); }
      else if (e.key.toLowerCase()==="e"){ el("#soloEdit").click(); }
      else if (e.key.toLowerCase()==="c"){ el("#soloCopy").click(); }
    }
  });

  el("#soloBack").addEventListener("click", (e)=>{ if (e.target===el("#soloBack")) closeSolo(); });
})();
</script>
</body>
</html>