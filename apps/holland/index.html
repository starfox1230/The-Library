<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Jeffrey R. Holland Tracker</title>
<style>
  :root {
    --bg: #0b0f14;
    --card: #101823;
    --card-2: #0e1520;
    --text: #e6f1ff;
    --muted: #9fb3c8;
    --accent: #37e3ff;
    --accent-2: #6df2ff;
    --danger: #ff6b6b;
    --good: #2fe6a5;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius: 18px;
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body {
    margin: 0; background: var(--bg); color: var(--text);
    font: 16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
    -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
  }
  a { color: var(--accent); text-decoration: none; }
  .wrap { max-width: 860px; margin: 0 auto; padding: 16px; }

  header { display: grid; gap: 12px; margin-bottom: 12px; }
  .titlebar { display:flex; align-items:center; justify-content:space-between; flex-wrap: wrap; gap: 10px; }
  .titlebar h1 { margin:0; font-size: 20px; letter-spacing:.3px; }
  .btn {
    background: var(--card);
    color: var(--text);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: 12px; padding: 10px 12px; box-shadow: var(--shadow);
    display:inline-flex; align-items:center; gap:8px; cursor:pointer;
    transition: transform .06s ease, background .2s ease, border-color .2s ease;
    -webkit-tap-highlight-color: transparent;
  }
  .btn:active { transform: scale(.98); }
  .btn.ghost { background: transparent; border-color: rgba(255,255,255,.12); }
  .btn.small { padding: 8px 10px; border-radius: 10px; font-size: 14px; }
  .btn.icon { padding: 8px; width: 40px; height: 40px; justify-content: center; }

  .bar { background: var(--card); border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); padding: 10px; box-shadow: var(--shadow); }
  .controls { display:flex; gap:8px; flex-wrap: wrap; }

  /* Progress */
  .progress { display:flex; align-items:center; gap:10px; padding: 10px 12px; background: var(--card); border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); box-shadow: var(--shadow); }
  .progress-bar { flex:1; height: 10px; background: #0a0f18; border-radius: 999px; overflow: hidden; position: relative; }
  .progress-bar > span { position:absolute; left:0; top:0; height:100%; width:0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); box-shadow: 0 0 16px rgba(55,227,255,.35) inset; transition: width .25s ease; }
  .progress pct { font-variant-numeric: tabular-nums; }

  /* Next Up */
  .nextup { margin: 14px 0 8px; background: var(--card); border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); overflow:hidden; box-shadow: var(--shadow); }
  .nextup .thumb { position: relative; aspect-ratio: 16/9; background: #06111a; overflow: hidden; }
  .nextup img { width:100%; height:100%; object-fit:cover; display:block; }
  .nextup .chip { position:absolute; left:10px; top:10px; background: rgba(0,0,0,.5); border:1px solid rgba(255,255,255,.15); color:#dbf7ff; padding:4px 8px; border-radius:999px; font-size:12px; backdrop-filter: blur(6px); }
  .nextup .meta { padding: 12px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .nextup .meta .t { font-size: 18px; font-weight: 600; }

  /* View buttons */
  .filters { display: grid; grid-template-columns: repeat(4, 1fr); gap:8px; margin: 10px 0 12px; }
  .seg { padding: 10px; text-align:center; border-radius: 12px; border:1px solid rgba(255,255,255,.08); background: var(--card-2); color: var(--muted); cursor:pointer; user-select:none; }
  .seg.active { color: var(--text); border-color: rgba(55,227,255,.5); box-shadow: 0 0 0 2px rgba(55,227,255,.12) inset; }

  /* Category Filters (collapsible) */
  .filterbar { margin: 6px 0 12px; }
  .filter-panel[hidden] { display: none !important; }

  .filter-panel {
    display: grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap: 8px;
    padding: 10px;
    margin-top: 8px;
    background: var(--card);
    border: 1px solid rgba(255,255,255,.06);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  .chk {
    display: flex; align-items: center; gap: 8px;
    padding: 10px; border:1px solid rgba(255,255,255,.08);
    border-radius: 12px; background: var(--card-2); color: var(--muted);
    cursor: pointer; user-select: none;
  }
  .chk input { accent-color: var(--accent); width: 18px; height: 18px; }
  .chk span { flex: 1; }

  #btnFilterToggle { width: 100%; justify-content: space-between; }

  /* Talks list - redesigned row layout */
  .list { display: grid; gap:10px; }
  .row {
    display: grid;
    grid-template-columns: clamp(110px, 18vw, 160px) 1fr;
    grid-template-rows: auto auto auto;
    grid-template-areas:
      "thumb main"
      "thumb main"
      "actions actions";
    gap:12px;
    align-items: stretch;
    padding: 10px;
    background: var(--card);
    border:1px solid rgba(255,255,255,.06);
    border-radius: 14px;
  }
  .thumb-sm {
    grid-area: thumb;
    border-radius: 10px;
    overflow: hidden;
    background: #06111a;
    aspect-ratio: 16 / 9;
    align-self: start;
    cursor: pointer;
  }
  .thumb-sm img { width:100%; height:100%; object-fit: cover; display:block; }

  .row-main { grid-area: main; display: grid; grid-template-rows: auto auto; row-gap: 6px; min-width: 0; }
  .row-title { font-weight: 700; font-size: 16px; letter-spacing:.2px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
  .row-title button { all: unset; color: var(--text); cursor: pointer; }
  .row-title button:hover { text-decoration: underline; }
  .row-speaker { color: var(--muted); font-size: 14px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
  .row-date { font-size: 12px; color: var(--accent); opacity: 0.8; margin-top: 2px; }

  .row-actions { grid-area: actions; display: flex; flex-wrap: wrap; gap:8px; align-items: center; margin-top: 2px; }

  .iconbtn { background: var(--card-2); border:1px solid rgba(255,255,255,.08); border-radius: 10px; padding: 8px 10px; display:flex; align-items:center; gap:6px; cursor:pointer; color:var(--muted); }
  .iconbtn:hover { color:var(--text); border-color: rgba(255,255,255,.18); }
  .star { font-size:18px; line-height:1; color:#bcd; }
  .star.fav { color: #ffe08a; text-shadow: 0 0 10px rgba(255,224,138,.35); }
  .check { width:22px; height:22px; border-radius:6px; display:inline-grid; place-items:center; border:1px solid rgba(255,255,255,.18); background: #0a0f18; color:#88ffd1; cursor:pointer; }
  .check.on { background: rgba(47,230,165,.12); border-color: rgba(47,230,165,.55); }

  /* Watch count pill */
  .countpill { display:flex; align-items:center; gap:6px; background: #0a121b; border:1px solid rgba(255,255,255,.08); border-radius: 999px; padding: 6px 8px; }
  .countpill input { width: 40px; background: transparent; border: none; color:var(--text); text-align:center; font-variant-numeric: tabular-nums; outline:none; }
  .countpill button { background:transparent; border:none; color:var(--text); width:24px; height:24px; border-radius:8px; cursor:pointer; }
  .countpill button:active { transform: scale(.95); }

  /* Footer controls */
  .settings { margin: 12px 0 24px; display:flex; flex-wrap: wrap; gap:8px; }

  /* Modal */
  dialog { border:none; padding:0; border-radius: 16px; background: var(--card); color: var(--text); width:min(720px, 92vw); box-shadow: var(--shadow); }
  dialog::backdrop { background: rgba(4,8,12,.55); backdrop-filter: blur(2px); }
  .modal-head { padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,.06); display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .modal-body { padding: 12px; }
  textarea.notes { width:100%; min-height: 220px; resize: vertical; background: #0a121b; color: var(--text); border:1px solid rgba(255,255,255,.12); border-radius: 12px; padding: 12px; line-height:1.4; }

  /* Toast */
  .toast { position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); background: rgba(0,0,0,.7); color: #dbf7ff; padding: 10px 14px; border-radius: 999px; border:1px solid rgba(255,255,255,.15); opacity:0; pointer-events:none; transition: opacity .2s ease, transform .2s ease; z-index: 999; }
  .toast.show { opacity:1; transform: translateX(-50%) translateY(-4px); }

  /* Fine tweaks */
  @media (min-width: 680px) {
    .row { gap:14px; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="titlebar">
        <h1>Holland Talks</h1>
        <div class="controls">
          <button class="btn small ghost" id="btnSort">Sort: Newest</button>
          <button class="btn small ghost" id="btnSettings">Settings</button>
        </div>
      </div>
      <div class="progress" aria-label="Overall progress">
        <div class="progress-bar" aria-hidden="true"><span id="progFill"></span></div>
        <div class="pct" id="progPct">0%</div>
      </div>
    </header>

    <section class="nextup" id="nextUp" hidden>
      <div class="thumb">
        <img id="nextThumb" alt="Next up thumbnail" />
        <div class="chip">Next Up</div>
      </div>
      <div class="meta">
        <div class="t" id="nextTitle">&nbsp;</div>
        <button class="btn" id="btnPlayNext">Open</button>
      </div>
    </section>

    <div class="filters" role="tablist" aria-label="View">
      <div class="seg active" data-filter="need" role="tab" aria-selected="true">Need</div>
      <div class="seg" data-filter="all" role="tab" aria-selected="false">All</div>
      <div class="seg" data-filter="seen" role="tab" aria-selected="false">Seen</div>
      <div class="seg" data-filter="faves" role="tab" aria-selected="false">Favs</div>
    </div>

    <div class="filterbar">
      <button class="btn" id="btnFilterToggle" type="button" role="button" aria-expanded="false" aria-controls="filterPanel">
        <span>Filters</span><span aria-hidden="true">‚ñæ</span>
      </button>
      <div id="filterPanel" class="filter-panel" hidden>
        <label class="chk"><input type="checkbox" id="catAll" checked> <span>All</span></label>
        <label class="chk"><input type="checkbox" id="catGC"> <span>General Conference</span></label>
        <label class="chk"><input type="checkbox" id="catBYU"> <span>BYU Speeches</span></label>
        <label class="chk"><input type="checkbox" id="catCES"> <span>CES & Other</span></label>
      </div>
    </div>

    <section class="list" id="list"></section>

    <section class="settings">
      <button class="btn small" id="btnDownload">Download All</button>
      <label class="btn small" for="fileRestore" style="cursor:pointer;">Upload / Restore</label>
      <input id="fileRestore" type="file" accept="application/json" hidden />
      <button class="btn small" id="btnEmail">Email Export</button>
      <button class="btn small" id="btnNotesDownload">Notes ‚Üí File</button>
      <button class="btn small" id="btnNotesCopy">Notes ‚Üí Clipboard</button>
    </section>
  </div>

  <dialog id="notesModal">
    <div class="modal-head">
      <div id="notesTitle" style="font-weight:600;">Notes</div>
      <button class="btn small ghost" id="closeNotes">Close</button>
    </div>
    <div class="modal-body">
      <textarea class="notes" id="notesArea" placeholder="Quick thoughts‚Ä¶"></textarea>
    </div>
  </dialog>

  <div class="toast" id="toast"></div>

<script>
// -----------------------------
// Data: Jeffrey R. Holland Talks
// -----------------------------
const talks = [
  // General Conference
  {title:"And Now I See", date:"October 2025", type:"gc", videoId:"dOoW-9p1rvQ"},
  {title:"As a Little Child", date:"April 2025", type:"gc", videoId:"0u99kLy0cHg"},
  {title:"‚ÄúI Am He‚Äù", date:"October 2024", type:"gc", videoId:"LqOBM4iGbbU"},
  {title:"Motions of a Hidden Fire", date:"April 2024", type:"gc", videoId:"2UwEMFoVIsM"},
  {title:"Lifted Up upon the Cross", date:"October 2022", type:"gc", videoId:"HvpNSgoqBlc"},
  {title:"Fear Not: Believe Only!", date:"April 2022", type:"gc", videoId:"nKAGTJIPTyQ"},
  {title:"The Greatest Possession", date:"October 2021", type:"gc", videoId:"jBqtxDpoYnE"},
  {title:"Not as the World Giveth", date:"April 2021", type:"gc", videoId:"U01sQ2tEVhY"},
  {title:"Waiting on the Lord", date:"October 2020", type:"gc", videoId:"qMjMJS6DGPw"},
  {title:"A Perfect Brightness of Hope", date:"April 2020", type:"gc", videoId:"TKs0ISgF_uc"},
  {title:"The Message, the Meaning, and the Multitude", date:"October 2019", type:"gc", videoId:"cOFFpk4q3LY"},
  {title:"Behold the Lamb of God", date:"April 2019", type:"gc", videoId:"6ccgyxWA2WM"},
  {title:"The Ministry of Reconciliation", date:"October 2018", type:"gc", videoId:"Ye3ND5onRtI"},
  {title:"‚ÄúBe With and Strengthen Them‚Äù", date:"April 2018", type:"gc", videoId:"vreIzfntOik"},
  {title:"Be Ye Therefore Perfect‚ÄîEventually", date:"October 2017", type:"gc", videoId:"_IuPBFjD2oQ"},
  {title:"Songs Sung and Unsung", date:"April 2017", type:"gc", videoId:"cgq5yUgZUro"},
  {title:"Emissaries to the Church", date:"October 2016", type:"gc", videoId:"46zTbZlP_d0"},
  {title:"Tomorrow the Lord Will Do Wonders among You", date:"April 2016", type:"gc", videoId:"GFLyLHa6vtE"},
  {title:"Behold Thy Mother", date:"October 2015", type:"gc", videoId:"JBxte7rrk7A"},
  {title:"Where Justice, Love, and Mercy Meet", date:"April 2015", type:"gc", videoId:"zmmn6zlWc3c"},
  {title:"Are We Not All Beggars?", date:"October 2014", type:"gc", videoId:"bdM9AOuqt2U"},
  {title:"The Cost‚Äîand Blessings‚Äîof Discipleship", date:"April 2014", type:"gc", videoId:"wnoRZr5CJXc"},
  {title:"Like a Broken Vessel", date:"October 2013", type:"gc", videoId:"hw4zk1cHWjI"},
  {title:"‚ÄúLord, I Believe‚Äù", date:"April 2013", type:"gc", videoId:"QLuHOnh6kIg"},
  {title:"The First Great Commandment", date:"October 2012", type:"gc", videoId:"XyVg4LB7Ysc"},
  {title:"The Laborers in the Vineyard", date:"April 2012", type:"gc", videoId:"gYQ6998NXIk"},
  {title:"We Are All Enlisted", date:"October 2011", type:"gc", videoId:"TY4Io9PPONI"},
  {title:"An Ensign to the Nations", date:"April 2011", type:"gc", videoId:"IRLCptUsi_U"},
  {title:"Because of Your Faith", date:"October 2010", type:"gc", videoId:"Lv4pTAw_3wM"},
  {title:"Place No More for the Enemy of My Soul", date:"April 2010", type:"gc", videoId:"71vlgwLp4mI"},
  {title:"Safety for the Soul", date:"October 2009", type:"gc", videoId:"2gAOrQBXEks"},
  {title:"None Were with Him", date:"April 2009", type:"gc", videoId:"4kcgnmO2Aho"},
  {title:"The Ministry of Angels", date:"October 2008", type:"gc", videoId:"TGy3dY6Z7ks"},
  {title:"‚ÄúMy Words ‚Ä¶ Never Cease‚Äù", date:"April 2008", type:"gc", videoId:"941x5P9Hdv4"},
  {title:"The Only True God and Jesus Christ Whom He Hath Sent", date:"October 2007", type:"gc", videoId:"8B2pqYPAtmM"},
  {title:"The Tongue of Angels", date:"April 2007", type:"gc", videoId:"ca86xohUuCE"},
  {title:"Prophets in the Land Again", date:"October 2006", type:"gc", videoId:"TKJbwMMeZqw"},
  {title:"Broken Things to Mend", date:"April 2006", type:"gc", videoId:"oSSKqBDbb54"},
  {title:"To Young Women", date:"October 2005", type:"gc", videoId:"kwrPvkTq1xI"},
  {title:"Prophets, Seers, and Revelators", date:"October 2004", type:"gc", videoId:"-iALHlmJIpw"},
  {title:"‚ÄúAbide in Me‚Äù", date:"April 2004", type:"gc", videoId:"3cdiKtVQ6VM"},
  {title:"The Grandeur of God", date:"October 2003", type:"gc", videoId:"4qR-vaMPFog"},
  {title:"A Prayer for the Children", date:"April 2003", type:"gc", videoId:"rAuczvrCpVo"},
  {title:"Called to Serve", date:"October 2002", type:"gc", videoId:"mg8DU1o_6YE"},
  {title:"The Other Prodigal", date:"April 2002", type:"gc", videoId:"kz8oNXJ6Cl0"},
  {title:"‚ÄúLike a Watered Garden‚Äù", date:"October 2001", type:"gc", videoId:"-26g4W8eZGc"},
  {title:"‚ÄúWitnesses unto Me‚Äù", date:"April 2001", type:"gc", videoId:"wQqUzsb6pdI"},
  {title:"‚ÄúSanctify Yourselves‚Äù", date:"October 2000", type:"gc", videoId:"JvvQNlCJhvA"},
  {title:"As Doves to Our Windows", date:"April 2000", type:"gc", videoId:"JTcOM6pjFgc"},
  {title:"‚ÄúAn High Priest of Good Things to Come‚Äù", date:"October 1999", type:"gc", videoId:"sy6U419yPoo"},
  {title:"The Hands of the Fathers", date:"April 1999", type:"gc", videoId:"rsMpIW4L0YA"},
  {title:"Personal Purity", date:"October 1998", type:"gc", videoId:"auwUjmf1jlA"},
  {title:"‚ÄúA Teacher Come from God‚Äù", date:"April 1998", type:"gc", videoId:"XM6VYkXsd4o"},
  {title:"‚ÄúHe Hath Filled the Hungry with Good Things‚Äù", date:"October 1997", type:"gc", videoId:"7x84wLiP3Uk"},
  {title:"‚ÄúBecause She Is a Mother‚Äù", date:"April 1997", type:"gc", videoId:"WqMlLk21vb0"},
  {title:"‚ÄúThe Peaceable Things of the Kingdom‚Äù", date:"October 1996", type:"gc", videoId:"elrs-PZr7bk"},
  {title:"A Handful of Meal and a Little Oil", date:"April 1996", type:"gc", videoId:"vGCsoVO6agM"},
  {title:"‚ÄúThis Do in Remembrance of Me‚Äù", date:"October 1995", type:"gc", videoId:"OUxt68PBhJM"},
  {title:"Our Priesthood Legacy", date:"April 1995", type:"gc", videoId:"p63D_p03Jd8"},
  {title:"Miracles of the Restoration", date:"October 1994", type:"gc", videoId:"xykBrU-oCJA"},
  {title:"‚ÄúLook to God and Live‚Äù", date:"October 1993", type:"gc", videoId:"4leAy4zFjKo"},
  {title:"‚ÄúHe Loved Them unto the End‚Äù", date:"October 1989", type:"gc", videoId:"Pddtp-ZgFho"},
  {title:"Within the Clasp of Your Arms", date:"April 1983", type:"gc", videoId:"LEi4IXiIjB4"},
  
  // BYU Speeches
  {title:"‚ÄúA Saint Through the Atonement of Christ the Lord‚Äù", date:"January 2022", type:"byu", videoId:"v9paJQccr64"},
  {title:"The Second Half of the Second Century of BYU", date:"August 2021", type:"byu", videoId:"5tOuMIYlzvA"},
  {title:"Banishing All Shadows", date:"April 2018", type:"byu", videoId:"g6wv46sKjFo"},
  {title:"Religion: Bound by Loving Ties", date:"August 2016", type:"byu", videoId:"KCwQy7Mcqm4"},
  {title:"‚ÄúRemember Lot‚Äôs Wife‚Äù", date:"January 2009", type:"byu", videoId:"NY4Cs2VfUsY"},
  {title:"Terror, Triumph, and a Wedding Feast", date:"September 2004", type:"byu", videoId:"ktiiv144yS8"},
  {title:"How Do I Love Thee?", date:"February 2000", type:"byu", videoId:"eM3mlgLAlMs"},
  {title:"‚ÄúCast Not Away Therefore Your Confidence‚Äù", date:"March 1999", type:"byu", videoId:"pCSs4f9DlVM"},
  {title:"‚ÄúCome unto Me‚Äù", date:"March 1997", type:"byu", videoId:"CvECof6uIkA"},
  {title:"The Will of the Father", date:"January 1989", type:"byu", videoId:"ISWofagrWcg"},
  {title:"Of Souls, Symbols, and Sacraments", date:"January 1988", type:"byu", videoId:"e5HYo2OMP2Q"},
  {title:"Oh, Lord, Keep My Rudder True", date:"January 1986", type:"byu", videoId:"cLKZJylpRBY"},
  {title:"Nailing Our Colors to the Mast", date:"September 1985", type:"byu", videoId:"s5UkBm9mFHM"},
  {title:"A Robe, a Ring, and a Fatted Calf", date:"January 1984", type:"byu", videoId:"slz0eQE-HSw"},
  {title:"However Long and Hard the Road", date:"January 1983", type:"byu", videoId:"rHKe9EqB5vE"},
  {title:"For Times of Trouble", date:"March 1980", type:"byu", videoId:"nKAGTJIPTyQ"},

  // CES & Other
  {title:"Worldwide Devotional for Young Adults", date:"January 2023", type:"ces", videoId:"DdP3TAFPd2w"},
  {title:"Israel, Israel, God Is Calling", date:"September 2012", type:"ces", videoId:"vGt4wXcJjA4"},
  {title:"Lessons from Liberty Jail", date:"September 2008", type:"ces", videoId:"2fOw820ApUQ"}
];

// Helper to create sortable date integers (e.g. "October 2025" -> 202510)
const monthMap = { "January":1, "February":2, "March":3, "April":4, "May":5, "June":6, "July":7, "August":8, "September":9, "October":10, "November":11, "December":12, "Jan":1, "Feb":2, "Mar":3, "Apr":4, "May":5, "Jun":6, "Jul":7, "Aug":8, "Sep":9, "Oct":10, "Nov":11, "Dec":12 };

function parseDateVal(dStr) {
  const parts = dStr.split(" ");
  if(parts.length < 2) return 0;
  const y = parseInt(parts[1]);
  const m = monthMap[parts[0]] || 0;
  return (y * 100) + m;
}

// Add derived properties
talks.forEach((t, i) => {
  t.speaker = "Jeffrey R. Holland"; 
  t.sortVal = parseDateVal(t.date);
  t.originalIndex = i; // fallback sort
});

// -----------------------------
// State & Persistence
// -----------------------------
const STORAGE_KEY = "jrh-tracker:state";
const DEFAULT_STATE = {
  version: 1,
  watched: [], 
  favorites: [],
  notes: {},
  watchCounts: {}, 
  round: 1,
  seenAt: {}, 
  seenSeq: 0,
  ui: {
    filter: 'need',       // need | all | seen | faves
    sort: 'newest',       // newest | oldest
    filterOpen: false,    
    cats: { all: true, gc: false, byu: false, ces: false } 
  }
};

function loadState(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { ...DEFAULT_STATE };
    const obj = JSON.parse(raw);
    // Migrations / Safety
    obj.ui = obj.ui || {};
    obj.ui.cats = obj.ui.cats || { all: true, gc: false, byu: false, ces: false };
    if(!obj.ui.sort) obj.ui.sort = 'newest';
    return obj;
  } catch(e){
    console.warn('Failed to parse state', e); return { ...DEFAULT_STATE };
  }
}

function saveState(next){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
}

let state = loadState();

// Helpers
const isWatched = (id) => state.watched.includes(id);
const setWatched = (id, val, {incrementCount=false}={}) => {
  const was = isWatched(id);
  if(val && !was){
    state.watched.push(id);
    if(incrementCount){
      state.watchCounts[id] = (state.watchCounts[id]||0)+1;
    }
  }
  if(!val && was){
    state.watched = state.watched.filter(x => x!==id);
  }
  if(val){
    state.seenSeq = (state.seenSeq||0) + 1;
    state.seenAt[id] = state.seenSeq;
  } else {
    if(state.seenAt){ delete state.seenAt[id]; }
  }
  if(state.watched.length === talks.length){
    state.round += 1;
    state.watched = [];
    toast(`All talks watched! Starting round ${state.round}.`);
  }
  saveState(state);
  renderAll();
};

const isFav = (id) => state.favorites.includes(id);
const toggleFav = (id) => { state.favorites = isFav(id) ? state.favorites.filter(x=>x!==id) : [...state.favorites, id]; saveState(state); renderAll(); };

function nextUnwatched(){
  // Find top unwatched based on current sort
  const sorted = getSortedList(talks);
  for(const t of sorted){ if(!isWatched(t.videoId)) return t; }
  return null;
}

// -----------------------------
// UI Rendering
// -----------------------------
const listEl = document.getElementById('list');
const progFill = document.getElementById('progFill');
const progPct = document.getElementById('progPct');
const nextUp = document.getElementById('nextUp');
const nextThumb = document.getElementById('nextThumb');
const nextTitle = document.getElementById('nextTitle');
const btnPlayNext = document.getElementById('btnPlayNext');

// Category filter elements
const btnFilterToggle = document.getElementById('btnFilterToggle');
const filterPanel = document.getElementById('filterPanel');
const catAll = document.getElementById('catAll');
const catGC = document.getElementById('catGC');
const catBYU = document.getElementById('catBYU');
const catCES = document.getElementById('catCES');
const btnSort = document.getElementById('btnSort');

function percent(){ return Math.round((state.watched.length / talks.length) * 100); }

function loadThumb(img, videoId) {
  const reliableThumb = `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;
  const highResThumb = `https://i.ytimg.com/vi/${videoId}/maxresdefault.jpg`;
  img.setAttribute('referrerpolicy', 'no-referrer');
  const tester = new Image();
  tester.onload = () => { img.src = tester.naturalWidth < 300 ? reliableThumb : highResThumb; };
  tester.onerror = () => { img.src = reliableThumb; };
  tester.src = highResThumb;
}

function renderProgress(){
  const p = percent();
  progFill.style.width = p + '%';
  progPct.textContent = p + '%';
}

function renderNextUp(){
  const t = nextUnwatched();
  if(!t){ nextUp.hidden = true; return; }
  nextUp.hidden = false;
  nextTitle.textContent = t.title;
  loadThumb(nextThumb, t.videoId);
  const openFn = (event) => { event.preventDefault(); openYouTubeAppAndMark(t); };
  btnPlayNext.onclick = openFn;
  nextUp.querySelector('.thumb').onclick = openFn;
}

function rowHTML(t){
  const watched = isWatched(t.videoId);
  const fav = isFav(t.videoId);
  const count = state.watchCounts[t.videoId] || 0;
  
  // Format details
  let typeLabel = "Talk";
  if(t.type === 'gc') typeLabel = "General Conference";
  if(t.type === 'byu') typeLabel = "BYU Speech";
  if(t.type === 'ces') typeLabel = "CES/Other";

  return `
    <div class="row" data-id="${t.videoId}">
      <div class="thumb-sm" title="Open in YouTube">
        <img class="rthumb" alt="Thumbnail">
      </div>
      <div class="row-main">
        <div class="row-title">
          <button class="link-open" data-id="${t.videoId}">${t.title}</button>
        </div>
        <div class="row-speaker">${typeLabel}</div>
        <div class="row-date">${t.date}</div>
      </div>
      <div class="row-actions">
        <div class="countpill" title="Times watched">
          <button class="minus" aria-label="decrease">‚àí</button>
          <input class="count" type="number" inputmode="numeric" min="0" value="${count}" />
          <button class="plus" aria-label="increase">+</button>
        </div>
        <button class="iconbtn copy" title="Copy transcript">üìã</button>
        <button class="iconbtn notes" title="Notes">üìù</button>
        <button class="iconbtn fav" title="Favorite"><span class="star ${fav?'fav':''}">‚òÖ</span></button>
        <div class="check ${watched?'on':''}" role="checkbox" aria-checked="${watched}" title="Mark watched">${watched?'‚úì':''}</div>
      </div>
    </div>
  `;
}

function currentFilter(){ return (state.ui && state.ui.filter) ? state.ui.filter : 'need'; }

function applyCategoryFilter(arr){
  const c = state.ui.cats;
  if (c.all || (!c.gc && !c.byu && !c.ces)) return arr; 

  return arr.filter(t => {
    if (c.gc  && t.type === 'gc')  return true;
    if (c.byu && t.type === 'byu') return true;
    if (c.ces && t.type === 'ces') return true;
    return false;
  });
}

function getSortedList(arr) {
  const s = state.ui.sort || 'newest';
  return [...arr].sort((a,b) => {
    if(s === 'newest') return b.sortVal - a.sortVal;
    if(s === 'oldest') return a.sortVal - b.sortVal;
    return 0;
  });
}

function filteredTalks(){
  // 1. Filter by Status (Need/Seen/All/Fav)
  const f = currentFilter();
  let base;
  if(f==='need')  base = talks.filter(t=>!isWatched(t.videoId));
  else if(f==='seen')  base = talks.filter(t=>isWatched(t.videoId));
  else if(f==='faves') base = talks.filter(t=>isFav(t.videoId));
  else base = talks; 

  // 2. Filter by Category
  const catFiltered = applyCategoryFilter(base);

  // 3. Sort
  if(f==='seen' && (!state.ui.sort || state.ui.sort === 'newest')){
    // Special case: If viewing "Seen", default to "Recently Watched" unless specific date sort requested?
    // Actually user requested date sort capability. Let's stick to date sort for consistency unless specific "seen order" is needed.
    // However, usually "Seen" lists are useful when sorted by "When I watched it". 
    // Let's stick to the Global Sort (Date) to keep it simple as requested.
  }
  return getSortedList(catFiltered);
}

function renderList(){
  listEl.innerHTML = filteredTalks().map(rowHTML).join('');
  listEl.querySelectorAll('.row').forEach(row => {
    const id = row.dataset.id;
    const t = talks.find(x=>x.videoId===id);
    const img = row.querySelector('.rthumb');
    if (img) loadThumb(img, id);

    const openFn = (event) => { event.preventDefault(); openYouTubeAppAndMark(t); };
    row.querySelector('.link-open').onclick = openFn;
    row.querySelector('.thumb-sm').onclick = openFn;

    row.querySelector('.copy').onclick = () => toast('Transcript not linked.');
    row.querySelector('.notes').onclick = () => openNotes(id, t.title);
    row.querySelector('.fav').onclick = () => toggleFav(id);
    row.querySelector('.check').onclick = () => {
      const now = !isWatched(id);
      setWatched(id, now, {incrementCount: now});
    };
    const minus = row.querySelector('.minus');
    const plus = row.querySelector('.plus');
    const input = row.querySelector('.count');
    minus.onclick = () => { setCount(id, Math.max(0, (state.watchCounts[id]||0)-1)); input.value = state.watchCounts[id]; };
    plus.onclick = () => { setCount(id, (state.watchCounts[id]||0)+1); input.value = state.watchCounts[id]; };
    input.onchange = () => { let v = parseInt(input.value||'0',10); if(isNaN(v)||v<0) v=0; setCount(id, v); input.value = state.watchCounts[id]; };
  });
}

function setCount(id, n){ state.watchCounts[id] = n; saveState(state); renderProgress(); }

function renderFilters(){
  document.querySelectorAll('.seg').forEach(seg => {
    const is = seg.dataset.filter === currentFilter();
    seg.classList.toggle('active', is);
    seg.setAttribute('aria-selected', String(is));
    seg.onclick = () => { state.ui.filter = seg.dataset.filter; saveState(state); renderAll(); };
  });
}

function renderCategoryUI(){
  const open = !!state.ui.filterOpen;
  filterPanel.hidden = !open;
  btnFilterToggle.setAttribute('aria-expanded', String(open));
  btnFilterToggle.querySelector('span:last-child').textContent = open ? '‚ñ¥' : '‚ñæ';

  const c = state.ui.cats;
  if(catAll) catAll.checked = !!c.all;
  if(catGC)  catGC.checked  = !!c.gc;
  if(catBYU) catBYU.checked = !!c.byu;
  if(catCES) catCES.checked = !!c.ces;
}

function renderSortUI(){
  const s = state.ui.sort || 'newest';
  btnSort.textContent = s === 'newest' ? "Sort: Newest" : "Sort: Oldest";
}

function renderAll(){
  renderProgress();
  renderSortUI();
  renderNextUp();
  renderFilters();
  renderCategoryUI();
  renderList();
}

// -----------------------------
// Deep Link + Auto Mark
// -----------------------------
function openYouTubeAppAndMark(t){
  setWatched(t.videoId, true, {incrementCount:true});
  const ua = navigator.userAgent || '';
  const isiOS = /iPad|iPhone|iPod/.test(ua);
  const isAndroid = /Android/.test(ua);
  let appUrl = null;

  if(isiOS){ appUrl = `youtube://www.youtube.com/watch?v=${t.videoId}`; }
  else if(isAndroid){ appUrl = `vnd.youtube:${t.videoId}`; }
  
  if(appUrl){ window.location.href = appUrl; }
  else { window.open(`https://www.youtube.com/watch?v=${t.videoId}`, '_blank'); }
}

// -----------------------------
// Notes Modal
// -----------------------------
const notesModal = document.getElementById('notesModal');
const notesTitle = document.getElementById('notesTitle');
const notesArea = document.getElementById('notesArea');
const closeNotesBtn = document.getElementById('closeNotes');
let currentNotesVid = null;

function openNotes(videoId, title){
  currentNotesVid = videoId;
  notesTitle.textContent = title + ' ‚Äî Notes';
  notesArea.value = state.notes[videoId] || '';
  notesModal.showModal();
}
closeNotesBtn.onclick = () => notesModal.close();
notesModal.addEventListener('close', ()=>{ currentNotesVid = null; });

let notesTimer = null;
notesArea.addEventListener('input', () => {
  if(!currentNotesVid) return;
  clearTimeout(notesTimer);
  notesTimer = setTimeout(()=>{
    state.notes[currentNotesVid] = notesArea.value;
    saveState(state);
  }, 250);
});

// -----------------------------
// Exports / Backup
// -----------------------------
function getFullState(){ return state; }

function downloadAll(){
  const blob = new Blob([JSON.stringify(getFullState(), null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.download = 'jrh-tracker-backup.json';
  a.href = URL.createObjectURL(blob);
  a.click(); URL.revokeObjectURL(a.href);
}

async function emailExport(){
  try{
    const blob = new Blob([JSON.stringify(getFullState())], {type:'application/json'});
    const file = new File([blob], 'jrh-tracker-backup.json', {type:'application/json'});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({ files:[file], title:'Holland Tracker Backup', text:'Backup file' });
      return;
    }
  }catch(_){}
  const body = encodeURIComponent(JSON.stringify(getFullState(), null, 2));
  window.location.href = `mailto:?subject=Holland%20Tracker%20Backup&body=${body}`;
}

function restoreFromFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);
      if(data.watched){ // simple validation
        state = { ...DEFAULT_STATE, ...data, ui: { ...DEFAULT_STATE.ui, ...data.ui } };
        saveState(state); renderAll(); toast('Restore complete.');
      } else { toast('Backup not recognized.'); }
    }catch(e){ toast('Invalid file.'); }
  };
  reader.readAsText(file);
}

function notesOnlyText(){
  const parts = [];
  for(const t of talks){
    const n = (state.notes[t.videoId]||'').trim();
    if(n){ parts.push(`${t.title} (${t.date})\n${n}\n`); }
  }
  return parts.join('\n');
}

document.getElementById('btnDownload').onclick = downloadAll;
document.getElementById('btnEmail').onclick = emailExport;
document.getElementById('btnNotesDownload').onclick = () => {
  const txt = notesOnlyText() || '‚Äî No notes yet ‚Äî';
  const blob = new Blob([txt], {type:'text/plain'});
  const a = document.createElement('a');
  a.download = 'jrh-notes.txt';
  a.href = URL.createObjectURL(blob);
  a.click(); URL.revokeObjectURL(a.href);
};
document.getElementById('btnNotesCopy').onclick = async () => {
  const txt = notesOnlyText();
  if(!txt){ toast('No notes yet.'); return; }
  await navigator.clipboard.writeText(txt); toast('Notes copied.');
};
document.getElementById('fileRestore').addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0]; if(f) restoreFromFile(f);
  e.target.value = '';
});

// -----------------------------
// UI Logic
// -----------------------------
const toastEl = document.getElementById('toast');
let toastTimer = null;
function toast(msg){
  toastEl.textContent = msg; toastEl.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> toastEl.classList.remove('show'), 1800);
}

// Filter Toggles
btnFilterToggle.onclick = () => {
  state.ui.filterOpen = !state.ui.filterOpen;
  saveState(state);
  renderCategoryUI();
};

function onCatChange(ev){
  const id = ev.target.id;
  if (id === 'catAll' && catAll.checked) {
    state.ui.cats = { all:true, gc:false, byu:false, ces:false };
  } else {
    state.ui.cats.all = false;
    state.ui.cats.gc  = !!catGC.checked;
    state.ui.cats.byu = !!catBYU.checked;
    state.ui.cats.ces = !!catCES.checked;
    if (!state.ui.cats.gc && !state.ui.cats.byu && !state.ui.cats.ces) {
      state.ui.cats.all = true;
    }
  }
  saveState(state);
  renderAll();
}
[catAll, catGC, catBYU, catCES].forEach(el => el.addEventListener('change', onCatChange));

// Sort Toggle
btnSort.onclick = () => {
  state.ui.sort = (state.ui.sort === 'newest') ? 'oldest' : 'newest';
  saveState(state);
  renderAll();
};

// Settings
document.getElementById('btnSettings').onclick = () => {
  toast('Scroll down for Backup & Notes options.');
};

// Init
renderAll();
</script>
</body>
</html>
