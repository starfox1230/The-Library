<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Hearth - Gift Exchange</title>
    <!-- Lottie Player Script -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <style>
        :root {
            --bg-color: #1a0f0f;
            --accent-gold: #d4af37;
            --accent-red: #8a1c1c;
            --text-color: #eecfa1;
            --card-bg: #2a1a1a;
        }

        body {
            font-family: 'Georgia', serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1, h2 { text-transform: uppercase; letter-spacing: 2px; color: var(--accent-gold); }
        button { cursor: pointer; }

        /* --- UTILITY & LAYOUT --- */
        .container { max-width: 1000px; width: 100%; padding: 20px; text-align: center; }
        .hidden { display: none !important; }
        
        .btn {
            background: var(--accent-red);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
            padding: 10px 20px;
            font-family: 'Georgia', serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: 0.3s;
            margin: 5px;
        }
        .btn:hover { background: var(--accent-gold); color: var(--accent-red); box-shadow: 0 0 15px var(--accent-gold); }
        .btn-small { font-size: 0.8rem; padding: 5px 10px; }

        /* --- SETUP PHASE --- */
        .setup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .sibling-card {
            background: var(--card-bg);
            border: 1px solid var(--accent-gold);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #000;
            border: 2px solid var(--accent-gold);
            margin-bottom: 10px;
            object-fit: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #555;
        }
        input[type="file"] { display: none; }
        .upload-label { font-size: 0.7rem; text-decoration: underline; cursor: pointer; color: #aaa; }

        /* --- THE HEARTH (CEREMONY) --- */
        #hearth-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 80vh;
            position: relative;
        }

        .hearth-circle {
            position: relative;
            width: 500px;
            height: 500px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* The central fire/result area */
        .center-stage {
            width: 300px;
            height: 300px;
            text-align: center;
            z-index: 10;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Lottie Positioning */
        lottie-player {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            width: 300px; 
            height: 300px;
            opacity: 0.9;
        }

        .result-box {
            position: relative;
            z-index: 20; /* Above the fire */
            font-size: 2rem;
            color: var(--accent-gold);
            opacity: 0;
            transform: scale(0.5);
            transition: all 1s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            
            /* Visual styling for readability over fire */
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            backdrop-filter: blur(2px);
        }
        .result-box.show { opacity: 1; transform: scale(1); }
        
        /* The Siblings around the table */
        .sibling-node {
            position: absolute;
            width: 100px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 1s ease;
            opacity: 0.5;
            filter: grayscale(80%);
        }
        .sibling-node img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid #333;
            object-fit: cover;
            box-shadow: 0 0 10px #000;
        }
        .sibling-node span { margin-top: 5px; background: #000; padding: 2px 8px; border-radius: 4px; }

        /* Active States */
        .sibling-node.active {
            opacity: 1;
            filter: grayscale(0%);
            transform: scale(1.3);
            z-index: 5;
        }
        .sibling-node.active img {
            border-color: var(--accent-gold);
            box-shadow: 0 0 30px var(--accent-gold);
        }

        /* --- HISTORY TABLE --- */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #222; }
        th, td { border: 1px solid #444; padding: 10px; text-align: left; }
        th { background: var(--accent-red); color: var(--accent-gold); }

        /* --- FILE ACTIONS --- */
        .io-bar {
            background: #333;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>üéÑ The Family Hearth üéÑ</h1>
        
        <!-- SAVE/LOAD SECTION -->
        <div class="io-bar">
            <span>üíæ Data Management:</span>
            <button class="btn btn-small" onclick="downloadData()">Download History</button>
            <input type="file" id="load-file" onchange="loadData(this)" style="display:block; width:auto;">
        </div>

        <!-- SETUP VIEW -->
        <div id="setup-view">
            <h2>Who is participating?</h2>
            <div class="setup-grid" id="siblings-list">
                <!-- Sibling cards generated by JS -->
            </div>
            
            <div style="margin-top: 30px; border-top: 1px solid #444; padding-top: 20px;">
                <button class="btn" onclick="generateAndStart()">üéÅ Start Ceremony</button>
                <button class="btn" style="background: #333" onclick="toggleHistory()">üìú View History</button>
            </div>
        </div>

        <!-- CEREMONY VIEW -->
        <div id="hearth-view" class="hidden">
            <h2 id="turn-indicator">Gather around...</h2>
            
            <div class="hearth-circle" id="circle-container">
                <!-- Center Stage -->
                <div class="center-stage">
                    <!-- FIRE ANIMATION -->
                    <lottie-player 
                        src="https://assets8.lottiefiles.com/packages/lf20_d6kb3w3o.json" 
                        background="transparent" 
                        speed="1" 
                        style="width: 300px; height: 300px;" 
                        loop 
                        autoplay>
                    </lottie-player>

                    <div id="reveal-area" class="result-box">
                        <div style="font-size: 1rem; color: #fff;">Giving To:</div>
                        <div id="recipient-name" style="font-size: 2.5rem; font-weight: bold; margin: 10px 0;">???</div>
                    </div>
                </div>
            </div>

            <div style="margin-top: 50px; z-index: 20;">
                <button id="action-btn" class="btn" onclick="nextStep()">Begin</button>
                <button class="btn" style="background: #333" onclick="exitCeremony()">Exit</button>
            </div>
        </div>

        <!-- HISTORY VIEW -->
        <div id="history-view" class="hidden">
            <h2>Gift History Archive</h2>
            <div id="history-tables"></div>
            <button class="btn" onclick="toggleHistory()">Close</button>
        </div>

    </div>

    <script>
        // --- DATA STRUCTURE ---
        const defaultSiblings = [
            { id: 1, name: "Savannah", avatar: null },
            { id: 2, name: "Chris", avatar: null },
            { id: 3, name: "Sterling", avatar: null },
            { id: 4, name: "Remi", avatar: null },
            { id: 5, name: "Ariana", avatar: null },
            { id: 6, name: "Lexi", avatar: null }
        ];

        let appData = {
            siblings: JSON.parse(JSON.stringify(defaultSiblings)),
            history: [], 
            currentMatches: []
        };

        // --- INIT ---
        function init() {
            renderSetup();
        }

        // --- SETUP LOGIC ---
        function renderSetup() {
            const container = document.getElementById('siblings-list');
            container.innerHTML = '';
            appData.siblings.forEach((sib, index) => {
                const imgSrc = sib.avatar ? sib.avatar : 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"/>';
                const hasImg = !!sib.avatar;
                
                const card = document.createElement('div');
                card.className = 'sibling-card';
                card.innerHTML = `
                    <div class="avatar-preview">
                        ${hasImg ? `<img src="${sib.avatar}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : 'üéÖ'}
                    </div>
                    <strong>${sib.name}</strong>
                    <label class="upload-label">
                        ${hasImg ? 'Change Art' : 'Upload Art'}
                        <input type="file" accept="image/*" onchange="handleImageUpload(${index}, this)">
                    </label>
                `;
                container.appendChild(card);
            });
        }

        function handleImageUpload(index, input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    appData.siblings[index].avatar = e.target.result;
                    renderSetup();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- MATCHING ALGORITHM ---
        function generateMatches() {
            const givers = [...appData.siblings];
            let receivers = [...appData.siblings];
            let matches = [];
            let isValid = false;
            let attempts = 0;

            // Simple Shuffle & Check Loop
            while (!isValid && attempts < 1000) {
                attempts++;
                receivers = receivers.sort(() => Math.random() - 0.5);
                matches = [];
                let possible = true;

                for (let i = 0; i < givers.length; i++) {
                    const giver = givers[i];
                    const receiver = receivers[i];

                    // Rule 1: Cannot pick self
                    if (giver.name === receiver.name) {
                        possible = false;
                        break;
                    }

                    // Rule 2: Check last 2 years history
                    const pastReceivers = [];
                    appData.history.forEach(yearRecord => {
                        const match = yearRecord.matches.find(m => m.giver === giver.name);
                        if (match) pastReceivers.push(match.receiver);
                    });

                    const recentPast = pastReceivers.slice(-2);
                    if (recentPast.includes(receiver.name)) {
                        possible = false;
                        break;
                    }

                    matches.push({ giver: giver.name, receiver: receiver.name });
                }
                if (possible) isValid = true;
            }

            if (!isValid) {
                alert("Could not find a valid match arrangement based on history constraints!");
                return false;
            }

            appData.currentMatches = matches;
            return true;
        }

        function generateAndStart() {
            if (generateMatches()) {
                startCeremony();
            }
        }

        // --- CEREMONY LOGIC ---
        let ceremonyStep = -1; 
        let isRevealed = false;

        function startCeremony() {
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('hearth-view').classList.remove('hidden');
            renderCircle();
            ceremonyStep = -1;
            isRevealed = false;
            document.getElementById('action-btn').innerText = "Light the Fire";
            document.getElementById('turn-indicator').innerText = "The Fire is Lit";
            document.getElementById('reveal-area').classList.remove('show');
        }

        function renderCircle() {
            const container = document.getElementById('circle-container');
            // Keep center stage, remove old nodes
            const center = container.querySelector('.center-stage');
            container.innerHTML = '';
            container.appendChild(center);

            const radius = 220; // Distance from center
            const count = appData.siblings.length;

            appData.siblings.forEach((sib, i) => {
                const angle = (i / count) * (2 * Math.PI) - (Math.PI / 2); // Start at top
                const x = Math.cos(angle) * radius;
                const y = Math.sin(angle) * radius;

                const node = document.createElement('div');
                node.className = 'sibling-node';
                node.id = `node-${sib.name}`;
                node.style.transform = `translate(${x}px, ${y}px)`;
                
                const imgSrc = sib.avatar ? sib.avatar : 'https://ui-avatars.com/api/?name='+sib.name+'&background=random';
                
                node.innerHTML = `
                    <img src="${imgSrc}">
                    <span>${sib.name}</span>
                `;
                container.appendChild(node);
            });
        }

        function nextStep() {
            const btn = document.getElementById('action-btn');
            const nodes = document.querySelectorAll('.sibling-node');
            const revealArea = document.getElementById('reveal-area');
            const recipientName = document.getElementById('recipient-name');
            const turnIndicator = document.getElementById('turn-indicator');

            // Initial Start
            if (ceremonyStep === -1) {
                ceremonyStep = 0;
                highlightSibling(ceremonyStep);
                btn.innerText = "Reveal Match";
                isRevealed = false;
                return;
            }

            // If we have gone through everyone
            if (ceremonyStep >= appData.siblings.length) {
                saveToHistory();
                alert("The Ceremony is complete! Be sure to download the history file.");
                exitCeremony();
                return;
            }

            if (!isRevealed) {
                // REVEAL ACTION
                const currentGiver = appData.siblings[ceremonyStep].name;
                const match = appData.currentMatches.find(m => m.giver === currentGiver);
                
                recipientName.innerText = match.receiver;
                revealArea.classList.add('show');
                
                turnIndicator.innerText = `üéâ ${currentGiver} has ${match.receiver}! üéâ`;
                
                btn.innerText = "Next Person";
                isRevealed = true;
            } else {
                // MOVE TO NEXT
                revealArea.classList.remove('show');
                ceremonyStep++;

                if (ceremonyStep >= appData.siblings.length) {
                    btn.innerText = "Finish Ceremony";
                    turnIndicator.innerText = "All matches revealed!";
                    nodes.forEach(n => n.classList.remove('active'));
                } else {
                    highlightSibling(ceremonyStep);
                    btn.innerText = "Reveal Match";
                    isRevealed = false;
                }
            }
        }

        function highlightSibling(index) {
            const name = appData.siblings[index].name;
            const nodes = document.querySelectorAll('.sibling-node');
            const turnIndicator = document.getElementById('turn-indicator');
            
            nodes.forEach(n => n.classList.remove('active'));
            document.getElementById(`node-${name}`).classList.add('active');
            turnIndicator.innerText = `It is ${name}'s turn...`;
        }

        function exitCeremony() {
            document.getElementById('hearth-view').classList.add('hidden');
            document.getElementById('setup-view').classList.remove('hidden');
        }

        // --- HISTORY & SAVE LOGIC ---
        function saveToHistory() {
            // Check if already saved
            const currentYear = new Date().getFullYear();
            const exists = appData.history.find(h => h.year === currentYear);
            if(!exists) {
                appData.history.push({
                    year: currentYear,
                    matches: appData.currentMatches
                });
            }
        }

        function downloadData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "christmas_history.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function loadData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    appData = loadedData;
                    renderSetup();
                    alert("History loaded successfully!");
                } catch(err) {
                    alert("Error loading file. Make sure it's a valid JSON file.");
                }
            };
            reader.readAsText(file);
        }

        function toggleHistory() {
            const view = document.getElementById('history-view');
            const setup = document.getElementById('setup-view');
            
            if (view.classList.contains('hidden')) {
                view.classList.remove('hidden');
                setup.classList.add('hidden');
                renderHistoryTable();
            } else {
                view.classList.add('hidden');
                setup.classList.remove('hidden');
            }
        }

        function renderHistoryTable() {
            const div = document.getElementById('history-tables');
            div.innerHTML = '';
            
            if (appData.history.length === 0) {
                div.innerHTML = '<p>No history yet.</p>';
                return;
            }

            appData.history.sort((a,b) => b.year - a.year).forEach(record => {
                let html = `<h3>${record.year}</h3><table><thead><tr><th>Giver</th><th>Receiver</th></tr></thead><tbody>`;
                record.matches.forEach(m => {
                    html += `<tr><td>${m.giver}</td><td>${m.receiver}</td></tr>`;
                });
                html += `</tbody></table>`;
                div.innerHTML += html;
            });
        }

        // Run Init
        init();

    </script>
</body>
</html>
